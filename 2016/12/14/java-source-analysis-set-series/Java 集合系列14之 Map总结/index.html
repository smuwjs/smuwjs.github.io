<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    <title>Java 集合系列14之 Map总结 | Jeeson&#39;s Blog | Write the code. Change the world.</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Java源码分析,Java 集合系列">
    <meta name="description" content="Map 总结学完了Map的全部内容，我们再回头看看Map的框架图。                                                                                                            Map概括 Map 是“键值对”映射的抽象接口。 AbstractMap 实现了Map中的绝大部分函数接口。它减少了“">
<meta name="keywords" content="Java源码分析,Java 集合系列">
<meta property="og:type" content="article">
<meta property="og:title" content="Java 集合系列14之 Map总结">
<meta property="og:url" content="https://smuwjs.github.io/2016/12/14/java-source-analysis-set-series/Java 集合系列14之 Map总结/index.html">
<meta property="og:site_name" content="Jeeson&#39;s Blog">
<meta property="og:description" content="Map 总结学完了Map的全部内容，我们再回头看看Map的框架图。                                                                                                            Map概括 Map 是“键值对”映射的抽象接口。 AbstractMap 实现了Map中的绝大部分函数接口。它减少了“">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://oov0wb0gl.bkt.clouddn.com/2017-06-08-14969090857546.jpg">
<meta property="og:image" content="http://oov0wb0gl.bkt.clouddn.com/2017-06-08-14969123240836.jpg">
<meta property="og:image" content="http://oov0wb0gl.bkt.clouddn.com/2017-06-08-14969321029224.jpg">
<meta property="og:updated_time" content="2018-06-27T09:39:57.953Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java 集合系列14之 Map总结">
<meta name="twitter:description" content="Map 总结学完了Map的全部内容，我们再回头看看Map的框架图。                                                                                                            Map概括 Map 是“键值对”映射的抽象接口。 AbstractMap 实现了Map中的绝大部分函数接口。它减少了“">
<meta name="twitter:image" content="http://oov0wb0gl.bkt.clouddn.com/2017-06-08-14969090857546.jpg">
    
        <link rel="alternate" type="application/atom+xml" title="Jeeson&#39;s Blog" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/head.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Jeeson</h5>
          <a href="mailto:smuwjs@163.com" title="smuwjs@163.com" class="mail">smuwjs@163.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/smuwjs" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Java 集合系列14之 Map总结</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Java 集合系列14之 Map总结</h1>
        <h5 class="subtitle">
            
                <time datetime="2016-12-13T16:00:00.000Z" itemprop="datePublished" class="page-time">
  2016-12-14
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/source-analysis/">source analysis</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Map-总结"><span class="post-toc-number">1.</span> <span class="post-toc-text">Map 总结</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Map概括"><span class="post-toc-number">2.</span> <span class="post-toc-text">Map概括</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#HashMap和Hashtable异同"><span class="post-toc-number">3.</span> <span class="post-toc-text">HashMap和Hashtable异同</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#HashMap和Hashtable的相同点"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">HashMap和Hashtable的相同点</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#存储的思想都是："><span class="post-toc-number">3.1.1.</span> <span class="post-toc-text">存储的思想都是：</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#添加key-value键值对："><span class="post-toc-number">3.1.2.</span> <span class="post-toc-text">添加key-value键值对：</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#删除key-value键值对："><span class="post-toc-number">3.1.3.</span> <span class="post-toc-text">删除key-value键值对：</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#HashMap和Hashtable的不同点"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">HashMap和Hashtable的不同点</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#继承和实现方式不同"><span class="post-toc-number">3.2.1.</span> <span class="post-toc-text">继承和实现方式不同</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#线程安全不同"><span class="post-toc-number">3.2.2.</span> <span class="post-toc-text">线程安全不同</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#对null值的处理不同"><span class="post-toc-number">3.2.3.</span> <span class="post-toc-text">对null值的处理不同</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#支持的遍历种类不同"><span class="post-toc-number">3.2.4.</span> <span class="post-toc-text">支持的遍历种类不同</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Iterator迭代器的遍历顺序不同"><span class="post-toc-number">3.2.5.</span> <span class="post-toc-text">Iterator迭代器的遍历顺序不同</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#容量的初始值-和-增加方式都不一样"><span class="post-toc-number">3.2.6.</span> <span class="post-toc-text">容量的初始值 和 增加方式都不一样</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#添加key-value时的hash值算法不同"><span class="post-toc-number">3.2.7.</span> <span class="post-toc-text">添加key-value时的hash值算法不同</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#HashMap和Hashtable使用的情景"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">HashMap和Hashtable使用的情景</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#HashMap和WeakHashMap异同"><span class="post-toc-number">4.</span> <span class="post-toc-text">HashMap和WeakHashMap异同</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#HashMap和WeakHashMap的相同点"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">HashMap和WeakHashMap的相同点</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#HashMap和WeakHashMap的不同点"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">HashMap和WeakHashMap的不同点</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#HashMap和WeakHashMap的比较测试程序"><span class="post-toc-number">5.</span> <span class="post-toc-text">HashMap和WeakHashMap的比较测试程序</span></a></li></ol>
        </nav>
    </aside>
    
<article id="post-java-source-analysis-set-series/Java 集合系列14之 Map总结"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Java 集合系列14之 Map总结</h1>
        <div class="post-meta">
            <time class="post-time" title="2016-12-14 00:00:00" datetime="2016-12-13T16:00:00.000Z"  itemprop="datePublished">2016-12-14</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/source-analysis/">source analysis</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="Map-总结"><a href="#Map-总结" class="headerlink" title="Map 总结"></a>Map 总结</h1><p>学完了Map的全部内容，我们再回头看看Map的框架图。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://oov0wb0gl.bkt.clouddn.com/2017-06-08-14969090857546.jpg" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<h1 id="Map概括"><a href="#Map概括" class="headerlink" title="Map概括"></a>Map概括</h1><ol>
<li>Map 是“键值对”映射的抽象接口。</li>
<li>AbstractMap 实现了Map中的绝大部分函数接口。它减少了“Map的实现类”的重复编码。</li>
<li>SortedMap 有序的“键值对”映射接口。</li>
<li>NavigableMap 是继承于SortedMap的，支持导航函数的接口。</li>
<li>HashMap, Hashtable, TreeMap, WeakHashMap这4个类是“键值对”映射的实现类。它们各有区别！<ol>
<li><strong>HashMap</strong>  是基于“拉链法”实现的散列表。一般用于单线程程序中。</li>
<li><strong>Hashtable</strong>  也是基于“拉链法”实现的散列表。它一般用于多线程程序中。</li>
<li><strong>WeakHashMap</strong>  也是基于“拉链法”实现的散列表，它一般也用于单线程程序中。相比HashMap，WeakHashMap中的键是“弱键”，当“弱键”被GC回收时，它对应的键值对也会被从WeakHashMap中删除；而HashMap中的键是强键。</li>
<li><strong>TreeMap</strong>  是有序的散列表，它是通过红黑树实现的。它一般用于单线程中存储有序的映射。</li>
</ol>
</li>
</ol>
<h1 id="HashMap和Hashtable异同"><a href="#HashMap和Hashtable异同" class="headerlink" title="HashMap和Hashtable异同"></a>HashMap和Hashtable异同</h1><h2 id="HashMap和Hashtable的相同点"><a href="#HashMap和Hashtable的相同点" class="headerlink" title="HashMap和Hashtable的相同点"></a>HashMap和Hashtable的相同点</h2><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://oov0wb0gl.bkt.clouddn.com/2017-06-08-14969123240836.jpg" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<p>HashMap和Hashtable都是存储“键值对(key-value)”的散列表，而且都是采用拉链法实现的。</p>
<h3 id="存储的思想都是："><a href="#存储的思想都是：" class="headerlink" title="存储的思想都是："></a>存储的思想都是：</h3><p>通过table数组存储，数组的每一个元素都是一个Entry；而一个Entry就是一个单向链表，Entry链表中的每一个节点就保存了key-value键值对数据。</p>
<h3 id="添加key-value键值对："><a href="#添加key-value键值对：" class="headerlink" title="添加key-value键值对："></a>添加key-value键值对：</h3><p>首先，根据key值计算出哈希值，再计算出数组索引(即，该key-value在table中的索引)。然后，根据数组索引找到Entry(即，单向链表)，再遍历单向链表，将key和链表中的每一个节点的key进行对比。若key已经存在Entry链表中，则用该value值取代旧的value值；若key不存在Entry链表中，则新建一个key-value节点，并将该节点插入Entry链表的表头位置。</p>
<h3 id="删除key-value键值对："><a href="#删除key-value键值对：" class="headerlink" title="删除key-value键值对："></a>删除key-value键值对：</h3><p>删除键值对，相比于“添加键值对”来说，简单很多。首先，还是根据key计算出哈希值，再计算出数组索引(即，该key-value在table中的索引)。然后，根据索引找出Entry(即，单向链表)。若节点key-value存在与链表Entry中，则删除链表中的节点即可。</p>
<p>上面介绍了HashMap和Hashtable的相同点。正是由于它们都是散列表，我们关注更多的是“它们的区别，以及它们分别适合在什么情况下使用”。那接下来，我们先看看它们的区别。</p>
<h2 id="HashMap和Hashtable的不同点"><a href="#HashMap和Hashtable的不同点" class="headerlink" title="HashMap和Hashtable的不同点"></a>HashMap和Hashtable的不同点</h2><h3 id="继承和实现方式不同"><a href="#继承和实现方式不同" class="headerlink" title="继承和实现方式不同"></a>继承和实现方式不同</h3><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://oov0wb0gl.bkt.clouddn.com/2017-06-08-14969321029224.jpg" alt="" title="">
                </div>
                <div class="image-caption"></div>
            </figure>
<p>HashMap 继承于AbstractMap，实现了Map、Cloneable、java.io.Serializable接口。<br>Hashtable 继承于Dictionary，实现了Map、Cloneable、java.io.Serializable接口。</p>
<p>HashMap的定义:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;, <span class="title">Cloneable</span>, <span class="title">Serializable</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>Hashtable的定义:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hashtable</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">Dictionary</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>从中，我们可以看出：<br>1.1 HashMap和Hashtable都实现了Map、Cloneable、java.io.Serializable接口。<br>      实现了Map接口，意味着它们都支持key-value键值对操作。支持“添加key-value键值对”、“获取key”、“获取value”、“获取map大小”、“清空map”等基本的key-value键值对操作。<br>      实现了Cloneable接口，意味着它能被克隆。<br>      实现了java.io.Serializable接口，意味着它们支持序列化，能通过序列化去传输。</p>
<p>1.2 HashMap继承于AbstractMap，而Hashtable继承于Dictionary<br>      Dictionary是一个抽象类，它直接继承于Object类，没有实现任何接口。Dictionary类是JDK 1.0的引入的。虽然Dictionary也支持“添加key-value键值对”、“获取value”、“获取大小”等基本操作，但它的API函数比Map少；而且             Dictionary一般是通过Enumeration(枚举类)去遍历，Map则是通过Iterator(迭代器)去遍历。 然而‘由于Hashtable也实现了Map接口，所以，它即支持Enumeration遍历，也支持Iterator遍历。关于这点，后面还会进一步说明。<br>      AbstractMap是一个抽象类，它实现了Map接口的绝大部分API函数；为Map的具体实现类提供了极大的便利。它是JDK 1.2新增的类。</p>
<h3 id="线程安全不同"><a href="#线程安全不同" class="headerlink" title="线程安全不同"></a>线程安全不同</h3><p>Hashtable的几乎所有函数都是同步的，即它是线程安全的，支持多线程。<br>而HashMap的函数则是非同步的，它不是线程安全的。若要在多线程中使用HashMap，需要我们额外的进行同步处理。 对HashMap的同步处理可以使用Collections类提供的synchronizedMap静态方法，或者直接使用JDK 5.0之后提供的java.util.concurrent包里的ConcurrentHashMap类。</p>
<h3 id="对null值的处理不同"><a href="#对null值的处理不同" class="headerlink" title="对null值的处理不同"></a>对null值的处理不同</h3><p>HashMap的key、value都可以为null。<br>Hashtable的key、value都不可以为null。</p>
<p>我们先看看HashMap和Hashtable “添加key-value”的方法</p>
<p>HashMap的添加key-value的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将“key-value”添加到HashMap中</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 若“key为null”，则将该键值对添加到table[0]中。</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">    <span class="comment">// 若“key不为null”，则计算该key的哈希值，然后将其添加到该哈希值对应的链表中。</span></span><br><span class="line">    <span class="keyword">int</span> hash = hash(key.hashCode());</span><br><span class="line">    <span class="keyword">int</span> i = indexFor(hash, table.length);</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="comment">// 若“该key”对应的键值对已经存在，则用新的value取代旧的value。然后退出！</span></span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若“该key”对应的键值对不存在，则将“key-value”添加到table中</span></span><br><span class="line">    modCount++;</span><br><span class="line">    addEntry(hash, key, value, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// putForNullKey()的作用是将“key为null”键值对添加到table[0]位置</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> V <span class="title">putForNullKey</span><span class="params">(V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[<span class="number">0</span>]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="comment">// recordAccess()函数什么也没有做</span></span><br><span class="line">            e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 添加第1个“key为null”的元素都table中的时候，会执行到这里。</span></span><br><span class="line">    <span class="comment">// 它的作用是将“设置table[0]的key为null，值为value”。</span></span><br><span class="line">    modCount++;</span><br><span class="line">    addEntry(<span class="number">0</span>, <span class="keyword">null</span>, value, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hashtable的添加key-value的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将“key-value”添加到Hashtable中</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Hashtable中不能插入value为null的元素！！！</span></span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若“Hashtable中已存在键为key的键值对”，</span></span><br><span class="line">    <span class="comment">// 则用“新的value”替换“旧的value”</span></span><br><span class="line">    Entry tab[] = table;</span><br><span class="line">    <span class="comment">// Hashtable中不能插入key为null的元素！！！</span></span><br><span class="line">    <span class="comment">// 否则，下面的语句会抛出异常！</span></span><br><span class="line">    <span class="keyword">int</span> hash = key.hashCode();</span><br><span class="line">    <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = tab[index] ; e != <span class="keyword">null</span> ; e = e.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">            V old = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="keyword">return</span> old;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若“Hashtable中不存在键为key的键值对”，</span></span><br><span class="line">    <span class="comment">// (01) 将“修改统计数”+1</span></span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// (02) 若“Hashtable实际容量” &gt; “阈值”(阈值=总的容量 * 加载因子)</span></span><br><span class="line">    <span class="comment">//  则调整Hashtable的大小</span></span><br><span class="line">    <span class="keyword">if</span> (count &gt;= threshold) &#123;</span><br><span class="line">        <span class="comment">// Rehash the table if the threshold is exceeded</span></span><br><span class="line">        rehash();</span><br><span class="line"></span><br><span class="line">        tab = table;</span><br><span class="line">        index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (03) 将“Hashtable中index”位置的Entry(链表)保存到e中 Entry&lt;K,V&gt; e = tab[index];</span></span><br><span class="line">    <span class="comment">// (04) 创建“新的Entry节点”，并将“新的Entry”插入“Hashtable的index位置”，并设置e为“新的Entry”的下一个元素(即“新Entry”为链表表头)。        </span></span><br><span class="line">    tab[index] = <span class="keyword">new</span> Entry&lt;K,V&gt;(hash, key, value, e);</span><br><span class="line">    <span class="comment">// (05) 将“Hashtable的实际容量”+1</span></span><br><span class="line">    count++;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据上面的代码，我们可以看出：</p>
<p>Hashtable的key或value，都不能为null！否则，会抛出异常NullPointerException。<br>HashMap的key、value都可以为null。 当HashMap的key为null时，HashMap会将其固定的插入table[0]位置(即HashMap散列表的第一个位置)；而且table[0]处只会容纳一个key为null的值，当有多个key为null的值插入的时候，table[0]会保留最后插入的value。</p>
<h3 id="支持的遍历种类不同"><a href="#支持的遍历种类不同" class="headerlink" title="支持的遍历种类不同"></a>支持的遍历种类不同</h3><p>HashMap只支持Iterator(迭代器)遍历。</p>
<p>而Hashtable支持Iterator(迭代器)和Enumeration(枚举器)两种方式遍历。</p>
<p>Enumeration 是JDK 1.0添加的接口，只有hasMoreElements(), nextElement() 两个API接口，不能通过Enumeration()对元素进行修改 。<br>而Iterator 是JDK 1.2才添加的接口，支持hasNext(), next(), remove() 三个API接口。HashMap也是JDK 1.2版本才添加的，所以用Iterator取代Enumeration，HashMap只支持Iterator遍历。</p>
<h3 id="Iterator迭代器的遍历顺序不同"><a href="#Iterator迭代器的遍历顺序不同" class="headerlink" title="Iterator迭代器的遍历顺序不同"></a>Iterator迭代器的遍历顺序不同</h3><p>HashMap是“从前向后”的遍历数组；再对数组具体某一项对应的链表，从表头开始进行遍历。<br>Hashtabl是“从后往前”的遍历数组；再对数组具体某一项对应的链表，从表头开始进行遍历。</p>
<h3 id="容量的初始值-和-增加方式都不一样"><a href="#容量的初始值-和-增加方式都不一样" class="headerlink" title="容量的初始值 和 增加方式都不一样"></a>容量的初始值 和 增加方式都不一样</h3><p>HashMap默认的容量大小是16；增加容量时，每次将容量变为“原始容量x2”。<br>Hashtable默认的容量大小是11；增加容量时，每次将容量变为“原始容量x2 + 1”。</p>
<p>HashMap 和 Hashtable 默认的“加载因子” 都是0.75。</p>
<h3 id="添加key-value时的hash值算法不同"><a href="#添加key-value时的hash值算法不同" class="headerlink" title="添加key-value时的hash值算法不同"></a>添加key-value时的hash值算法不同</h3><p>HashMap 添加元素时，是使用自定义的哈希算法。<br>Hashtable 没有自定义哈希算法，而直接采用的key的hashCode()。</p>
<p>HashMap 添加元素时，是使用自定义的哈希算法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(<span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">    h ^= (h &gt;&gt;&gt; <span class="number">20</span>) ^ (h &gt;&gt;&gt; <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">7</span>) ^ (h &gt;&gt;&gt; <span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将“key-value”添加到HashMap中</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 若“key为null”，则将该键值对添加到table[0]中。</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">    <span class="comment">// 若“key不为null”，则计算该key的哈希值，然后将其添加到该哈希值对应的链表中。</span></span><br><span class="line">    <span class="keyword">int</span> hash = hash(key.hashCode());</span><br><span class="line">    <span class="keyword">int</span> i = indexFor(hash, table.length);</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="comment">// 若“该key”对应的键值对已经存在，则用新的value取代旧的value。然后退出！</span></span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若“该key”对应的键值对不存在，则将“key-value”添加到table中</span></span><br><span class="line">    modCount++;</span><br><span class="line">    addEntry(hash, key, value, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hashtable 没有自定义哈希算法，而直接采用的key的hashCode()。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Hashtable中不能插入value为null的元素！！！</span></span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若“Hashtable中已存在键为key的键值对”，</span></span><br><span class="line">    <span class="comment">// 则用“新的value”替换“旧的value”</span></span><br><span class="line">    Entry tab[] = table;</span><br><span class="line">    <span class="keyword">int</span> hash = key.hashCode();</span><br><span class="line">    <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = tab[index] ; e != <span class="keyword">null</span> ; e = e.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">            V old = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="keyword">return</span> old;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若“Hashtable中不存在键为key的键值对”，</span></span><br><span class="line">    <span class="comment">// (01) 将“修改统计数”+1</span></span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// (02) 若“Hashtable实际容量” &gt; “阈值”(阈值=总的容量 * 加载因子)</span></span><br><span class="line">    <span class="comment">//  则调整Hashtable的大小</span></span><br><span class="line">    <span class="keyword">if</span> (count &gt;= threshold) &#123;</span><br><span class="line">        <span class="comment">// Rehash the table if the threshold is exceeded</span></span><br><span class="line">        rehash();</span><br><span class="line"></span><br><span class="line">        tab = table;</span><br><span class="line">        index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (03) 将“Hashtable中index”位置的Entry(链表)保存到e中</span></span><br><span class="line">    Entry&lt;K,V&gt; e = tab[index];</span><br><span class="line">    <span class="comment">// (04) 创建“新的Entry节点”，并将“新的Entry”插入“Hashtable的index位置”，并设置e为“新的Entry”的下一个元素(即“新Entry”为链表表头)。        </span></span><br><span class="line">    tab[index] = <span class="keyword">new</span> Entry&lt;K,V&gt;(hash, key, value, e);</span><br><span class="line">    <span class="comment">// (05) 将“Hashtable的实际容量”+1</span></span><br><span class="line">    count++;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="HashMap和Hashtable使用的情景"><a href="#HashMap和Hashtable使用的情景" class="headerlink" title="HashMap和Hashtable使用的情景"></a>HashMap和Hashtable使用的情景</h2><p>其实，若了解它们之间的不同之处后，可以很容易的区分根据情况进行取舍。例如：(01) 若在单线程中，我们往往会选择HashMap；而在多线程中，则会选择Hashtable。(02)，若不能插入null元素，则选择Hashtable；否则，可以选择HashMap。<br>但这个不是绝对的标准。例如，在多线程中，我们可以自己对HashMap进行同步，也可以选择<strong>ConcurrentHashMap</strong>。当HashMap和Hashtable都不能满足自己的需求时，还可以考虑新定义一个类，继承或重新实现散列表；当然，一般情况下是不需要的了。</p>
<h1 id="HashMap和WeakHashMap异同"><a href="#HashMap和WeakHashMap异同" class="headerlink" title="HashMap和WeakHashMap异同"></a>HashMap和WeakHashMap异同</h1><h2 id="HashMap和WeakHashMap的相同点"><a href="#HashMap和WeakHashMap的相同点" class="headerlink" title="HashMap和WeakHashMap的相同点"></a>HashMap和WeakHashMap的相同点</h2><ol>
<li>它们都是散列表，存储的是“键值对”映射。</li>
<li>它们都继承于AbstractMap，并且实现Map基础。</li>
<li>它们的构造函数都一样。它们都包括4个构造函数，而且函数的参数都一样。</li>
<li>默认的容量大小是16，默认的加载因子是0.75。</li>
<li>它们的“键”和“值”都允许为null。</li>
<li>它们都是“非同步的”。</li>
</ol>
<h2 id="HashMap和WeakHashMap的不同点"><a href="#HashMap和WeakHashMap的不同点" class="headerlink" title="HashMap和WeakHashMap的不同点"></a>HashMap和WeakHashMap的不同点</h2><ol>
<li><p>HashMap实现了Cloneable和Serializable接口，而WeakHashMap没有。<br>HashMap实现Cloneable，意味着它能通过clone()克隆自己。<br>HashMap实现Serializable，意味着它支持序列化，能通过序列化去传输。</p>
</li>
<li><p>HashMap的“键”是“强引用(StrongReference)”，而WeakHashMap的键是“弱引用(WeakReference)”。<br>WeakReference的“弱键”能实现WeakReference对“键值对”的动态回收。当“弱键”不再被使用到时，GC会回收它，WeakReference也会将“弱键”对应的键值对删除。</p>
</li>
</ol>
<p>这个“弱键”实现的动态回收“键值对”的原理呢？其实，通过WeakReference(弱引用)和ReferenceQueue(引用队列)实现的。 首先，我们需要了解WeakHashMap中：</p>
<ol>
<li>“键”是WeakReference，即key是弱键。</li>
<li>ReferenceQueue是一个引用队列，它是和WeakHashMap联合使用的。当弱引用所引用的对象被垃圾回收，Java虚拟机就会把这个弱引用加入到与之关联的引用队列中。 WeakHashMap中的ReferenceQueue是queue。</li>
<li>WeakHashMap是通过数组实现的，我们假设这个数组是table。</li>
</ol>
<p>接下来，说说“动态回收”的步骤。</p>
<ol>
<li>新建WeakHashMap，将“键值对”添加到WeakHashMap中。<pre><code>将“键值对”添加到WeakHashMap中时，添加的键都是弱键。
实际上，WeakHashMap是通过数组table保存Entry(键值对)；每一个Entry实际上是一个单向链表，即Entry是键值对链表。
</code></pre></li>
<li>当某“弱键”不再被其它对象引用，并被GC回收时。在GC回收该“弱键”时，这个“弱键”也同时会被添加到queue队列中。<pre><code>例如，当我们在将“弱键”key添加到WeakHashMap之后；后来将key设为null。这时，便没有外部外部对象再引用该了key。
接着，当Java虚拟机的GC回收内存时，会回收key的相关内存；同时，将key添加到queue队列中。
</code></pre></li>
<li>当下一次我们需要操作WeakHashMap时，会先同步table和queue。table中保存了全部的键值对，而queue中保存被GC回收的“弱键”；同步它们，就是删除table中被GC回收的“弱键”对应的键值对。<br>例如，当我们“读取WeakHashMap中的元素或获取WeakReference的大小时”，它会先同步table和queue，目的是“删除table中被GC回收的‘弱键’对应的键值对”。删除的方法就是逐个比较“table中元素的‘键’和queue中的‘键’”，若它们相当，则删除“table中的该键值对”。</li>
</ol>
<h1 id="HashMap和WeakHashMap的比较测试程序"><a href="#HashMap和WeakHashMap的比较测试程序" class="headerlink" title="HashMap和WeakHashMap的比较测试程序"></a>HashMap和WeakHashMap的比较测试程序</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.WeakHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.WeakReference;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span> HashMap 和 WeakHashMap比较程序</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> skywang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@email</span> kuiwu-wang@163.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompareHashmapAndWeakhashmap</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当“弱键”是String时，比较HashMap和WeakHashMap</span></span><br><span class="line">        compareWithString();</span><br><span class="line">        <span class="comment">// 当“弱键”是自定义类型时，比较HashMap和WeakHashMap</span></span><br><span class="line">        compareWithSelfClass();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 遍历map，并打印map的大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">iteratorAndCountMap</span><span class="params">(Map map)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 遍历map</span></span><br><span class="line">        <span class="keyword">for</span> (Iterator iter = map.entrySet().iterator();</span><br><span class="line">                iter.hasNext();  ) &#123;</span><br><span class="line">            Map.Entry en = (Map.Entry)iter.next();</span><br><span class="line">            System.out.printf(<span class="string">"map entry : %s - %s\n "</span>,en.getKey(), en.getValue());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印HashMap的实际大小</span></span><br><span class="line">        System.out.printf(<span class="string">" map size:%s\n\n"</span>, map.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过String对象测试HashMap和WeakHashMap</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">compareWithString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 新建4个String字符串</span></span><br><span class="line">        String w1 = <span class="keyword">new</span> String(<span class="string">"W1"</span>);</span><br><span class="line">        String w2 = <span class="keyword">new</span> String(<span class="string">"W2"</span>);</span><br><span class="line">        String h1 = <span class="keyword">new</span> String(<span class="string">"H1"</span>);</span><br><span class="line">        String h2 = <span class="keyword">new</span> String(<span class="string">"H2"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 新建 WeakHashMap对象，并将w1,w2添加到 WeakHashMap中</span></span><br><span class="line">        Map wmap = <span class="keyword">new</span> WeakHashMap();</span><br><span class="line">        wmap.put(w1, <span class="string">"w1"</span>);</span><br><span class="line">        wmap.put(w2, <span class="string">"w2"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 新建 HashMap对象，并将h1,h2添加到 WeakHashMap中</span></span><br><span class="line">        Map hmap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        hmap.put(h1, <span class="string">"h1"</span>);</span><br><span class="line">        hmap.put(h2, <span class="string">"h2"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除HashMap中的“h1”。</span></span><br><span class="line">        <span class="comment">// 结果：删除“h1”之后，HashMap中只有 h2 ！</span></span><br><span class="line">        hmap.remove(h1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将WeakHashMap中的w1设置null，并执行gc()。系统会回收w1</span></span><br><span class="line">        <span class="comment">// 结果：w1是“弱键”，被GC回收后，WeakHashMap中w1对应的键值对，也会被从WeakHashMap中删除。</span></span><br><span class="line">        <span class="comment">//       w2是“弱键”，但它不是null，不会被GC回收；也就不会被从WeakHashMap中删除。</span></span><br><span class="line">        <span class="comment">// 因此，WeakHashMap中只有 w2</span></span><br><span class="line">        <span class="comment">// 注意：若去掉“w1=null” 或者“System.gc()”，结果都会不一样！</span></span><br><span class="line">        w1 = <span class="keyword">null</span>;</span><br><span class="line">        System.gc();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历并打印HashMap的大小</span></span><br><span class="line">        System.out.printf(<span class="string">" -- HashMap --\n"</span>);</span><br><span class="line">        iteratorAndCountMap(hmap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历并打印WeakHashMap的大小</span></span><br><span class="line">        System.out.printf(<span class="string">" -- WeakHashMap --\n"</span>);</span><br><span class="line">        iteratorAndCountMap(wmap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过自定义类测试HashMap和WeakHashMap</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">compareWithSelfClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 新建4个自定义对象</span></span><br><span class="line">        Self s1 = <span class="keyword">new</span> Self(<span class="number">10</span>);</span><br><span class="line">        Self s2 = <span class="keyword">new</span> Self(<span class="number">20</span>);</span><br><span class="line">        Self s3 = <span class="keyword">new</span> Self(<span class="number">30</span>);</span><br><span class="line">        Self s4 = <span class="keyword">new</span> Self(<span class="number">40</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 新建 WeakHashMap对象，并将s1,s2添加到 WeakHashMap中</span></span><br><span class="line">        Map wmap = <span class="keyword">new</span> WeakHashMap();</span><br><span class="line">        wmap.put(s1, <span class="string">"s1"</span>);</span><br><span class="line">        wmap.put(s2, <span class="string">"s2"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 新建 HashMap对象，并将s3,s4添加到 WeakHashMap中</span></span><br><span class="line">        Map hmap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        hmap.put(s3, <span class="string">"s3"</span>);</span><br><span class="line">        hmap.put(s4, <span class="string">"s4"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除HashMap中的s3。</span></span><br><span class="line">        <span class="comment">// 结果：删除s3之后，HashMap中只有 s4 ！</span></span><br><span class="line">        hmap.remove(s3);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将WeakHashMap中的s1设置null，并执行gc()。系统会回收w1</span></span><br><span class="line">        <span class="comment">// 结果：s1是“弱键”，被GC回收后，WeakHashMap中s1对应的键值对，也会被从WeakHashMap中删除。</span></span><br><span class="line">        <span class="comment">//       w2是“弱键”，但它不是null，不会被GC回收；也就不会被从WeakHashMap中删除。</span></span><br><span class="line">        <span class="comment">// 因此，WeakHashMap中只有 s2</span></span><br><span class="line">        <span class="comment">// 注意：若去掉“s1=null” 或者“System.gc()”，结果都会不一样！</span></span><br><span class="line">        s1 = <span class="keyword">null</span>;</span><br><span class="line">        System.gc();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        // 休眠500ms</span></span><br><span class="line"><span class="comment">        try &#123;</span></span><br><span class="line"><span class="comment">            Thread.sleep(500);</span></span><br><span class="line"><span class="comment">        &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">            e.printStackTrace();</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        // */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 遍历并打印HashMap的大小</span></span><br><span class="line">        System.out.printf(<span class="string">" -- Self-def HashMap --\n"</span>);</span><br><span class="line">        iteratorAndCountMap(hmap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历并打印WeakHashMap的大小</span></span><br><span class="line">        System.out.printf(<span class="string">" -- Self-def WeakHashMap --\n"</span>);</span><br><span class="line">        iteratorAndCountMap(wmap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Self</span> </span>&#123; </span><br><span class="line">        <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Self</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.id = id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 覆盖finalize()方法</span></span><br><span class="line">        <span class="comment">// 在GC回收时会被执行</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.finalize();</span><br><span class="line">            System.out.printf(<span class="string">"GC Self: id=%d addr=0x%s)\n"</span>, id, <span class="keyword">this</span>);</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> -- HashMap --</span><br><span class="line">map entry : H2 - h2</span><br><span class="line">map size:<span class="number">1</span></span><br><span class="line"></span><br><span class="line"> -- WeakHashMap --</span><br><span class="line">map entry : W2 - w2</span><br><span class="line">map size:<span class="number">1</span></span><br><span class="line"></span><br><span class="line"> -- Self-def HashMap --</span><br><span class="line">map entry : CompareHashmapAndWeakhashmap$Self@<span class="number">1f</span>f9dc36 - s4</span><br><span class="line">map size:<span class="number">1</span></span><br><span class="line"></span><br><span class="line"> -- Self-def WeakHashMap --</span><br><span class="line">GC Self: id=<span class="number">10</span> addr=<span class="number">0xC</span>ompareHashmapAndWeakhashmap$Self@<span class="number">12276</span>af2)</span><br><span class="line">map entry : CompareHashmapAndWeakhashmap$Self@<span class="number">59</span>de3f2d - s2</span><br><span class="line">map size:<span class="number">1</span></span><br></pre></td></tr></table></figure>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2018-06-27T09:39:57.953Z" itemprop="dateUpdated">2018-06-27 17:39:57</time>
</span><br>


        
        本文固定链接：<a href="/2016/12/14/java-source-analysis-set-series/Java 集合系列14之 Map总结/" target="_blank" rel="external">https://smuwjs.github.io/2016/12/14/java-source-analysis-set-series/Java 集合系列14之 Map总结/</a>
        
    </div>
    <footer>
        <a href="https://smuwjs.github.io">
            <img src="/img/head.png" alt="Jeeson">
            Jeeson
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java-集合系列/">Java 集合系列</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java源码分析/">Java源码分析</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://smuwjs.github.io/2016/12/14/java-source-analysis-set-series/Java 集合系列14之 Map总结/&title=《Java 集合系列14之 Map总结》 — Jeeson's Blog&pic=https://smuwjs.github.io/img/head.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://smuwjs.github.io/2016/12/14/java-source-analysis-set-series/Java 集合系列14之 Map总结/&title=《Java 集合系列14之 Map总结》 — Jeeson's Blog&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://smuwjs.github.io/2016/12/14/java-source-analysis-set-series/Java 集合系列14之 Map总结/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Java 集合系列14之 Map总结》 — Jeeson's Blog&url=https://smuwjs.github.io/2016/12/14/java-source-analysis-set-series/Java 集合系列14之 Map总结/&via=https://smuwjs.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://smuwjs.github.io/2016/12/14/java-source-analysis-set-series/Java 集合系列14之 Map总结/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2016/12/15/java-source-analysis-set-series/Java 集合系列15之 Set架构/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Java 集合系列15之 Set架构</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2016/12/13/java-source-analysis-set-series/Java 集合系列13之 WeakHashMap详细介绍/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Java 集合系列13之 WeakHashMap详细介绍</h4>
      </a>
    </div>
  
</nav>



    

<div class="comments" id="comments">
    <div class="ds-thread" data-thread-key="java-source-analysis-set-series/Java 集合系列14之 Map总结" data-title="Java 集合系列14之 Map总结" data-url="https://smuwjs.github.io/2016/12/14/java-source-analysis-set-series/Java 集合系列14之 Map总结/"></div>
</div>
<script>
lazyScripts.push('//cdn.bootcss.com/marked/0.3.6/marked.min.js');

var duoshuoQuery = {short_name:'smuwjs', theme: 'none'};
lazyScripts.push('//unpkg.com/hexo-theme-material-indigo@latest/js/embed.min.js');


</script>
















</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p>
            <span>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></span>
            <span>Jeeson &copy; 2015 - 2018</span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://smuwjs.github.io/2016/12/14/java-source-analysis-set-series/Java 集合系列14之 Map总结/&title=《Java 集合系列14之 Map总结》 — Jeeson's Blog&pic=https://smuwjs.github.io/img/head.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://smuwjs.github.io/2016/12/14/java-source-analysis-set-series/Java 集合系列14之 Map总结/&title=《Java 集合系列14之 Map总结》 — Jeeson's Blog&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://smuwjs.github.io/2016/12/14/java-source-analysis-set-series/Java 集合系列14之 Map总结/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Java 集合系列14之 Map总结》 — Jeeson's Blog&url=https://smuwjs.github.io/2016/12/14/java-source-analysis-set-series/Java 集合系列14之 Map总结/&via=https://smuwjs.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://smuwjs.github.io/2016/12/14/java-source-analysis-set-series/Java 集合系列14之 Map总结/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://smuwjs.github.io/2016/12/14/java-source-analysis-set-series/Java 集合系列14之 Map总结/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };



</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
