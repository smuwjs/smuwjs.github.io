<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jeeson&#39;s Blog</title>
  <subtitle>Write the code. Change the world.</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://smuwjs.github.io/"/>
  <updated>2017-05-05T09:48:30.740Z</updated>
  <id>https://smuwjs.github.io/</id>
  
  <author>
    <name>Jeeson</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>mina学习笔记七：串口编程</title>
    <link href="https://smuwjs.github.io/2016/09/08/mina%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%83%EF%BC%9A%E4%B8%B2%E5%8F%A3%E7%BC%96%E7%A8%8B/"/>
    <id>https://smuwjs.github.io/2016/09/08/mina学习笔记七：串口编程/</id>
    <published>2016-09-08T20:12:19.000Z</published>
    <updated>2017-05-05T09:48:30.740Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://blog.csdn.net/yoara/article/details/37726817" target="_blank" rel="external">原文：http://blog.csdn.net/yoara/article/details/37726817</a></p>
<h1 id="1-基于java-comm的串口编程"><a href="#1-基于java-comm的串口编程" class="headerlink" title="1.基于java.comm的串口编程"></a>1.基于java.comm的串口编程</h1><p>以前做过一个针对串口扫描枪解析的项目，当时是用的java.comm包。回忆一下当时是怎么做的。</p>
<p>第一步：下载comm包，它包含有三个文件win32com.dll、comm.jar、javax.comm.properties</p>
<p>第二步：分别将他们拷到对应的文件夹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">xcopy "system\win32com.dll" "%JAVA_HOME%\jre6\bin\"  /E  </div><div class="line">xcopy "system\comm.jar" "%JAVA_HOME%\jre6\lib\"  /E  </div><div class="line">xcopy "system\javax.comm.properties" "%JAVA_HOME%\jre6\lib\"  /E</div></pre></td></tr></table></figure>
<p>第三步：编码，代码大致如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> CommPortIdentifier portId;  </div><div class="line"><span class="keyword">private</span> SerialPort serialPort;  </div><div class="line"><span class="keyword">private</span> InputStream is;  </div><div class="line"><span class="keyword">private</span> ReaderThread t;  </div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PortName = <span class="string">"COM1"</span>;  <span class="comment">//串口号  </span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DATABITS = <span class="number">8</span>;      <span class="comment">//数据位  </span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOPBITS = <span class="number">1</span>;      <span class="comment">//停止位  </span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RATE = <span class="number">9600</span>;           <span class="comment">//波特率  </span></div><div class="line"><span class="keyword">try</span>&#123;   </div><div class="line">    <span class="keyword">this</span>.portId = CommPortIdentifier.getPortIdentifier(getPortName());  </div><div class="line">    <span class="keyword">this</span>.serialPort = ((SerialPort)<span class="keyword">this</span>.portId.open(<span class="string">"Bar_Scan"</span>, <span class="number">20000</span>));  </div><div class="line">    <span class="keyword">this</span>.is = <span class="keyword">this</span>.serialPort.getInputStream();  </div><div class="line">    <span class="keyword">this</span>.serialPort.addEventListener(<span class="keyword">this</span>.t);  </div><div class="line">    <span class="keyword">this</span>.serialPort.notifyOnDataAvailable(<span class="keyword">true</span>);  </div><div class="line">    <span class="keyword">this</span>.serialPort.setSerialPortParams(getRATE(), getDATABITS(),   </div><div class="line">      getSTOPBITS(), <span class="number">0</span>);  </div><div class="line">  </div><div class="line">    <span class="keyword">this</span>.t.init(<span class="keyword">this</span>.serialPort, <span class="keyword">this</span>.is);  </div><div class="line">&#125;<span class="keyword">catch</span>()&#123;&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReaderThread</span> <span class="keyword">extends</span> <span class="title">Thread</span>  </span></div><div class="line">  <span class="keyword">implements</span> <span class="title">SerialPortEventListener</span>&#123;  </div><div class="line">  <span class="keyword">private</span> SerialPort serialPort;  </div><div class="line">  <span class="keyword">private</span> InputStream is;  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(SerialPort serialPort, InputStream is)</span> </span>&#123;  </div><div class="line">     <span class="keyword">this</span>.serialPort = serialPort;  </div><div class="line">     <span class="keyword">this</span>.is = is;   </div><div class="line">  &#125;  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serialEvent</span><span class="params">(SerialPortEvent event)</span> </span>&#123;  </div><div class="line">    <span class="keyword">switch</span> (event.getEventType()) &#123;  </div><div class="line">    <span class="keyword">case</span> SerialPortEvent.DATA_AVAILABLE:  </div><div class="line">      <span class="keyword">while</span> (<span class="keyword">true</span>) <span class="keyword">try</span> &#123;  </div><div class="line">        ...;  </div><div class="line">        <span class="keyword">int</span> b = <span class="keyword">this</span>.is.read();  </div><div class="line">        ...  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">catch</span> (IOException e)&#123;  </div><div class="line">            log4J.error(e);  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">  &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="2-为什么用mina封装串口通讯"><a href="#2-为什么用mina封装串口通讯" class="headerlink" title="2.为什么用mina封装串口通讯"></a>2.为什么用mina封装串口通讯</h1><p>可以看出，用sun自带的comm方式针对串口编程也很简单，同时comm包自带了非常丰富的参考例子。但是用mina封装的好处是能复用mina的连接模型，包括filter、listener、handler等等，把对底层的通讯和业务解耦，是系统结构清晰，权责分明。     不过估计mina也觉得用串口编程或通过mina框架串口编程的人士不会很多，所以在官方的标准发布包中并未包含serial部分，需要重新下载。     同时该serial包依赖于rxtx的串口并口包。由于sun的comm包很久都没有维护了，RXTX事实上是对comm再支持，他是开源的，基本思想和开发的模式跟comm几乎一样。编程时最明显的不同是要包含的包名由javax.comm.<em>改成了gnu.io.</em>。</p>
<h2 id="2-1-RXTX的配置方式"><a href="#2-1-RXTX的配置方式" class="headerlink" title="2.1 RXTX的配置方式"></a>2.1 RXTX的配置方式</h2><p>RXTX官网的下载链接失效了，可以使用<a href="http://mfizz.com/oss/rxtx-for-java" target="_blank" rel="external">这里的</a>。和comm一样，RXTX在使用前需要进行配置（Window下，linux请看包内install）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Copy RXTXcomm.jar ---&gt; &lt;JAVA_HOME&gt;\jre\lib\ext  </div><div class="line">Copy rxtxSerial.dll ---&gt; &lt;JAVA_HOME&gt;\jre\bin  </div><div class="line">Copy rxtxParallel.dll ---&gt; &lt;JAVA_HOME&gt;\jre\bin</div></pre></td></tr></table></figure>
<h2 id="2-2-mina中的集成使用方式"><a href="#2-2-mina中的集成使用方式" class="headerlink" title="2.2 mina中的集成使用方式"></a>2.2 mina中的集成使用方式</h2><p>串行通信只提供了一个IoConnector接口，因为串行通信是基于点对点的。要连接到一个串行通信端口上，需要创建一个SerialConnector。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//创建串口连接  </span></div><div class="line">SerialConnector connector = <span class="keyword">new</span> SerialConnector();  </div><div class="line"><span class="comment">//绑定处理handler  </span></div><div class="line">connector.setHandler(<span class="keyword">new</span> MyHandler());  </div><div class="line"><span class="comment">//设置过滤器  </span></div><div class="line">connector.getFilterChain().addLast(<span class="string">"logger"</span>,<span class="keyword">new</span> LoggingFilter());</div></pre></td></tr></table></figure>
<p>现在创建一个地址连接到一个串行端口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//配置串口连接  </span></div><div class="line">SerialAddress address = <span class="keyword">new</span> SerialAddress  </div><div class="line">    (<span class="string">"COM1"</span>, <span class="number">9600</span>, DataBits.DATABITS_8,StopBits.BITS_1 , Parity.NONE, FlowControl.NONE);</div></pre></td></tr></table></figure>
<p>第一个参数是串行端口标识符，对于Windows系统来说，串行端口被称作“COM1”、“COM2”等，对于Linux和Unix系统来说，则是”/dev/ttyS0”、”/dev/ttyS1”和”/dev/ttyUsb0”等。</p>
<p>剩余的参数取决于所使用的设备，在SerialAddress类中定义了相关的枚举量可参考：</p>
<ul>
<li><p><strong>波特率：</strong>这是一个衡量符号传输速率的参数。指的是信号被调制以后在单位时间内的变化，即单位时间内载波参数变化的次数，如每秒钟传送240个字符，而每个字符格式包含10位（1个起始位，1个停止位，8个数据位），这时的波特率为240Bd，比特率为10位*240个/秒=2400bps。一般调制速率大于波特率，比如曼彻斯特编码）。通常电话线的波特率为14400，28800和36600。波特率可以远远大于这些值，但是波特率和距离成反比。高波特率常常用于放置的很近的仪器间的通信，典型的例子就是GPIB设备的通信。</p>
</li>
<li><p><strong>数据位：</strong>这是衡量通信中实际数据位的参数。当计算机发送一个信息包，实际的数据不会是8位的，标准的值是6、7和8位。如何设置取决于你想传送的信息。比如，标准的ASCII码是0～127（7位）。扩展的ASCII码是0～255（8位）。如果数据使用简单的文本（标准 ASCII码），那么每个数据包使用7位数据。每个包是指一个字节，包括开始/停止位，数据位和奇偶校验位。由于实际数据位取决于通信协议的选取，术语“包”指任何通信的情况。</p>
</li>
<li><p><strong>停止位：</strong>用于表示单个包的最后一位。典型的值为1，1.5和2位。由于数据是在传输线上定时的，并且每一个设备有其自己的时钟，很可能在通信中两台设备间出现了小小的不同步。因此停止位不仅仅是表示传输的结束，并且提供计算机校正时钟同步的机会。适用于停止位的位数越多，不同时钟同步的容忍程度越大，但是数据传输率同时也越慢。</p>
</li>
<li><p><strong>奇偶校验位：</strong>在串口通信中一种简单的检错方式。有四种检错方式：偶、奇、高和低。当然没有校验位也是可以的。对于偶和奇校验的情况，串口会设置校验位（数据位后面的一位），用一个值确保传输的数据有偶个或者奇个逻辑高位。例如，如果数据是011，那么对于偶校验，校验位为0，保证逻辑高的位数是偶数个。如果是奇校验，校验位为1，这样就有3个逻辑高位。高位和低位不真正的检查数据，简单置位逻辑高或者逻辑低校验。这样使得接收设备能够知道一个位的状态，有机会判断是否有噪声干扰了通信或者是否传输和接收数据是否不同步。</p>
</li>
</ul>
<p>最后建立链接</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ConnectFuture future = connector.connect(address);  </div><div class="line">future.await();  </div><div class="line">IoSession session = future.getSession();  </div><div class="line">session.write(<span class="string">"good mina"</span>);</div></pre></td></tr></table></figure>
<h2 id="2-3-测试效果"><a href="#2-3-测试效果" class="headerlink" title="2.3 测试效果"></a>2.3 测试效果</h2><p>手头上没有串口工具，所以用VSPD虚拟了串口出来。测试可用正常。  </p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/32390574-file_1493967899939_b28b.jpg" alt=""></p>
<h1 id="3-mina-serial处理方式分析"><a href="#3-mina-serial处理方式分析" class="headerlink" title="3.mina serial处理方式分析"></a>3.mina serial处理方式分析</h1><p>连接代码被调用时SerialConnector.connect0方法被执行 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">SerialPort serialPort = initializePort(<span class="string">"Apache MINA"</span>, portId, portAddress);  </div><div class="line">  </div><div class="line">ConnectFuture future = <span class="keyword">new</span> DefaultConnectFuture();  </div><div class="line">SerialSessionImpl session = <span class="keyword">new</span> SerialSessionImpl(<span class="keyword">this</span>, getListeners(), portAddress, serialPort);  </div><div class="line">initSession(session, future, sessionInitializer);  </div><div class="line">session.start();  </div><div class="line"><span class="keyword">return</span> future;</div></pre></td></tr></table></figure>
<p>串口的session，不仅继承了AbstractIoSession ，同时他还实现了SerialSession, SerialPortEventListener。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SerialSessionImpl</span> <span class="keyword">extends</span> <span class="title">AbstractIoSession</span> <span class="keyword">implements</span> <span class="title">SerialSession</span>, <span class="title">SerialPortEventListener</span></span></div></pre></td></tr></table></figure>
<p>我们注意他的start方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TooManyListenersException </span>&#123;  </div><div class="line">    inputStream = port.getInputStream();  </div><div class="line">    outputStream = port.getOutputStream();  </div><div class="line">    ReadWorker w = <span class="keyword">new</span> ReadWorker();  </div><div class="line">    w.start();  </div><div class="line">    port.addEventListener(<span class="keyword">this</span>);  </div><div class="line">    ((SerialConnector) getService()).getIdleStatusChecker0().addSession(<span class="keyword">this</span>);  </div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">        getService().getFilterChainBuilder().buildFilterChain(getFilterChain());  </div><div class="line">        serviceListeners.fireSessionCreated(<span class="keyword">this</span>);  </div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;  </div><div class="line">        getFilterChain().fireExceptionCaught(e);  </div><div class="line">        processor.remove(<span class="keyword">this</span>);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中有个ReadWorker线程，他首先等待Object readReadyMonitor的资源，如果readReadyMonitor被notify，那线程就开始读数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;  </div><div class="line">    readReadyMonitor.wait();  </div><div class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </div><div class="line">    log.error(<span class="string">"InterruptedException"</span>, e);  </div><div class="line">&#125;  </div><div class="line"><span class="keyword">if</span> (isClosing() || !isConnected()) &#123;  </div><div class="line">    <span class="keyword">break</span>;  </div><div class="line">&#125;  </div><div class="line"><span class="keyword">int</span> dataSize;  </div><div class="line"><span class="keyword">try</span> &#123;  </div><div class="line">    dataSize = inputStream.available();  </div><div class="line">    <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[dataSize];  </div><div class="line">    <span class="keyword">int</span> readBytes = inputStream.read(data);  </div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (readBytes &gt; <span class="number">0</span>) &#123;  </div><div class="line">        IoBuffer buf = IoBuffer.wrap(data, <span class="number">0</span>, readBytes);  </div><div class="line">        buf.put(data, <span class="number">0</span>, readBytes);  </div><div class="line">        buf.flip();  </div><div class="line">        getFilterChain().fireMessageReceived(buf);  </div><div class="line">    &#125;  </div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;  </div><div class="line">    getFilterChain().fireExceptionCaught(e);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而readReadyMonitor被notify的事件就发生在串口有数据读入，因SerialSessionImpl实现了SerialPortEventListener，所以他就可以监听事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serialEvent</span><span class="params">(SerialPortEvent evt)</span> </span>&#123;  </div><div class="line">    <span class="keyword">if</span> (evt.getEventType() == SerialPortEvent.DATA_AVAILABLE) &#123;  </div><div class="line">        <span class="keyword">synchronized</span> (readReadyMonitor) &#123;  </div><div class="line">            readReadyMonitor.notifyAll();  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>补充了一下mina对串口的支持，框架确实是个剥离业务与底层的好东西。</p>
<p>版权声明：本文为博主原创文章，未经博主允许不得转载。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;http://blog.csdn.net/yoara/article/details/37726817&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;原文：http://blog.csdn.net/yoara/article/detail
    
    </summary>
    
      <category term="mina" scheme="https://smuwjs.github.io/categories/mina/"/>
    
    
      <category term="java mina" scheme="https://smuwjs.github.io/tags/java-mina/"/>
    
  </entry>
  
  <entry>
    <title>mina学习笔记六：补刀</title>
    <link href="https://smuwjs.github.io/2016/09/08/mina%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%85%AD%EF%BC%9A%E8%A1%A5%E5%88%80/"/>
    <id>https://smuwjs.github.io/2016/09/08/mina学习笔记六：补刀/</id>
    <published>2016-09-08T20:12:18.000Z</published>
    <updated>2017-05-05T09:48:30.740Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://blog.csdn.net/yoara/article/details/37612703" target="_blank" rel="external">原文：http://blog.csdn.net/yoara/article/details/37612703</a></p>
<p>补充一些可能没讲到的细节。</p>
<h1 id="1-WriteRequest"><a href="#1-WriteRequest" class="headerlink" title="1.WriteRequest"></a>1.WriteRequest</h1><p>每一个session.write()操作都会被封装成writeRequest并被添加到WriteRequestQueue队列中。过滤器的每一次责任链流转都是以writeRequest为传参的。我们的老祖父AbstractIoService在实例化时，自带了一个非常重要的属性字段。是不得不注意的参数哟，虽然他对我们基本上是透明的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> IoSessionDataStructureFactory sessionDataStructureFactory = <span class="keyword">new</span> DefaultIoSessionDataStructureFactory();</div></pre></td></tr></table></figure>
<p>这个参数就包括了两个鸟不得的结构体，一个就是attribute的map，另一个就是我们可爱的WriteRequestQueue了。</p>
<h1 id="2-IoBuffer"><a href="#2-IoBuffer" class="headerlink" title="2.IoBuffer"></a>2.IoBuffer</h1><p>IoBuffer是mina框架对Nio中Buffer的再封装，Buffer应已经是很好用了，mina为什么还要继续封装呢？他给出的原因有2：</p>
<ul>
<li>Buffer没有提供实用的工具型getter和setter方法，比如fill, get/putString, and get/putAsciiInt() 。</li>
<li>原生的Buffer是固定长度的，非常不利于用于操作可变长度的数据。</li>
</ul>
<p>说实话，这两个原因看上去都不怎么靠谱，要我说，真正的原因就是，框架没有点自己的封装就不是高大上了嘛~哈哈。</p>
<p>mina自身也有点后悔这样的选择，据说在mina3中将采取不同的策略。下面是官方的原话：</p>
<blockquote>
<pre><code>This will change in MINA 3\. The main reason why MINA has its own wrapper on top of nio ByteBuffer is to have extensible buffers.This was a very bad decision.Buffers are just buffers : a temporary place to store temporary data, before it is used. Many other solutions exist, like defining a wrapper which relies on a list of NIO ByteBuffers, instead of copying the existing buffer to a bigger one just because we want to extend the buffer capacity. It might also be more comfortable to use an InputStream instead of a byte buffer all along the filters, as it does not imply anything about the nature of the stored data : it can be a byte array, strings, messages... Last, not least, the current implementation defeat one of the target : zero-copy strategy (ie, once we have read the data from the socket, we want to avoid a copy being done later). As we use extensible byte buffers, we will most certainly copy those data if we have to manage big messages. Assuming that the MINA ByteBuffer is just a wrapper on top of NIO ByteBuffer, this can be a real problem when using direct buffers.
</code></pre></blockquote>
<h1 id="3-用到的设计模式"><a href="#3-用到的设计模式" class="headerlink" title="3.用到的设计模式"></a>3.用到的设计模式</h1><h2 id="3-1抽象工厂ProtocolCodecFactory"><a href="#3-1抽象工厂ProtocolCodecFactory" class="headerlink" title="3.1抽象工厂ProtocolCodecFactory"></a>3.1抽象工厂ProtocolCodecFactory</h2><p>机智的过滤器ProtocolCodecFilter需要机智的解编码器。以TextLineCodecFactory为例： </p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/96615731-file_1493967211098_8576.jpg" alt=""></p>
<h2 id="3-2-建造者模式"><a href="#3-2-建造者模式" class="headerlink" title="3.2 建造者模式"></a>3.2 建造者模式</h2><p>这里的导演类就是我们添加filter的设置代码，而产生出的产品则是顺序不同的filter链。 </p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/13183021-file_1493967252599_17ab6.jpg" alt=""></p>
<h2 id="3-3-适配器模式"><a href="#3-3-适配器模式" class="headerlink" title="3.3 适配器模式"></a>3.3 适配器模式</h2><pre><code>![](http://opesdt6ii.bkt.clouddn.com/17-5-5/66833683-file_1493967343756_e360.jpg)
</code></pre><h2 id="3-4-装饰者模式"><a href="#3-4-装饰者模式" class="headerlink" title="3.4 装饰者模式"></a>3.4 装饰者模式</h2><p>writeRequest这一家子就是很好的例子。</p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/58251518-file_1493967389693_127e8.jpg" alt=""></p>
<h2 id="3-5-外观模式"><a href="#3-5-外观模式" class="headerlink" title="3.5 外观模式"></a>3.5 外观模式</h2><p>我们劳苦功高的IoServiceListenerSupport，为filter和listener提供了一致性的操作接口 </p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/1227133-file_1493967428109_d710.jpg" alt=""></p>
<h2 id="3-6-桥接模式"><a href="#3-6-桥接模式" class="headerlink" title="3.6 桥接模式"></a>3.6 桥接模式</h2><p>这就太多了，但凡存在属性字段是接口的，几乎都是桥接模式。只画个类图示意： </p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/96996656-file_1493967457215_11800.jpg" alt=""></p>
<h2 id="3-7-组合模式"><a href="#3-7-组合模式" class="headerlink" title="3.7 组合模式"></a>3.7 组合模式</h2><p>过滤器链里面的用到的模式之一。 </p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/44112552-file_1493967480186_154c.jpg" alt=""></p>
<h2 id="3-8-享元模式"><a href="#3-8-享元模式" class="headerlink" title="3.8 享元模式"></a>3.8 享元模式</h2><p>每个在数组pool里的IoProcessor都是一个享元。</p>
<h2 id="3-9-模板方法"><a href="#3-9-模板方法" class="headerlink" title="3.9 模板方法"></a>3.9 模板方法</h2><p>大量的实现都用到了模板方法，这个模式是子类延迟实现的典范。 </p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/55458890-file_1493967502366_8754.jpg" alt=""></p>
<h2 id="3-10-观察者模式"><a href="#3-10-观察者模式" class="headerlink" title="3.10 观察者模式"></a>3.10 观察者模式</h2><p>在背后默默支持我们的IoServiceListenerSupport，就担负着通知观察者的重任。 </p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/12974433-file_1493967526941_cfe7.jpg" alt=""></p>
<h2 id="3-11-策略模式"><a href="#3-11-策略模式" class="headerlink" title="3.11 策略模式"></a>3.11 策略模式</h2><p>每一种filter的具体实现都是一种策略</p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/54278099-file_1493967569443_f597.jpg" alt=""></p>
<h2 id="3-12-责任链模式"><a href="#3-12-责任链模式" class="headerlink" title="3.12 责任链模式"></a>3.12 责任链模式</h2><p>在过滤器链中，每个节点都持有对下一个节点的引用。其中节点并非filter实例，而是封装了filter、上一个filter、下一个filter、下一个filter操作对象的Entry对象。 </p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/76149157-file_1493967589076_4720.jpg" alt=""></p>
<h2 id="3-13-命令模式"><a href="#3-13-命令模式" class="headerlink" title="3.13 命令模式"></a>3.13 命令模式</h2><p>比如session.wirte，发送的消息将被封装到WriteRequest中，最终经过一系列的过滤器被提交到WriteRequestQueue中等待发送。IoProcessor通过轮询将消息队列flush出去。在这里，消息的请求者是session、消息发送实现者是Processor，而消息及消息处理的future被封装到WriteRequest这个对象中。     一般命令模式的主体会持有执行者的引用，命令模式通过调用执行者的方法执行命令，这里是放到一个队列里被轮询执行，所以不能算是完整的命令模式。但命令模式关注的是“行为请求者”和“行为执行者”的解耦，并封装调用请求的变化，这里是符合这个思想的。 </p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/25316091-file_1493967611506_333b.jpg" alt=""></p>
<h1 id="4-为什么NioDatagramAcceptor不使用SimpleIoProcessorPool"><a href="#4-为什么NioDatagramAcceptor不使用SimpleIoProcessorPool" class="headerlink" title="4.为什么NioDatagramAcceptor不使用SimpleIoProcessorPool"></a>4.为什么NioDatagramAcceptor不使用SimpleIoProcessorPool</h1><p>我们知道在前面讲到NioSocketAcceptor在初始化时会生成SimpleIoProcessorPool的IoProcessor的池，池中每个processor都会处理一组session。而NioDatagramAcceptor没有使用池化的IoProcessor，而是选择实现了IoProcessor，即他本身就是一个IoProcessor，在他自身的executer中只有一个Acceptor勤劳的为他做着接受新数据的</p>
<p>但是为什么呢？</p>
<p>我们知道，UDP是无连接的协议，select()应答器响应有通道的数据到来时，通过receive()方法获取buffer内容。NioDatagramAcceptor只开启了单个DatagramChannel用于数据传输，因为他不需要像NioSocketAcceptor那样维持一个通讯会话session。     对于远程地址相同的请求，NioDatagramAcceptor使用可重用的ExpiringSessionRecycler对象sessionRecycler来复用session。而NioSocketAcceptor会为把每个session分配到指定的IoProcessor池中的一个去处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">AbstractPollingConnectionlessIoAcceptor.newSessionWithoutLock( SocketAddress remoteAddress, SocketAddress localAddress ) <span class="keyword">throws</span> Exception  </div><div class="line">    &#123;  </div><div class="line">        H handle = boundHandles.get( localAddress );  </div><div class="line">  </div><div class="line">        <span class="keyword">if</span> ( handle == <span class="keyword">null</span> )  </div><div class="line">        &#123;  </div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException( <span class="string">"Unknown local address: "</span> + localAddress );  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        IoSession session;  </div><div class="line">  </div><div class="line">        <span class="keyword">synchronized</span> ( sessionRecycler )  </div><div class="line">        &#123;  </div><div class="line">            session = sessionRecycler.recycle( remoteAddress );  </div><div class="line">  </div><div class="line">            <span class="keyword">if</span> ( session != <span class="keyword">null</span> )  </div><div class="line">            &#123;  </div><div class="line">                <span class="keyword">return</span> session;  </div><div class="line">            &#125;  </div><div class="line">  </div><div class="line">            <span class="comment">// If a new session needs to be created.  </span></div><div class="line">            S newSession = newSession( <span class="keyword">this</span>, handle, remoteAddress );  </div><div class="line">            getSessionRecycler().put( newSession );  </div><div class="line">            session = newSession;  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        initSession( session, <span class="keyword">null</span>, <span class="keyword">null</span> );  </div><div class="line">  </div><div class="line">        <span class="keyword">try</span>  </div><div class="line">        &#123;  </div><div class="line">            <span class="keyword">this</span>.getFilterChainBuilder().buildFilterChain( session.getFilterChain() );  </div><div class="line">            getListeners().fireSessionCreated( session );  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">catch</span> ( Throwable t )  </div><div class="line">        &#123;  </div><div class="line">            ExceptionMonitor.getInstance().exceptionCaught( t );  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="keyword">return</span> session;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>究其原因，应该是NioDatagramAcceptor对于会话的维护不需要付出NioSocketAcceptor那么大的代价。NioDatagramAcceptor只用了一个Selector去监听会话请求，而NioSocketAcceptor用了1个监听连接、CPU+1个去监听不同的session，可见一斑。</p>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>客户端的IoConnector部分就不分析了。相信通过这几节的了解，框架结构都非常清楚了。应该没有别的落下= =不过其中有很多对网络的实现方面的细节还不是很清楚，看来要了解网络传输底层的东西才行。</p>
<p>版权声明：本文为博主原创文章，未经博主允许不得转载。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;http://blog.csdn.net/yoara/article/details/37612703&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;原文：http://blog.csdn.net/yoara/article/detail
    
    </summary>
    
      <category term="mina" scheme="https://smuwjs.github.io/categories/mina/"/>
    
    
      <category term="java mina" scheme="https://smuwjs.github.io/tags/java-mina/"/>
    
  </entry>
  
  <entry>
    <title>mina学习笔记五：做嫁衣的IoFilter和IoListener</title>
    <link href="https://smuwjs.github.io/2016/09/08/mina%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%BA%94%EF%BC%9A%E5%81%9A%E5%AB%81%E8%A1%A3%E7%9A%84IoFilter%E5%92%8CIoListener/"/>
    <id>https://smuwjs.github.io/2016/09/08/mina学习笔记五：做嫁衣的IoFilter和IoListener/</id>
    <published>2016-09-08T20:12:17.000Z</published>
    <updated>2017-05-05T09:48:30.740Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://blog.csdn.net/yoara/article/details/37597141" target="_blank" rel="external">原文：http://blog.csdn.net/yoara/article/details/37597141</a>    </p>
<p>总有那么一群人，他们默默无闻的工作在自己的岗位上，你永远都接触不到他们，可是离了他们完整的做好一件事。譬如只注意在荧光屏上的明星，却不知道谁给他们打得灯光、谁给他们踩得位、谁给他们化妆端茶送水等等。IoFilter也是这群人中的一员，每个session的请求和事件离不了他们，IoFilter在IoService和IoHandler之间提供了各个层面的切面支持，让其他两个组件安心做自己的事而不用关注其他细节。软件工程的魅力也在于此——解耦。</p>
<h1 id="1-IoFilter的一家子"><a href="#1-IoFilter的一家子" class="headerlink" title="1.IoFilter的一家子"></a>1.IoFilter的一家子</h1><p>IoFilter家族的类图结构非常简单明快，mina非常贴心的为广大使用者提供了丰富的Filter实现子类，很多标准服务我们都不需要自己实现。 </p>
<p>图5.1 IoFilter类图     我们先简单介绍一下这个家族成员和他们各自的作用吧：<br>| Filter                       | class                                    | Description                              |<br>| —————————- | —————————————- | —————————————- |<br>| Blacklist                    | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/firewall/BlacklistFilter.html" target="_blank" rel="external">BlacklistFilter</a> | 黑名单过滤器                                   |<br>| BufferedWrite                | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/buffer/BufferedWriteFilter.html" target="_blank" rel="external">BufferedWriteFilter</a> | 发送缓存过滤器，缓存发送的消息，避免短小消息频繁发送               |<br>| Compression                  | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/compression/CompressionFilter.html" target="_blank" rel="external">CompressionFilter</a> | 数据压缩过滤器                                  |<br>| ConnectionThrottle           | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/firewall/ConnectionThrottleFilter.html" target="_blank" rel="external">ConnectionThrottleFilter</a> | 连接控制过滤器，对同一IP地址频繁的创建连接的时间间隔进行控制          |<br>| ErrorGenerating              | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/errorgenerating/ErrorGeneratingFilter.html" target="_blank" rel="external">ErrorGeneratingFilter</a> | 花数据过滤器，增加、修改、移除接受的数据包内容，可作为加密的方式         |<br>| Executor                     | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/executor/ExecutorFilter.html" target="_blank" rel="external">ExecutorFilter</a> | 处理线程池过滤器，让每个请求或者事件都通过线程池去执行              |<br>| FileRegionWrite              | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/stream/FileRegionWriteFilter.html" target="_blank" rel="external">FileRegionWriteFilter</a> | 文件转换过滤器，通常应该由IoProcess做这件事，但若需要压缩或者修改时，可通过过滤器链之间的配合来实现 |<br>| KeepAlive                    | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/keepalive/KeepAliveFilter.html" target="_blank" rel="external">KeepAliveFilter</a> | 心跳包过滤器，在idle状态时发送心跳包，并能对超时进行处理           |<br>| Logging                      | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/logging/LoggingFilter.html" target="_blank" rel="external">LoggingFilter</a> | 日志记录过滤器，最常用之一                            |<br>| MDC Injection                | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/logging/MdcInjectionFilter.html" target="_blank" rel="external">MdcInjectionFilter</a> | 日志信息注入过滤器，MDC(Mapped Diagnostic Context有译作线程映射表)是日志框架维护的一组信息键值对，可向日志输出信息中插入一些想要显示的内容。 |<br>| Noop                         | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/util/NoopFilter.html" target="_blank" rel="external">NoopFilter</a> | 用作内部测试的filter，什么也没做                      |<br>| Profiler                     | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/statistic/ProfilerTimerFilter.html" target="_blank" rel="external">ProfilerTimerFilter</a> | 时间分析过滤器，记录各种事件消耗的时间                      |<br>| ProtocolCodec                | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/codec/ProtocolCodecFilter.html" target="_blank" rel="external">ProtocolCodecFilter</a> | 编解码过滤器，最常用之二                             |<br>| Proxy                        | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/proxy/filter/ProxyFilter.html" target="_blank" rel="external">ProxyFilter</a> | 是IoConnector在连接握手时自动加入的过滤器，握手成功后就透明了     |<br>| Reference counting           | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/util/ReferenceCountingFilter.html" target="_blank" rel="external">ReferenceCountingFilter</a> | 引用数过滤器，能记录该过滤器被加入或移除过滤器链的次数，真实使用是继承他。    |<br>| RequestResponse              | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/reqres/RequestResponseFilter.html" target="_blank" rel="external">RequestResponseFilter</a> | 继承WriteRequest                           |<br>| SessionAttributeInitializing | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/util/SessionAttributeInitializingFilter.html" target="_blank" rel="external">SessionAttributeInitializingFilter</a> | 初始化过滤器                                   |<br>| StreamWrite                  | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/stream/StreamWriteFilter.html" target="_blank" rel="external">StreamWriteFilter</a> | InputStream直接转换成IoBuffer的过滤器             |<br>| SslFilter                    | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/ssl/SslFilter.html" target="_blank" rel="external">SslFilter</a> | TCP/IP层面的SSl加解密过滤器                       |<br>| WriteRequest                 | <a href="http://mina.apache.org/mina-project/xref/org/apache/mina/filter/util/WriteRequestFilter.html" target="_blank" rel="external">WriteRequestFilter</a> | 简化IoFilter IoEventType.WRITE事件的实现的抽象过滤器  |</p>
<p>还有两个FIlter是mina自带并且不为用户管理的，当生成过滤器链自动注入：</p>
<ul>
<li>HeadFilter（当发生write操作时，将写buffer加入到session.scheduledWriteMessages队列，并执行发送调用IoProcessor执行write()操作），位于过滤器链头。</li>
<li>TailFilter（当所有过滤器都处理完后，他将调用IoHandler的对应方法）。位于过滤器链尾。</li>
</ul>
<h1 id="2-IoFilter执行顺序"><a href="#2-IoFilter执行顺序" class="headerlink" title="2.IoFilter执行顺序"></a>2.IoFilter执行顺序</h1><p>搞清楚了 </p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/15329899-file_1493966521689_24fe.png" alt="图5.2 过滤器调用顺序图"></p>
<p>在事件端，我们以messageSent事件被执行的代码来详解下过程；在操作端我们的例子是session.write。</p>
<h2 id="2-1-messageSent顺序调用过滤器链"><a href="#2-1-messageSent顺序调用过滤器链" class="headerlink" title="2.1 messageSent顺序调用过滤器链"></a>2.1 messageSent顺序调用过滤器链</h2><pre><code>当IoProcessor的remove(session)方法被调用时，该session将被添加进Processor内部的removingSessions的ConcurrentLinkedQueue等待被移除。
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(S session)</span> </span>&#123;  </div><div class="line">    scheduleRemove(session);  </div><div class="line">    startupProcessor();  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleRemove</span><span class="params">(S session)</span> </span>&#123;  </div><div class="line">    removingSessions.add(session);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当IoProcessor工作线程执行一个循环，调用removeSessions()方法，状态为SessionState.OPENED的session将被移除，移除的代码中就包括刷新消息队列，其中代码如下，从而引发一次过滤器链的调用。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (message <span class="keyword">instanceof</span> IoBuffer) &#123;  </div><div class="line">    IoBuffer buf = (IoBuffer) message;  </div><div class="line">    <span class="keyword">if</span> (buf.hasRemaining()) &#123;  </div><div class="line">        buf.reset();  </div><div class="line">        failedRequests.add(req);  </div><div class="line">    &#125; <span class="keyword">else</span> &#123;  </div><div class="line">        IoFilterChain filterChain = session.getFilterChain();  </div><div class="line">        filterChain.fireMessageSent(req);  </div><div class="line">    &#125;  </div><div class="line">&#125; <span class="keyword">else</span> &#123;  </div><div class="line">    failedRequests.add(req);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终调用的是TailFilter，他的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TailFilter</span> <span class="keyword">extends</span> <span class="title">IoFilterAdapter</span> </span>&#123;  </div><div class="line">  </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionCreated</span><span class="params">(NextFilter nextFilter, IoSession session)</span> <span class="keyword">throws</span> Exception </span>&#123;  </div><div class="line">            session.getHandler().sessionCreated(session);  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionOpened</span><span class="params">(NextFilter nextFilter, IoSession session)</span> <span class="keyword">throws</span> Exception </span>&#123;  </div><div class="line">            session.getHandler().sessionOpened(session);  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionClosed</span><span class="params">(NextFilter nextFilter, IoSession session)</span> <span class="keyword">throws</span> Exception </span>&#123;  </div><div class="line">            AbstractIoSession s = (AbstractIoSession) session;  </div><div class="line">            <span class="keyword">try</span> &#123;  </div><div class="line">                s.getHandler().sessionClosed(session);  </div><div class="line">            &#125; <span class="keyword">finally</span> &#123;  </div><div class="line">                <span class="keyword">try</span> &#123;  </div><div class="line">                    s.getWriteRequestQueue().dispose(session);  </div><div class="line">                &#125; <span class="keyword">finally</span> &#123;  </div><div class="line">                    <span class="keyword">try</span> &#123;  </div><div class="line">                        s.getAttributeMap().dispose(session);  </div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;  </div><div class="line">                        <span class="keyword">try</span> &#123;  </div><div class="line">                            <span class="comment">// Remove all filters.  </span></div><div class="line">                            session.getFilterChain().clear();  </div><div class="line">                        &#125; <span class="keyword">finally</span> &#123;  </div><div class="line">                            <span class="keyword">if</span> (s.getConfig().isUseReadOperation()) &#123;  </div><div class="line">                                s.offerClosedReadFuture();  </div><div class="line">                            &#125;  </div><div class="line">                        &#125;  </div><div class="line">                    &#125;  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionIdle</span><span class="params">(NextFilter nextFilter, IoSession session, IdleStatus status)</span> <span class="keyword">throws</span> Exception </span>&#123;  </div><div class="line">            session.getHandler().sessionIdle(session, status);  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(NextFilter nextFilter, IoSession session, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;  </div><div class="line">            AbstractIoSession s = (AbstractIoSession) session;  </div><div class="line">            <span class="keyword">try</span> &#123;  </div><div class="line">                s.getHandler().exceptionCaught(s, cause);  </div><div class="line">            &#125; <span class="keyword">finally</span> &#123;  </div><div class="line">                <span class="keyword">if</span> (s.getConfig().isUseReadOperation()) &#123;  </div><div class="line">                    s.offerFailedReadFuture(cause);  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">messageReceived</span><span class="params">(NextFilter nextFilter, IoSession session, Object message)</span> <span class="keyword">throws</span> Exception </span>&#123;  </div><div class="line">            session.getHandler().messageReceived(s, message);  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">messageSent</span><span class="params">(NextFilter nextFilter, IoSession session, WriteRequest writeRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;  </div><div class="line">            session.getHandler().messageSent(session, writeRequest.getMessage());  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">filterWrite</span><span class="params">(NextFilter nextFilter, IoSession session, WriteRequest writeRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;  </div><div class="line">            nextFilter.filterWrite(session, writeRequest);  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">filterClose</span><span class="params">(NextFilter nextFilter, IoSession session)</span> <span class="keyword">throws</span> Exception </span>&#123;  </div><div class="line">            nextFilter.filterClose(session);  </div><div class="line">        &#125;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="2-2-session-write逆序调用过滤器链"><a href="#2-2-session-write逆序调用过滤器链" class="headerlink" title="2.2 session.write逆序调用过滤器链"></a>2.2 session.write逆序调用过滤器链</h2><p>在Handler中持有session的对象，调用session.write(date.toString());，session会调用具体方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">AbstractIoSession.write(Object message) &#123;  </div><div class="line">    ...  </div><div class="line">        IoFilterChain filterChain = getFilterChain();  </div><div class="line">        filterChain.fireFilterWrite(writeRequest);  </div><div class="line">    ...  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">DefaultIoFilterChain.fireFilterWrite(WriteRequest writeRequest) &#123;  </div><div class="line">        Entry tail = <span class="keyword">this</span>.tail;  </div><div class="line">        callPreviousFilterWrite(tail, session, writeRequest);  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>触发逆序的过滤器链，最终到HeadFilter中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">...其他Filter  </div><div class="line">HeadFilter.filterWrite(NextFilter nextFilter, IoSession session, WriteRequest writeRequest) <span class="keyword">throws</span> Exception &#123;  </div><div class="line">        AbstractIoSession s = (AbstractIoSession) session;  </div><div class="line">        ...  </div><div class="line">            WriteRequestQueue writeRequestQueue = s.getWriteRequestQueue();  </div><div class="line">  </div><div class="line">            <span class="keyword">if</span> (!s.isWriteSuspended()) &#123;  </div><div class="line">                <span class="keyword">if</span> (writeRequestQueue.size() == <span class="number">0</span>) &#123;  </div><div class="line">                    <span class="comment">// We can write directly the message  </span></div><div class="line">                    s.getProcessor().write(s, writeRequest);  </div><div class="line">                &#125; <span class="keyword">else</span> &#123;  </div><div class="line">                    s.getWriteRequestQueue().offer(s, writeRequest);  </div><div class="line">                    s.getProcessor().flush(s);  </div><div class="line">                &#125;  </div><div class="line">            &#125; <span class="keyword">else</span> &#123;  </div><div class="line">                s.getWriteRequestQueue().offer(s, writeRequest);  </div><div class="line">            &#125;  </div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<h1 id="3-IoHandler-API"><a href="#3-IoHandler-API" class="headerlink" title="3.IoHandler API"></a>3.IoHandler API</h1><pre><code>Handler虽然是直面用户的对象，但由上述可知，他其实只是整个操作链上最后的一环，也是最简单的一环，给出IoHander的API清单
</code></pre><ul>
<li>sessionCreated(IoSession)：session创建时调用</li>
<li>sessionOpened(IoSession)：session打开时调用，实际上是在sessionCreated后立即执行</li>
<li>sessionClosed(IoSession)：session关闭时调用</li>
<li>sessionIdle(IoSession, IdleStatus)：session空闲时调用</li>
<li>exceptionCaught(IoSession, Throwable)：异常时调用</li>
<li>messageReceived(IoSession, Object)：接收到新的request时调用</li>
<li>messageSent(IoSession, Object)：发送在消息队列中未完成的消息时调用</li>
</ul>
<h1 id="4-IoFilter-API"><a href="#4-IoFilter-API" class="headerlink" title="4. IoFilter API"></a>4. IoFilter API</h1><p>和Handler有一部分一致：</p>
<ul>
<li>init() filter初始化方法，在下面4个on方法调用之前必须先被调用。</li>
<li>destroy() 该方法被ReferenceCountingFilter引用到，如果不继承ReferenceCountingFilter，不需实现该方法。</li>
<li>onPreAdd(IoFilterChain, String, NextFilter) 过滤器被添加之前调用。</li>
<li>onPostAdd(IoFilterChain, String, NextFilter) 过滤器被添加之后调用。</li>
<li>onPreRemove(IoFilterChain, String, NextFilter) 过滤器被移除之前调用。</li>
<li>onPostRemove(IoFilterChain, String, NextFilter) 过滤器被移除之后调用。</li>
<li>sessionCreated(NextFilter, IoSession) </li>
<li>sessionOpened(NextFilter, IoSession)</li>
<li>sessionClosed(NextFilter, IoSession)</li>
<li>sessionIdle(NextFilter, IoSession, IdleStatus)</li>
<li>exceptionCaught(NextFilter, IoSession, Throwable)</li>
<li>messageReceived(NextFilter, IoSession, Object)</li>
<li>messageSent(NextFilter, IoSession, WriteRequest)</li>
<li>filterClose(NextFilter, IoSession)  session.close(）方法中调用。</li>
<li>filterWrite(NextFilter, IoSession, WriteRequest) session.write(）方法中调用。</li>
</ul>
<h1 id="5-IoListener"><a href="#5-IoListener" class="headerlink" title="5. IoListener"></a>5. IoListener</h1><p>上面用了比较多的篇幅介绍了IoFilter，现在我们也该讲讲二号后台人物——IoListerner。在mina中主要有两类，一个是IoServiceListener，另一个就是IoFutureListener。</p>
<h2 id="5-1-IoServiceListener"><a href="#5-1-IoServiceListener" class="headerlink" title="5.1 IoServiceListener"></a>5.1 IoServiceListener</h2><pre><code>IoServiceListener负责Service的各个生命周期节点事件通知。我们曾在学习笔记三中提到过IoServiceListenerSupport，此类对象是该service所有IoServiceListener对象的持有类并管理着监听器的回调入口，同时还管理着当前Service的所有session。当时没有详细的介绍，现在我们重点说说这个类在做嫁衣方面的独到之处。     IoServiceListenerSupport是在AbstractIoService的构造函数中被生成的，也就是说，恭喜，无论你是Acceptor还是Connector，你都拥有这个强大的助手了。为了支持监听器的功能，可爱的祖父AbstractIoService还贴心的为我们实现好了addListener(IoServiceListener listener)和removeListener(IoServiceListener listener)方法。     我们先看看的API吧：
</code></pre><ul>
<li><p>serviceActivated(IoService) 当service生效时被调用。当新的service被bind时或第一个session生成时，IoServiceListenerSupport.fireServiceActivated被调用同时调用此方法。</p>
</li>
<li><p>serviceIdle(IoService, IdleStatus) 当service空闲时被调用，不过此方法没有在mina中真正使用。</p>
</li>
<li><p>serviceDeactivated(IoService) 当service失效时被调用。当service被unbind或最后个session注销时，IoServiceListenerSupport.fireServiceDeactivated被调用同时调用此方法。</p>
</li>
<li><p>sessionCreated(IoSession) 当新的session生成时被调用。IoServiceListenerSupport.fireSessionCreated</p>
</li>
<li>sessionDestroyed(IoSession) 当session被注销时调用。IoServiceListenerSupport.fireSessionDestroyed</li>
</ul>
<p>如此一看，还是很简单清晰的，监听器可以在任意时刻被添加或移除。我们的使用方法也很简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">IoServiceListener listener = <span class="keyword">new</span> IoServiceListener() &#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionDestroyed</span><span class="params">(IoSession session)</span> <span class="keyword">throws</span> Exception </span>&#123;  </div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionCreated</span><span class="params">(IoSession session)</span> <span class="keyword">throws</span> Exception </span>&#123;  </div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceIdle</span><span class="params">(IoService service, IdleStatus idleStatus)</span>  </span></div><div class="line">            <span class="keyword">throws</span> Exception &#123;  </div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceDeactivated</span><span class="params">(IoService service)</span> <span class="keyword">throws</span> Exception </span>&#123;  </div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceActivated</span><span class="params">(IoService service)</span> <span class="keyword">throws</span> Exception </span>&#123;  </div><div class="line">    &#125;  </div><div class="line">&#125;;  </div><div class="line">acceptor.addListener(listener);  </div><div class="line">acceptor.removeListener(listener);</div></pre></td></tr></table></figure>
<h2 id="5-1-IoFutureListener"><a href="#5-1-IoFutureListener" class="headerlink" title="5.1 IoFutureListener"></a>5.1 IoFutureListener</h2><p>还有一种Listener就是IoFutureListener，他在学习笔记四种也出现过，确实也比较简单，能在IoFuture任务完成后被调用，唯一的API：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IoFutureListener</span>&lt;<span class="title">F</span> <span class="keyword">extends</span> <span class="title">IoFuture</span>&gt; <span class="keyword">extends</span> <span class="title">EventListener</span> </span>&#123;    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(F future)</span></span>;    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为大部分的future都被mina集成在框架里，所以future的listener支持一项特性：若任务已经执行完后添加的listener将被立刻执行。我们先看看future是怎么实现该功能的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> IoFuture <span class="title">addListener</span><span class="params">(IoFutureListener&lt;?&gt; listener)</span> </span>&#123;  </div><div class="line">    <span class="keyword">if</span> (listener == <span class="keyword">null</span>) &#123;  </div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"listener"</span>);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="keyword">boolean</span> notifyNow = <span class="keyword">false</span>;  </div><div class="line">    <span class="keyword">synchronized</span> (lock) &#123;  </div><div class="line">        <span class="keyword">if</span> (ready) &#123;  </div><div class="line">            notifyNow = <span class="keyword">true</span>;  </div><div class="line">        &#125; <span class="keyword">else</span> &#123;  </div><div class="line">            <span class="keyword">if</span> (firstListener == <span class="keyword">null</span>) &#123;  </div><div class="line">                firstListener = listener;  </div><div class="line">            &#125; <span class="keyword">else</span> &#123;  </div><div class="line">                <span class="keyword">if</span> (otherListeners == <span class="keyword">null</span>) &#123;  </div><div class="line">                    otherListeners = <span class="keyword">new</span> ArrayList&lt;IoFutureListener&lt;?&gt;&gt;(<span class="number">1</span>);  </div><div class="line">                &#125;  </div><div class="line">                otherListeners.add(listener);  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">是这里了！如果ready完成了，则马上执行  </div><div class="line">    <span class="keyword">if</span> (notifyNow) &#123;  </div><div class="line">        notifyListener(listener);  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>那不用说就知道啦，在notiffyListener中将会回调监听器的方法。</p>
<h1 id="6-结语"><a href="#6-结语" class="headerlink" title="6. 结语"></a>6. 结语</h1><p>mina框架核心部件基本上都讲的差不多了，看看如果有需要补余的，留在下一章节。</p>
<p>版权声明：本文为博主原创文章，未经博主允许不得转载。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;http://blog.csdn.net/yoara/article/details/37597141&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;原文：http://blog.csdn.net/yoara/article/detail
    
    </summary>
    
      <category term="mina" scheme="https://smuwjs.github.io/categories/mina/"/>
    
    
      <category term="java mina" scheme="https://smuwjs.github.io/tags/java-mina/"/>
    
  </entry>
  
  <entry>
    <title>mina学习笔记四：交互的核心IoSession</title>
    <link href="https://smuwjs.github.io/2016/09/08/mina%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%9B%9B%EF%BC%9A%E4%BA%A4%E4%BA%92%E7%9A%84%E6%A0%B8%E5%BF%83IoSession/"/>
    <id>https://smuwjs.github.io/2016/09/08/mina学习笔记四：交互的核心IoSession/</id>
    <published>2016-09-08T20:12:16.000Z</published>
    <updated>2017-05-05T09:48:30.756Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://blog.csdn.net/yoara/article/details/37568027" target="_blank" rel="external">原文：http://blog.csdn.net/yoara/article/details/37568027</a>    </p>
<p>这一章讲的就是IoSession，session这个词做web应用的人应该都是耳熟能详，在mina中IoSession也是起着相同的作用。mina为每个客户端提供了会话session，session是服务器端和客户端的连接持有者，直到连接中断session才会被销毁。</p>
<p>IoSession不仅是connection的相关信息，同时，服务器端还能通过他存储其他可能需要的数据信息。好，让我们一步一步剖析IoSession那不平凡的一生吧。</p>
<h1 id="1-IoSession在服务器端的创建第一步：accept-processor-handle"><a href="#1-IoSession在服务器端的创建第一步：accept-processor-handle" class="headerlink" title="1. IoSession在服务器端的创建第一步：accept(processor,handle)"></a>1. IoSession在服务器端的创建第一步：accept(processor,handle)</h1><p>接着上节说，我们已经知道，NioSocketAcceptor.bind()后，最终会生成一个在自身维护的executor线程池内提交的任务Acceptor（单一线程），该任务不断的轮询判断服务是否关闭、同时等待新的连接接入。当有新的连接接入时：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Acceptor.run()&#123;</div><div class="line">	...</div><div class="line">	<span class="comment">//selectedHandles()获取一个selector中注册的服务监听的serversocketchannel的迭代器</span></div><div class="line">	processHandles(selectedHandles());</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建session、并为其分配指定IoProcessor的秘密都在AbstractPollingIoAcceptor.processHandles()这个方法中。我们接着看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processHandles</span><span class="params">(Iterator&lt;ServerSocketChannel&gt; handles)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">           <span class="keyword">while</span> (handles.hasNext()) &#123;</div><div class="line">               H handle = handles.next();</div><div class="line">               handles.remove();</div><div class="line"></div><div class="line">               <span class="comment">// 创建session并将本地的processor处理池当参数传递给session</span></div><div class="line">	<span class="comment">// 注意这里还未分配具体的processor</span></div><div class="line">               S session = accept(processor, handle);</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (session == <span class="keyword">null</span>) &#123;</div><div class="line">                   <span class="keyword">continue</span>;</div><div class="line">               &#125;</div><div class="line">	<span class="comment">// 初始化Session</span></div><div class="line">               initSession(session, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">               <span class="comment">// 将session分配给具体的processor</span></div><div class="line">               session.getProcessor().add(session);</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<pre><code>第一步accept(processor,handle)方法，调用子类实现的NioSession accept(...)方法，判断了SelectionKey的有效性后，获得连接的通道SocketChannel ch = handle.accept();最后以此为传参创建IoSession对象return new NioSocketSession(this, processor, ch);我们看下构造函数做了什么（为了方便起见，相关的父类构造函数都写在一块了）：
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">NioSocketSession</span><span class="params">(IoService service, IoProcessor&lt;NioSession&gt; processor, SocketChannel channel)</span> </span>&#123;</div><div class="line"><span class="comment">//AbstractIoSession(IoService service)</span></div><div class="line">       <span class="keyword">this</span>.service = service;</div><div class="line">       <span class="keyword">this</span>.handler = service.getHandler();</div><div class="line"></div><div class="line">       <span class="comment">//保存当前的处理时间信息</span></div><div class="line">       <span class="keyword">long</span> currentTime = System.currentTimeMillis();</div><div class="line">       creationTime = currentTime;</div><div class="line">       lastThroughputCalculationTime = currentTime;</div><div class="line">       lastReadTime = currentTime;</div><div class="line">       lastWriteTime = currentTime;</div><div class="line">       lastIdleTimeForBoth = currentTime;</div><div class="line">       lastIdleTimeForRead = currentTime;</div><div class="line">       lastIdleTimeForWrite = currentTime;</div><div class="line"></div><div class="line">       <span class="comment">//在关闭时的动作，下面以此展开对IoFuture的探讨。</span></div><div class="line">       closeFuture.addListener(SCHEDULED_COUNTER_RESETTER);</div><div class="line"></div><div class="line">       <span class="comment">//为session创建唯一的ID</span></div><div class="line">       sessionId = idGenerator.incrementAndGet();</div><div class="line"><span class="comment">//END AbstractIoSession(IoService service)</span></div><div class="line"></div><div class="line"><span class="comment">//NioSession(IoProcessor&lt;NioSession&gt; processor, IoService service, Channel channel)</span></div><div class="line"><span class="comment">//即当前session的SocketChannel</span></div><div class="line"><span class="keyword">this</span>.channel = channel;</div><div class="line"><span class="comment">//这是ioservice中的processor池哦</span></div><div class="line">       <span class="keyword">this</span>.processor = processor;</div><div class="line"><span class="comment">//这步过滤器链厉害了，后面细说</span></div><div class="line">       filterChain = <span class="keyword">new</span> DefaultIoFilterChain(<span class="keyword">this</span>);</div><div class="line"><span class="comment">//END NioSession(IoProcessor&lt;NioSession&gt; processor, IoService service, Channel channel)</span></div><div class="line"></div><div class="line"><span class="comment">//设置各种初始参数</span></div><div class="line">       config = <span class="keyword">new</span> SessionConfigImpl();</div><div class="line">       <span class="keyword">this</span>.config.setAll(service.getSessionConfig());</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>右边这张图是IoSession的类图结构，比较清晰。</p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/80907734-file_1493965083462_ab65.jpg" alt=""></p>
<p>我们细细的分析一下NioSocketSession在初始化时做了哪些工作，首先持有了sevice及其处理类引用，并设置了一些初始时间信息，然后他在关闭时注册了监听操作closeFuture.addListener(SCHEDULED_COUNTER_RESETTER)。</p>
<h2 id="1-1-IoFuture"><a href="#1-1-IoFuture" class="headerlink" title="1.1 IoFuture"></a>1.1 IoFuture</h2><p>我们已经很多次看到IoFuture，有必要来详细了解一下IoFuture的作用。那用过Executor的同学都知道，submit()提交Callback的任务后将返回一个Future表示这个任务的操作结果，这里的IoFuture的作用是类似的，他代表一次相关于IoSession的操作的操作结果，同时，还可以在他完成时获取定义相关的操作。我们看下他的子类结构图 </p>
<p>图4.1 IoFuture子类结构图</p>
<p>由图中可见，对session相关的操作例如关闭、连接、写、读等操作，IoFuture全都有子类去支持。session的操作可以很方便的通过IoFuture查看处理的结果。我们看下IoFuture接口的API清单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">addListener(IoFutureListener&lt;?&gt;)</div><div class="line">await()</div><div class="line">await(<span class="keyword">long</span>)</div><div class="line">await(<span class="keyword">long</span>, TimeUnit)</div><div class="line">awaitUninterruptibly()</div><div class="line">awaitUninterruptibly(<span class="keyword">long</span>)</div><div class="line">awaitUninterruptibly(<span class="keyword">long</span>, TimeUnit)</div><div class="line">getSession()</div><div class="line">isDone()</div><div class="line">removeListener(IoFutureListener&lt;?&gt;)</div></pre></td></tr></table></figure>
<pre><code>从清单我们了解到：1.IoFuture支持添加操作完成的监听器，2.IoFuture支持可中断、可设置超时时间的阻塞式操作。3.isDone()则返回操作的完成状态。 
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IoFutureListener</span>&lt;<span class="title">F</span> <span class="keyword">extends</span> <span class="title">IoFuture</span>&gt; <span class="keyword">extends</span> <span class="title">EventListener</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(F future)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在他的直接实现子类DefaultIoFuture里面，我们看一下该类很主要一个实现方法setValue(Object newValue)，所有其他子类都会调用该方法以完成具体的操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(Object newValue)</span> </span>&#123;</div><div class="line">       <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">           <span class="comment">// 已经完成则直接返回</span></div><div class="line">           <span class="keyword">if</span> (ready) &#123;</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line">    <span class="comment">//设置结果</span></div><div class="line">           result = newValue;</div><div class="line">    <span class="comment">//设置完成状态</span></div><div class="line">           ready = <span class="keyword">true</span>;</div><div class="line">    <span class="comment">//唤醒所有等待线程</span></div><div class="line">           <span class="keyword">if</span> (waiters &gt; <span class="number">0</span>) &#123;</div><div class="line">               lock.notifyAll();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"><span class="comment">//通知监听器执行完成操作</span></div><div class="line">       notifyListeners();</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>DefaultIoFuture中个还有一个检查死锁的方法，大家有兴趣可以看下是怎么判断死锁的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkDeadLock</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Only read / write / connect / write future can cause dead lock. </span></div><div class="line">    <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> CloseFuture || <span class="keyword">this</span> <span class="keyword">instanceof</span> WriteFuture || <span class="keyword">this</span> <span class="keyword">instanceof</span> ReadFuture || <span class="keyword">this</span> <span class="keyword">instanceof</span> ConnectFuture)) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Get the current thread stackTrace. </span></div><div class="line">    <span class="comment">// Using Thread.currentThread().getStackTrace() is the best solution,</span></div><div class="line">    <span class="comment">// even if slightly less efficient than doing a new Exception().getStackTrace(),</span></div><div class="line">    <span class="comment">// as internally, it does exactly the same thing. The advantage of using</span></div><div class="line">    <span class="comment">// this solution is that we may benefit some improvement with some</span></div><div class="line">    <span class="comment">// future versions of Java.</span></div><div class="line">    StackTraceElement[] stackTrace = Thread.currentThread().getStackTrace();</div><div class="line"></div><div class="line">    <span class="comment">// Simple and quick check.</span></div><div class="line">    <span class="keyword">for</span> (StackTraceElement s : stackTrace) &#123;</div><div class="line">        <span class="keyword">if</span> (AbstractPollingIoProcessor.class.getName().equals(s.getClassName())) &#123;</div><div class="line">            IllegalStateException e = <span class="keyword">new</span> IllegalStateException(<span class="string">"t"</span>);</div><div class="line">            e.getStackTrace();</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"DEAD LOCK: "</span> + IoFuture.class.getSimpleName()</div><div class="line">                    + <span class="string">".await() was invoked from an I/O processor thread.  "</span> + <span class="string">"Please use "</span></div><div class="line">                    + IoFutureListener.class.getSimpleName() + <span class="string">" or configure a proper thread model alternatively."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// And then more precisely.</span></div><div class="line">    <span class="keyword">for</span> (StackTraceElement s : stackTrace) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Class&lt;?&gt; cls = DefaultIoFuture.class.getClassLoader().loadClass(s.getClassName());</div><div class="line">            <span class="keyword">if</span> (IoProcessor.class.isAssignableFrom(cls)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"DEAD LOCK: "</span> + IoFuture.class.getSimpleName()</div><div class="line">                        + <span class="string">".await() was invoked from an I/O processor thread.  "</span> + <span class="string">"Please use "</span></div><div class="line">                        + IoFutureListener.class.getSimpleName()</div><div class="line">                        + <span class="string">" or configure a proper thread model alternatively."</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception cnfe) &#123;</div><div class="line">            <span class="comment">// Ignore</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="1-2-IoSession的过滤器链"><a href="#1-2-IoSession的过滤器链" class="headerlink" title="1.2 IoSession的过滤器链"></a>1.2 IoSession的过滤器链</h2><p>IoSession是有状态的，它包括：</p>
<ul>
<li>Connected ：IoSession已被创建且生效。</li>
<li>Idle ：会话在一定时间内没有处理任何请求，它包括下面三个子状态：<ul>
<li>Idle for read ： 一段时间内没有接受数据。</li>
<li>Idle for write ： 一段时间内没有发送数据。</li>
<li>Idle for both ： 一段时间内没有产生接受或发送数据的操作。</li>
</ul>
</li>
<li>Closing : IoSession正在关闭中。</li>
<li>Closed : session已经被关闭。</li>
</ul>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/97950260-file_1493965242301_10746.png" alt="图4.2 IoSession状态变化图"></p>
<p>每个状态都会引起一系列的过滤器的对应的操作，从这句代码中我们了解到，每个IoSession都有他自己的过滤器链，即我们可以为每个session定制过滤器链。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">filterChain = <span class="keyword">new</span> DefaultIoFilterChain(<span class="keyword">this</span>);</div></pre></td></tr></table></figure>
<pre><code>IoSession会先继承IoService的过滤器链，过滤器链将放在下一节统一分析。
</code></pre><h1 id="2-IoSession在服务器端的创建第二步：initSession-session-null-null"><a href="#2-IoSession在服务器端的创建第二步：initSession-session-null-null" class="headerlink" title="2. IoSession在服务器端的创建第二步：initSession(session, null, null)"></a>2. IoSession在服务器端的创建第二步：initSession(session, null, null)</h1><pre><code>这一步initSession(session, null, null);主要的有两段可配置的属性，一个就是存储attribute属性键值对的Map，默认是ConcurrentHashMap；另一个就是发送队列，默认是ConcurrentLinkedQueue。若要实现自己的数据结构，需要重写接口IoSessionDataStructureFactory或继承DefaultIoSessionDataStructureFactory。
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;  </div><div class="line">    ((AbstractIoSession) session).setAttributeMap(session.getService().getSessionDataStructureFactory()  </div><div class="line">            .getAttributeMap(session));  </div><div class="line">&#125; <span class="keyword">catch</span> (IoSessionInitializationException e) &#123;  </div><div class="line">    <span class="keyword">throw</span> e;  </div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;  </div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IoSessionInitializationException(<span class="string">"Failed to initialize an attributeMap."</span>, e);  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="keyword">try</span> &#123;  </div><div class="line">    ((AbstractIoSession) session).setWriteRequestQueue(session.getService().getSessionDataStructureFactory()  </div><div class="line">            .getWriteRequestQueue(session));  </div><div class="line">&#125; <span class="keyword">catch</span> (IoSessionInitializationException e) &#123;  </div><div class="line">    <span class="keyword">throw</span> e;  </div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;  </div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IoSessionInitializationException(<span class="string">"Failed to initialize a writeRequestQueue."</span>, e);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="3-IoSession在服务器端的创建第三步：session-getProcessor-add-session"><a href="#3-IoSession在服务器端的创建第三步：session-getProcessor-add-session" class="headerlink" title="3. IoSession在服务器端的创建第三步：session.getProcessor().add(session);"></a>3. IoSession在服务器端的创建第三步：session.getProcessor().add(session);</h1><p>这一步就是为我们新生成的IoSession在IoService的Processor池中指定一个Processor处理。分配的方式就是取模分配，完成后在分配Processor中增加该IoSession的引用。SimpleIoProcessorPool中的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(S session)</span> </span>&#123;  </div><div class="line"><span class="comment">//请注意这里是两步，第一步getProcessor(session)在下面段代码，创建（若没有）并返回Processor  </span></div><div class="line"><span class="comment">//第二步在该Processor中add(session),这里就是调用AbstractPollingIoProcessor.add()，后面有更多描述  </span></div><div class="line">       getProcessor(session).add(session);  </div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> IoProcessor&lt;S&gt; <span class="title">getProcessor</span><span class="params">(S session)</span> </span>&#123;  </div><div class="line">    IoProcessor&lt;S&gt; processor = (IoProcessor&lt;S&gt;) session.getAttribute(PROCESSOR);  </div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (processor == <span class="keyword">null</span>) &#123;  </div><div class="line">        <span class="keyword">if</span> (disposed || disposing) &#123;  </div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"A disposed processor cannot be accessed."</span>);  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        processor = pool[Math.abs((<span class="keyword">int</span>) session.getId()) % pool.length];  </div><div class="line">  </div><div class="line">        <span class="keyword">if</span> (processor == <span class="keyword">null</span>) &#123;  </div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"A disposed processor cannot be accessed."</span>);  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        session.setAttributeIfAbsent(PROCESSOR, processor);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="keyword">return</span> processor;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="4-SimpleIoProcessorPool、IoProcess和NioSocketAcceptor之间的关系"><a href="#4-SimpleIoProcessorPool、IoProcess和NioSocketAcceptor之间的关系" class="headerlink" title="4. SimpleIoProcessorPool、IoProcess和NioSocketAcceptor之间的关系"></a>4. SimpleIoProcessorPool、IoProcess和NioSocketAcceptor之间的关系</h1><p>上节我们留了个悬念，SimpleIoProcessorPool、IoProcess和IoServices之间的到底是关系呢？我们从SimpleIoProcessorPool初始化池说起：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; pool.length; i++) &#123;  </div><div class="line">    ...  </div><div class="line">    pool[i] = processorConstructor.newInstance(<span class="keyword">this</span>.executor);  </div><div class="line">    ...  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码将生成的线程池当做构造传参传递给所有的NioProcess，即数组池中所有NioProcess都是共享一个Executro线程池的（newCashedThreadPool）。AbstractPollingIoProcessor.add()方法做了这些工作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(S session)</span> </span>&#123;  </div><div class="line">      <span class="keyword">if</span> (disposed || disposing) &#123;  </div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already disposed."</span>);  </div><div class="line">      &#125;  </div><div class="line">  </div><div class="line">      <span class="comment">// 将session添加到ConcurrentLinkedQueue的队列中，并启动Processor 的worker线程  </span></div><div class="line">      newSessions.add(session);  </div><div class="line"><span class="comment">//启动Processor线程  </span></div><div class="line">tartupProcessor();   </div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>我们很有必要具体看一下Processor线程做了什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Processor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </div><div class="line"> ...  </div><div class="line">        <span class="keyword">for</span> (;;) &#123;  </div><div class="line">            <span class="keyword">try</span> &#123;  </div><div class="line">                <span class="comment">// 监控空闲时间  </span></div><div class="line">                <span class="keyword">long</span> t0 = System.currentTimeMillis();  </div><div class="line">                <span class="keyword">int</span> selected = select(<span class="number">1000</span>);  </div><div class="line">                <span class="keyword">long</span> t1 = System.currentTimeMillis();  </div><div class="line">                <span class="keyword">long</span> delta = (t1 - t0);  </div><div class="line">  </div><div class="line">                ...  </div><div class="line">                <span class="comment">// 注册新的session连接，并初始化session信息，如过滤器链，  </span></div><div class="line">  <span class="comment">// 通知service的监听器  </span></div><div class="line">                nSessions += handleNewSessions();  </div><div class="line">  ...  </div><div class="line">                <span class="comment">// 处理新的请求  </span></div><div class="line">                <span class="keyword">if</span> (selected &gt; <span class="number">0</span>) &#123;  </div><div class="line">                    process();  </div><div class="line">                &#125;  </div><div class="line">  ...  </div><div class="line">                <span class="comment">// 移除  </span></div><div class="line">                nSessions -= removeSessions();  </div><div class="line">  </div><div class="line">                <span class="comment">// 通知空闲监听器  </span></div><div class="line">                notifyIdleSessions(currentTime);  </div><div class="line">  </div><div class="line">                ...  </div><div class="line">  <span class="comment">//关闭  </span></div><div class="line">                <span class="keyword">if</span> (isDisposing()) &#123;  </div><div class="line">                    <span class="keyword">for</span> (Iterator&lt;S&gt; i = allSessions(); i.hasNext();) &#123;  </div><div class="line">                        scheduleRemove(i.next());  </div><div class="line">                    &#125;  </div><div class="line">  </div><div class="line">                    wakeup();  </div><div class="line">                &#125;  </div><div class="line">            &#125; <span class="keyword">catch</span> ...  </div><div class="line">        &#125;  </div><div class="line"> ...  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中，handlesNewSessions()做了如下工作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">//在selector上注册感兴趣的相应集合读操作  </span></div><div class="line">        SelectableChannel ch = (SelectableChannel) session.getChannel();  </div><div class="line">        ch.configureBlocking(<span class="keyword">false</span>);  </div><div class="line">        session.setSelectionKey(ch.register(selector, SelectionKey.OP_READ, session));  </div><div class="line">  </div><div class="line">   <span class="comment">//将service的过滤器链设置在session上  </span></div><div class="line">        IoFilterChainBuilder chainBuilder = session.getService().getFilterChainBuilder();  </div><div class="line">        chainBuilder.buildFilterChain(session.getFilterChain());  </div><div class="line">    <span class="comment">//回调监听器  </span></div><div class="line">        IoServiceListenerSupport listeners = ((AbstractIoService) session.getService()).getListeners();  </div><div class="line">        listeners.fireSessionCreated(session);</div></pre></td></tr></table></figure>
<p>至此SimpleIoProcessorPool、IoProcess和IoServices的关系就清晰了。</p>
<ul>
<li>SimpleIoProcessorPool维护一组IoProcess[] ，每个IoProcess都在线程池中绑定了工作线程，该工作线程开启一个selector并监听session交互OP_READ。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioProcessor</span><span class="params">(Executor executor)</span> </span>&#123;  </div><div class="line">    <span class="keyword">super</span>(executor);  </div><div class="line">  </div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">        selector = Selector.open();  </div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;  </div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeIoException(<span class="string">"Failed to open a selector."</span>, e);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>NioSocketAcceptor持有一个pool的引用</p>
</li>
<li><p>NioSocketAcceptor自身也有个单线程的executor，用于监听新的session的链接OP_ACCEPT。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">NioSocketAcceptor.init() <span class="keyword">throws</span> Exception &#123;  </div><div class="line">    selector = Selector.open();  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>今天分析了IoSession后，mina的框架体系就比较清晰了，不过还有重要的filter、handler等，我们接下来几章继续探讨。</p>
<p>版权声明：本文为博主原创文章，未经博主允许不得转载。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;http://blog.csdn.net/yoara/article/details/37568027&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;原文：http://blog.csdn.net/yoara/article/detail
    
    </summary>
    
      <category term="mina" scheme="https://smuwjs.github.io/categories/mina/"/>
    
    
      <category term="java mina" scheme="https://smuwjs.github.io/tags/java-mina/"/>
    
  </entry>
  
  <entry>
    <title>mina学习笔记三：一切的源头IoService</title>
    <link href="https://smuwjs.github.io/2016/09/08/mina%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%9A%E4%B8%80%E5%88%87%E7%9A%84%E6%BA%90%E5%A4%B4IoService/"/>
    <id>https://smuwjs.github.io/2016/09/08/mina学习笔记三：一切的源头IoService/</id>
    <published>2016-09-08T20:12:15.000Z</published>
    <updated>2017-05-05T09:48:30.740Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://blog.csdn.net/yoara/article/details/37382137" target="_blank" rel="external">原文:http://blog.csdn.net/yoara/article/details/37382137</a></p>
<h1 id="1-IoService介绍"><a href="#1-IoService介绍" class="headerlink" title="1.IoService介绍"></a>1.IoService介绍</h1><p>从上节的例子已经了解到，创建服务端服务第一步是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">IoAcceptor acceptor = <span class="keyword">new</span> NioSocketAcceptor();</div></pre></td></tr></table></figure>
<p>而创建客户端连接的第一步是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">IoConnector connector = <span class="keyword">new</span> NioSocketConnector();</div></pre></td></tr></table></figure>
<p>这两个接口的父接口正是IoService。IoService是mina的核心组件，他提供标准的I/O 服务并且管理I/O 会话Session。IoService为大部分mina服务提供了底层的API支持。AbstractIoService是IoService的子类，他提供了基本的服务实现。先由下图简单的了解下IoService及其子类AbstractIoService的在mina体系结构中所担负的责任。 </p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/38311166-file_1493954966129_17b01.png" alt="图3.1"></p>
<p>职责分解图 如图所见，IoService的权责主要包括：</p>
<ul>
<li>会话Session管理：创建和销毁会话，检测session等待等。</li>
<li>过滤器链管理：管理过滤器链，提供多个切面的服务，并允许用户在运行时动态变更过滤器链。</li>
<li>处理调用：当有新消息或其他session生命周期触发事件响应时，回调用户的业务代码。</li>
<li>统计管理：更新消息发送量、字节发送量等等信息。</li>
<li>监听器管理：提供服务各个生命周期触发时间的监听器管理，如服务有效时、服务空闲时、会话创建时等。</li>
<li>传输管理：可在服务端客户端有效的控制数据流的传输，平衡负载。</li>
</ul>
<h1 id="2-IoService-API分析"><a href="#2-IoService-API分析" class="headerlink" title="2.IoService API分析"></a>2.IoService API分析</h1><p>那了解了IoService所承担的责任，以及知道他是服务端和客户端的共同祖先接口，我们有必要看一下他的API 清单：</p>
<ul>
<li>void addListener(IoServiceListener)：为service添加监听器</li>
<li>void removeListener(IoServiceListener)：移除一个监听器</li>
<li>Set<writefuture> broadcast(Object)：向持有的所有session广播消息</writefuture></li>
<li>void dispose()：关闭service并释放相关联的资源，如果有session还未关闭，此方法会一直堵塞。</li>
<li>void dispose(boolean)：如果参数为true，service会一直阻塞直到ExecutorService线程池关闭后，才会关闭。</li>
<li>boolean isDisposed()：是否已经注销service</li>
<li>boolean isDisposing()：是否正在注销service</li>
<li>boolean isActive()：是否service还在服务</li>
<li>long getActivationTime()：获取最新活动的时间，如果sevice已经停止，则返回最后一次活动时间</li>
<li>DefaultIoFilterChainBuilder getFilterChain()：获得默认的过滤器链，如果用户没有使用自定义的，将会抛IllegalStateException异常。</li>
<li>void setFilterChainBuilder(IoFilterChainBuilder)：设置过滤器链对象</li>
<li>IoFilterChainBuilder getFilterChainBuilder()：获得过滤器链对象</li>
<li>void setHandler(IoHandler)：设置处理类</li>
<li>IoHandler getHandler()：获得处理类</li>
<li>int getManagedSessionCount()：获得有效的连接session数量</li>
<li>Map<long, iosession=""> getManagedSessions() ：获得当前只读的有效session</long,></li>
<li>int getScheduledWriteBytes()：获取尚未发送的字节数</li>
<li>int getScheduledWriteMessages()：获取尚未发送的消息数量</li>
<li>IoSessionConfig getSessionConfig()：获得连接配置信息</li>
<li>void setSessionDataStructureFactory(IoSessionDataStructureFactory)：设置初始化session用的数据信息，注意，服务启动后不可设置。</li>
<li>IoSessionDataStructureFactory getSessionDataStructureFactory()：获得初始化session时用到的一些数据信息</li>
<li>IoServiceStatistics getStatistics()：获得统计数据信息</li>
<li>TransportMetadata getTransportMetadata()：session相关的元数据信息</li>
</ul>
<h1 id="3-从IoAcceptor开始吧"><a href="#3-从IoAcceptor开始吧" class="headerlink" title="3.从IoAcceptor开始吧"></a>3.从IoAcceptor开始吧</h1><pre><code>显然，该接口的名称来源于耳熟能详的accept()方法。mina框架已经为我们封装了大部分网络通讯的实现类。因此我们大可不必自己重新去实现（除非有特殊的应用场景）。我们可根据自己的情况从下选择：
</code></pre><ul>
<li>NioSocketAcceptor ：非阻塞的套接字TCP（Socket） IoAcceptor</li>
<li>NioDatagramAcceptor : 非阻塞的数据包UDP IoAcceptor</li>
<li>AprSocketAcceptor : 基于 APR 的阻塞式套接字 IoAcceptor</li>
<li><p>VmPipeSocketAcceptor : 基于虚拟机管道的 IoAcceptor</p>
<p>下图是IoAccceptor一支的类图结构：</p>
</li>
</ul>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/35734540-file_1493955049172_17775.jpg" alt="图3.2 IoAccceptor类图结构"></p>
<h2 id="3-1-创建IoAcceptor"><a href="#3-1-创建IoAcceptor" class="headerlink" title="3.1 创建IoAcceptor"></a>3.1 创建IoAcceptor</h2><p>上节我们已经了解到，IoService开启服务的第一步是创建IoAcceptor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//首先，我们为服务端创建IoAcceptor，NioSocketAcceptor是基于NIO的服务端监听器</span></div><div class="line">IoAcceptor acceptor = <span class="keyword">new</span> NioSocketAcceptor();</div></pre></td></tr></table></figure>
<p>NioSocketAcceptor 继承自 AbstractPollingIoAcceptor<niosession, serversocketchannel="">并实现了SocketAcceptor接口。NioSocketAcceptor共有四个构造函数签名：</niosession,></p>
<ul>
<li>NioSocketAcceptor()</li>
<li>NioSocketAcceptor(int)</li>
<li>NioSocketAcceptor(IoProcessor<niosession>)</niosession></li>
<li>NioSocketAcceptor(Executor, IoProcessor<niosession>)</niosession></li>
</ul>
<p>分别调用父类的四个对应构造函数如下。从这里我们知道，IoAcceptor在实例化是必须依赖3个接口，他们分别是IoSessionConfig、IoProcessor、Executor。</p>
<ul>
<li>AbstractPollingIoAcceptor(IoSessionConfig, Class&lt;? extends IoProcessor<s>&gt;)</s></li>
<li>AbstractPollingIoAcceptor(IoSessionConfig, Class&lt;? extends IoProcessor<s>&gt;, int)</s></li>
<li>AbstractPollingIoAcceptor(IoSessionConfig, IoProcessor<s>)</s></li>
<li>AbstractPollingIoAcceptor(IoSessionConfig, Executor, IoProcessor<s>)</s></li>
</ul>
<h3 id="3-1-1先从IoSessionConfig说起"><a href="#3-1-1先从IoSessionConfig说起" class="headerlink" title="3.1.1先从IoSessionConfig说起"></a>3.1.1先从IoSessionConfig说起</h3><pre><code>无论是NioSocketAcceptor或者NioDatagramAcceptor，具体实现类都是new一个DefaultDatagramSessionConfig实例做为传参： 
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioSocketAcceptor</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> DefaultSocketSessionConfig(), NioProcessor.class);</div><div class="line">        ((DefaultSocketSessionConfig) getSessionConfig()).init(<span class="keyword">this</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>boolean tcpNoDelay：表示立即发送数据。默认false</p>
<p>boolean reuseAddress：表示是否允许重用Socket所绑定的本地地址。默认false</p>
<p>int soLinger：表示当执行Socket的close()方法时，是否立即关闭底层的Socket。默认-1</p>
<p>int sendBufferSize：表示发送数据的缓冲区的大小。默认-1</p>
<p>int receiveBufferSize：表示接收数据的缓冲区的大小。默认-1</p>
<p>boolean keepAlive：表示对于长时间处于空闲状态的Socket，是否要自动把它关闭。默认false</p>
<p>boolean oobInline：表示是否支持发送一个字节的TCP紧急数据。默认false。 int trafficClass：IP服务类型，底成本：0x02/高可靠：0x04/最高吞吐量：0x08/最小延迟：0x10</p>
<pre><code>同时祖父类AbstractIoSessionConfig还包括如下参数：

private int minReadBufferSize = 64;

private int readBufferSize = 2048;

private int maxReadBufferSize = 65536;

private int idleTimeForRead;

private int idleTimeForWrite;

private int idleTimeForBoth;

private int writeTimeout = 60;

private boolean useReadOperation;//当IoSession.read()方法可用时，为true。接受到的所有消息将被存储在内部的BlockingQueue中，使用客户端程序可使用更加方便的读取方式。但使该操作生效并不会在服务端应用中产生什么好处反倒会导致不可预料的内存泄露，默认是关闭的。

private int throughputCalculationInterval = 3;//每次throughputCalculation（吞吐量计算？）的间隔时间，默认是3秒。
</code></pre><p>这些设置主要是传输相关的参数设置，默认就可以了，我们经常用到的估计就是BufferSize和idleTime了。</p>
<h3 id="3-1-2-IoProcessor"><a href="#3-1-2-IoProcessor" class="headerlink" title="3.1.2 IoProcessor"></a>3.1.2 IoProcessor</h3><pre><code>如果自己不实现IoProcess的话，默认的传递参数是NioProcessor.class（NioDatagramAcceptor构造函数是不需要该参数的）。在父类AbstractPollingIoAcceptor将调用
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> SimpleIoProcessorPool&lt;S&gt;(processorClass)</div></pre></td></tr></table></figure>
<p>方法新建一个SimpleIoProcessorPool的实例。IoProcessor提供一个IoProcessor[处理器数+1] 数组类型的池，未处理每一种IoSessions分类。大多数的Services的实现子类都在内部使用该IoProcessor已达到在多核环境下更好的性能。我们不需要直接使用它。但是，如果在本地JVM中需要存在多个IoServices，那有必要让这些services共享一个SimpleIoProcessorPool。如使用一下方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">SimpleIoProcessorPool&lt;NioSession&gt; pool = <span class="keyword">new</span> SimpleIoProcessorPool&lt;NioSession&gt;(NioProcessor.class, <span class="number">16</span>);</div><div class="line"></div><div class="line">SocketAcceptor acceptor = <span class="keyword">new</span> NioSocketAcceptor(pool);</div><div class="line">SocketConnector connector = <span class="keyword">new</span> NioSocketConnector(pool);</div></pre></td></tr></table></figure>
<p>来看一看SimpleIoProcessorPool的构造方法吧：其中，传递的参数processorType为NioProcessor.class</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line">public SimpleIoProcessorPool(Class&lt;? extends IoProcessor&lt;S&gt;&gt; processorType, Executor executor, int size) &#123;</div><div class="line">        if (processorType == null) &#123;</div><div class="line">            throw new IllegalArgumentException("processorType");</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (size &lt;= 0) &#123;</div><div class="line">            throw new IllegalArgumentException("size: " + size + " (expected: positive integer)");</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // 事实上，&lt;span style="font-family: Arial, Helvetica, sans-serif;"&gt;executor在框架内必然是null，除非我们实现自己的子类。&lt;/span&gt;</div><div class="line">        createdExecutor = (executor == null);</div><div class="line"></div><div class="line">        if (createdExecutor) &#123;</div><div class="line">            &lt;span style="color:#ff0000;"&gt;this.executor = Executors.newCachedThreadPool();&lt;/span&gt;</div><div class="line">            //饱和策略选择了由调度者执行的机制。不过newCachedThreadPool不是无限线程池么，怎么又回饱和呢？</div><div class="line">	    //难道是并发过载导致线程生成不过来？这样的话，负荷过载就会蔓延到IoServices的主线程，这样的饱和策略真的好么？</div><div class="line">	    //我觉得不如抛弃任务，并抛出异常让上层捕获比较好。</div><div class="line">            ((ThreadPoolExecutor) this.executor).setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());</div><div class="line">        &#125; else &#123;</div><div class="line">            this.executor = executor;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        pool = new IoProcessor[size];</div><div class="line"></div><div class="line">        boolean success = false;</div><div class="line">        Constructor&lt;? extends IoProcessor&lt;S&gt;&gt; processorConstructor = null;</div><div class="line">        boolean usesExecutorArg = true;</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            // 首先保证至少能生成一个processor：默认的话就是newCachedThreadPool()返回的ThreadPoolExecutor，可自行实现</div><div class="line">	    // 这里的初始化策略是：1.首先调用参数类型为ExecutorService 子类的构造函数，</div><div class="line">	    // 如果失败则2.调用参数类型为Executor子类的构造函数，</div><div class="line">	    // 否则3.调用无参的构造函数</div><div class="line">            try &#123;</div><div class="line">                try &#123;</div><div class="line">                    processorConstructor = processorType.getConstructor(ExecutorService.class);</div><div class="line">                    pool[0] = processorConstructor.newInstance(this.executor);</div><div class="line">                &#125; catch (NoSuchMethodException e1) &#123;</div><div class="line">                    // To the next step...</div><div class="line">                    try &#123;</div><div class="line">                        processorConstructor = processorType.getConstructor(Executor.class);</div><div class="line">                        pool[0] = processorConstructor.newInstance(this.executor);</div><div class="line">                    &#125; catch (NoSuchMethodException e2) &#123;</div><div class="line">                        // To the next step...</div><div class="line">                        try &#123;</div><div class="line">                            processorConstructor = processorType.getConstructor();</div><div class="line">                            usesExecutorArg = false;</div><div class="line">                            pool[0] = processorConstructor.newInstance();</div><div class="line">                        &#125; catch (NoSuchMethodException e3) &#123;</div><div class="line">                            // To the next step...</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; catch (RuntimeException re) &#123;</div><div class="line">                LOGGER.error("Cannot create an IoProcessor :&#123;&#125;", re.getMessage());</div><div class="line">                throw re;</div><div class="line">            &#125; catch (Exception e) &#123;</div><div class="line">                String msg = "Failed to create a new instance of " + processorType.getName() + ":" + e.getMessage();</div><div class="line">                LOGGER.error(msg, e);</div><div class="line">                throw new RuntimeIoException(msg, e);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (processorConstructor == null) &#123;</div><div class="line">                // Raise an exception if no proper constructor is found.</div><div class="line">                String msg = String.valueOf(processorType) + " must have a public constructor with one "</div><div class="line">                        + ExecutorService.class.getSimpleName() + " parameter, a public constructor with one "</div><div class="line">                        + Executor.class.getSimpleName() + " parameter or a public default constructor.";</div><div class="line">                LOGGER.error(msg);</div><div class="line">                throw new IllegalArgumentException(msg);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // 生成其他的Processor，重复上述步骤</div><div class="line">            for (int i = 1; i &lt; pool.length; i++) &#123;</div><div class="line">                try &#123;</div><div class="line">                    if (usesExecutorArg) &#123;</div><div class="line">                        pool[i] = processorConstructor.newInstance(this.executor);</div><div class="line">                    &#125; else &#123;</div><div class="line">                        pool[i] = processorConstructor.newInstance();</div><div class="line">                    &#125;</div><div class="line">                &#125; catch (Exception e) &#123;</div><div class="line">                    // Won't happen because it has been done previously</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            success = true;</div><div class="line">        &#125; finally &#123;</div><div class="line">            if (!success) &#123;</div><div class="line">                dispose();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<pre><code>如果创建失败，则调用dispose方法，遍历IoProcess[]数组并释放所有的资源。     有人会问了，那SimpleIoProcessorPool、IoProcess和IoServices的服务之间有什么关联，为什么NioDatagramAcceptor不需要IoProcess呢？我们将在后面详细阐述。
</code></pre><h3 id="3-1-3-Executor"><a href="#3-1-3-Executor" class="headerlink" title="3.1.3 Executor"></a>3.1.3 Executor</h3><pre><code>如果不传入Executor的而实现，mina会默认生成一个newCashedThreadPool，具体代码在非常底层的AbstractIoService类中，即无论是哪种连接方式、服务端、客户端，Executor的默认初始化方式都是一致的。
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (executor == <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">this</span>.executor = Executors.newCachedThreadPool();</div><div class="line">    createdExecutor = <span class="keyword">true</span>;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">this</span>.executor = executor;</div><div class="line">    createdExecutor = <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>又有问题了，这里的Executor和SimpleIoProcessorPool中为每个IoProcess所共享的Executor有什么关系呢？再卖个关子。</p>
<h2 id="3-2-IoAcceptor的构造函数做了什么？"><a href="#3-2-IoAcceptor的构造函数做了什么？" class="headerlink" title="3.2 IoAcceptor的构造函数做了什么？"></a>3.2 IoAcceptor的构造函数做了什么？</h2><p>搞清楚了传入参数，我们来看下构造器做了哪些初始化的动作。以NioSocketAcceptor为例。上面我们已经知道底层的AbstractIoService类做了executor的初始化，不仅如此，在这之前他还做了元数据判断和初始化监听器链的工作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">       <span class="keyword">if</span> (!getTransportMetadata().getSessionConfigType().isAssignableFrom(sessionConfig.getClass())) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"sessionConfig type: "</span> + sessionConfig.getClass() + <span class="string">" (expected: "</span></div><div class="line">                   + getTransportMetadata().getSessionConfigType() + <span class="string">")"</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// 创建监听器链，并增加第一个监听器</span></div><div class="line"><span class="comment">// 该监听器的作用就是在service被激活时，设置IoServiceStatistics的</span></div><div class="line"><span class="comment">// setLastReadTime、setLastWriteTime、setLastThroughputCalculationTime为激活时间</span></div><div class="line">       listeners = <span class="keyword">new</span> IoServiceListenerSupport(<span class="keyword">this</span>);</div><div class="line">       listeners.add(serviceActivationListener);</div></pre></td></tr></table></figure>
<p>同时，AbstructIoService类还实例化了IoFilterChainBuilder 对象，用于维护过滤器链。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> IoFilterChainBuilder filterChainBuilder = <span class="keyword">new</span> DefaultIoFilterChainBuilder();</div></pre></td></tr></table></figure>
<p>有必要提一下IoServiceListenerSupport，此类是所有监听器对象的持有类并管理着监听器的回调入口，同时还管理着当前Service的所有session。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** 当前service的引用 **/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> IoService service;</div><div class="line"></div><div class="line"><span class="comment">/** 基于COW线程保护的listeners集合 */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;IoServiceListener&gt; listeners = <span class="keyword">new</span> CopyOnWriteArrayList&lt;IoServiceListener&gt;();</div><div class="line"></div><div class="line"><span class="comment">/** 线程安全的session集合 */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Long, IoSession&gt; managedSessions = <span class="keyword">new</span> ConcurrentHashMap&lt;Long, IoSession&gt;();</div><div class="line"></div><div class="line"><span class="comment">/**  session集合的只读视图  **/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Long, IoSession&gt; readOnlyManagedSessions = Collections.unmodifiableMap(managedSessions);</div></pre></td></tr></table></figure>
<pre><code>以其中的方法fireServiceActivated()为例，此方法是Service被激活时调用 
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fireServiceActivated</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!activated.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</div><div class="line">           <span class="comment">// 如果已经激活，则返回</span></div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"><span class="comment">//设置激活时间</span></div><div class="line">       activationTime = System.currentTimeMillis();</div><div class="line"></div><div class="line">       <span class="comment">// 观察者模式，回调观察者listener的serviceActivated()方法</span></div><div class="line">       <span class="keyword">for</span> (IoServiceListener listener : listeners) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               listener.serviceActivated(service);</div><div class="line">           &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">               ExceptionMonitor.getInstance().exceptionCaught(e);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>监听器的每个方法都是在IoServiceListenerSupport里被回调的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">fireServiceActivated()</div><div class="line">fireServiceDeactivated()</div><div class="line">fireSessionCreated(IoSession)</div><div class="line">fireSessionDestroyed(IoSession)</div></pre></td></tr></table></figure>
<p>同时，service的getActivationTime()、isActive()方法等跟生命周期相关的信息获取方法，都是通过IoServiceListenerSupport的同名方法获得，可以说，IoServiceListenerSupport贯穿了整个IoService的生命周期。</p>
<p>至此，AbstructIoService完成了他的工作，接着AbstructIoAcceptor把defaultLocalAddresses设置为null，<strong>不知道这个defaultLocalAddresses的什么用？</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">super</span>(sessionConfig, executor);</div><div class="line">defaultLocalAddresses.add(<span class="keyword">null</span>);</div></pre></td></tr></table></figure>
<pre><code>AbstructIoAcceptor老爹唱罢，儿子AbstractPollingIoAcceptor登场。这儿子就干了一件正经事儿，回调了孙子NioSocketAccept的init()方法。
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    selector = Selector.open();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>于是，选择器开启。在NIO的时代，Selector.open后紧接着就是注册了channel了，然后select()阻塞起等待连接了。而我们的mina接着是怎么做的呢？我们先跳过fliter链的设置和连接参数的设置，进入 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//绑定端口</span></div><div class="line">acceptor.bind(<span class="keyword">new</span> InetSocketAddress(PORT));</div></pre></td></tr></table></figure>
<p>在一步老精彩了，儿子AbstractPollingIoAcceptor再也不是打酱油的角色了。老爹霹雳啪啦一大串模板方法，引出儿子关键的一步：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">try &#123;</div><div class="line">    &lt;span style="color:#ff0000;"&gt;Set&lt;SocketAddress&gt; addresses = bindInternal(localAddressesCopy);&lt;/span&gt;</div><div class="line"></div><div class="line">    synchronized (boundAddresses) &#123;</div><div class="line">        boundAddresses.addAll(addresses);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">...</div></pre></td></tr></table></figure>
<p>我们看看bindInternal在AbstractPollingIoAcceptor中做了什么 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">   protected final Set&lt;SocketAddress&gt; bindInternal(List&lt;? extends SocketAddress&gt; localAddresses) throws Exception &#123;</div><div class="line">// 创建了与selector注册相关的任务，并添加至registerQueue中</div><div class="line">       AcceptorOperationFuture request = new AcceptorOperationFuture(localAddresses);</div><div class="line"></div><div class="line">       registerQueue.add(request);</div><div class="line"></div><div class="line">       // 在私有变量executor线程池中启动具体的Acceptor执行线程</div><div class="line">       &lt;span style="color:#ff0000;"&gt;startupAcceptor();&lt;/span&gt;</div><div class="line"></div><div class="line">       // As we just started the acceptor, we have to unblock the select()</div><div class="line">       // in order to process the bind request we just have added to the</div><div class="line">       // registerQueue.</div><div class="line">       try &#123;</div><div class="line">           lock.acquire();</div><div class="line"></div><div class="line">           // 让线程池任务运行Acceptor任务</div><div class="line">    // 实际上不需要这一步，我们知道wakeup()方法，如果当前没有select()执行，则会解除下一次select()阻塞状态</div><div class="line">           Thread.sleep(10);</div><div class="line">    // 这个wakeup()方法很巧妙，因为Acceptor监听线程已经开启</div><div class="line">    // 但是没有连接接入，因此select()方法是阻塞的，</div><div class="line">    // 为了让必要的request完成操作，调用一次wakeup();</div><div class="line">           wakeup();</div><div class="line">       &#125; finally &#123;</div><div class="line">           lock.release();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       // 等待request任务完成注册</div><div class="line">       request.awaitUninterruptibly();</div><div class="line"></div><div class="line">       if (request.getException() != null) &#123;</div><div class="line">           throw request.getException();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       // Update the local addresses.</div><div class="line">       // setLocalAddresses() shouldn't be called from the worker thread</div><div class="line">       // because of deadlock.</div><div class="line">       Set&lt;SocketAddress&gt; newLocalAddresses = new HashSet&lt;SocketAddress&gt;();</div><div class="line"></div><div class="line">       for (H handle : boundHandles.values()) &#123;</div><div class="line">           newLocalAddresses.add(localAddress(handle));</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       return newLocalAddresses;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这里我们看到，bindInternal()方法主要完成了selector的注册和启动。其中主要的方法是startupAcceptor();</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">private void startupAcceptor() throws InterruptedException &#123;</div><div class="line">    if (!selectable) &#123;</div><div class="line">        registerQueue.clear();</div><div class="line">        cancelQueue.clear();</div><div class="line">    &#125;</div><div class="line">    // 如果acceptor已经启动，则什么也不做，否则启动之。</div><div class="line">    Acceptor acceptor = acceptorRef.get();</div><div class="line"></div><div class="line">    if (acceptor == null) &#123;</div><div class="line">        lock.acquire();</div><div class="line">        &lt;span style="color:#ff0000;"&gt;acceptor = new Acceptor();&lt;/span&gt;</div><div class="line"></div><div class="line">        if (acceptorRef.compareAndSet(null, acceptor)) &#123;</div><div class="line">            executeWorker(acceptor);</div><div class="line">        &#125; else &#123;</div><div class="line">            lock.release();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Acceptor继承自Runnable，用于提交到线程池中执行，而这个线程池就是作为参数（或者默认newCashedThreadPool返回）的Executor。Acceptor线程任务以循环的方式调用select()，第一次运行时将注册选择器。后续主要完成3个工作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 将 selector 设置监听 OP_ACCEPT，只在选择器第一次运行执行该代码，该方法依赖registerQueue队列</span></div><div class="line">nHandles += registerHandles();		    </div><div class="line">                   </div><div class="line"><span class="comment">// 如有连接接入，处理session</span></div><div class="line">processHandles(selectedHandles());</div><div class="line">                   </div><div class="line"><span class="comment">// 关闭selector监听，若关闭，则循环break跳出，线程任务结束，&lt;span style="font-family: Arial, Helvetica, sans-serif;"&gt;该方法依赖cancelQueue队列&lt;/span&gt;</span></div><div class="line">nHandles -= unregisterHandles();</div></pre></td></tr></table></figure>
<p>启动和关闭selector的操作比较NIO，就不解释了，直接截取registerHandles()和unregisterHandles()部分方法源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> ServerSocketChannel <span class="title">open</span><span class="params">(SocketAddress localAddress)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="comment">// Creates the listening ServerSocket</span></div><div class="line">    ServerSocketChannel channel = ServerSocketChannel.open();</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// This is a non blocking socket channel</span></div><div class="line">        channel.configureBlocking(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Configure the server socket,</span></div><div class="line">        ServerSocket socket = channel.socket();</div><div class="line"></div><div class="line">        <span class="comment">// Set the reuseAddress flag accordingly with the setting</span></div><div class="line">        socket.setReuseAddress(isReuseAddress());</div><div class="line"></div><div class="line">        <span class="comment">// and bind.</span></div><div class="line">        socket.bind(localAddress, getBacklog());</div><div class="line"></div><div class="line">        <span class="comment">// Register the channel within the selector for ACCEPT event</span></div><div class="line">        channel.register(selector, SelectionKey.OP_ACCEPT);</div><div class="line">        success = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">if</span> (!success) &#123;</div><div class="line">            close(channel);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> channel;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(ServerSocketChannel handle)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    SelectionKey key = handle.keyFor(selector);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</div><div class="line">        key.cancel();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    handle.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>processHandles(selectedHandles());</p>
<p>而最最关键也最最精彩的则是处理客户端连接的部分，我们下节继续。</p>
<p>版权声明：本文为博主原创文章，未经博主允许不得转载。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;http://blog.csdn.net/yoara/article/details/37382137&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;原文:http://blog.csdn.net/yoara/article/detail
    
    </summary>
    
      <category term="mina" scheme="https://smuwjs.github.io/categories/mina/"/>
    
    
      <category term="java mina" scheme="https://smuwjs.github.io/tags/java-mina/"/>
    
  </entry>
  
  <entry>
    <title>mina学习笔记二：从官方例子开始</title>
    <link href="https://smuwjs.github.io/2016/09/08/mina%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%BA%8C%EF%BC%9A%E4%BB%8E%E5%AE%98%E6%96%B9%E4%BE%8B%E5%AD%90%E5%BC%80%E5%A7%8B/"/>
    <id>https://smuwjs.github.io/2016/09/08/mina学习笔记二：从官方例子开始/</id>
    <published>2016-09-08T20:12:14.000Z</published>
    <updated>2017-05-05T09:48:30.740Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://blog.csdn.net/yoara/article/details/37324821" target="_blank" rel="external">原文：http://blog.csdn.net/yoara/article/details/37324821    </a></p>
<p>本节内容只介绍mina总体架构，同时给出官方的几个实用TCP、UDP的经典服务端客户端例子。</p>
<h1 id="mina体系结构"><a href="#mina体系结构" class="headerlink" title="mina体系结构"></a>mina体系结构</h1><p>mina位于用户程序和网络处理之间，将用户从复杂的网络处理中解耦，那我们就可以更加关注业务领域。</p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/73185035-file_1493951689595_62d1.png" alt="图2.1 mina鸟瞰图"></p>
<p>让我们再深入进去，mina框架内部的各个组件是怎么协调工作的呢？ <img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/1757032-file_1493951826742_1606b.png?imageView/2/w/450" alt="mina组件结构图"></p>
<p>显然，mina框架被分成了主要的3个组件部分：</p>
<ul>
<li>I/O Service，具体提供服务的组件。</li>
<li>I/O Filter Chain，过滤器链，用于支持各种切面服务。</li>
<li>I/O Handler，用于处理用户的业务逻辑。</li>
</ul>
<p>相对应的，为了创建一个基于mina的应用程序，我们需要：</p>
<ul>
<li>创建I/O Service ：可选择mina提供的Services如（*Acceptor）或实现自己的Service。</li>
<li>创建I/O Filter ：同样可以选择mina提供的各类filter，也可以实现自己的编解码过滤器等。</li>
<li>实现I/O Handler，实现Handler接口，处理各种消息。</li>
</ul>
<h1 id="服务端结构"><a href="#服务端结构" class="headerlink" title="服务端结构"></a>服务端结构</h1><p>服务端的作用就是开启监听端口，等待请求的到来、处理他们、以及将发送对请求的响应。同时，服务端会为每个连接创建session，在session周期内提供各种精度的服务，比如连接创建时(sessionCreated(IoSession session))、连接等待时(sessionIdle(IoSession session, IdleStatus status))、连接销毁时(sessionClosed(IoSession session))等。mina的api为TCP/UDP提供的一致性Server端操作。 <img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/13929582-file_1493951496846_fb87.png" alt="Server结构图"></p>
<ul>
<li>IOAcceptor 监听来自网络的请求。</li>
<li>当新的连接建立时，一个新的session会被创建，该session用作对同一IP/端口组合的客户端提供服务。</li>
<li>数据包需经过一系列的过滤器，这些过滤器可用来修改数据包的内容（如转换对象、添加或修改信息等），其中将原始字节流转换成POJO对象是非常有用的。当然这需要解编码器提供支持。</li>
<li>最后这些数据包或转化后的对象将交由IOHandler处理，我们将实现IOHandler用于处理具体的业务逻辑。</li>
</ul>
<h1 id="客户端结构"><a href="#客户端结构" class="headerlink" title="客户端结构"></a>客户端结构</h1><p>客户端需要连接服务端，发送请求并处理响应。实际上客户端的结构和服务端极其相似。 </p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/95294309-file_1493953292315_102b1.png" alt="图2.4 客户端结构"></p>
<ul>
<li>客户端首先需要创建IOConnector对象，绑定服务端的IP和端口。</li>
<li>一旦连接成功，一个于本次连接绑定的session对象将被创建。</li>
<li>客户端发送给服务端的请求都需要经过一系列的fliter。</li>
<li>同样，响应消息的接受也会经过一系列的filter再到IOHandler被处理。</li>
</ul>
<p>所以整体上，mina提供良好的一致性调用和封装结构。在使用mina创建基于网络的程序应用时，投入的学习成本比较低。</p>
<h1 id="TCP连接的例子"><a href="#TCP连接的例子" class="headerlink" title="TCP连接的例子"></a>TCP连接的例子</h1><p>依赖的Jar包：</p>
<ul>
<li>MINA 2.x Core</li>
<li>JDK 1.5 或以上</li>
<li><p>SLF4J 1.3.0 或以上</p>
<ul>
<li>Log4J 1.2： slf4j-api.jar, slf4j-log4j12.jar, Log4j 1.2.x</li>
<li>Log4J 1.3： slf4j-api.jar, slf4j-log4j13.jar, Log4j 1.3.x（注意，请确认log4j的版本）</li>
</ul>
<p>TCP Server端代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MinaTimeTest</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PORT = <span class="number">9123</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		<span class="comment">//首先，我们为服务端创建IoAcceptor，NioSocketAcceptor是基于NIO的服务端监听器</span></div><div class="line">		IoAcceptor acceptor = <span class="keyword">new</span> NioSocketAcceptor();</div><div class="line">		<span class="comment">//接着，如结构图示，在Acceptor和IoHandler之间将设置一系列的Fliter</span></div><div class="line">		<span class="comment">//包括记录过滤器和编解码过滤器。其中TextLineCodecFactory是mina自带的文本解编码器</span></div><div class="line">		acceptor.getFilterChain().addLast(<span class="string">"logger"</span>, <span class="keyword">new</span> LoggingFilter());</div><div class="line">		acceptor.getFilterChain().addLast(<span class="string">"codec"</span>,</div><div class="line">				<span class="keyword">new</span> ProtocolCodecFilter(<span class="keyword">new</span> TextLineCodecFactory(Charset.forName(<span class="string">"UTF-8"</span>))));</div><div class="line">		<span class="comment">//配置事务处理Handler，将请求转由TimeServerHandler处理。</span></div><div class="line">		acceptor.setHandler(<span class="keyword">new</span> TimeServerHandler());</div><div class="line">		<span class="comment">//配置Buffer的缓冲区大小</span></div><div class="line">		acceptor.getSessionConfig().setReadBufferSize(<span class="number">2048</span>);</div><div class="line">		<span class="comment">//设置等待时间，每隔IdleTime将调用一次handler.sessionIdle()方法</span></div><div class="line">		acceptor.getSessionConfig().setIdleTime(IdleStatus.BOTH_IDLE, <span class="number">10</span>);</div><div class="line">		<span class="comment">//绑定端口</span></div><div class="line">		acceptor.bind(<span class="keyword">new</span> InetSocketAddress(PORT));</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeServerHandler</span> <span class="keyword">extends</span> <span class="title">IoHandlerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(IoSession session, Throwable cause)</span></span></div><div class="line">				<span class="keyword">throws</span> Exception &#123;</div><div class="line">			cause.printStackTrace();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">messageReceived</span><span class="params">(IoSession session, Object message)</span></span></div><div class="line">				<span class="keyword">throws</span> Exception &#123;</div><div class="line">			String str = message.toString();</div><div class="line">			<span class="keyword">if</span> (str.trim().equalsIgnoreCase(<span class="string">"quit"</span>)) &#123;</div><div class="line">				session.close(<span class="keyword">false</span>);</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			Date date = <span class="keyword">new</span> Date();</div><div class="line">			session.write(date.toString());</div><div class="line">			System.out.println(<span class="string">"Message written..."</span>);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionIdle</span><span class="params">(IoSession session, IdleStatus status)</span></span></div><div class="line">				<span class="keyword">throws</span> Exception &#123;</div><div class="line">			System.out.println(<span class="string">"IDLE "</span> + session.getIdleCount(status));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>TCP Client端代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeClient</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOSTNAME = <span class="string">"127.0.0.1"</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PORT = <span class="number">9123</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> CONNECT_TIMEOUT = <span class="number">30</span> * <span class="number">1000L</span>; <span class="comment">// 30 seconds</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">		<span class="comment">//创建Connector连接器</span></div><div class="line">		NioSocketConnector connector = <span class="keyword">new</span> NioSocketConnector();</div><div class="line">		<span class="comment">//设置连接超时时间</span></div><div class="line">		connector.setConnectTimeoutMillis(CONNECT_TIMEOUT);</div><div class="line">		</div><div class="line">		connector.getFilterChain().addLast(<span class="string">"codec"</span>,</div><div class="line">				<span class="keyword">new</span> ProtocolCodecFilter(<span class="keyword">new</span> TextLineCodecFactory()));</div><div class="line">		connector.getFilterChain().addLast(<span class="string">"logger"</span>, <span class="keyword">new</span> LoggingFilter());</div><div class="line">		<span class="comment">//非常简单的处理Handler，向服务器发送一个数字</span></div><div class="line">		connector.setHandler(<span class="keyword">new</span> ClientSessionHandler(<span class="number">1</span>));</div><div class="line">		IoSession session = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">//连接远程主机，设置IP和端口</span></div><div class="line">			ConnectFuture future = connector.connect(<span class="keyword">new</span> InetSocketAddress(</div><div class="line">					HOSTNAME, PORT));</div><div class="line">			<span class="comment">//等待连接建立</span></div><div class="line">			future.awaitUninterruptibly();</div><div class="line">			<span class="comment">//连接建立后返回会话session</span></div><div class="line">			session = future.getSession();</div><div class="line">		&#125; <span class="keyword">catch</span> (RuntimeIoException e) &#123;</div><div class="line">			System.err.println(<span class="string">"Failed to connect."</span>);</div><div class="line">			e.printStackTrace();</div><div class="line">			Thread.sleep(<span class="number">5000</span>);</div><div class="line">		&#125; <span class="keyword">finally</span>&#123;</div><div class="line">			<span class="keyword">if</span>(session!=<span class="keyword">null</span>)&#123;</div><div class="line">				<span class="comment">//等待本次连接通话结束，不可中断式的阻塞等待</span></div><div class="line">				session.getCloseFuture().awaitUninterruptibly();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//关闭连接</span></div><div class="line">		connector.dispose();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientSessionHandler</span> <span class="keyword">extends</span> <span class="title">IoHandlerAdapter</span> </span>&#123;</div><div class="line">	    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</div><div class="line">	    <span class="function"><span class="keyword">public</span> <span class="title">ClientSessionHandler</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</div><div class="line">	        <span class="keyword">this</span>.value = value;</div><div class="line">	    &#125;</div><div class="line">	    <span class="meta">@Override</span></div><div class="line">	    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionOpened</span><span class="params">(IoSession session)</span> </span>&#123;</div><div class="line">	    	session.write(value);</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    <span class="meta">@Override</span></div><div class="line">	    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">messageReceived</span><span class="params">(IoSession session, Object message)</span> </span>&#123;</div><div class="line">	        System.out.println(message);</div><div class="line">	        session.close(<span class="keyword">true</span>);</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    <span class="meta">@Override</span></div><div class="line">	    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(IoSession session, Throwable cause)</span> </span>&#123;</div><div class="line">	        session.close(<span class="keyword">true</span>);</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="UDP连接的例子"><a href="#UDP连接的例子" class="headerlink" title="UDP连接的例子"></a>UDP连接的例子</h1><p>UDP服务端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UdpServer</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> PORT = <span class="number">9234</span>;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		<span class="comment">//创建UDPAcceptor</span></div><div class="line">		NioDatagramAcceptor acceptor = <span class="keyword">new</span> NioDatagramAcceptor(<span class="keyword">null</span>);</div><div class="line">		<span class="comment">//这次不设置字符解编码器filter，消息直接用Buffer字节流传递</span></div><div class="line">		acceptor.getFilterChain().addLast(<span class="string">"logger"</span>, <span class="keyword">new</span> LoggingFilter());</div><div class="line">		acceptor.setHandler(<span class="keyword">new</span> UDPHandler());</div><div class="line">		acceptor.getSessionConfig().setIdleTime(IdleStatus.BOTH_IDLE, <span class="number">10</span>);</div><div class="line">		acceptor.getSessionConfig().setReuseAddress(<span class="keyword">true</span>);<span class="comment">//&lt;span style="font-family: Arial, Helvetica, sans-serif;"&gt;NioDatagramAcceptor 设置为null，才能重复使用端口&lt;/span&gt;</span></div><div class="line">		acceptor.bind(<span class="keyword">new</span> InetSocketAddress(PORT));</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UDPHandler</span> <span class="keyword">extends</span> <span class="title">IoHandlerAdapter</span></span>&#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">messageReceived</span><span class="params">(IoSession session, Object message)</span></span></div><div class="line">				<span class="keyword">throws</span> Exception &#123;</div><div class="line">			IoBuffer buffer = (IoBuffer)message;</div><div class="line">			System.out.println(buffer.getLong());</div><div class="line">			session.close(<span class="keyword">false</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionIdle</span><span class="params">(IoSession session, IdleStatus status)</span></span></div><div class="line">				<span class="keyword">throws</span> Exception &#123;</div><div class="line">			System.out.println(<span class="string">"IDLE "</span> + session.getIdleCount(status));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>UDP客户端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UdpClient</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> IoSession session = <span class="keyword">null</span>;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		NioDatagramConnector connect = <span class="keyword">new</span> NioDatagramConnector();</div><div class="line">		connect.setHandler(<span class="keyword">new</span> UDPClientHandler());</div><div class="line">		<span class="keyword">try</span>&#123;</div><div class="line">			ConnectFuture future = connect.connect(<span class="keyword">new</span> InetSocketAddress(<span class="string">"127.0.0.1"</span>,<span class="number">9234</span>));</div><div class="line">			future.awaitUninterruptibly();</div><div class="line">			session = future.getSession();</div><div class="line">			<span class="comment">//增加连接建立完成后的监听器。</span></div><div class="line">			<span class="comment">//若在建立完成后才添加监听器，监听器将马上执行</span></div><div class="line">			future.addListener(<span class="keyword">new</span> IoFutureListener&lt;ConnectFuture&gt;()&#123;</div><div class="line">	            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ConnectFuture future)</span> </span>&#123;</div><div class="line">	                <span class="keyword">if</span>( future.isConnected() )&#123;</div><div class="line">	                    <span class="keyword">try</span> &#123;</div><div class="line">	                        sendData();</div><div class="line">	                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">	                        e.printStackTrace();</div><div class="line">	                    &#125;</div><div class="line">	                &#125; <span class="keyword">else</span> &#123;</div><div class="line">	                    System.out.println((<span class="string">"Not connected...exiting"</span>));</div><div class="line">	                &#125;</div><div class="line">	            &#125;</div><div class="line">	        &#125;);</div><div class="line">		&#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">			</div><div class="line">		&#125;<span class="keyword">finally</span>&#123;</div><div class="line">			<span class="keyword">if</span>(session!=<span class="keyword">null</span>)&#123;</div><div class="line">        	    session.getCloseFuture().awaitUninterruptibly();</div><div class="line">        	&#125;</div><div class="line">		&#125;</div><div class="line">		connect.dispose();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendData</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="keyword">long</span> free = Runtime.getRuntime().freeMemory();</div><div class="line">        IoBuffer buffer = IoBuffer.allocate(<span class="number">8</span>);</div><div class="line">        buffer.putLong(free);</div><div class="line">        buffer.flip();</div><div class="line">        session.write(buffer);</div><div class="line">        <span class="comment">//因为是UDP，客户端需主动关闭连接</span></div><div class="line">        session.close(<span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UDPClientHandler</span> <span class="keyword">extends</span> <span class="title">IoHandlerAdapter</span></span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>这一节介绍了mina的组件结构和框架体系，用几个案例简单介绍了下mina的使用方法。在日常的开发中，其实已经足够了。</p>
<p>版权声明：本文为博主原创文章，未经博主允许不得转载。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;http://blog.csdn.net/yoara/article/details/37324821&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;原文：http://blog.csdn.net/yoara/article/detail
    
    </summary>
    
      <category term="mina" scheme="https://smuwjs.github.io/categories/mina/"/>
    
    
      <category term="java mina" scheme="https://smuwjs.github.io/tags/java-mina/"/>
    
  </entry>
  
  <entry>
    <title>mina学习笔记一：mina上路</title>
    <link href="https://smuwjs.github.io/2016/09/08/mina%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%80%EF%BC%9Amina%E4%B8%8A%E8%B7%AF/"/>
    <id>https://smuwjs.github.io/2016/09/08/mina学习笔记一：mina上路/</id>
    <published>2016-09-08T20:12:13.000Z</published>
    <updated>2017-05-05T09:48:30.740Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://blog.csdn.net/yoara/article/details/37117477" target="_blank" rel="external">原文：http://blog.csdn.net/yoara/article/details/37117477</a></p>
<p>很久以前用mina做过项目，当时的感觉就是很轻松简单，几行代码就能写好复杂的网络连接雏形，不用考虑请求阻塞，不用考虑客户端的负荷压力。做了好些年业务代码，有时候回头看看自己的技术底蕴真的有些欠缺。最近重拾起NIO和并发编程的内容，java api了解了大概，通过对mina的学习，也算是巩固和升华吧。</p>
<p>起篇的意义在于对mina的背景了解和mina框架的鸟瞰，NIO是什么？为什么还需要在NIO的基础上重新开发出一套mina框架？带着问题我们进入主题。</p>
<h1 id="NIO-VS-IO"><a href="#NIO-VS-IO" class="headerlink" title="NIO VS IO"></a><strong>NIO VS IO</strong></h1><p>NIO即所谓的new IO(也称为Non-Blocking IO)，是Java在1.4版本引入的用以解决java.io在系统伸缩性上瓶颈的新的架构设计。java.io类主要分为字符流（Reader/Writer）和字节流(Input/OutputStream)，无一例外的是阻塞式的。阻塞式代码带来的问题就是系统的性能瓶颈就受制于串行的挂起等待，线程因为磁盘IO操作或套接字的连接传输等而被挂起，在这其间不仅CPU资源被闲置浪费，也不能通过横向的增加硬件设备以得到很好的缓解负荷提升性能的目的。</p>
<p>于是NIO引入了一套非阻塞的机制。 java.nio框架主要包含以下几个构成部分：</p>
<ul>
<li>Buffer：缓冲区，数据的载体。</li>
<li>Channel：数据通道，他要么从Buffer中获取数据并向flie或socket写，要么从file或socket中获取数据往Buffer中写。</li>
<li>Selector：提供多路复用的非阻塞IO选择器。</li>
<li>Charset：用于字节到Unicode字符集的转码工具。</li>
<li>Regexp：正则表达式工具类</li>
</ul>
<p>NIO提供多路复用的机制，他把读写IO的操作委托给操作系统（select()/poll()）。当操作系统从数据源读入数据，并将它存放到nio指定的Buffer缓冲区后，就会提醒Selector选择器，某一Channel通道的数据已经准备就绪。这时Selector告诉用户线程数据已到位可以来做对应的业务处理了。如图1.1</p>
<p><img src="http://opesdt6ii.bkt.clouddn.com/17-5-5/46097041-file_1493950446253_9186.png?imageView/2/w/300" alt="图1.1 nio总体结构"><br>    相较于IO，NIO的优势在于，用户线程不需要在串行的等待数据的IO操作，操作系统代替了用户去准备，这时用户线程可以从当前阻塞中脱离并去做其他的事情。同时在服务器端也不必为连接客户端而持有大量的处理线程，只需单线程的selector负责监听即可实现高伸缩性的网络应用。（事实上NIO主要分为文件(File)IO和套接字(Socket)IO，File 类操作依旧是阻塞式的。FileChannel没有实现SelectedChannel，而选择器只接受实现自此接口的通道注册。本质的原因是基于文件的IO操作系统已经有了足够的优化和预读取机制，并且更重要的一点是可以实现异步IO。而多路复用其实是一种同步的IO，具体可参详LInux的5种IO方式。）</p>
<h1 id="为什么需要mina"><a href="#为什么需要mina" class="headerlink" title="为什么需要mina"></a>为什么需要mina</h1><p>相较于业务功能的开发，网络通讯更偏向于底层。可能大多数程序员在学校里学完以后，在以后的工作中就很难用到。毕竟，Java的好处就是取之不尽的框架，不同的人把焦点集中在不同层面，既避免了重复造轮子也提高了生产效率。</p>
<p>对于阻塞式的IO，线程需要等待；而对于非阻塞式的IO，仍然需要单线程去轮询selector的状态。mina将封装了这些网络层的处理，对用户是透明的。它简化了TCP、UDP、串行通信程序等网络连接的使用；简化了服务端和客户端的使用。在高扩展性、性能和内存使用（据说netty做的更好，不过这两个框架基本思想差不多）方面给用户提供有力的支持。</p>
<p>mina是简单但功能齐全的网络应用程序框架，它的主要特性包括：</p>
<ul>
<li>为各种网络通讯提供统一的API。<ul>
<li>基于Java NIO 的TCP/IP UDP/IP。</li>
<li>基于RXTX的串行通信程序。</li>
<li>基于VM内部的管道通讯。</li>
<li>支持自定义实现。</li>
</ul>
</li>
<li>可扩展的过滤器链，类似Serlvet的过滤器模型。</li>
<li>底层和抽象层的数据API。<ul>
<li>底层：可基于ByteBuffer使用。</li>
<li>抽象层：用户自定义的消息对象和解编码方式。</li>
</ul>
</li>
<li>高度可定制的线程模型。<ul>
<li>单线程</li>
<li>单线程池</li>
<li>多个线程池</li>
</ul>
</li>
<li>基于Java 5 SSLEngine进行了封装，支持开箱即用的SSL、TLS、StartTLS等。（？）</li>
<li>过载保护和流量控制。</li>
<li>可使用mock对象进行方便的单元测试。</li>
<li>集成JMX的管理架构</li>
<li>支持流IO（Stream-Base I/O）的操作，通过实现StreamIoHandle。</li>
<li>可被常用的容器框架集成管理，如Spring。</li>
<li>能从Netty平滑的迁移过度到Mina。</li>
</ul>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>  总体介绍就是这样了，下一节从官方的例子开始，一步一步的剖析mina吧。</p>
<p>版权声明：本文为博主原创文章，未经博主允许不得转载。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;http://blog.csdn.net/yoara/article/details/37117477&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;原文：http://blog.csdn.net/yoara/article/detail
    
    </summary>
    
      <category term="mina" scheme="https://smuwjs.github.io/categories/mina/"/>
    
    
      <category term="java mina" scheme="https://smuwjs.github.io/tags/java-mina/"/>
    
  </entry>
  
  <entry>
    <title>使用GitHub搭建Hexo博客</title>
    <link href="https://smuwjs.github.io/2016/09/08/GitHub+Hexo/"/>
    <id>https://smuwjs.github.io/2016/09/08/GitHub+Hexo/</id>
    <published>2016-09-08T20:12:12.000Z</published>
    <updated>2017-05-05T09:48:30.740Z</updated>
    
    <content type="html"><![CDATA[<p>来到GitHub这么长时间，才开始真真的了解GitHub，这个国外的代码托管平台，充满着大牛的身影。<br>国内也有不多少的代码托管平台，本文将就用GitHub的GitHub Pages 功能来搭建，我的个性博客，最近在学习JS后端Node.js, 现在火的不行, 异步IO的机制, 所以在学习过程中发现了<a href="2">hexo</a>是由Node.js驱动的一款快速、简单且功能强大的博客框架。<br>比起WordPress，hexo的搭建更加简洁，配合上markdown的使用，更加便捷的管理自己的学习文档。<br><a id="more"></a></p>
<h1 id="概况"><a href="#概况" class="headerlink" title="概况"></a>概况</h1><blockquote>
<ol>
<li>为什么选择<a href="1">GitHub Pages</a><br>1、<a href="1">GitHub Pages</a>有免费的代码托管空间，资料自己管理，保存可靠；<br>2、学着用 GitHub，享受 GitHub 的便利，上面有很多大牛，眼界会开阔很多；<br>3、顺便理解 GitHub 工作原理，最好的团队协作流程；<br>4、GitHub建立私有仓库才会收费，所以会有很多开源代码。</li>
<li><a href="1">GitHub Pages</a>是什么<br>应用GitHub Pages创建属于自己的个人博客，GitHub将提供免费的空间。GitHub提供的域名（用户名+github+io）,在Repository name对应处填写资源名，其需要使用自己的用户名，每个用户名下面只能建立一个，并且资源命名必须符合这样的规则username/username.github.io，之后勾选下面的”Initialize this repository with a README” 。</li>
<li><a href="2">hexo</a>出自何人<br>hexo出自台湾大学生 tommy351 之手，是一个基于Node.js的静态博客程序，其编译上百篇文字只需要几秒。hexo生成的静态网页可以直接放到GitHub Pages，BAE，SAE等平台上。</li>
</ol>
</blockquote>
<h1 id="安装准备"><a href="#安装准备" class="headerlink" title="安装准备"></a>安装准备</h1><blockquote>
<p>环境搭建：</p>
<ol>
<li><a href="http://nodejs.org/" target="_blank" rel="external">Node.js</a>：下载<a href="https://nodejs.org/en/" target="_blank" rel="external">地址</a></li>
<li><a href="http://git-scm.com/" target="_blank" rel="external">Git</a>：下载<a href="https://git-scm.com/download/win" target="_blank" rel="external">地址</a></li>
<li><a href="http://www.sublimetext.com/" target="_blank" rel="external">Sublime</a>：下载<a href="http://www.sublimetext.com/2" target="_blank" rel="external">地址</a><h2 id="安装Node"><a href="#安装Node" class="headerlink" title="安装Node"></a>安装Node</h2>到 Node.js 官网下载相应平台的 最新版本 ，一路安装即可。我用的是 node-v0.10.22-x86.msi<h2 id="安装Git"><a href="#安装Git" class="headerlink" title="安装Git"></a>安装Git</h2>Git的客户端很多，我用的是 msysgit ，喜欢用绿色版本 Portable application for official Git for Windows 1.8.4 ，下载下来设置一下环境变量即可，Git_HOME，%Git_HOME%\bin之类的，不多说。<h2 id="安装Sublime"><a href="#安装Sublime" class="headerlink" title="安装Sublime"></a>安装Sublime</h2>Sublime Text 2 在这里仅仅作为一个文本编辑器使用，支持各种编程语言和文件格式，当然也支持Markdown语法，实在是个不可多得的练码奇才。喜欢追鲜的也可以尝试处于beta版本的 Sublime Text 3 。</li>
</ol>
</blockquote>
<h1 id="GitHub注册与配置"><a href="#GitHub注册与配置" class="headerlink" title="GitHub注册与配置"></a>GitHub注册与配置</h1><blockquote>
<ol>
<li><p>注册：<br>访问：<a href="0">GitHub</a>，注册你的username和邮箱，邮箱十分重要，GitHub上很多通知都是通过邮箱的。注册过程比较简单，详细也可以看：<br>使用Github Page搭建博客, 需要遵循一定的规则, 需要在github建立仓库,仓库名为Github用户.github.io, 更多详情请参考<a href="https://pages.github.com/" target="_blank" rel="external">官方文档</a></p>
</li>
<li><p>配置和使用Github<br>以下教程主要参考beiyuu的<a href="http://beiyuu.com/github-pages/" target="_blank" rel="external">《使用Github Pages建独立博客》</a>写成。</p>
</li>
<li><p>配置SSH keys<br>我们如何让本地git项目与远程的github建立联系呢？用SSH keys。<br>打开Git Bash工具，执行以下操作</p>
</li>
<li><p>检查SSH keys的设置</p>
</li>
</ol>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">    首先我们需要检查你电脑上现有的ssh key：</div><div class="line"></div><div class="line">$ cd ~/. ssh 检查本机的ssh密钥</div><div class="line"></div><div class="line">    如果提示：No such file or directory 说明你是第一次使用git。</div><div class="line"></div><div class="line">    生成新的SSH Key：</div><div class="line"></div><div class="line">$ ssh-keygen -t rsa -C &quot;邮件地址@youremail.com&quot;</div><div class="line">Generating public/private rsa key pair.</div><div class="line">Enter file in which to save the key </div><div class="line">(/Users/your_user_directory/.ssh/id_rsa):&lt;回车就好&gt;</div></pre></td></tr></table></figure>
<p>注意1: 此处的邮箱地址，你可以输入自己的邮箱地址；<br>注意2: 此处的「-C」的是大写的「C」</p>
<pre><code>然后系统会要你输入密码：
</code></pre><p>Enter passphrase (empty for no passphrase):&lt;输入加密串&gt;<br>Enter same passphrase again:&lt;再次输入加密串&gt;</p>
<p>在回车中会提示你输入一个密码，这个密码会在你提交项目时使用，如果为空的话提交项目时则不用输入。这个设置是防止别人往你的项目里提交内容。</p>
<p>注意：输入密码的时候没有*字样的，你直接输入就可以了。</p>
<p>最后看到这样的界面，就成功设置ssh key了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<blockquote>
<ol>
<li>添加SSH Key到GitHub<br>在本机设置SSH Key之后，需要添加到GitHub上，以完成SSH链接的设置。</li>
<li>打开本地C:\Documents and Settings\Administrator.ssh\id_rsa.pub文件。此文件里面内容为刚才生成人密钥。如果看不到这个文件，你需要设置显示隐藏文件。准确的复制这个文件的内容，才能保证设置的成功。</li>
<li>登陆github系统。点击右上角的 Account Settings—&gt;SSH Public keys —&gt; add another public keys</li>
<li><p>把你本地生成的密钥复制到里面（key文本框中）， 点击 add key 就ok了</p>
</li>
<li><p>测试</p>
</li>
</ol>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">    可以输入下面的命令，看看设置是否成功，git@github.com的部分不要修改：</div><div class="line"></div><div class="line">$ ssh -T git@github.com</div><div class="line"></div><div class="line">    如果是下面的反馈：</div><div class="line"></div><div class="line">The authenticity of host &apos;github.com (207.97.227.239)&apos; can&apos;t be established.</div><div class="line">RSA key fingerprint is 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48.</div><div class="line">Are you sure you want to continue connecting (yes/no)?</div><div class="line"></div><div class="line">    不要紧张，输入yes就好，然后会看到：</div><div class="line"></div><div class="line">Hi cnfeat! You&apos;ve successfully authenticated, </div><div class="line">but GitHub does not provide shell access.</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    设置用户信息：</div><div class="line">    现在你已经可以通过SSH链接到GitHub了，还有一些个人信息需要完善的。</div><div class="line">    Git会根据用户的名字和邮箱来记录提交。</div><div class="line">    GitHub也是用这些信息来做权限的处理，输入下面的代码进行个人信息的设置，把名称和邮箱替换成你自己的，名字必须是你的真名，而不是GitHub的昵称。</div><div class="line"></div><div class="line">$ git config --global user.name &quot;cnfeat&quot;//用户名</div><div class="line">$ git config --global user.email &quot;cnfeat@gmail.com&quot;//填写自己的邮箱</div><div class="line"></div><div class="line">    SSH Key配置成功，本机已成功连接到github。</div></pre></td></tr></table></figure>
<h1 id="Hexo博客"><a href="#Hexo博客" class="headerlink" title="Hexo博客"></a>Hexo博客</h1><blockquote>
<p>Hexo<br>Hexo的作者是<a href="https://github.com/tommy351/hexo" target="_blank" rel="external">tommy351</a>，根据<a href="http://hexo.io/docs/index.html" target="_blank" rel="external">官方介绍</a>，Hexo是一个简单、快速、强大的博客发布工具，支持Markdown格式。hexo的主题列表 <a href="http://github.com/tommy351/hexo/wiki/Themes" target="_blank" rel="external">Hexo Themes</a>。 我比较喜欢 <a href="http://github.com/A-limon/pacman" target="_blank" rel="external">pacman</a> ， <a href="http://github.com/heroicyang/hexo-theme-modernist" target="_blank" rel="external">modernist</a> 、 <a href="http://github.com/DavidKk/Hexo.ishgo" target="_blank" rel="external">ishgo</a> ， <a href="http://github.com/raytaylorlin/hexo-theme-raytaylorism" target="_blank" rel="external">raytaylorism</a> 。 </p>
</blockquote>
<h2 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h2><p>打开Git Bash工具（前提确保Node.js已经安装，环境配置OK）</p>
<pre><code>$ npm install -g hexo
</code></pre><blockquote>
<p>注释：</p>
</blockquote>
<p>执行命令：npm install -g hexo，报错如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">npm ERR! Error: shasum check failed for C:\Users\ADMINI~1\AppData\Local\Temp\npm</div><div class="line">-30024-KDJHJzgP\registry.npmjs.org\hexo-cli\-\hexo-cli-0.1.6.tgz</div><div class="line">npm ERR! Expected: 7dc3ab939d0889c4bed6a961605ff3e2d67f67a2</div><div class="line">npm ERR! Actual:   41de7d67a9b764352eb07c49c32fc38dd7f479b9</div><div class="line">npm ERR! From:     https://registry.npmjs.org/hexo-cli/-/hexo-cli-0.1.6.tgz</div><div class="line">npm ERR!     at d:\Program Files\nodejs\node_modules\npm\node_modules\sha\index.</div><div class="line">js:38:8</div><div class="line">npm ERR!     at ReadStream.&lt;anonymous&gt; (d:\Program Files\nodejs\node_modules\npm</div><div class="line">\node_modules\sha\index.js:85:7)</div><div class="line">npm ERR!     at ReadStream.emit (events.js:117:20)</div><div class="line">npm ERR!     at _stream_readable.js:943:16</div><div class="line">npm ERR!     at process._tickCallback (node.js:419:13)</div><div class="line">npm ERR! If you need help, you may report this *entire* log,</div><div class="line">npm ERR! including the npm and node versions, at:</div><div class="line">npm ERR!     &lt;http://github.com/npm/npm/issues&gt;</div><div class="line"></div><div class="line">npm ERR! System Windows_NT 6.2.9200</div><div class="line">npm ERR! command &quot;d:\\Program Files\\nodejs\\node.exe&quot; &quot;d:\\Program Files\\nodej</div><div class="line">s\\node_modules\\npm\\bin\\npm-cli.js&quot; &quot;install&quot; &quot;-g&quot; &quot;hexo&quot;</div><div class="line">npm ERR! cwd C:\Users\Administrator\Desktop</div><div class="line">npm ERR! node -v v0.10.31</div><div class="line">npm ERR! npm -v 1.4.23</div><div class="line">npm ERR! registry error parsing json</div><div class="line">npm ERR!</div><div class="line">npm ERR! Additional logging details can be found in:</div><div class="line">npm ERR!     C:\Users\Administrator\Desktop\npm-debug.log</div><div class="line">npm ERR! not ok code 0</div><div class="line"></div><div class="line">    莫非是因为被墙了？换国内镜像源试试。</div><div class="line">npm config set registry=&quot;http://registry.cnpmjs.org&quot;，</div><div class="line">    然后再次执行npm install -g hexo，成功！</div></pre></td></tr></table></figure>
<h2 id="部署Hexo"><a href="#部署Hexo" class="headerlink" title="部署Hexo"></a>部署Hexo</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">    在我的电脑中建立一个名字叫「Hexo」的文件夹，然后在此文件夹中右键打开Git Bash。</div><div class="line"></div><div class="line">$ hexo init</div><div class="line"></div><div class="line">    如果无法使用右击“Git Bash”，则可以切换到指定目录</div><div class="line"></div><div class="line">    UUhike@UUhike-pc MINGW64 ~</div><div class="line">$ cd j:/github/hexo</div><div class="line">    UUhike@UUhike-pc MINGW64 /j/github/hexo</div><div class="line"></div><div class="line">    安装依赖包</div><div class="line">$ npm install</div><div class="line"></div><div class="line">    Hexo随后会自动在目标文件夹建立网站所需要的所有文件。</div><div class="line">    现在我们已经搭建起本地的hexo博客了，执行以下命令(在H:\hexo)，然后到浏览器输入localhost:4000看看。</div><div class="line"></div><div class="line">    本地查看</div><div class="line"></div><div class="line">$ hexo generate #生成静态页面至public目录（最终上传这个文件到GitHub）</div><div class="line"></div><div class="line">$ hexo server #开启预览访问端口（默认端口4000，&apos;ctrl + c&apos;关闭server）</div></pre></td></tr></table></figure>
<h2 id="部署到GitHub"><a href="#部署到GitHub" class="headerlink" title="部署到GitHub"></a>部署到GitHub</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">编辑E:\hexo下的_config.yml，修改Deployment部分：</div><div class="line"></div><div class="line"># Deployment</div><div class="line">## Docs: http://hexo.io/docs/deployment.html</div><div class="line">deploy:</div><div class="line">  type: git</div><div class="line">    repository: https://github.com/luuman/luuman.github.io.git</div><div class="line">    branch: master</div></pre></td></tr></table></figure>
<blockquote>
<p>注释：</p>
</blockquote>
<p>hexo d，执行该命令，报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">ERROR Deployer not found: git</div><div class="line"></div><div class="line">执行命令：</div><div class="line">npm install hexo-deployer-git --save</div><div class="line">再次执行hexo d,报错：</div><div class="line"></div><div class="line">INFO  Deploying: git</div><div class="line">INFO  Clearing .deploy folder...</div><div class="line">INFO  Copying files from public folder...</div><div class="line">warning: LF will be replaced by CRLF in 2015/05/30/hello-world/index.html.</div><div class="line">The file will have its original line endings in your working directory.</div><div class="line">......</div><div class="line">*** Please tell me who you are.</div><div class="line"></div><div class="line">Run</div><div class="line"></div><div class="line">  git config --global user.email &quot;you@example.com&quot;</div><div class="line">  git config --global user.name &quot;Your Name&quot;</div><div class="line"></div><div class="line">to set your account&apos;s default identity.</div><div class="line">Omit --global to set the identity only in this repository.</div><div class="line"></div><div class="line">fatal: unable to auto-detect email address (got &apos;Administrator@PC-201505290750.(none)&apos;)</div><div class="line">Username for &apos;https://github.com&apos;: voidking</div><div class="line">Password for &apos;https://voidking@github.com&apos;:</div><div class="line">error: src refspec master does not match any.</div><div class="line">error: failed to push some refs to &apos;https://github.com/voidking/voidking.github.io.git&apos;</div><div class="line">FATAL Something&apos;s wrong. Maybe you can find the solution here: http://hexo.io/docs/troubleshooting.html</div><div class="line">Error: error: src refspec master does not match any.</div><div class="line">error: failed to push some refs to &apos;https://github.com/voidking/voidking.github.io.git&apos;</div><div class="line"></div><div class="line">    at ChildProcess.&lt;anonymous&gt; (E:\hexo\node_modules\hexo-deployer-git\node_modules\hexo-util\lib\spawn.js:42:17)</div><div class="line">    at ChildProcess.emit (events.js:98:17)</div><div class="line">    at maybeClose (child_process.js:756:16)</div><div class="line">    at Process.ChildProcess._handle.onexit (child_process.js:823:5)</div></pre></td></tr></table></figure>
<p>hexo d，执行该命令，报错：</p>
<h2 id="复制cnfeat的主题"><a href="#复制cnfeat的主题" class="headerlink" title="复制cnfeat的主题"></a>复制cnfeat的主题</h2><p>以下进入复制主题环节，如果那一步出现问题，或者修改后没有显示修改的结果，建议来来一个，再看看，可以解决很多问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ hexo clean</div><div class="line"></div><div class="line">$ hexo generate #生成静态页面至public目录（最终上传这个文件到GitHub）</div><div class="line"></div><div class="line">$ hexo server #开启预览访问端口（默认端口4000，&apos;ctrl + c&apos;关闭server）</div><div class="line"></div><div class="line">建立了Hexo文件，复制我的主题了到themes文件夹中</div><div class="line">yilia</div><div class="line">$ git clone https://github.com/litten/hexo-theme-yilia.git themes/yilia</div><div class="line">modernist</div><div class="line">$ git clone https://github.com/heroicyang/hexo-theme-modernist.git themes/modernist</div><div class="line">jacman</div><div class="line">$ git clone https://github.com/cnfeat/cnfeat.git themes/jacman</div></pre></td></tr></table></figure>
<h2 id="启用cnfeat的主题"><a href="#启用cnfeat的主题" class="headerlink" title="启用cnfeat的主题"></a>启用cnfeat的主题</h2><p>修改Hexo目录下的config.yml配置文件中的theme属性，将其设置为jacman。同时请设置stylus属性中的compress值为true。<br>theme: jacman</p>
<p>注意：Hexo有两个config.yml文件，一个在根目录，一个在theme下，此时修改的是在根目录下的。</p>
<pre><code>更新主题

$ cd themes/jacman
$ git pull
</code></pre><p>注意：为避免出错，请先备份你的_config.yml 文件后再升级<br>本地查看调试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$ hexo g #生成</div><div class="line">$ hexo s #启动本地服务，进行文章预览调试</div><div class="line"></div><div class="line">或者直接作用组合命令</div><div class="line"></div><div class="line">$ hexo deploy -g</div><div class="line">$ hexo server -g</div><div class="line"></div><div class="line">简写：</div><div class="line"></div><div class="line">hexo n == hexo new</div><div class="line">hexo g == hexo generate</div><div class="line">hexo s == hexo server</div><div class="line">hexo d == hexo deploy</div></pre></td></tr></table></figure>
<blockquote>
<p>4、浏览器中查看效果</p>
</blockquote>
<p>浏览器输入<a href="http://localhost:4000" target="_blank" rel="external">http://localhost:4000</a> ，查看搭建效果。此后的每次变更_config.yml文件或者上传文件都可以先用此命令调试，非常好用，尤其是当你想调试出自己想要的主题时。</p>
<p>#进阶篇：Hexo设置</p>
<p>网站搭建完成后，就可以根据自己爱好来对Hexo生成的网站进行设置了，对整站的设置，只要修改项目目录的hexo/_config.yml就可以了，这是我的设置，可供参考。</p>
<blockquote>
<p>默认目录结构：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">.</div><div class="line">├── .deploy</div><div class="line">├── public</div><div class="line">├── scaffolds</div><div class="line">├── scripts</div><div class="line">├── source</div><div class="line">|   ├── _drafts</div><div class="line">|   └── _posts</div><div class="line">├── themes</div><div class="line">├── _config.yml</div><div class="line">└── package.json</div></pre></td></tr></table></figure>
<blockquote>
<p>hexo/_config.yml</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"># Hexo Configuration</div><div class="line">## Docs: http://hexo.io/docs/configuration.html</div><div class="line">## Source: https://github.com/hexojs/hexo/</div><div class="line"></div><div class="line"># Site #整站的基本信息</div><div class="line">title: 1000 words a Day #网站标题</div><div class="line">subtitle: Writing 1000 Words a Day Changes My Life #网站副标题</div><div class="line">description: 学习总结 思考感悟 知识管理 #网站描述</div><div class="line">author:  cnFeat #网站作者，在下方显示</div><div class="line">email: cnFeat@gmail.com #联系邮箱</div><div class="line">language: zh-CN #主题实际的文件名称</div><div class="line">timezone:</div><div class="line"></div><div class="line"># URL #这项暂不配置，绑定域名后，欲创建sitemap.xml需要配置该项</div><div class="line">## If your site is put in a subdirectory, set url as &apos;http://yoursite.com/child&apos; and root as &apos;/child/&apos;</div><div class="line">url: http://yoursite.com</div><div class="line">root: /</div><div class="line">permalink: :year/:month/:day/:title/</div><div class="line">permalink_defaults:</div><div class="line"></div><div class="line"># Directory</div><div class="line">source_dir: source</div><div class="line">public_dir: public</div><div class="line">tag_dir: tags</div><div class="line">archive_dir: archives</div><div class="line">category_dir: categories</div><div class="line">code_dir: downloads/code</div><div class="line">i18n_dir: :lang</div><div class="line">skip_render:</div><div class="line"></div><div class="line"># Writing 文章布局、写作格式的定义，不修改</div><div class="line">new_post_name: :title.md # File name of new posts</div><div class="line">default_layout: post</div><div class="line">titlecase: false # Transform title into titlecase</div><div class="line">external_link: true # Open external links in new tab</div><div class="line">filename_case: 0</div><div class="line">render_drafts: false</div><div class="line">post_asset_folder: false</div><div class="line">relative_link: false</div><div class="line">future: true</div><div class="line">highlight:</div><div class="line">  enable: true</div><div class="line">  line_number: true</div><div class="line">  auto_detect: true</div><div class="line">  tab_replace:</div><div class="line"></div><div class="line"># Category &amp; Tag</div><div class="line">default_category: uncategorized</div><div class="line">category_map:</div><div class="line">tag_map:</div><div class="line"></div><div class="line"># Date / Time format 日期格式，不修改</div><div class="line">## Hexo uses Moment.js to parse and display date</div><div class="line">## You can customize the date format as defined in</div><div class="line">## http://momentjs.com/docs/#/displaying/format/</div><div class="line">date_format: YYYY-MM-DD</div><div class="line">time_format: HH:mm:ss</div><div class="line"></div><div class="line"># Pagination 每页显示文章数，可以自定义，我将10改成了5</div><div class="line">## Set per_page to 0 to disable pagination</div><div class="line">per_page: 5</div><div class="line">pagination_dir: page</div><div class="line"></div><div class="line"># Disqus Disqus插件，我们会替换成“多说”，不修改</div><div class="line">disqus_shortname:</div><div class="line"></div><div class="line"># Extensions</div><div class="line">## Plugins: http://hexo.io/plugins/</div><div class="line">## Themes: http://hexo.io/themes/</div><div class="line">theme: spfk</div><div class="line"></div><div class="line"></div><div class="line"># 自动生成sitemap</div><div class="line">sitemap:</div><div class="line">path: sitemap.xml</div><div class="line">baidusitemap:</div><div class="line">path: baidusitemap.xml</div><div class="line"></div><div class="line"></div><div class="line"># Deployment 站点部署到github要配置，上一节中已经讲过</div><div class="line">## Docs: http://zespia.tw/hexo/docs/deploy.html</div><div class="line">deploy:</div><div class="line">  type: git</div><div class="line">  repository: git@github.com:luuman/luuman.github.io.git</div><div class="line">  branch: master</div></pre></td></tr></table></figure>
<p>修改局部页面</p>
<p>页面展现的全部逻辑都在每个主题中控制，源代码在hexo\themes\主题名称\中：</p>
<blockquote>
<p>hexo\themes\</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">├── languages  #多语言</div><div class="line">|   ├── default.yml#默认语言</div><div class="line">|   └── zh-CN.yml  #中文语言</div><div class="line">├── layout #布局，根目录下的*.ejs文件是对主页，分页，存档等的控制</div><div class="line">|   ├── _partial   #局部的布局，此目录下的*.ejs是对头尾等局部的控制</div><div class="line">|   └── _widget#小挂件的布局，页面下方小挂件的控制</div><div class="line">├── source #源码</div><div class="line">|   ├── css#css源码 </div><div class="line">|   |   ├── _base  #*.styl基础css</div><div class="line">|   |   ├── _partial   #*.styl局部css</div><div class="line">|   |   ├── fonts  #字体</div><div class="line">|   |   ├── images #图片</div><div class="line">|   |   └── style.styl #*.styl引入需要的css源码</div><div class="line">|   ├── fancybox   #fancybox效果源码</div><div class="line">|   └── js #javascript源代码</div><div class="line">├── _config.yml#主题配置文件</div><div class="line">└── README.md  #用GitHub的都知道</div></pre></td></tr></table></figure>
<p>主题文档的配置</p>
<blockquote>
<p>hexo\themes/_config.yml</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"># Header</div><div class="line">menu:</div><div class="line">  主页: /</div><div class="line">  所有文章: /archives</div><div class="line">  # 随笔: /tags/随笔</div><div class="line"></div><div class="line"># SubNav</div><div class="line">subnav:</div><div class="line">  github: &quot;#&quot;</div><div class="line">  weibo: &quot;#&quot;</div><div class="line">  rss: &quot;#&quot;</div><div class="line">  zhihu: &quot;#&quot;</div><div class="line">  #douban: &quot;#&quot;</div><div class="line">  #mail: &quot;#&quot;</div><div class="line">  #facebook: &quot;#&quot;</div><div class="line">  #google: &quot;#&quot;</div><div class="line">  #twitter: &quot;#&quot;</div><div class="line">  #linkedin: &quot;#&quot;</div><div class="line"></div><div class="line">rss: /atom.xml</div><div class="line"></div><div class="line"># Content</div><div class="line">excerpt_link: more</div><div class="line">fancybox: true</div><div class="line">mathjax: true</div><div class="line"></div><div class="line"># Miscellaneous</div><div class="line">google_analytics: &apos;&apos;</div><div class="line">favicon: /favicon.png</div><div class="line"></div><div class="line">#你的头像url</div><div class="line">avatar: &quot;&quot;</div><div class="line">#是否开启分享</div><div class="line">share: true</div><div class="line">#是否开启多说评论，填写你在多说申请的项目名称 duoshuo: duoshuo-key（http://duoshuo-key.duoshuo.com/）</div><div class="line">#若使用disqus，请在博客config文件中填写disqus_shortname，并关闭多说评论</div><div class="line">duoshuo: true</div><div class="line">#是否开启云标签</div><div class="line">tagcloud: true</div><div class="line"></div><div class="line">#是否开启友情链接</div><div class="line">#不开启——</div><div class="line">#friends: false</div><div class="line">#开启——</div><div class="line">friends:</div><div class="line">  奥巴马的博客: http://localhost:4000/</div><div class="line">  卡卡的美丽传说: http://localhost:4000/</div><div class="line">  本泽马的博客: http://localhost:4000/</div><div class="line">  吉格斯的博客: http://localhost:4000/</div><div class="line">  习大大大不同: http://localhost:4000/</div><div class="line">  托蒂的博客: http://localhost:4000/</div><div class="line"></div><div class="line">#是否开启“关于我”。</div><div class="line">#不开启——</div><div class="line">#aboutme: false</div><div class="line">#开启——</div><div class="line">aboutme: 我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货…</div></pre></td></tr></table></figure>
<h1 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h1><p><a href="http://ibruce.info/2013/11/22/hexo-your-blog/" target="_blank" rel="external">hexo你的博客</a><br><a href="http://www.jianshu.com/p/05289a4bc8b2#" target="_blank" rel="external">如何搭建一个独立博客——简明Github Pages与Hexo教程</a><br><a href="http://luuman.github.io/2015/12/25/Hexo/" target="_blank" rel="external">Hexo的使用介绍</a><br><a href="http://luuman.github.io/2015/12/27/Hexo-plug/" target="_blank" rel="external">Hexo插件安装</a></p>
]]></content>
    
    <summary type="html">
    
      来到GitHub这么长时间，才开始真真的了解GitHub，这个国外的代码托管平台，充满着大牛的身影。
    
    </summary>
    
      <category term="Hexo" scheme="https://smuwjs.github.io/categories/Hexo/"/>
    
    
      <category term="Hexo" scheme="https://smuwjs.github.io/tags/Hexo/"/>
    
  </entry>
  
  <entry>
    <title>Hexo插件安装</title>
    <link href="https://smuwjs.github.io/2016/09/07/Hexo-plug/"/>
    <id>https://smuwjs.github.io/2016/09/07/Hexo-plug/</id>
    <published>2016-09-07T22:33:55.000Z</published>
    <updated>2017-05-05T09:48:30.740Z</updated>
    
    <content type="html"><![CDATA[<p>　　<strong>自用笔记：</strong>本文属于自用笔记，不做详解，仅供参考。在此记录自己已理解并开始遵循的前端代码规范。What How Why<br>　　最近，使用Hexo遇到了很多问题，在设立进行整理。</p>
<a id="more"></a>
<h2 id="同步instagram图片"><a href="#同步instagram图片" class="headerlink" title="同步instagram图片"></a>同步instagram图片</h2><blockquote>
<p>新建页面</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">执行命令：</div><div class="line">hexo new page &quot;instagram&quot;</div></pre></td></tr></table></figure>
<blockquote>
<p>修改文件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">在目录yourBlog\source\instagram下，修改index.md内容为：</div><div class="line"></div><div class="line">---</div><div class="line">layout: post</div><div class="line">slug: &quot;instagram&quot;</div><div class="line">title: &quot;相册&quot;</div><div class="line">noDate: &quot;true&quot;</div><div class="line">---</div><div class="line">&lt;div class=&quot;instagram&quot; data-client-id=&quot;a0d4bd    ab154b4c689aff70602cb34a2c&quot; data-user-id=&quot;438522285&quot;&gt;</div><div class="line">    &lt;a href=&quot;http://instagram.com/litten225&quot; target=&quot;_blank&quot; class=&quot;open-ins&quot;&gt;图片来自instagram，正在加载中…&lt;/a&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;script src=&quot;/js/jquery.lazyload.js&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;script src=&quot;/js/instagram.js&quot;&gt;&lt;/script&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>获取ID</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">data-client-id：</div><div class="line">[注册新客户端](http://instagram.com/developer/clients/manage/)</div><div class="line">获取CLIENT ID：a0d4bdab154b4c689aff70602cb34a2c</div><div class="line">用client_id去换取token：</div><div class="line">在浏览器中请求：</div><div class="line"></div><div class="line">    https://instagram.com/oauth/authorize/?client_id=&#123;CLIENT_ID&#125;&amp;redirect_uri=&#123;REDIRECT_URI&#125;&amp;response_type=token</div><div class="line">    https://instagram.com/oauth/authorize/?client_id=a0d4bdab154b4c689aff70602cb34a2c&amp;redirect_uri=http://luuman.github.io/&amp;response_type=token</div><div class="line">    花括号里面的值，对应上一步最终得到的client_id和自己设定的redirect_uri。</div><div class="line">    请求到的是一个授权页面，授权完毕后，则重定向到你的redirect_uri。</div><div class="line">    注意看授权成功后的url，hash部分会附带给你的token。至此，token成功获取，将至放在data-client-id。</div><div class="line"></div><div class="line">data-user-id：</div><div class="line"></div><div class="line">需要到[lookup-user-id](http://jelled.com/instagram/lookup-user-id#)填写用户名并查找。</div></pre></td></tr></table></figure>
<h2 id="分享按钮"><a href="#分享按钮" class="headerlink" title="分享按钮"></a>分享按钮</h2><blockquote>
<p>添加代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">以下代码是百度分享的页面24页面分享的代码，可以自行选择以下标签。</div><div class="line"></div><div class="line">配置</div><div class="line"></div><div class="line">vim themes/light/layout/_partial/article.ejs</div><div class="line">删除</div><div class="line">&lt;%-partial(&apos;post/share&apos;)%&gt;</div><div class="line">替换为刚刚获取的分享代码</div><div class="line"></div><div class="line">&lt;div class=&quot;bdsharebuttonbox&quot;&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx fa-weibo bds_tsina&quot; data-cmd=&quot;tsina&quot; title=&quot;分享到新浪微博&quot;&gt;&lt;/a&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx fa-weixin bds_weixin&quot; data-cmd=&quot;weixin&quot; title=&quot;分享到微信&quot;&gt;&lt;/a&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx fa-qq bds_sqq&quot; data-cmd=&quot;sqq&quot; title=&quot;分享到QQ好友&quot;&gt;&lt;/a&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx fa-facebook-official bds_fbook&quot; data-cmd=&quot;fbook&quot; title=&quot;分享到Facebook&quot;&gt;&lt;/a&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx fa-twitter bds_twi&quot; data-cmd=&quot;twi&quot; title=&quot;分享到Twitter&quot;&gt;&lt;/a&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx fa-linkedin bds_linkedin&quot; data-cmd=&quot;linkedin&quot; title=&quot;分享到linkedin&quot;&gt;&lt;/a&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx fa-files-o bds_copy&quot; data-cmd=&quot;copy&quot; title=&quot;分享到复制网址&quot;&gt;&lt;/a&gt;</div><div class="line"></div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx fa-plus-square bds_more&quot; data-cmd=&quot;more&quot;&gt;&lt;/a&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx fa-tencent-weibo bds_tqq&quot; data-cmd=&quot;tqq&quot; title=&quot;分享到腾讯微博&quot;&gt;&lt;/a&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx fa-renren bds_renren&quot; data-cmd=&quot;renren&quot; title=&quot;分享到人人网&quot;&gt;&lt;/a&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx fa-paw bds_tieba&quot; data-cmd=&quot;tieba&quot; title=&quot;分享到百度贴吧&quot;&gt;&lt;/a&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx fa-envelope-o bds_mail&quot; data-cmd=&quot;mail&quot; title=&quot;分享到邮件分享&quot;&gt;&lt;/a&gt;&lt;/div&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx fa-print bds_print&quot; data-cmd=&quot;print&quot; title=&quot;分享到打印&quot;&gt;&lt;/a&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx fa-share-alt bds_mshare&quot; data-cmd=&quot;mshare&quot; title=&quot;分享到一键分享&quot;&gt;&lt;/a&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx bds_douban&quot; data-cmd=&quot;douban&quot; title=&quot;分享到豆瓣网&quot;&gt;&lt;/a&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx fa- bds_qzone&quot; data-cmd=&quot;qzone&quot; title=&quot;分享到QQ空间&quot;&gt;&lt;/a&gt;</div><div class="line">    &lt;a href=&quot;#&quot; class=&quot;fx fa- bds_evernotecn&quot; data-cmd=&quot;evernotecn&quot; title=&quot;分享到印象笔记&quot;&gt;&lt;/a&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;script&gt;window._bd_share_config=&#123;&quot;common&quot;:&#123;&quot;bdSnsKey&quot;:&#123;&#125;,&quot;bdText&quot;:&quot;&quot;,&quot;bdMini&quot;:&quot;1&quot;,&quot;bdMiniList&quot;:false,&quot;bdPic&quot;:&quot;&quot;,&quot;bdStyle&quot;:&quot;2&quot;,&quot;bdSize&quot;:&quot;24&quot;&#125;,&quot;share&quot;:&#123;&#125;&#125;;with(document)0[(getElementsByTagName(&apos;head&apos;)[0]||body).appendChild(createElement(&apos;script&apos;)).src=&apos;http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=&apos;+~(-new Date()/36e5)];&lt;/script&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>修改样式</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">\themes\spfk\source\css\_partial\article.styl</div><div class="line"></div><div class="line">/* bd share button box */</div><div class="line">.bdshare-button-style2-24&#123;</div><div class="line">  width: 330px;</div><div class="line">  margin: auto;</div><div class="line">  .fx &#123;</div><div class="line">      color: #999;</div><div class="line">      padding: 0;</div><div class="line">      margin: 6px;</div><div class="line">      height: 54px;</div><div class="line">      display: inline-block;</div><div class="line">      font: normal normal normal 36px/1 FontAwesome;</div><div class="line">      background: none;</div><div class="line">      text-rendering: auto;</div><div class="line">      -webkit-font-smoothing: antialiased;</div><div class="line">      -moz-osx-font-smoothing: grayscale;</div><div class="line">  &#125;</div><div class="line">  .fx:hover&#123;</div><div class="line">    color: #FFF;</div><div class="line">    opacity: 1;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">themes\spfk\source\css\_partial\mobile.styl</div><div class="line">/* bd share button box */</div><div class="line">.bdshare-button-style2-24&#123;</div><div class="line">  width: 289px;</div><div class="line">  .fx &#123;</div><div class="line">      font: normal normal normal 30px/1 FontAwesome;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="百度统计"><a href="#百度统计" class="headerlink" title="百度统计"></a>百度统计</h2><blockquote>
<p>添加代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">去百度统计获取统计代码</div><div class="line"></div><div class="line">vim themes/light/layout/_partial/baidu_analytics.ejs</div><div class="line"></div><div class="line">&lt;% if (theme.baidu_analytics)&#123; %&gt;</div><div class="line">&lt;script&gt;</div><div class="line">var _hmt = _hmt || [];</div><div class="line">(function() &#123;</div><div class="line">  var hm = document.createElement(&quot;script&quot;);</div><div class="line">  hm.src = &quot;//hm.baidu.com/hm.js?819b1c6493df653afb8c784db6&quot;;</div><div class="line">  var s = document.getElementsByTagName(&quot;script&quot;)[0]; </div><div class="line">  s.parentNode.insertBefore(hm, s);</div><div class="line">&#125;)();</div><div class="line">&lt;/script&gt;</div><div class="line"></div><div class="line">&lt;% &#125; %&gt;</div><div class="line"></div><div class="line">vim hexo/themes/light/_config.yml</div><div class="line"></div><div class="line">baidu_analytics: true</div><div class="line"></div><div class="line">vim hexo/themes/light/layout/_partial/head.ejs</div><div class="line">在/head前添加</div><div class="line"></div><div class="line">&lt;%- partial(&apos;baidu_analytics&apos;) %&gt;</div><div class="line">&lt;/head&gt;</div></pre></td></tr></table></figure>
<h2 id="不蒜子"><a href="#不蒜子" class="headerlink" title="不蒜子"></a>不蒜子</h2><blockquote>
<p>添加代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">themes/你的主题/layout/_partial/footer.ejs</div><div class="line"></div><div class="line">&lt;footer id=&quot;footer&quot;&gt;</div><div class="line">    &lt;div class=&quot;outer&quot;&gt;</div><div class="line">        &lt;div id=&quot;footer-info&quot;&gt;</div><div class="line">            &lt;div class=&quot;footer-left&quot;&gt;</div><div class="line">                &amp;copy; &lt;%= date(new Date(), &apos;YYYY&apos;) %&gt; &lt;%= config.author || config.title %&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">            &lt;div class=&quot;footer-right&quot;&gt;</div><div class="line">                &lt;a href=&quot;http://hexo.io/&quot; target=&quot;_blank&quot;&gt;Hexo&lt;/a&gt;  Theme &lt;a href=&quot;https://github.com/luuman/hexo-theme-spfk&quot; target=&quot;_blank&quot;&gt;spfk&lt;/a&gt; by luuman</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;div class=&quot;visit&quot;&gt;</div><div class="line">            &lt;span id=&quot;busuanzi_container_site_pv&quot; style=&apos;display:none&apos;&gt;</div><div class="line">                &lt;span id=&quot;site-visit&quot; &gt;本站到访数: </div><div class="line">                    &lt;span id=&quot;busuanzi_value_site_uv&quot;&gt;&lt;/span&gt;</div><div class="line">                &lt;/span&gt;</div><div class="line">            &lt;/span&gt;</div><div class="line">            &lt;span id=&quot;busuanzi_container_page_pv&quot; style=&apos;display:none&apos;&gt;</div><div class="line">                &lt;span id=&quot;page-visit&quot;&gt;, 本页阅读量: </div><div class="line">                    &lt;span id=&quot;busuanzi_value_page_pv&quot;&gt;&lt;/span&gt;</div><div class="line">                &lt;/span&gt;</div><div class="line">            &lt;/span&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">    &lt;/div&gt;&lt;script async src=&quot;https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js&quot;&gt;</div><div class="line">&lt;/script&gt;</div><div class="line">&lt;/footer&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>修改样式</p>
</blockquote>
<p>移动端出现上移themes\spfk\source\css_partial\mobile.styl<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#footer &#123;</div><div class="line">    bottom: 10px;</div><div class="line">    .footer-left&#123;</div><div class="line">        float: initial;</div><div class="line">        margin-bottom: 10px;</div><div class="line">    &#125;</div><div class="line">    .footer-right&#123;</div><div class="line">        float: initial;</div><div class="line">        margin-bottom: 10px;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">#container .visit &#123;</div><div class="line">    margin-top: 1em;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="版权声明"><a href="#版权声明" class="headerlink" title="版权声明"></a>版权声明</h2><blockquote>
<p>添加代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">\layout\_partial\post\nav.ejs</div><div class="line"></div><div class="line">&lt;% if (post.original != false &amp;&amp; !is_page())&#123; %&gt;</div><div class="line">    &lt;div class=&quot;copyright&quot;&gt;</div><div class="line">        &lt;p&gt;&lt;span&gt;本文标题:&lt;/span&gt;&lt;a href=&quot;&lt;%- url_for(post.path) %&gt;&quot;&gt;&lt;%= post.title %&gt;&lt;/a&gt;&lt;/p&gt;</div><div class="line">        &lt;p&gt;&lt;span&gt;文章作者:&lt;/span&gt;&lt;a href=&quot;/&quot; title=&quot;请访问 &lt;%=theme.author%&gt; 博客&quot;&gt;&lt;%=theme.author%&gt;&lt;/a&gt;&lt;/p&gt;</div><div class="line">        &lt;!-- &lt;p&gt;&lt;span&gt;发布时间:&lt;/span&gt;&lt;%= post.date.format(&quot;YYYY年MM月DD日 - HH时mm分&quot;) %&gt;&lt;/p&gt; --&gt;</div><div class="line">        &lt;!-- &lt;p&gt;&lt;span&gt;最后更新:&lt;/span&gt;&lt;%= post.updated.format(&quot;YYYY年MM月DD日 - HH时mm分&quot;) %&gt;&lt;/p&gt; --&gt;</div><div class="line">        &lt;p&gt;</div><div class="line">            &lt;span&gt;原始链接:&lt;/span&gt;&lt;a class=&quot;post-url&quot; href=&quot;&lt;%- url_for(post.path) %&gt;&quot; title=&quot;&lt;%= post.title %&gt;&quot;&gt;&lt;%= post.permalink %&gt;&lt;/a&gt;</div><div class="line">            &lt;span class=&quot;copy-path&quot; data-clipboard-text=&quot;原文: &lt;%= post.permalink %&gt;　　作者: &lt;%=theme.author%&gt;&quot; title=&quot;点击复制文章链接&quot;&gt;&lt;i class=&quot;fa fa-clipboard&quot;&gt;&lt;/i&gt;&lt;/span&gt;</div><div class="line">            &lt;script src=&quot;/js/clipboard.min.js&quot;&gt;&lt;/script&gt;</div><div class="line">            &lt;script&gt; var clipboard = new Clipboard(&apos;.copy-path&apos;); &lt;/script&gt;</div><div class="line">        &lt;/p&gt;</div><div class="line">        &lt;p&gt;</div><div class="line">            &lt;span&gt;许可协议:&lt;/span&gt;&lt;i class=&quot;fa fa-creative-commons&quot;&gt;&lt;/i&gt; &lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-nc-sa/3.0/cn/&quot; title=&quot;中国大陆 (CC BY-NC-SA 3.0 CN)&quot;&gt;&quot;署名-非商用-相同方式共享 3.0&quot;&lt;/a&gt; 转载请保留原文链接及作者。</div><div class="line">        &lt;/p&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">&lt;% &#125; %&gt;</div><div class="line"></div><div class="line">&lt;% if (post.prev || post.next)&#123; %&gt;</div><div class="line">&lt;nav id=&quot;article-nav&quot;&gt;</div><div class="line">  &lt;% if (post.prev)&#123; %&gt;</div><div class="line">    &lt;a href=&quot;&lt;%- url_for(post.prev.path) %&gt;&quot; id=&quot;article-nav-newer&quot; class=&quot;article-nav-link-wrap&quot;&gt;</div><div class="line">      &lt;strong class=&quot;article-nav-caption&quot;&gt;&lt;&lt;/strong&gt;</div><div class="line">      &lt;div class=&quot;article-nav-title&quot;&gt;</div><div class="line">        &lt;% if (post.prev.title)&#123; %&gt;</div><div class="line">          &lt;%= post.prev.title %&gt;</div><div class="line">        &lt;% &#125; else &#123; %&gt;</div><div class="line">          (no title)</div><div class="line">        &lt;% &#125; %&gt;</div><div class="line">      &lt;/div&gt;</div><div class="line">    &lt;/a&gt;</div><div class="line">  &lt;% &#125; %&gt;</div><div class="line">  &lt;% if (post.next)&#123; %&gt;</div><div class="line">    &lt;a href=&quot;&lt;%- url_for(post.next.path) %&gt;&quot; id=&quot;article-nav-older&quot; class=&quot;article-nav-link-wrap&quot;&gt;</div><div class="line">      &lt;div class=&quot;article-nav-title&quot;&gt;&lt;%= post.next.title %&gt;&lt;/div&gt;</div><div class="line">      &lt;strong class=&quot;article-nav-caption&quot;&gt;&gt;&lt;/strong&gt;</div><div class="line">    &lt;/a&gt;</div><div class="line">  &lt;% &#125; %&gt;</div><div class="line">&lt;/nav&gt;</div><div class="line">&lt;% &#125; %&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>修改样式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">\themes\spfk\source\css\_partial\article.styl</div><div class="line"></div><div class="line">/* copyright */</div><div class="line">.copyright &#123;</div><div class="line">    width: 85%;</div><div class="line">    max-width: 45em;</div><div class="line">    margin: 0 auto;</div><div class="line">    padding: .5em 1.8em;</div><div class="line">    border: 1px solid lightgray;</div><div class="line">    font-size: .93em;</div><div class="line">    line-height: 1.6em;</div><div class="line">    word-break: break-word;</div><div class="line">    background: rgba(255, 255, 255, .4);</div><div class="line">    span &#123;</div><div class="line">        margin-right: 1em;</div><div class="line">        color: #B5B5B5;</div><div class="line">        font-weight: bold;</div><div class="line">    &#125;</div><div class="line">    a &#123;</div><div class="line">        color: gray;</div><div class="line">        &amp;:hover &#123;</div><div class="line">            font-weight: bold;</div><div class="line">            color: #a3d2a3;</div><div class="line">            text-decoration: underline;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    &amp;:hover p .copy-path::after &#123;</div><div class="line">        content: &quot;复制&quot;;</div><div class="line">    &#125;</div><div class="line">    .post-url:hover &#123;</div><div class="line">        font-weight: normal;</div><div class="line">    &#125;</div><div class="line">    .copy-path &#123;</div><div class="line">        margin-left: 1em;</div><div class="line">        &amp;:hover &#123;</div><div class="line">            color: gray;</div><div class="line">            cursor: pointer;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="社交账号图标修改"><a href="#社交账号图标修改" class="headerlink" title="社交账号图标修改"></a>社交账号图标修改</h2><blockquote>
<p>添加代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">\themes\spfk\layout\_partial\left-col.ejs</div><div class="line"></div><div class="line">&lt;nav class=&quot;header-nav&quot;&gt;</div><div class="line">    &lt;div class=&quot;social&quot;&gt;</div><div class="line">        &lt;% for (var i in theme.subnav)&#123; %&gt;</div><div class="line">            &lt;a class=&quot;fl &lt;%= i %&gt;&quot; target=&quot;_blank&quot; href=&quot;&lt;%- url_for(theme.subnav[i]) %&gt;&quot; title=&quot;&lt;%= i %&gt;&quot;&gt;&lt;%= i %&gt;&lt;/a&gt;</div><div class="line">        &lt;%&#125;%&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">&lt;/nav&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>修改样式</p>
</blockquote>
<h2 id="站内搜索框"><a href="#站内搜索框" class="headerlink" title="站内搜索框"></a>站内搜索框</h2><blockquote>
<p>添加代码<br>用ajax+json搜索</p>
</blockquote>
<p><a href="http://www.netcan666.com/2015/11/20/%E5%AE%8C%E7%BE%8E%E8%A7%A3%E5%86%B3Hexo%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2%E6%90%9C%E7%B4%A2%E9%97%AE%E9%A2%98/" target="_blank" rel="external">完美解决Hexo静态博客搜索问题</a></p>
<h2 id="站点Swiftype搜索框"><a href="#站点Swiftype搜索框" class="headerlink" title="站点Swiftype搜索框"></a>站点Swiftype搜索框</h2><blockquote>
<p>添加代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">\themes\spfk\layout\_partial\left-col.ejs</div><div class="line"></div><div class="line">&lt;form&gt;                </div><div class="line">    &lt;input type=&quot;text&quot; class=&quot;st-default-search-input search&quot; id=&quot;search&quot; placeholder=&quot; Search...&quot; autocomplete=&quot;off&quot; autocorrect=&quot;off&quot; autocapitalize=&quot;off&quot;&gt;</div><div class="line">&lt;/form&gt;</div><div class="line"></div><div class="line"></div><div class="line">D:\Hexo\Hexo\themes\spfk\layout\_partial\after-footer.ejs</div><div class="line"></div><div class="line">&lt;script type=&quot;text/javascript&quot;&gt;</div><div class="line">  window.onload = function()&#123;</div><div class="line">    document.getElementById(&quot;search&quot;).onclick = function()&#123;</div><div class="line">        console.log(&quot;search&quot;)</div><div class="line">        search();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  function search()&#123;</div><div class="line">    (function(w,d,t,u,n,s,e)&#123;w[&apos;SwiftypeObject&apos;]=n;w[n]=w[n]||function()&#123;</div><div class="line">    (w[n].q=w[n].q||[]).push(arguments);&#125;;s=d.createElement(t);</div><div class="line">    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);</div><div class="line">    &#125;)(window,document,&apos;script&apos;,&apos;//s.swiftypecdn.com/install/v2/st.js&apos;,&apos;_st&apos;);</div><div class="line"></div><div class="line">    _st(&apos;install&apos;,&apos;A1Pz-LKMXbrzcFg2FWi6&apos;,&apos;2.0.0&apos;);</div><div class="line">  &#125;</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>修改样式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">.search &#123;</div><div class="line">    width: 68%;</div><div class="line">    height: 18px;</div><div class="line">    margin-top: 1px;</div><div class="line">    padding: 0;</div><div class="line">    font-family: inherit;</div><div class="line">    border: 2px solid transparent;</div><div class="line">    border-bottom: 2px solid lightgray;</div><div class="line">    border-radius: 2px;</div><div class="line">    opacity: .7;</div><div class="line">    background: none;</div><div class="line">    &amp;:hover &#123;</div><div class="line">        border: 0px solid lightgray;</div><div class="line">        opacity: 1;</div><div class="line">        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">display: inline-block;</div><div class="line">    width: 190px;</div><div class="line">    height: 16px;</div><div class="line">    padding: 7px 11px 7px 28px;</div><div class="line">    border: 1px solid #bbb;</div><div class="line">    border: 1px solid rgba(0,0,0,0.25);</div><div class="line">    font-weight: 400;</div><div class="line">    color: #444;</div><div class="line">    font-size: 14px;</div><div class="line">    line-height: 16px;</div><div class="line">    box-sizing: content-box;</div><div class="line">    background: #fff 8px 8px no-repeat url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6%2BR8AAAACXB…Hx4Taq1nrnKaW8K6XUUsrHWuvNevdRRLzFGwzvDbXAB9cDAHvhedDruuxSAAAAAElFTkSuQmCC);</div><div class="line">    background-clip: padding-box;</div><div class="line">    -webkit-border-radius: 5px;</div><div class="line">    -moz-border-radius: 5px;</div><div class="line">    -ms-border-radius: 5px;</div><div class="line">    -o-border-radius: 5px;</div><div class="line">    border-radius: 5px;</div><div class="line">    -webkit-box-shadow: none;</div><div class="line">    -moz-box-shadow: none;</div><div class="line">    box-shadow: none;</div><div class="line">    font-family: &quot;Helvetica Neue&quot;,Helvetica,Arial,&quot;Lucida Grande&quot;,sans-serif;</div></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="RSS不显示"><a href="#RSS不显示" class="headerlink" title="RSS不显示"></a>RSS不显示</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">    安装RSS插件</div><div class="line"></div><div class="line">$ npm install hexo-generator-feed --save</div><div class="line"></div><div class="line">    开启RSS功能</div><div class="line"></div><div class="line">    编辑hexo/themes_config.yml，添加如下代码：</div><div class="line"></div><div class="line">    rss: /atom.xml #rss地址  默认即可</div></pre></td></tr></table></figure>
<h2 id="sitemap网站地图"><a href="#sitemap网站地图" class="headerlink" title="sitemap网站地图"></a>sitemap网站地图</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">1、安装插件：</div><div class="line"></div><div class="line">$ npm install hexo-generator-sitemap --save</div><div class="line">$ npm install hexo-generator-baidu-sitemap --save</div><div class="line"></div><div class="line">2、在博客目录的hexo/_config.yml中添加如下代码：</div><div class="line"></div><div class="line"># 自动生成sitemap编辑</div><div class="line"></div><div class="line">sitemap:</div><div class="line">path: sitemap.xml</div><div class="line">baidusitemap:</div><div class="line">path: baidusitemap.xml</div><div class="line"></div><div class="line">3、hexo编译的时候会自动在根目录生成站点地图</div><div class="line"></div><div class="line">    UUhike@UUhike-pc MINGW64 /d/Hexo/Hexo (master)</div><div class="line">    $ npm install hexo-generator-sitemap --save</div><div class="line">    npm WARN install Couldn&apos;t install optional dependency: Unsupported</div><div class="line">    npm WARN install Couldn&apos;t install optional dependency: Unsupported</div><div class="line">    hexo-site@0.0.0 D:\Hexo\Hexo</div><div class="line">    └── hexo-generator-sitemap@1.0.1</div><div class="line"></div><div class="line"></div><div class="line">    UUhike@UUhike-pc MINGW64 /d/Hexo/Hexo (master)</div><div class="line">    $ npm install hexo-generator-baidu-sitemap --save</div><div class="line">    npm WARN install Couldn&apos;t install optional dependency: Unsupported</div><div class="line">    npm WARN install Couldn&apos;t install optional dependency: Unsupported</div><div class="line">    hexo-site@0.0.0 D:\Hexo\Hexo</div><div class="line">    └── hexo-generator-baidu-sitemap@0.1.2</div><div class="line"></div><div class="line"></div><div class="line">    UUhike@UUhike-pc MINGW64 /d/Hexo/Hexo (master)</div><div class="line">    $ hexo g</div><div class="line">    INFO  Files loaded in 2.42 s</div><div class="line">    INFO  Generated: baidusitemap.xml</div><div class="line">    INFO  Generated: sitemap.xml</div><div class="line">    INFO  2 files generated in 477 ms</div></pre></td></tr></table></figure>
<h2 id="多说评论插件"><a href="#多说评论插件" class="headerlink" title="多说评论插件"></a>多说评论插件</h2><blockquote>
<p>添加代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">    ├── spfk</div><div class="line">        ├── _config.yml #主题配置文件</div><div class="line">    #是否开启多说评论，填写你在多说申请的项目名称 duoshuo: duoshuo-key（http://duoshuo-key.duoshuo.com/）</div><div class="line">    #若使用disqus，请在博客config文件中填写disqus_shortname，并关闭多说评论</div><div class="line">    duoshuo: true</div><div class="line"></div><div class="line"></div><div class="line">复制到 themes\landscape\layout\_partial\article.ejs把</div><div class="line"></div><div class="line">&lt;% if (!index &amp;&amp; post.comments &amp;&amp; config.disqus_shortname)&#123; %&gt;</div><div class="line">&lt;section id=&quot;comments&quot;&gt;</div><div class="line">&lt;div id=&quot;disqus_thread&quot;&gt;</div><div class="line">&lt;noscript&gt;Please enable JavaScript to view the &lt;a href=&quot;//disqus.com/?ref_noscript&quot;&gt;comments powered by Disqus.&lt;/a&gt;&lt;/noscript&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;/section&gt;</div><div class="line">&lt;% &#125; %&gt;</div><div class="line"></div><div class="line">改为</div><div class="line"></div><div class="line">&lt;% if (!index &amp;&amp; post.comments &amp;&amp; config.disqus_shortname)&#123; %&gt;</div><div class="line">&lt;section id=&quot;comments&quot;&gt;</div><div class="line">&lt;!-- 多说评论框 start --&gt;</div><div class="line">&lt;div class=&quot;ds-thread&quot; data-thread-key=&quot;&lt;%= post.layout %&gt;-&lt;%= post.slug %&gt;&quot; data-title=&quot;&lt;%= post.title %&gt;&quot; data-url=&quot;&lt;%= page.permalink %&gt;&quot;&gt;&lt;/div&gt;</div><div class="line">&lt;!-- 多说评论框 end --&gt;</div><div class="line">&lt;!-- 多说公共JS代码 start (一个网页只需插入一次) --&gt;</div><div class="line">&lt;script type=&quot;text/javascript&quot;&gt;</div><div class="line">var duoshuoQuery = &#123;short_name:&apos;&lt;%= config.disqus_shortname %&gt;&apos;&#125;;</div><div class="line">  (function() &#123;</div><div class="line">    var ds = document.createElement(&apos;script&apos;);</div><div class="line">    ds.type = &apos;text/javascript&apos;;ds.async = true;</div><div class="line">    ds.src = (document.location.protocol == &apos;https:&apos; ? &apos;https:&apos; : &apos;http:&apos;) + &apos;//static.duoshuo.com/embed.js&apos;;</div><div class="line">    ds.charset = &apos;UTF-8&apos;;</div><div class="line">    (document.getElementsByTagName(&apos;head&apos;)[0] </div><div class="line">     || document.getElementsByTagName(&apos;body&apos;)[0]).appendChild(ds);</div><div class="line">  &#125;)();</div><div class="line">  &lt;/script&gt;</div><div class="line">&lt;!-- 多说公共JS代码 end --&gt;</div><div class="line">&lt;/section&gt;</div><div class="line">&lt;% &#125; %&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>修改样式：<a href="http://www.vsay.cn/one-more-custom-css-lets-you-say-comments-city.html" target="_blank" rel="external">V说：</a><a href="http://www.shejidaren.com/use-css3-to-create-a-beautiful-comment-ui.html" target="_blank" rel="external">设计达人：</a><a href="http://www.shejidaren.com/examples/comment-ui/" target="_blank" rel="external">设计达人：</a></p>
<p>添加方法：<br>添加方法：打开「后台」 &gt; 「多说评论」 &gt; 「设置」 &gt; 「基本设置」 &gt; 然后把样式粘贴到「自定义CSS」文本框 &gt; 「保存」</p>
</blockquote>
<p>个性样式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#ds-thread #ds-reset ul.ds-comments-tabs li.ds-tab a.ds-current&#123;border:0;color:#848568;text-shadow:none;background:#dddfc2&#125;#ds-thread #ds-reset .ds-highlight&#123;font-family:Arial,Helvetica,sans-serif;font-size:14px;font-weight:700;color:#848568!important&#125;#ds-thread #ds-reset ul.ds-comments-tabs li.ds-tab a.ds-current:hover&#123;color:#696a52;background:#d4d6ba&#125;#ds-thread #ds-reset a.ds-highlight:hover&#123;color:#696a52!important&#125;#ds-thread&#123;padding-left:30px&#125;#ds-thread #ds-reset #ds-hot-posts,#ds-thread #ds-reset li.ds-post&#123;overflow:visible&#125;#ds-thread #ds-reset .ds-post-self&#123;padding:10px 0 10px 10px&#125;#ds-thread #ds-reset .ds-post-self,#ds-thread #ds-reset li.ds-post&#123;border:0!important&#125;#ds-reset .ds-avatar,#ds-thread #ds-reset ul.ds-children .ds-avatar&#123;position:absolute;top:26px;left:-14px;padding:5px;width:36px;height:36px;box-shadow:-1px 0 1px rgba(0,0,0,.15) inset;border-radius:46px;background:#E5E6D0&#125;#ds-thread #ds-reset ul.ds-children .ds-avatar&#123;left:-23px&#125;#ds-thread .ds-avatar a&#123;display:inline-block;padding:1px;width:32px;height:32px;border:1px solid #b9baa6;border-radius:50%;background-color:#fff!important&#125;#ds-thread .ds-avatar a:hover&#123;border-color:#de5a4e&#125;#ds-thread .ds-avatar&gt;img&#123;margin:2px 0 0 2px&#125;#ds-thread #ds-reset .ds-replybox&#123;box-shadow:none&#125;#ds-reset .ds-replybox.ds-inline-replybox a.ds-avatar,#ds-thread #ds-reset ul.ds-children .ds-replybox.ds-inline-replybox a.ds-avatar&#123;left:0;top:0;padding:0;width:32px!important;height:32px!important;background:0 0;box-shadow:none&#125;#ds-reset .ds-replybox.ds-inline-replybox a.ds-avatar img&#123;width:32px!important;height:32px!important;border-radius:50%&#125;#ds-reset .ds-replybox .ds-avatar img,#ds-reset .ds-replybox a.ds-avatar&#123;padding:0;width:50px!important;height:50px!important;border-radius:5px&#125;#ds-reset .ds-avatar img&#123;width:32px!important;height:32px!important;border-radius:32px;box-shadow:0 1px 3px rgba(0,0,0,.22);-webkit-transition:.4s all ease-in-out;-moz-transition:.4s all ease-in-out;-o-transition:.4s all ease-in-out;-ms-transition:.4s all ease-in-out;transition:.4s all ease-in-out&#125;.ds-post-self:hover .ds-avatar img&#123;-webkit-transform:rotate(360deg);-moz-transform:rotate(360deg);-o-transform:rotate(360deg);-ms-transform:rotate(360deg);transform:rotate(360deg)&#125;#ds-thread #ds-reset .ds-comment-body&#123;background:#F0F0E3;padding:15px 15px 12px 32px;border-radius:5px;box-shadow:0 1px 2px rgba(0,0,0,.15),0 1px 0 rgba(255,255,255,.75) inset&#125;#ds-thread #ds-reset .ds-comment-body p&#123;color:#787968&#125;#ds-thread #ds-reset .ds-comments a.ds-user-name&#123;font-weight:700;color:#696A52!important&#125;#ds-thread #ds-reset .ds-comments a.ds-user-name:hover&#123;color:#D32!important&#125;#ds-thread #ds-reset #ds-hot-posts&#123;border:0&#125;#ds-reset #ds-hot-posts .ds-gradient-bg&#123;background:0 0&#125;#ds-reset #ds-bubble #ds-ctx .ds-ctx-entry&#123;padding:0&#125;#ds-reset #ds-bubble #ds-ctx-bubble .ds-avatar a,#ds-reset #ds-bubble .ds-avatar&#123;position:static;padding:0;border:0;background:0 0;box-shadow:none&#125;#ds-reset #ds-bubble #ds-ctx-bubble .ds-avatar a,#ds-reset #ds-bubble .ds-avatar img&#123;width:45px!important;height:45px!important&#125;#ds-reset #ds-bubble .ds-user-name&#123;padding-left:13px&#125;#ds-reset .ds-comment-body #ds-ctx&#123;border-left:1px solid #b9baa6;background-color:#e8e8dc!important&#125;#ds-reset #ds-ctx&#123;margin-right:-15px&#125;#ds-reset #ds-ctx .ds-ctx-entry&#123;position:relative;padding:10px 30px 10px 10px&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-avatar&#123;top:6px;left:5px;background:0 0;box-shadow:none&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-body&#123;margin-left:46px&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-content&#123;color:#787968&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a&#123;color:#696A52;font-weight:700&#125;</div></pre></td></tr></table></figure>
<p>个性样式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#ds-reset .ds-avatar img,#ds-reset .ds-avatar img:hover&#123;-webkit-animation-fill-mode:both;-moz-animation-fill-mode:both;-ms-animation-fill-mode:both;-o-animation-fill-mode:both;animation-fill-mode:both;-webkit-animation-duration:0s;-moz-animation-duration:0s;-ms-animation-duration:0s;-o-animation-duration:0s;animation-duration:0s;-webkit-animation-duration:.7s;-moz-animation-duration:.7s;-ms-animation-duration:.7s;-o-animation-duration:.7s;animation-duration:.7s&#125;@-webkit-keyframes wobble&#123;0%&#123;-webkit-transform:translateX(0)&#125;15%&#123;-webkit-transform:translateX(-25%) rotate(-5deg)&#125;30%&#123;-webkit-transform:translateX(20%) rotate(3deg)&#125;45%&#123;-webkit-transform:translateX(-15%) rotate(-3deg)&#125;60%&#123;-webkit-transform:translateX(10%) rotate(2deg)&#125;75%&#123;-webkit-transform:translateX(-5%) rotate(-1deg)&#125;100%&#123;-webkit-transform:translateX(0)&#125;&#125;@-moz-keyframes wobble&#123;0%&#123;-moz-transform:translateX(0)&#125;15%&#123;-moz-transform:translateX(-25%) rotate(-5deg)&#125;30%&#123;-moz-transform:translateX(20%) rotate(3deg)&#125;45%&#123;-moz-transform:translateX(-15%) rotate(-3deg)&#125;60%&#123;-moz-transform:translateX(10%) rotate(2deg)&#125;75%&#123;-moz-transform:translateX(-5%) rotate(-1deg)&#125;100%&#123;-moz-transform:translateX(0)&#125;&#125;@-o-keyframes wobble&#123;0%&#123;-o-transform:translateX(0)&#125;15%&#123;-o-transform:translateX(-25%) rotate(-5deg)&#125;30%&#123;-o-transform:translateX(20%) rotate(3deg)&#125;45%&#123;-o-transform:translateX(-15%) rotate(-3deg)&#125;60%&#123;-o-transform:translateX(10%) rotate(2deg)&#125;75%&#123;-o-transform:translateX(-5%) rotate(-1deg)&#125;100%&#123;-o-transform:translateX(0)&#125;&#125;@keyframes wobble&#123;0%&#123;transform:translateX(0)&#125;15%&#123;transform:translateX(-25%) rotate(-5deg)&#125;30%&#123;transform:translateX(20%) rotate(3deg)&#125;45%&#123;transform:translateX(-15%) rotate(-3deg)&#125;60%&#123;transform:translateX(10%) rotate(2deg)&#125;75%&#123;transform:translateX(-5%) rotate(-1deg)&#125;100%&#123;transform:translateX(0)&#125;&#125;#ds-reset .ds-avatar img:hover&#123;-webkit-animation-name:wobble;-moz-animation-name:wobble;-o-animation-name:wobble;animation-name:wobble&#125;</div></pre></td></tr></table></figure>
<p>个性样式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#ds-ssr&#123;display:none !important&#125;#ds-reset&#123;font-weight:normal;font-size:13px;font-size-adjust:none;color:#333;line-height:1;text-align:left&#125;#ds-reset *&#123;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box&#125;#ds-reset input[type=button],#ds-reset input[type=submit],#ds-reset input[type=reset],#ds-reset button&#123;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box&#125;#ds-reset div,#ds-reset ul,#ds-reset ol,#ds-reset li,#ds-reset ul li,#ds-reset ol li,#ds-reset iframe,#ds-reset h1,#ds-reset h2,#ds-reset h3,#ds-reset h4,#ds-reset h5,#ds-reset h6,#ds-reset p,#ds-reset img,#ds-reset blockquote,#ds-reset a,#ds-reset span,#ds-reset pre,#ds-reset code,#ds-reset strong,#ds-reset sub,#ds-reset sup,#ds-reset fieldset,#ds-reset form,#ds-reset label,#ds-reset input,#ds-reset textarea,#ds-reset select&#123;border:0;padding:0;margin:0;vertical-align:baseline;font:inherit;line-height:inherit;background:none;width:auto;float:none;overflow:visible;transition:none&#125;#ds-reset strong&#123;font-weight:bold&#125;#ds-reset p&#123;text-indent:0;clear:none&#125;#ds-reset span,#ds-reset strong,#ds-reset label,#ds-reset input&#123;display:inline;margin:0&#125;#ds-reset textarea:focus,#ds-reset input:focus&#123;outline:none&#125;#ds-reset ul,#ds-reset ol,#ds-reset ul li,#ds-reset ol li&#123;list-style:none;display:block&#125;#ds-reset input,#ds-reset button&#123;-webkit-border-radius:3px;border-radius:3px&#125;#ds-indicator&#123;display:none;position:fixed;z-index:99999;top:150px;left:0;padding:8px;border-bottom-right-radius:3px;border-top-right-radius:3px;width:16px;height:16px;background:#666 url(&quot;data:image/gif;base64,R0lGODlhEAAQAPQAAGZmZv///2lpadzc3K+vr/r6+ufn5319fZmZmfDw8Le3t8DAwHV1daOjo4eHh9LS0srKygAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAAFUCAgjmRpnqUwFGwhKoRgqq2YFMaRGjWA8AbZiIBbjQQ8AmmFUJEQhQGJhaKOrCksgEla+KIkYvC6SJKQOISoNSYdeIk1ayA8ExTyeR3F749CACH5BAkKAAAALAAAAAAQABAAAAVoICCKR9KMaCoaxeCoqEAkRX3AwMHWxQIIjJSAZWgUEgzBwCBAEQpMwIDwY1FHgwJCtOW2UDWYIDyqNVVkUbYr6CK+o2eUMKgWrqKhj0FrEM8jQQALPFA3MAc8CQSAMA5ZBjgqDQmHIyEAIfkECQoAAAAsAAAAABAAEAAABWAgII4j85Ao2hRIKgrEUBQJLaSHMe8zgQo6Q8sxS7RIhILhBkgumCTZsXkACBC+0cwF2GoLLoFXREDcDlkAojBICRaFLDCOQtQKjmsQSubtDFU/NXcDBHwkaw1cKQ8MiyEAIfkECQoAAAAsAAAAABAAEAAABVIgII5kaZ6AIJQCMRTFQKiDQx4GrBfGa4uCnAEhQuRgPwCBtwK+kCNFgjh6QlFYgGO7baJ2CxIioSDpwqNggWCGDVVGphly3BkOpXDrKfNm/4AhACH5BAkKAAAALAAAAAAQABAAAAVgICCOZGmeqEAMRTEQwskYbV0Yx7kYSIzQhtgoBxCKBDQCIOcoLBimRiFhSABYU5gIgW01pLUBYkRItAYAqrlhYiwKjiWAcDMWY8QjsCf4DewiBzQ2N1AmKlgvgCiMjSQhACH5BAkKAAAALAAAAAAQABAAAAVfICCOZGmeqEgUxUAIpkA0AMKyxkEiSZEIsJqhYAg+boUFSTAkiBiNHks3sg1ILAfBiS10gyqCg0UaFBCkwy3RYKiIYMAC+RAxiQgYsJdAjw5DN2gILzEEZgVcKYuMJiEAOwAAAAAAAAAAAA==&quot;) 8px 8px no-repeat;*background-image:url(&quot;//static.duoshuo.com/images/loading.gif&quot;);*position:absolute;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box&#125;#ds-waiting&#123;cursor:wait;display:block;width:16px;height:11px;padding:0 0 3px 5px;margin:0;background:url(&quot;data:image/gif;base64,R0lGODlhEAALAPQAAP///z2LqeLt8dvp7u7090GNqz2LqV+fuJ/F1IW2ycrf51aatHWswaXJ14i4ys3h6FmctUCMqniuw+vz9eHs8fb5+meku+Tu8vT4+cfd5bbT3tbm7PH2+AAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCwAAACwAAAAAEAALAAAFLSAgjmRpnqSgCuLKAq5AEIM4zDVw03ve27ifDgfkEYe04kDIDC5zrtYKRa2WQgAh+QQJCwAAACwAAAAAEAALAAAFJGBhGAVgnqhpHIeRvsDawqns0qeN5+y967tYLyicBYE7EYkYAgAh+QQJCwAAACwAAAAAEAALAAAFNiAgjothLOOIJAkiGgxjpGKiKMkbz7SN6zIawJcDwIK9W/HISxGBzdHTuBNOmcJVCyoUlk7CEAAh+QQJCwAAACwAAAAAEAALAAAFNSAgjqQIRRFUAo3jNGIkSdHqPI8Tz3V55zuaDacDyIQ+YrBH+hWPzJFzOQQaeavWi7oqnVIhACH5BAkLAAAALAAAAAAQAAsAAAUyICCOZGme1rJY5kRRk7hI0mJSVUXJtF3iOl7tltsBZsNfUegjAY3I5sgFY55KqdX1GgIAIfkECQsAAAAsAAAAABAACwAABTcgII5kaZ4kcV2EqLJipmnZhWGXaOOitm2aXQ4g7P2Ct2ER4AMul00kj5g0Al8tADY2y6C+4FIIACH5BAkLAAAALAAAAAAQAAsAAAUvICCOZGme5ERRk6iy7qpyHCVStA3gNa/7txxwlwv2isSacYUc+l4tADQGQ1mvpBAAIfkECQsAAAAsAAAAABAACwAABS8gII5kaZ7kRFGTqLLuqnIcJVK0DeA1r/u3HHCXC/aKxJpxhRz6Xi0ANAZDWa+kEAA7AAAAAAAAAAAA&quot;) 0 0 no-repeat;*background-image:url(&quot;//static.duoshuo.com/images/waiting.gif&quot;)&#125;#ds-reset .ds-highlight&#123;color:#d32 !important&#125;#ds-reset .ds-rounded&#123;-webkit-border-radius:3px;border-radius:3px&#125;#ds-reset .ds-rounded-top&#123;-webkit-border-top-right-radius:3px;-webkit-border-top-left-radius:3px;border-top-right-radius:3px;border-top-left-radius:3px&#125;#ds-reset .ds-rounded-bottom&#123;border-bottom-left-radius:3px;border-bottom-right-radius:3px;-webkit-border-bottom-left-radius:3px;-webkit-border-bottom-right-radius:3px&#125;#ds-reset .ds-gradient-bg&#123;background:url(&quot;//static.duoshuo.com/images/bg_sprites.png&quot;) 0 -60px repeat-x&#125;#ds-reset .ds-avatar&#123;box-shadow:0 1px 1px rgba(255,255,255,0.75);position:relative;-webkit-border-radius:3px;border-radius:3px;background-color:#fff;float:left&#125;#ds-reset .ds-avatar img&#123;display:block;width:50px;height:50px;max-width:none;box-shadow:0 1px 3px rgba(0,0,0,0.22);-webkit-border-radius:3px;border-radius:3px&#125;#ds-reset .ds-avatar .ds-service-icon&#123;display:block;position:absolute;bottom:-4px;right:-4px&#125;#ds-reset img.ds-smiley&#123;margin:0;padding:0;display:inline;border:none&#125;#ds-reset .ds-icon&#123;vertical-align:middle;display:inline-block;overflow:hidden;background:transparent url(&quot;//static.duoshuo.com/images/sprites.png&quot;) no-repeat;_background-image:url(&quot;//static.duoshuo.com/images/sprites.gif&quot;)&#125;#ds-reset a .ds-icon&#123;opacity:.6;-webkit-transition:opacity .15s linear;-moz-transition:opacity .15s linear;transition:opacity .15s linear&#125;#ds-reset a:hover .ds-icon&#123;opacity:1&#125;#ds-reset .ds-service-list a&#123;vertical-align:middle;padding-right:3px&#125;#ds-reset .ds-service-list li:hover a&#123;color:#333&#125;#ds-reset .ds-service-icon,#ds-reset .ds-service-icon-grey&#123;width:16px !important;height:16px !important;line-height:100px;display:inline-block;background:url(&quot;//static.duoshuo.com/images/service-icons-color.png?v=2&quot;) no-repeat;_background-image:url(&quot;//static.duoshuo.com/images/service-icons-color.gif?v=2&quot;);overflow:hidden&#125;#ds-reset .ds-service-icon-grey&#123;background-image:url(&quot;//static.duoshuo.com/images/service-icons-grey.png&quot;);_background-image:url(&quot;//static.duoshuo.com/images/service-icons-grey.gif&quot;)&#125;#ds-reset .ds-service-link&#123;height:16px !important;line-height:16px;padding-left:20px;display:block;background:url(&quot;//static.duoshuo.com/images/service-icons-color.png?v=2&quot;) no-repeat;_background-image:url(&quot;//static.duoshuo.com/images/service-icons-color.gif?v=2&quot;);overflow:hidden&#125;#ds-reset .ds-weibo&#123;background-position:0 0&#125;#ds-reset .ds-renren&#123;background-position:0 -32px&#125;#ds-reset .ds-qqt&#123;background-position:0 -64px&#125;#ds-reset .ds-kaixin&#123;background-position:0 -80px&#125;#ds-reset .ds-douban&#123;background-position:0 -96px&#125;#ds-reset .ds-qzone&#123;background-position:0 -128px&#125;#ds-reset .ds-duoshuo&#123;background-position:0 -144px&#125;#ds-reset .ds-qq&#123;background-position:0 -192px&#125;#ds-reset .ds-baidu&#123;background-position:0 -208px&#125;#ds-reset .ds-google&#123;background-position:0 -240px&#125;#ds-reset .ds-weixin&#123;background-position:0 -272px&#125;#ds-reset .ds-wechat&#123;background-position:0 -272px&#125;.ds-icons-32 a&#123;display:block;cursor:pointer;width:32px !important;height:32px !important;background:url(&quot;//static.duoshuo.com/images/icons_large.png&quot;) no-repeat !important;overflow:hidden;text-indent:-9999px&#125;.ds-icons-32 a.ds-weibo&#123;background-position:-37px 0 !important&#125;.ds-icons-32 a.ds-qzone&#123;background-position:0 0 !important&#125;.ds-icons-32 a.ds-qqt&#123;background-position:-74px 0 !important&#125;.ds-icons-32 a.ds-renren&#123;background-position:-148px 0 !important&#125;.ds-icons-32 a.ds-kaixin&#123;background-position:-111px 0 !important&#125;.ds-icons-32 a.ds-weixin&#123;background-position:-224px 0 !important&#125;.ds-icons-32 a.ds-wechat&#123;background-position:-224px 0 !important&#125;.ds-icons-32 a.ds-qq&#123;background-position:-488px 0 !important&#125;.ds-icons-32 a.ds-douban&#123;background-position:-186px 0 !important&#125;.ds-icons-32 a.ds-baidu&#123;background-position:-262px 0 !important&#125;#ds-reset #ds-ctx&#123;padding:0;margin:8px 0;max-width:640px&#125;#ds-reset #ds-ctx .ds-ctx-entry&#123;padding:6px;margin:0;border-bottom:1px solid #e6e6e6&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a&#123;color:#e77064&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a:hover&#123;color:#d32&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-avatar&#123;margin:0;width:30px;height:30px&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-avatar img&#123;width:30px;height:30px;box-shadow:none&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-body&#123;margin-left:38px&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head&#123;position:relative;_zoom:1;line-height:1em;padding:1px 0 0;margin:0 0 .25em&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-nth&#123;color:#999;font-size:12px;position:absolute;top:2px;right:0&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-time&#123;font-size:12px;*font-size:12px;margin-left:8px;color:#999;_zoom:1&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-content&#123;position:relative;_zoom:1;padding:0;margin:0;overflow:hidden;line-height:1.5em&#125;#ds-reset #ds-ctx .ds-ctx-entry:hover .ds-comment-actions&#123;display:block&#125;#ds-reset #ds-ctx .ds-comment-actions&#123;bottom:0;right:0;line-height:18px;position:absolute;display:none;*display:block&#125;#ds-reset #ds-ctx .ds-comment-actions a&#123;margin:0 0 0 6px&#125;#ds-reset.ds-touch #ds-ctx .ds-ctx-entry .ds-comment-actions&#123;display:block&#125;#ds-reset .ds-comment-body #ds-ctx&#123;border-left:3px solid #ccc;background-color:rgba(0,0,0,0.03)&#125;#ds-reset.ds-no-opacity .ds-comment-body #ds-ctx&#123;background:#f8f8f8&#125;#ds-reset .ds-dialog-body #ds-ctx .ds-ctx-entry:hover .ds-comment-actions&#123;display:none&#125;#ds-thread&#123;clear:both;position:relative;overflow:visible;_zoom:1&#125;#ds-thread #ds-reset a&#123;cursor:pointer;text-decoration:none;color:#777;background-color:transparent;-webkit-transition:color .15s linear;-moz-transition:color .15s linear;transition:color .15s linear&#125;#ds-thread #ds-reset a:hover&#123;color:#333&#125;#ds-thread #ds-reset ul,#ds-thread #ds-reset ul li&#123;background:none;margin:0;padding:0&#125;#ds-thread #ds-reset .ds-arrow&#123;position:absolute;width:0;height:0;font-size:0 !important;line-height:0 !important;_border-right-color:#ffc0cb !important;_border-left-color:#ffc0cb !important;_filter:chroma(color=#ffc0cb) !important&#125;#ds-thread #ds-reset .ds-arrow-down&#123;border-left:5px solid transparent;border-right:5px solid transparent;border-top:5px solid #fff&#125;#ds-thread #ds-reset button&#123;cursor:pointer;margin:0;padding:0;border-radius:0&#125;#ds-thread #ds-reset .ds-meta&#123;position:relative;padding:8px 0;line-height:24px;border-bottom:1px solid rgba(0,0,0,0.13)&#125;#ds-thread #ds-reset .ds-like-tooltip&#123;position:absolute;z-index:9999;background-color:#fcfcfc;background-repeat:repeat-x;background-image:-khtml-gradient(linear, left top, left bottom, from(#fcfcfc), to(#f9f9f9));background:-moz-linear-gradient(top, #fcfcfc 0, #f9f9f9 100%);background:-webkit-gradient(linear, left top, left bottom, color-stop(0, #fcfcfc), color-stop(100%, #f9f9f9));background:-webkit-linear-gradient(top, #fcfcfc 0, #f9f9f9 100%);background:-ms-linear-gradient(top, #fcfcfc 0, #f9f9f9 100%);background:linear-gradient(top, #fcfcfc 0, #f9f9f9 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=&apos;#fcfcfc&apos;,endColorstr=&apos;#f9f9f9&apos;,GradientType=0);border:1px solid #aaa;box-shadow:0 0 2px rgba(0,0,0,0.2);text-shadow:0 1px 0 #fff;font-size:12px;padding:8px 14px&#125;#ds-thread #ds-reset .ds-like-tooltip ul&#123;width:84px;float:left&#125;#ds-thread #ds-reset .ds-like-tooltip li&#123;line-height:16px;margin:6px 0&#125;#ds-thread #ds-reset .ds-like-tooltip p&#123;clear:both;margin:6px 0&#125;#ds-thread #ds-reset .ds-like-tooltip .ds-like-tooltip-footer&#123;text-align:right&#125;#ds-thread #ds-reset a.ds-like-thread-button&#123;color:#555;padding:4px 8px;border:1px solid #ccc;border-bottom-color:#aaa;box-shadow:inset 0 0 1px #fff;margin-right:15px;text-shadow:0 1px 0 #fff;background-color:#e0e0e0;background-repeat:no-repeat;background-image:-webkit-gradient(linear, 0 0, 0 100%, from(#fff), color-stop(25%, #fff), to(#e0e0e0));background-image:-webkit-linear-gradient(#fff, #fff 25%, #e0e0e0);background-image:-moz-linear-gradient(top, #fff, #fff 25%, #e0e0e0);background-image:-ms-linear-gradient(#fff, #fff 25%, #e0e0e0);background-image:linear-gradient(#fff, #fff 25%, #e0e0e0)&#125;#ds-thread #ds-reset a.ds-like-thread-button .ds-icon-heart&#123;position:relative;top:-2px;opacity:1&#125;#ds-thread #ds-reset a.ds-like-thread-button span&#123;color:#555&#125;#ds-thread #ds-reset .ds-thread-cancel-like&#123;display:none&#125;#ds-thread #ds-reset a.ds-thread-liked&#123;background:#e9e9e9&#125;#ds-thread #ds-reset a.ds-thread-liked:hover .ds-thread-cancel-like&#123;display:inline&#125;#ds-thread #ds-reset a.ds-thread-liked:hover .ds-thread-like-text&#123;display:none&#125;#ds-thread #ds-reset #ds-hot-posts&#123;border:1px solid #ccc;overflow:hidden;margin:8px 0;padding:0;_height:100%&#125;#ds-thread #ds-reset .ds-header&#123;font-weight:bold;font-size:14px;color:#555;line-height:30px;padding:0 12px&#125;#ds-thread #ds-reset .ds-toolbar&#123;position:relative;z-index:5;font-size:12px;padding:8px 0;width:100%;clear:both&#125;#ds-thread #ds-reset .ds-toolbar:after&#123;content:&quot;.&quot;;display:block;height:0;clear:both;visibility:hidden&#125;#ds-thread #ds-reset .ds-visitor&#123;float:right;line-height:1.5em;margin-right:6px&#125;#ds-thread #ds-reset .ds-account-control&#123;float:right;position:relative;font-size:12px;cursor:pointer;text-align:right;line-height:18px;padding-bottom:3px;width:75px&#125;#ds-thread #ds-reset .ds-account-control span&#123;display:block;float:left;color:#999&#125;#ds-thread #ds-reset .ds-account-control ul&#123;display:none;position:absolute;top:19px;left:0;border:1px solid #aaa;background:#f8f8f8;box-shadow:inset 0 1px 1px #fff,0 1px 1px rgba(0,0,0,0.3);border-radius:3px;text-align:center&#125;#ds-thread #ds-reset .ds-account-control ul li a&#123;border-top:1px solid #fff;border-bottom:1px solid #ddd;display:block;padding:3px 10px;text-shadow:0 1px 0 #fff&#125;#ds-thread #ds-reset .ds-account-control ul li a:hover&#123;color:#555&#125;#ds-thread #ds-reset .ds-account-control.ds-active span&#123;color:#555&#125;#ds-thread #ds-reset .ds-account-control.ds-active ul&#123;display:block&#125;#ds-thread #ds-reset .ds-alert&#123;margin:.5em 0;border:1px solid #fbeed5;border-radius:3px;padding:6px 6px;color:#c09853;background-color:#fcf8e3;line-height:1.5em&#125;#ds-thread #ds-reset .ds-login-buttons&#123;width:100%;position:relative;padding:10px 0 6px&#125;#ds-thread #ds-reset .ds-login-buttons p&#123;float:left;line-height:24px;margin:0&#125;#ds-thread #ds-reset .ds-login-buttons .ds-service-list li&#123;float:left;height:16px;width:54px;padding:4px 0;margin:0 0 0 6px&#125;#ds-thread #ds-reset .ds-login-buttons .ds-more-services&#123;color:#d32 !important;line-height:16px;display:block&#125;#ds-thread #ds-reset .ds-login-buttons .ds-more-services:hover&#123;color:#e77064 !important&#125;#ds-thread #ds-reset .ds-login-buttons .ds-additional-services&#123;display:none&#125;#ds-thread #ds-reset .ds-login-buttons .ds-social-links&#123;float:left;width:306px&#125;#ds-thread #ds-reset .ds-login-buttons:after&#123;content:&quot;.&quot;;display:block;height:0;clear:both;visibility:hidden&#125;#ds-thread #ds-reset a.ds-unread-comments-count&#123;display:none;background-color:#d32;color:#fff !important;margin-right:6px;padding:1px 5px;font-weight:bold;-webkit-border-radius:5px;border-radius:5px;box-shadow:inset 0 1px 1px rgba(255,255,255,0.4),0 1px 1px rgba(0,0,0,0.3);text-shadow:0 1px 1px rgba(0,0,0,0.3)&#125;#ds-thread #ds-reset a.ds-unread-comments-count:hover&#123;background:#f00&#125;#ds-thread #ds-reset .ds-replybox&#123;width:auto;font-size:12px;z-index:3;margin:8px 0;padding:0 0 0 60px;position:relative;_zoom:1&#125;#ds-thread #ds-reset .ds-replybox:after&#123;content:&quot;.&quot;;display:block;height:0;clear:both;visibility:hidden&#125;#ds-thread #ds-reset .ds-replybox .ds-avatar&#123;position:absolute;top:0;left:0&#125;#ds-thread #ds-reset .ds-replybox .ds-avatar img&#123;width:50px;height:50px;visibility:visible;margin:0&#125;#ds-thread #ds-reset .ds-inline-replybox&#123;margin:8px 0 2px 0;padding-left:38px&#125;#ds-thread #ds-reset .ds-inline-replybox .ds-avatar img&#123;width:30px;height:30px;box-shadow:0 1px 2px rgba(0,0,0,0.22)&#125;#ds-thread #ds-reset .ds-textarea-wrapper&#123;position:relative;border:1px solid #ccc;border-bottom:none;padding-right:20px;background:#fff url(&quot;//static.duoshuo.com/images/bg_sprites.png&quot;) 0 -90px repeat-x;overflow:hidden&#125;#ds-thread #ds-reset .ds-textarea-wrapper textarea&#123;box-shadow:none;-webkit-appearance:none;overflow:auto;padding:10px;height:54px;margin:0;resize:none;color:#999;width:100%&#125;#ds-thread #ds-reset .ds-textarea-wrapper textarea:focus&#123;color:#333&#125;#ds-thread #ds-reset .ds-textarea-wrapper .ds-hidden-text&#123;word-wrap:break-word;visibility:hidden;position:absolute;top:0;left:10px;right:10px&#125;#ds-thread #ds-reset .ds-textarea-wrapper textarea,#ds-thread #ds-reset .ds-textarea-wrapper .ds-hidden-text&#123;display:block;font-family:&quot;Helvetica Neue&quot;,Helvetica,Arial,sans-serif;font-size:13px;line-height:20px;border:none&#125;#ds-thread #ds-reset .ds-post-toolbar&#123;position:relative;width:100%;box-shadow:0 1px 0 rgba(255,255,255,0.6)&#125;#ds-thread #ds-reset .ds-post-toolbar span,#ds-thread #ds-reset .ds-post-toolbar input,#ds-thread #ds-reset .ds-post-toolbar label,#ds-thread #ds-reset .ds-post-toolbar a&#123;vertical-align:middle;width:auto&#125;#ds-thread #ds-reset .ds-post-options&#123;position:relative;margin-right:100px;height:30px;border:1px solid #ccc;border-right:none;border-bottom-color:#aaa;border-bottom-left-radius:3px;-webkit-border-bottom-left-radius:3px&#125;#ds-thread #ds-reset .ds-toolbar-buttons&#123;position:absolute;top:5px;left:6px&#125;#ds-thread #ds-reset .ds-toolbar-button&#123;display:block;width:19px !important;height:19px;float:left;margin-right:4px;background:transparent url(&quot;//static.duoshuo.com/images/sprites.png&quot;) no-repeat;_background-image:url(&quot;//static.duoshuo.com/images/sprites.gif&quot;);vertical-align:middle;opacity:.6;-webkit-transition:opacity .15s linear;-moz-transition:opacity .15s linear;transition:opacity .15s linear&#125;#ds-thread #ds-reset .ds-toolbar-button:hover&#123;opacity:1&#125;#ds-thread #ds-reset .ds-add-image&#123;background-position:0 -48px&#125;#ds-thread #ds-reset .ds-add-image:hover&#123;background-position:0 -66px&#125;#ds-thread #ds-reset .ds-add-emote&#123;background-position:0 -12px&#125;#ds-thread #ds-reset .ds-add-emote:hover&#123;background-position:0 -30px&#125;#ds-thread #ds-reset .ds-sync&#123;font-size:12px;color:#999;line-height:30px;position:absolute;right:5px&#125;#ds-thread #ds-reset .ds-sync label&#123;color:#777;cursor:pointer;-webkit-transition:color .15s linear;-moz-transition:color .15s linear;transition:color .15s linear&#125;#ds-thread #ds-reset .ds-sync label:hover&#123;color:#555&#125;#ds-thread #ds-reset .ds-sync a.ds-service-icon,#ds-thread #ds-reset .ds-sync a.ds-service-icon-grey&#123;margin:7px 2px 7px 3px&#125;#ds-thread #ds-reset .ds-post-button&#123;font-family:&quot;Helvetica Neue&quot;,Helvetica,Arial,sans-serif;position:absolute;right:0;top:0;height:32px;width:100px;text-align:center;text-shadow:0 1px 0 #fff;color:#555;font-size:14px;font-weight:bold;border:1px solid #ccc;border-bottom-color:#aaa;border-bottom-right-radius:3px;-webkit-border-bottom-right-radius:3px;background-color:#e6e6e6;background-repeat:no-repeat;background-image:-webkit-gradient(linear, 0 0, 0 100%, from(#fcfcfc), color-stop(25%, #fcfcfc), to(#e6e6e6));background-image:-webkit-linear-gradient(#fcfcfc, #fcfcfc 25%, #e6e6e6);background-image:-moz-linear-gradient(top, #fcfcfc, #fcfcfc 25%, #e6e6e6);background-image:-ms-linear-gradient(#fcfcfc, #fcfcfc 25%, #e6e6e6);background-image:linear-gradient(#fcfcfc, #fcfcfc 25%, #e6e6e6);-webkit-transition:all .15s linear;-moz-transition:all .15s linear;transition:all .15s linear;box-shadow:inset 0 0 1px #fff&#125;#ds-thread #ds-reset .ds-post-button:hover&#123;background-position:0 -15px;color:#333&#125;#ds-thread #ds-reset .ds-post-button:active&#123;-webkit-box-shadow:inset 0 2px 4px rgba(0,0,0,0.15),0 1px 2px rgba(0,0,0,0.05);box-shadow:inset 0 2px 4px rgba(0,0,0,0.15),0 1px 2px rgba(0,0,0,0.05)&#125;#ds-thread #ds-reset .ds-comments-info&#123;width:100%;font-size:13px;margin-top:10px;padding:8px 0;line-height:25px;position:relative&#125;#ds-thread #ds-reset .ds-sort&#123;position:absolute;right:0;top:8px&#125;#ds-thread #ds-reset .ds-sort a&#123;color:#999;padding:0 4px;margin:0 2px&#125;#ds-thread #ds-reset .ds-sort a:hover&#123;color:#333&#125;#ds-thread #ds-reset .ds-sort a.ds-current,#ds-thread #ds-reset .ds-sort a:active&#123;color:#d32&#125;#ds-thread #ds-reset ul.ds-comments-tabs .ds-highlight&#123;margin:0 2px 0 0&#125;#ds-thread #ds-reset ul.ds-comments-tabs .ds-service-icon&#123;vertical-align:middle;margin:0 2px 1px 0&#125;#ds-thread #ds-reset li.ds-tab&#123;display:inline;font-size:13px;margin:0 5px 0 0;padding:0&#125;#ds-thread #ds-reset li.ds-tab a&#123;text-shadow:0 1px 0 #fff;padding:3px 5px;display:inline;-webkit-border-radius:5px;border-radius:5px&#125;#ds-thread #ds-reset li.ds-tab a.ds-current&#123;border:1px solid #ccc;background-color:rgba(0,0,0,0.04)&#125;#ds-thread #ds-reset li.ds-tab a:hover&#123;background-color:rgba(0,0,0,0.04)&#125;#ds-thread #ds-reset .ds-comments&#123;width:100%;border-bottom:1px solid rgba(0,0,0,0.13)&#125;#ds-thread #ds-reset .ds-comments:after&#123;content:&quot;.&quot;;display:block;height:0;clear:both;visibility:hidden&#125;#ds-thread #ds-reset li.ds-post&#123;width:100%;overflow:hidden;clear:both;border-top:1px solid rgba(0,0,0,0.13);margin:0;padding:0;list-style:none&#125;#ds-thread #ds-reset li.ds-post-placeholder&#123;text-align:center;color:#999;padding:1em 0&#125;#ds-thread #ds-reset .ds-post-self&#123;position:relative;padding:10px;border-top:1px solid rgba(255,255,255,0.7)&#125;#ds-thread #ds-reset .ds-post-self:after&#123;content:&quot;.&quot;;display:block;height:0;clear:both;visibility:hidden&#125;#ds-thread #ds-reset .ds-post-self:hover .ds-post-delete,#ds-thread #ds-reset .ds-post-self:hover .ds-post-report&#123;display:inline-block&#125;#ds-thread #ds-reset.ds-touch .ds-post-self .ds-post-delete,#ds-thread #ds-reset.ds-touch .ds-post-self .ds-post-report&#123;display:inline-block&#125;#ds-thread #ds-reset .ds-comment-body&#123;padding-left:60px&#125;#ds-thread #ds-reset .ds-comment-body p&#123;font-size:13px;line-height:1.5em;margin:.5em 0;word-wrap:break-word&#125;#ds-thread #ds-reset .ds-comment-body img&#123;max-width:100%;vertical-align:text-bottom;box-shadow:none&#125;#ds-thread #ds-reset .ds-comment-body embed&#123;max-width:100%&#125;#ds-thread #ds-reset .ds-comment-body code&#123;display:block;font-size:12px;font-family:Monaco,Menlo,Consolas,&quot;Courier New&quot;,monospace;padding:8px 12px;background-color:#f0f0f0;margin:8px 0;border-radius:3px;border:1px solid #ddd;color:#666&#125;#ds-thread #ds-reset .ds-comment-body a&#123;color:#777&#125;#ds-thread #ds-reset .ds-comment-body a:hover&#123;color:#555&#125;#ds-thread #ds-reset a.ds-comment-context&#123;position:relative;margin:.5em 0;color:#e77064&#125;#ds-thread #ds-reset a.ds-comment-context:hover&#123;color:#d32&#125;#ds-thread #ds-reset #ds-bubble&#123;position:absolute;background-color:#fff;-webkit-border-radius:5px;border-radius:5px;padding:10px;color:#333;border:1px solid #aaa;box-shadow:0 0 2px rgba(0,0,0,0.2);z-index:9999;font-size:13px&#125;#ds-thread #ds-reset #ds-bubble a&#123;color:#e77064&#125;#ds-thread #ds-reset #ds-bubble a:hover&#123;color:#d32&#125;#ds-thread #ds-reset #ds-bubble p&#123;line-height:18px&#125;#ds-thread #ds-reset #ds-bubble .ds-arrow-border&#123;border-top-color:#aaa;bottom:-6px&#125;#ds-thread #ds-reset #ds-bubble .ds-arrow&#123;left:32px;bottom:-5px&#125;#ds-thread #ds-reset #ds-ctx-bubble&#123;width:300px&#125;#ds-thread #ds-reset #ds-ctx-bubble .ds-bubble-footer&#123;padding:6px 0 0 0;line-height:18px&#125;#ds-thread #ds-reset #ds-user-card&#123;width:276px;min-height:50px&#125;#ds-thread #ds-reset #ds-user-card .ds-avatar&#123;margin-right:10px&#125;#ds-thread #ds-reset #ds-user-card .ds-avatar img&#123;width:50px;height:50px&#125;#ds-thread #ds-reset #ds-user-card .ds-user-name&#123;vertical-align:top;display:inline-block;max-width:8em;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;font-size:14px&#125;#ds-thread #ds-reset #ds-user-card .ds-user-card-meta&#123;margin:14px 0 0 62px&#125;#ds-thread #ds-reset #ds-user-card .ds-user-description&#123;border-top:1px dotted #ddd;margin-top:.5em;color:#aaa&#125;#ds-thread #ds-reset #ds-user-card .ds-service-icon&#123;margin-right:3px&#125;#ds-thread #ds-reset .ds-comment-header&#123;padding-top:1px&#125;#ds-thread #ds-reset .ds-comment-footer&#123;line-height:1.5em&#125;#ds-thread #ds-reset .ds-comment-footer a&#123;margin:0 6px 0 0;padding:0 6px 0 0&#125;#ds-thread #ds-reset .ds-comment-actions a&#123;font-size:12px;color:#999&#125;#ds-thread #ds-reset .ds-comment-actions a .ds-icon&#123;position:relative;top:-1px&#125;#ds-thread #ds-reset .ds-user-name&#123;color:#777;font-size:13px;margin-right:8px&#125;#ds-thread #ds-reset .ds-post-liked .ds-icon-like&#123;background-position:0 -130px&#125;#ds-thread #ds-reset .ds-post-liked a.ds-post-likes&#123;color:#d32&#125;#ds-thread #ds-reset .ds-reply-active&#123;display:block&#125;#ds-thread #ds-reset .ds-reply-active .ds-post-reply&#123;color:#333&#125;#ds-thread #ds-reset .ds-reply-active .ds-post-reply .ds-icon&#123;opacity:1&#125;#ds-thread #ds-reset .ds-post-delete,#ds-thread #ds-reset .ds-post-report&#123;display:none&#125;#ds-thread #ds-reset .ds-icon-heart&#123;width:14px;height:13px;background-position:0 -130px&#125;#ds-thread #ds-reset .ds-icon-settings&#123;width:12px;height:12px;margin:3px 4px 0;opacity:1&#125;#ds-thread #ds-reset .ds-icon-like&#123;width:14px;height:13px;background-position:0 -117px&#125;#ds-thread #ds-reset .ds-icon-share&#123;width:18px;height:13px;background-position:0 -234px&#125;#ds-thread #ds-reset .ds-icon-reply&#123;width:18px;height:13px;background-position:0 -105px&#125;#ds-thread #ds-reset .ds-icon-delete&#123;width:13px;height:13px;background-position:0 -176px&#125;#ds-thread #ds-reset .ds-icon-report&#123;width:12px;height:12px;background-position:0 -189px&#125;#ds-thread #ds-reset .ds-time&#123;font-size:12px;*font-size:12px;margin-right:8px;color:#999;_zoom:1&#125;#ds-thread #ds-reset ul.ds-children&#123;margin-left:38px&#125;#ds-thread #ds-reset ul.ds-children .ds-avatar&#123;width:30px;height:30px&#125;#ds-thread #ds-reset ul.ds-children .ds-avatar img&#123;width:30px;height:30px&#125;#ds-thread #ds-reset ul.ds-children .ds-post-self&#123;padding-left:0&#125;#ds-thread #ds-reset ul.ds-children .ds-comment-body&#123;padding-left:38px&#125;#ds-thread #ds-reset .ds-paginator&#123;border-bottom:1px solid rgba(0,0,0,0.13);text-align:right;padding-bottom:15px;clear:both;line-height:1em&#125;#ds-thread #ds-reset .ds-paginator div.ds-border&#123;border-top:1px solid rgba(255,255,255,0.7);margin-bottom:15px&#125;#ds-thread #ds-reset .ds-paginator a&#123;font-size:12px;margin:0 3px;padding:2px 5px;border:1px solid transparent&#125;#ds-thread #ds-reset .ds-paginator a:hover,#ds-thread #ds-reset .ds-paginator a.ds-current&#123;-webkit-border-radius:3px;border-radius:3px;background-color:rgba(0,0,0,0.03)&#125;#ds-thread #ds-reset .ds-paginator a.ds-current&#123;color:#d32;border:1px solid #ccc&#125;#ds-thread #ds-reset .ds-powered-by&#123;font-size:12px;text-align:right;padding:10px 0&#125;#ds-thread #ds-reset .ds-powered-by a&#123;color:#999;text-decoration:none&#125;#ds-thread #ds-reset .ds-powered-by a:hover&#123;color:#555&#125;#ds-thread #ds-reset.ds-no-transition .ds-post-button,#ds-thread #ds-reset.ds-no-transition .ds-more a&#123;background:url(&quot;//static.duoshuo.com/images/bg_sprites.png&quot;) repeat-x !important&#125;#ds-thread #ds-reset.ds-no-transition .ds-post-button:hover,#ds-thread #ds-reset.ds-no-transition .ds-more a:hover&#123;background-position:0 -30px !important&#125;#ds-thread #ds-reset.ds-no-transition .ds-like-thread-button&#123;background:url(&quot;//static.duoshuo.com/images/bg_sprites.png&quot;) repeat-x&#125;#ds-thread #ds-reset.ds-no-opacity li.ds-post&#123;border-top:1px solid #ddd&#125;#ds-thread #ds-reset.ds-no-opacity .ds-comments,#ds-thread #ds-reset.ds-no-opacity .ds-paginator&#123;border-bottom:1px solid #ddd&#125;#ds-thread #ds-reset.ds-no-opacity .ds-post-self&#123;border-top:none&#125;#ds-thread #ds-reset.ds-no-opacity .ds-tab a.ds-current&#123;background:#f8f8f8&#125;#ds-thread #ds-reset.ds-ie6 .ds-post-report,#ds-thread #ds-reset.ds-ie6 .ds-post-delete&#123;display:inline !important&#125;#ds-thread #ds-reset.ds-ie6 .ds-textarea-wrapper&#123;padding:10px 10px&#125;#ds-thread #ds-reset.ds-ie6 .ds-textarea-wrapper textarea&#123;width:95%;color:#333;padding:0&#125;#ds-thread #ds-reset.ds-ie6 .ds-post&#123;width:100%;float:left&#125;#ds-thread #ds-reset.ds-ie6 .ds-tab a.ds-current&#123;padding-bottom:5px&#125;#ds-thread #ds-reset.ds-ie6 #ds-ctx-bubble .ds-arrow&#123;bottom:-8px&#125;#ds-thread #ds-reset.ds-ie6 #ds-ctx-bubble .ds-arrow-border&#123;bottom:-9px&#125;#ds-thread.ds-narrow #ds-reset .ds-post-self&#123;padding:8px&#125;#ds-thread.ds-narrow #ds-reset .ds-comment-body,#ds-thread.ds-narrow #ds-reset .ds-replybox&#123;padding-left:38px&#125;#ds-thread.ds-narrow #ds-reset .ds-avatar img&#123;width:30px;height:30px&#125;#ds-thread.ds-narrow #ds-reset .ds-post-button&#123;width:70px&#125;#ds-thread.ds-narrow #ds-reset .ds-post-options&#123;margin-right:70px&#125;#ds-smilies-tooltip&#123;border:1px solid #aaa;position:absolute;width:400px;background-color:#fff;z-index:9999;box-shadow:0 0 2px rgba(0,0,0,0.2);text-shadow:0 1px 0 #fff;-webkit-border-radius:3px;border-radius:3px&#125;#ds-smilies-tooltip a&#123;cursor:pointer&#125;#ds-smilies-tooltip ul&#123;list-style-type:none;padding:0;margin:0&#125;#ds-smilies-tooltip ul.ds-smilies-tabs&#123;width:119px;position:absolute;top:0;left:0;height:159px;overflow-y:auto;background:#f8f8f8;border-right:1px solid #ccc;border-top-left-radius:3px;border-bottom-left-radius:3px&#125;#ds-smilies-tooltip ul.ds-smilies-tabs li a&#123;color:#999;padding:6px 10px;display:block;border-bottom:1px solid #ccc;background-color:#fff;background-repeat:repeat-x;background-image:-khtml-gradient(linear, left top, left bottom, from(#fff), to(#e9e9e9));background:-moz-linear-gradient(top, #fff 0, #e9e9e9 100%);background:-webkit-gradient(linear, left top, left bottom, color-stop(0, #fff), color-stop(100%, #e9e9e9));background:-webkit-linear-gradient(top, #fff 0, #e9e9e9 100%);background:-ms-linear-gradient(top, #fff 0, #e9e9e9 100%);background:linear-gradient(top, #fff 0, #e9e9e9 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=&apos;#ffffff&apos;,endColorstr=&apos;#e9e9e9&apos;,GradientType=0);font-size:12px;line-height:1.3em&#125;#ds-smilies-tooltip ul.ds-smilies-tabs li:first-child a&#123;border-top-left-radius:3px&#125;#ds-smilies-tooltip ul.ds-smilies-tabs li a.ds-current&#123;color:#666;background:#e3e3e3;filter:none;box-shadow:inset 0 0 4px rgba(0,0,0,0.1)&#125;#ds-smilies-tooltip .ds-smilies-container&#123;padding:10px 5px;height:140px;margin-left:125px;overflow-y:auto&#125;#ds-smilies-tooltip .ds-smilies-container li&#123;list-style:none;float:left;width:26px;height:26px;text-align:center;cursor:pointer&#125;#ds-smilies-tooltip .ds-smilies-container li img&#123;visibility:visible&#125;#ds-smilies-tooltip .ds-smilies-container li:hover&#123;position:relative;top:-1px&#125;#ds-wrapper&#123;left:0;right:0;top:20%;bottom:0;width:100%;margin:auto;z-index:9999;position:fixed;_position:absolute;text-align:center;color:#777&#125;#ds-wrapper .ds-dialog,#ds-wrapper #ds-reset.ds-dialog&#123;margin:0 auto;text-align:left;_zoom:1;width:480px;max-width:100%&#125;#ds-wrapper #ds-reset.ds-dialog-bind-more .ds-service-list&#123;width:50%&#125;#ds-wrapper #ds-reset a&#123;cursor:pointer;text-decoration:none;color:#777&#125;#ds-wrapper #ds-reset .ds-dialog-inner&#123;width:100%;position:relative;border:1px solid #aaa;background:#fff url(&quot;//static.duoshuo.com/images/bg_sprites.png&quot;) 0 -90px repeat-x;text-shadow:0 1px 0 #fff;box-shadow:inset 0 1px 1px #fff,0 2px 6px rgba(0,0,0,0.4)&#125;#ds-wrapper #ds-reset .ds-dialog-inner .ds-unread-list&#123;max-height:300px;overflow-y:auto&#125;#ds-wrapper #ds-reset .ds-control-group&#123;margin:18px 0;position:relative;padding-right:80px;max-width:166px&#125;#ds-wrapper #ds-reset .ds-control-group input&#123;color:#777;width:100%;font-size:13px;border:1px solid #ccc;padding:4px 80px 6px 6px;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1)&#125;#ds-wrapper #ds-reset .ds-control-group input:focus&#123;border-color:#08b5fb&#125;#ds-wrapper #ds-reset .ds-control-group label&#123;font-size:13px;color:#ccc;letter-spacing:1px;position:absolute;right:0;top:8px&#125;#ds-wrapper #ds-reset tr&#123;height:45px&#125;#ds-wrapper #ds-reset button&#123;cursor:pointer;color:#555;background-color:#e6e6e6;background-repeat:no-repeat;background-image:-webkit-gradient(linear, 0 0, 0 100%, from(#fff), color-stop(25%, #fff), to(#e6e6e6));background-image:-webkit-linear-gradient(#fff, #fff 25%, #e6e6e6);background-image:-moz-linear-gradient(top, #fff, #fff 25%, #e6e6e6);background-image:-ms-linear-gradient(#fff, #fff 25%, #e6e6e6);background-image:linear-gradient(#fff, #fff 25%, #e6e6e6);-webkit-transition:all .15s linear;-moz-transition:all .15s linear;transition:all .15s linear;border:1px solid #aaa;display:inline-block;font-size:15px;height:30px;width:100px;padding:0&#125;#ds-wrapper #ds-reset button:hover&#123;background-position:0 -15px;color:#333&#125;#ds-wrapper #ds-reset button:active&#123;top:0;-webkit-box-shadow:inset 0 2px 4px rgba(0,0,0,0.15),0 1px 2px rgba(0,0,0,0.05);box-shadow:inset 0 2px 4px rgba(0,0,0,0.15),0 1px 2px rgba(0,0,0,0.05)&#125;#ds-wrapper #ds-reset h2&#123;display:block;font-weight:normal;font-size:16px;margin:0 0 15px 0;color:#555&#125;#ds-wrapper #ds-reset .ds-dialog-body&#123;padding:30px 30px 25px;position:relative;overflow:hidden&#125;#ds-wrapper #ds-reset .ds-icons-32&#123;height:32px;margin-bottom:20px;overflow:hidden&#125;#ds-wrapper #ds-reset .ds-icons-32 a&#123;float:left;margin:0 5px 0 0&#125;#ds-wrapper #ds-reset ul li&#123;margin:10px 0&#125;#ds-wrapper #ds-reset .ds-service-list&#123;width:45%;float:left&#125;#ds-wrapper #ds-reset .ds-service-list .ds-more-services&#123;display:none&#125;#ds-wrapper #ds-reset .ds-icon-ok&#123;background-position:0 -203px;width:12px;height:12px&#125;#ds-wrapper #ds-reset .ds-quote&#123;margin:10px 0;padding:6px 10px;background:#f8f8f8;line-height:1.5em;font-size:12px;overflow-y:auto;max-height:180px&#125;#ds-wrapper #ds-reset .ds-textarea-wrapper&#123;border:1px solid #ccc;padding:0 20px 0 0;position:relative;margin:12px 0&#125;#ds-wrapper #ds-reset .ds-textarea-wrapper textarea&#123;width:100%;height:54px;margin:0;resize:none;padding:6px 10px;overflow:auto&#125;#ds-wrapper #ds-reset .ds-textarea-wrapper .ds-hidden-text&#123;top:0;left:10px;right:10px;position:absolute;visibility:hidden;word-wrap:break-word&#125;#ds-wrapper #ds-reset .ds-textarea-wrapper textarea,#ds-wrapper #ds-reset .ds-textarea-wrapper .ds-hidden-text&#123;font-size:13px;line-height:1.5em&#125;#ds-wrapper #ds-reset .ds-actions&#123;position:relative;height:30px&#125;#ds-wrapper #ds-reset .ds-actions button&#123;display:block;position:absolute;top:0;right:0&#125;#ds-wrapper #ds-reset .ds-dialog-close&#123;position:absolute;bottom:13px;right:11px;display:block;width:13px;height:13px;overflow:hidden;background:transparent url(&quot;//static.duoshuo.com/images/sprites.png&quot;) 0 -163px no-repeat;_background-image:url(&quot;//static.duoshuo.com/images/sprites.gif&quot;)&#125;#ds-wrapper #ds-reset .ds-dialog-close:hover&#123;background-position:0 -176px&#125;#ds-wrapper #ds-reset .ds-logo&#123;display:inline-block;width:64px;height:21px;margin-right:10px;background:url(&quot;//static.duoshuo.com/images/logo.png&quot;) 0 0 no-repeat&#125;#ds-wrapper #ds-reset .ds-dialog-footer&#123;clear:both;border-top:1px dotted #ccc;padding:10px 15px 6px&#125;#ds-wrapper #ds-reset .ds-dialog-footer span&#123;color:#999;position:relative;top:-6px&#125;#ds-wrapper #ds-reset .ds-connect&#123;display:none&#125;#ds-wrapper #ds-reset .ds-unread-list li&#123;position:relative;margin:0;padding:8px 0;border-top:1px solid #eee;line-height:1.5em;color:#777&#125;#ds-wrapper #ds-reset .ds-unread-list li a&#123;color:#d32&#125;#ds-wrapper #ds-reset .ds-unread-list li a:hover&#123;color:#e45c4e&#125;#ds-wrapper #ds-reset .ds-unread-list li a[rel~=&quot;author&quot;]&#123;color:#777&#125;#ds-wrapper #ds-reset .ds-unread-list li .ds-delete&#123;display:none;position:absolute;right:0;bottom:10px;text-indent:-9999px;width:14px;height:14px;overflow:hidden;background:transparent url(&quot;//static.duoshuo.com/images/delete.gif&quot;) no-repeat scroll 0 -14px&#125;#ds-wrapper #ds-reset .ds-unread-list li:hover .ds-delete&#123;display:block&#125;#ds-wrapper #ds-reset.ds-touch .ds-unread-list li .ds-delete&#123;display:block&#125;#ds-wrapper.ds-no-transition #ds-reset button&#123;background:url(&quot;//static.duoshuo.com/images/bg_sprites.png&quot;) repeat-x !important&#125;#ds-wrapper.ds-no-transition #ds-reset button:hover&#123;background-position:0 -30px !important&#125;#ds-wrapper.ds-no-transition #ds-reset.ds-dialog&#123;background-image:url(&quot;//static.duoshuo.com/images/black.png&quot;)&#125;#ds-wrapper.ds-ie6 #ds-reset&#123;margin-top:0&#125;#ds-wrapper.ds-ie6 #ds-reset .ds-dialog-footer span&#123;top:-3px&#125;#ds-notify&#123;position:fixed;*position:absolute;z-index:9999;max-width:144px;_width:130px;display:block;float:none;padding:8px 12px;background-color:#fff;-webkit-border-radius:5px;border-radius:5px;box-shadow:0 1px 1px rgba(0,0,0,0.25);border:1px solid #aaa&#125;#ds-notify #ds-reset&#123;line-height:14px&#125;#ds-notify #ds-reset a.ds-logo&#123;width:18px;height:14px;background:transparent url(&quot;//static.duoshuo.com/images/sprites.png&quot;) 0 -220px no-repeat;_background-image:url(&quot;//static.duoshuo.com/images/sprites.gif&quot;);position:absolute;display:block;top:8px;left:12px&#125;#ds-notify #ds-reset span.ds-unread-count&#123;font-weight:bold;color:#e32&#125;#ds-notify #ds-reset ul.ds-notify-unread&#123;line-height:150%;display:inline-block;margin:0 0 0 22px;padding:0&#125;#ds-notify #ds-reset ul.ds-notify-unread li a&#123;color:#d32;text-decoration:none&#125;#ds-recent-comments li.ds-comment&#123;list-style-type:none;position:relative !important;margin:0 !important;padding:6px 0 !important;_zoom:1;border-top:1px solid #dcdcdc;word-wrap:break-word;font-size:13px&#125;#ds-recent-comments li.ds-comment a&#123;display:inline&#125;#ds-recent-comments li.ds-comment div&#123;padding:0;margin:0&#125;#ds-recent-comments li.ds-comment .ds-avatar&#123;position:absolute !important;top:6px !important;left:0 !important&#125;#ds-recent-comments li.ds-comment .ds-avatar a&#123;display:block&#125;#ds-recent-comments li.ds-comment .ds-meta&#123;*margin-left:-15px;_margin-left:0&#125;#ds-recent-comments li.ds-comment .ds-time&#123;font-size:10px;color:#999;margin-left:5px&#125;#ds-recent-comments li.ds-comment .ds-thread-title&#123;margin:0 0 4px 0;line-height:13px;font-size:12px;color:#777&#125;#ds-recent-comments li.ds-comment .ds-thread-title a&#123;font-size:12px&#125;#ds-recent-comments li.ds-comment .ds-excerpt&#123;line-height:18px&#125;#ds-recent-comments li.ds-comment.ds-show-avatars&#123;padding-left:38px !important&#125;#ds-recent-visitors .ds-avatar&#123;display:inline;padding:0 !important;margin:4px !important&#125;#ds-login .ds-icons-32 a&#123;float:left;margin:0 5px 0 0&#125;#ds-share #ds-reset.ds-share-aside-left ul,#ds-share #ds-reset.ds-share-aside-right ul,#ds-share #ds-reset.ds-share-inline ul&#123;list-style:none;margin:0;padding:0;*zoom:1&#125;#ds-share #ds-reset.ds-share-aside-left ul:after,#ds-share #ds-reset.ds-share-aside-right ul:after,#ds-share #ds-reset.ds-share-inline ul:after&#123;content:&quot;.&quot;;display:block;height:0;clear:both;visibility:hidden&#125;#ds-share #ds-reset.ds-share-aside-left ul li,#ds-share #ds-reset.ds-share-aside-right ul li,#ds-share #ds-reset.ds-share-inline ul li&#123;list-style:none;float:left;font-size:14px;padding:7px 0&#125;#ds-share #ds-reset.ds-share-inline&#123;position:relative&#125;#ds-share #ds-reset.ds-share-inline ul li&#123;margin-left:8px&#125;#ds-share #ds-reset.ds-share-inline ul li:first-child&#123;margin-left:0&#125;#ds-share #ds-reset.ds-share-aside-left,#ds-share #ds-reset.ds-share-aside-right&#123;position:fixed;top:50%;z-index:1000;-webkit-transition:all .2s linear;-moz-transition:all .2s linear;transition:all .2s linear&#125;#ds-share #ds-reset.ds-share-aside-left&#123;left:0;-webkit-transform:translate(-100%, -50%);-ms-transform:translate(-100%, -50%);-o-transform:translate(-100%, -50%);transform:translate(-100%, -50%)&#125;#ds-share #ds-reset.ds-share-aside-right&#123;right:0;-webkit-transform:translate(100%, -50%);-ms-transform:translate(100%, -50%);-o-transform:translate(100%, -50%);transform:translate(100%, -50%)&#125;#ds-share #ds-reset .ds-share-aside-toggle&#123;width:28px;padding:23px 2px;background:#e94c4c;color:#fff;position:absolute;top:0;text-align:center;font-size:16px;font-weight:bolder;cursor:pointer&#125;#ds-share #ds-reset.ds-share-aside-left .ds-share-aside-toggle&#123;right:-32px;border-top-right-radius:3px;border-bottom-right-radius:3px&#125;#ds-share #ds-reset.ds-share-aside-left .ds-share-icons&#123;border-top-right-radius:0;border-top-left-radius:0;border-bottom-left-radius:0;border-left:none&#125;#ds-share #ds-reset.ds-share-aside-right .ds-share-aside-toggle&#123;left:-32px;border-top-left-radius:3px;border-bottom-left-radius:3px&#125;#ds-share #ds-reset.ds-share-aside-right .ds-share-icons&#123;border-top-left-radius:0;border-top-right-radius:0;border-bottom-right-radius:0;border-right:none&#125;#ds-share #ds-reset.slide-to-left&#123;-webkit-transform:translate(0, -50%);-ms-transform:translate(0, -50%);-o-transform:translate(0, -50%);transform:translate(0, -50%)&#125;#ds-share #ds-reset.slide-to-right&#123;-webkit-transform:translate(0, -50%);-ms-transform:translate(0, -50%);-o-transform:translate(0, -50%);transform:translate(0, -50%)&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-weibo,#ds-share #ds-reset .ds-share-icons-32 .ds-sohu,#ds-share #ds-reset .ds-share-icons-32 .ds-renren,#ds-share #ds-reset .ds-share-icons-32 .ds-netease,#ds-share #ds-reset .ds-share-icons-32 .ds-qqt,#ds-share #ds-reset .ds-share-icons-32 .ds-kaixin,#ds-share #ds-reset .ds-share-icons-32 .ds-douban,#ds-share #ds-reset .ds-share-icons-32 .ds-msn,#ds-share #ds-reset .ds-share-icons-32 .ds-qzone,#ds-share #ds-reset .ds-share-icons-32 .ds-duoshuo,#ds-share #ds-reset .ds-share-icons-32 .ds-360,#ds-share #ds-reset .ds-share-icons-32 .ds-alipay,#ds-share #ds-reset .ds-share-icons-32 .ds-qq,#ds-share #ds-reset .ds-share-icons-32 .ds-baidu,#ds-share #ds-reset .ds-share-icons-32 .ds-taobao,#ds-share #ds-reset .ds-share-icons-32 .ds-google,#ds-share #ds-reset .ds-share-icons-32 .ds-more,#ds-share #ds-reset .ds-share-icons-32 .ds-wechat,#ds-share #ds-reset .ds-share-icons-32 .ds-diandian,#ds-share #ds-reset .ds-share-icons-32 .ds-huaban,#ds-share #ds-reset .ds-share-icons-32 .ds-duitang,#ds-share #ds-reset .ds-share-icons-32 .ds-youdao,#ds-share #ds-reset .ds-share-icons-32 .ds-pengyou,#ds-share #ds-reset .ds-share-icons-32 .ds-facebook,#ds-share #ds-reset .ds-share-icons-32 .ds-twitter,#ds-share #ds-reset .ds-share-icons-32 .ds-linkedin,#ds-share #ds-reset .ds-share-icons-32 .ds-meilishuo,#ds-share #ds-reset .ds-share-icons-32 .ds-mogujie&#123;height:32px;width:32px;text-decoration:none;color:#999;display:block;overflow:hidden;background-image:url(&quot;//static.duoshuo.com/images/service-icons-color-32.png&quot;);background-repeat:no-repeat;_background-image:url(&quot;//static.duoshuo.com/images/service-icons-color-32.gif&quot;)&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-weibo&#123;background-position:0 0&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-sohu&#123;background-position:0 -32px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-renren&#123;background-position:0 -64px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-netease&#123;background-position:0 -96px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-qqt&#123;background-position:0 -128px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-kaixin&#123;background-position:0 -160px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-douban&#123;background-position:0 -192px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-msn&#123;background-position:0 -224px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-qzone&#123;background-position:0 -256px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-duoshuo&#123;background-position:0 -288px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-360&#123;background-position:0 -320px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-alipay&#123;background-position:0 -352px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-qq&#123;background-position:0 -384px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-baidu&#123;background-position:0 -416px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-taobao&#123;background-position:0 -448px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-google&#123;background-position:0 -480px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-more&#123;background-position:0 -512px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-wechat&#123;background-position:0 -544px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-diandian&#123;background-position:0 -576px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-huaban&#123;background-position:0 -608px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-duitang&#123;background-position:0 -640px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-youdao&#123;background-position:0 -672px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-pengyou&#123;background-position:0 -704px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-facebook&#123;background-position:0 -736px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-twitter&#123;background-position:0 -768px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-linkedin&#123;background-position:0 -800px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-meilishuo&#123;background-position:0 -832px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-mogujie&#123;background-position:0 -864px&#125;#ds-share #ds-reset .ds-share-icons-32 .flat&#123;background-image:url(&quot;//static.duoshuo.com/images/service-icons-color-flat-32.png&quot;);_background-image:url(&quot;//static.duoshuo.com/images/service-icons-color-flat-32.gif&quot;)&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-weibo,#ds-share #ds-reset .ds-share-icons-16 .ds-sohu,#ds-share #ds-reset .ds-share-icons-16 .ds-renren,#ds-share #ds-reset .ds-share-icons-16 .ds-netease,#ds-share #ds-reset .ds-share-icons-16 .ds-qqt,#ds-share #ds-reset .ds-share-icons-16 .ds-kaixin,#ds-share #ds-reset .ds-share-icons-16 .ds-douban,#ds-share #ds-reset .ds-share-icons-16 .ds-msn,#ds-share #ds-reset .ds-share-icons-16 .ds-qzone,#ds-share #ds-reset .ds-share-icons-16 .ds-duoshuo,#ds-share #ds-reset .ds-share-icons-16 .ds-360,#ds-share #ds-reset .ds-share-icons-16 .ds-alipay,#ds-share #ds-reset .ds-share-icons-16 .ds-qq,#ds-share #ds-reset .ds-share-icons-16 .ds-baidu,#ds-share #ds-reset .ds-share-icons-16 .ds-taobao,#ds-share #ds-reset .ds-share-icons-16 .ds-google,#ds-share #ds-reset .ds-share-icons-16 .ds-more,#ds-share #ds-reset .ds-share-icons-16 .ds-wechat,#ds-share #ds-reset .ds-share-icons-16 .ds-diandian,#ds-share #ds-reset .ds-share-icons-16 .ds-huaban,#ds-share #ds-reset .ds-share-icons-16 .ds-duitang,#ds-share #ds-reset .ds-share-icons-16 .ds-youdao,#ds-share #ds-reset .ds-share-icons-16 .ds-pengyou,#ds-share #ds-reset .ds-share-icons-16 .ds-facebook,#ds-share #ds-reset .ds-share-icons-16 .ds-twitter,#ds-share #ds-reset .ds-share-icons-16 .ds-linkedin,#ds-share #ds-reset .ds-share-icons-16 .ds-meilishuo,#ds-share #ds-reset .ds-share-icons-16 .ds-mogujie&#123;line-height:16px;padding-left:20px;text-decoration:none;color:#999;display:block;overflow:hidden;background-image:url(&quot;//static.duoshuo.com/images/service-icons-color.png?v=2&quot;);background-repeat:no-repeat;_background-image:url(&quot;//static.duoshuo.com/images/service-icons-color.gif?v=2&quot;)&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-weibo&#123;background-position:0 0&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-sohu&#123;background-position:0 -16px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-renren&#123;background-position:0 -32px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-netease&#123;background-position:0 -48px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-qqt&#123;background-position:0 -64px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-kaixin&#123;background-position:0 -80px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-douban&#123;background-position:0 -96px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-msn&#123;background-position:0 -112px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-qzone&#123;background-position:0 -128px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-duoshuo&#123;background-position:0 -144px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-360&#123;background-position:0 -160px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-alipay&#123;background-position:0 -176px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-qq&#123;background-position:0 -192px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-baidu&#123;background-position:0 -208px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-taobao&#123;background-position:0 -224px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-google&#123;background-position:0 -240px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-more&#123;background-position:0 -256px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-wechat&#123;background-position:0 -272px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-diandian&#123;background-position:0 -288px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-huaban&#123;background-position:0 -304px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-duitang&#123;background-position:0 -320px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-youdao&#123;background-position:0 -336px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-pengyou&#123;background-position:0 -352px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-facebook&#123;background-position:0 -368px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-twitter&#123;background-position:0 -384px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-linkedin&#123;background-position:0 -400px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-meilishuo&#123;background-position:0 -416px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-mogujie&#123;background-position:0 -432px&#125;#ds-share #ds-reset .ds-share-icons-16 .flat&#123;background-image:url(&quot;//static.duoshuo.com/images/service-icons-color-flat.png&quot;);_background-image:url(&quot;//static.duoshuo.com/images/service-icons-color-flat.gif&quot;)&#125;#ds-share #ds-reset .ds-share-icons&#123;border:1px solid #ccc;background:#fff;border-radius:3px&#125;#ds-share #ds-reset .ds-share-icons .ds-share-icons-inner&#123;width:208px;padding:10px&#125;#ds-share #ds-reset .ds-share-icons .ds-share-icons-inner ul&#123;margin:0;padding:0&#125;#ds-share #ds-reset .ds-share-icons .ds-share-icons-inner ul li&#123;padding-left:8px;margin-left:0;width:92px;font-size:12px&#125;#ds-share #ds-reset .ds-share-icons .ds-share-icons-inner ul li:hover&#123;border-radius:3px;background:#eee&#125;#ds-share #ds-reset .ds-share-icons .ds-share-icons-inner ul li:nth-child(even)&#123;margin-left:8px&#125;#ds-share #ds-reset .ds-share-icons .ds-share-icons-footer&#123;text-align:right;line-height:30px;font-size:12px;color:#ccc;background-color:#eee;padding-right:10px&#125;#ds-share #ds-reset .ds-share-icons-more&#123;top:30px;left:0;position:absolute;z-index:1000&#125;#ds-share.ds-no-transition #ds-reset.ds-share-aside-left&#123;left:-229px;transform:none&#125;#ds-share.ds-no-transition #ds-reset.ds-share-aside-right&#123;right:-229px;transform:none&#125;#ds-share .ds-share-aside-left,#ds-share .ds-share-aside-right&#123;width:230px;_position:absolute;_bottom:auto;_top:expression(eval(document.documentElement.scrollTop+200))&#125;#ds-share .ds-share-aside-left&#123;_left:expression(eval(document.documentElement.scrollLeft-230))&#125;#ds-share .ds-share-aside-right&#123;_right:auto;_left:expression(eval(document.documentElement.scrollLeft+document.documentElement.clientWidth-this.offsetWidth)-(parseInt(this.currentStyle.marginLeft,10)||0)-(parseInt(this.currentStyle.marginRight,10)||0 - 230))&#125;</div></pre></td></tr></table></figure>
<p>具体样式请参照：<a href="https://github.com/luuman/Hexo/blob/master/themes/spfk/source/css/%E5%A4%9A%E8%AF%B4.css" target="_blank" rel="external">多说.css</a></p>
<h2 id="为Hexo博客添加目录"><a href="#为Hexo博客添加目录" class="headerlink" title="为Hexo博客添加目录"></a>为Hexo博客添加目录</h2><p>Hexo博客系统的核心支持生成目录（Table of Contents），但其默认的主题Landscape并不支持目录的显示。我们只需对Landscape的主题文件稍作修改并添加一点目录的CSS就可以在文章前面显示友好的目录了。</p>
<blockquote>
<p>修改Landscape主题的ejs文件</p>
</blockquote>
<p>我们首先要编辑文章显示页面的模板，也就是themes/landscape/layout/_partial/article.ejs文件。为了将目录生成在正文之前，我们首先在这个文件中找到&lt;%- post.content %&gt;，并在这一行之前加入如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">    引入文件_partial\article.ejs</div><div class="line">    &lt;% if (!index &amp;&amp; post.toc != false &amp;&amp; !is_page())&#123; %&gt;</div><div class="line">        &lt;%- partial(&apos;_partial/toc&apos;) %&gt;</div><div class="line">    &lt;% &#125; %&gt;</div><div class="line"></div><div class="line"></div><div class="line">    &lt;% if (!index &amp;&amp; post.toc)&#123; %&gt;</div><div class="line">    &lt;%- partial(&apos;post/toc&apos;) %&gt;</div><div class="line">    &lt;% &#125; %&gt;</div><div class="line"></div><div class="line">&lt;div id=&quot;toc&quot; class=&quot;toc-article&quot;&gt;</div><div class="line">    &lt;strong class=&quot;toc-title&quot;&gt;文章目录&lt;/strong&gt;</div><div class="line">    &lt;%- toc(post.content) %&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;style&gt;</div><div class="line">    .left-col .switch-btn &#123;</div><div class="line">        display: none;</div><div class="line">    &#125;</div><div class="line">    .left-col .switch-area &#123;</div><div class="line">        display: none;</div><div class="line">    &#125;</div><div class="line">&lt;/style&gt;</div><div class="line"></div><div class="line">&lt;input type=&quot;button&quot; id=&quot;tocButton&quot; value=&quot;隐藏目录&quot;  title=&quot;点击按钮隐藏或者显示文章目录&quot;&gt;</div><div class="line"></div><div class="line">&lt;%- js(&apos;http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min&apos;) %&gt;</div><div class="line">&lt;script&gt;</div><div class="line">    var toc_button = document.getElementById(&quot;tocButton&quot;);</div><div class="line">    var toc_div = document.getElementById(&quot;toc&quot;);</div><div class="line">    toc_button.onclick=function() &#123;</div><div class="line">        if (toc_div.style.display == &quot;none&quot;) &#123;</div><div class="line">            toc_div.style.display = &quot;block&quot;;</div><div class="line">            toc_button.value = &quot;隐藏目录&quot;;</div><div class="line">            document.getElementById(&quot;switch-btn&quot;).style.display = &quot;none&quot;;</div><div class="line">            document.getElementById(&quot;switch-area&quot;).style.display = &quot;none&quot;;</div><div class="line">        &#125;</div><div class="line">        else &#123;</div><div class="line">            toc_div.style.display = &quot;none&quot;;</div><div class="line">            toc_button.value = &quot;显示目录&quot;;</div><div class="line">            document.getElementById(&quot;switch-btn&quot;).style.display = &quot;block&quot;;</div><div class="line">            document.getElementById(&quot;switch-area&quot;).style.display = &quot;block&quot;;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if ($(&quot;.toc&quot;).length &lt; 1) &#123;</div><div class="line">        $(&quot;#toc&quot;).css(&quot;display&quot;,&quot;none&quot;);</div><div class="line">        $(&quot;#tocButton&quot;).css(&quot;display&quot;,&quot;none&quot;);</div><div class="line">        $(&quot;.switch-btn&quot;).css(&quot;display&quot;,&quot;block&quot;);</div><div class="line">        $(&quot;.switch-area&quot;).css(&quot;display&quot;,&quot;block&quot;);</div><div class="line">    &#125;</div><div class="line">&lt;/script&gt;</div><div class="line"></div><div class="line">&lt;% if (theme.toc_nowrap) &#123; %&gt;</div><div class="line">    &lt;style&gt;</div><div class="line">        .toc &#123;</div><div class="line">            white-space: nowrap;</div><div class="line">            overflow-x: hidden;</div><div class="line">        &#125;</div><div class="line">    &lt;/style&gt;</div><div class="line"></div><div class="line">    &lt;script&gt;</div><div class="line">        $(document).ready(function() &#123;</div><div class="line">            $(&quot;.toc li a&quot;).mouseover(function() &#123;</div><div class="line">                var title = $(this).attr(&apos;href&apos;);</div><div class="line">                $(this).attr(&quot;title&quot;, title);</div><div class="line">            &#125;);</div><div class="line">        &#125;)</div><div class="line">    &lt;/script&gt;</div><div class="line">&lt;% &#125; %&gt;</div></pre></td></tr></table></figure>
<p>这段代码的含义清晰明了，if语句中有两个条件，!index是为了不在首页的文章摘要中生成目录，post.toc确保了只在显式地标记了toc: true的文章中生成目录。若这两个条件满足，则创建一个目录的<div>。</div></p>
<p>修改完这个文件之后，找一篇包含了多个子标题的文章，并在文章开头的front-matter中添加一句toc: true，在浏览器中访问这篇文章，应该可以看到文章的开头处已经有了带链接的目录。但是这样的目录实在太难看，我们还需要添加相应的CSS来将其指定为我们想要的样式。</p>
<blockquote>
<p>为目录编写CSS文件</p>
</blockquote>
<p>要指定目录的样式，我们要修改的文件是themes/landscape/source/css/_partial/article.styl。在文件的最后，添加如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line">/*toc*/</div><div class="line">#tocButton &#123;</div><div class="line">    position: fixed;</div><div class="line">    border: none;</div><div class="line">    left: 220px;</div><div class="line">    top: 382px;</div><div class="line">    background: none;</div><div class="line">    font-size: .9em;</div><div class="line">    font-weight: bold;</div><div class="line">    color: lightgray;</div><div class="line">    cursor: pointer</div><div class="line">    font-family: inherit;</div><div class="line">    outline: none; /*Remove button border when clicked.*/</div><div class="line">    -webkit-appearance: none; /*Remove iOS button style*/</div><div class="line">    &amp;:hover &#123;</div><div class="line">        color: #88acdb;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">.toc-article &#123;</div><div class="line">  position: fixed;</div><div class="line">  width: 230px;</div><div class="line">  top: 378px;</div><div class="line">  bottom: 1em;</div><div class="line">  left: 0;</div><div class="line">  margin-left: 0em;</div><div class="line">  padding: 6px 10px 10px 50px;</div><div class="line">  border-radius: 2.8%;</div><div class="line">  overflow: auto;</div><div class="line">&#125;</div><div class="line">#toc &#123;</div><div class="line">    float: right;</div><div class="line">    font-size: .9em;</div><div class="line">    line-height: 1.65em;</div><div class="line">    z-index: 12;</div><div class="line">    a &#123;</div><div class="line">        color: gray;</div><div class="line">        &amp;:visited &#123;</div><div class="line">            color: rgba(244, 131, 133, 1);</div><div class="line">        &#125; </div><div class="line">        &amp;:hover &#123;</div><div class="line">            color: #88acdb;</div><div class="line">            text-decoration: none;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    li:hover &#123;</div><div class="line">        background: none;</div><div class="line">        li:hover &#123;</div><div class="line">            background: rgba(158, 188, 226, .21);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    .toc-title &#123;</div><div class="line">        font-weight: bold;</div><div class="line">        color: gray;</div><div class="line">    &#125;</div><div class="line">    .toc &#123;</div><div class="line">        padding: .7em;</div><div class="line">        padding-right: 0;</div><div class="line">        li &#123;</div><div class="line">            list-style-type: none;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ol &#123;</div><div class="line">        margin-left: 0;</div><div class="line">    &#125;</div><div class="line">    .toc-child &#123;</div><div class="line">        padding-left: 1.25em;</div><div class="line">        margin: 4px 0; </div><div class="line">    &#125;</div><div class="line">    .toc-link:hover &#123;</div><div class="line">        background: rgba(158, 188, 226, .21);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">.copyright &#123;</div><div class="line">    width: 85%;</div><div class="line">    max-width: 45em;</div><div class="line">    margin: 0 auto;</div><div class="line">    padding: .5em 1.8em;</div><div class="line">    border: 1px solid lightgray;</div><div class="line">    font-size: .93em;</div><div class="line">    line-height: 1.6em;</div><div class="line">    word-break: break-word;</div><div class="line">    background: rgba(255, 255, 255, .4);</div><div class="line">    span &#123;</div><div class="line">        margin-right: 1em;</div><div class="line">        color: #B5B5B5;</div><div class="line">        font-weight: bold;</div><div class="line">    &#125;</div><div class="line">    a &#123;</div><div class="line">        color: gray;</div><div class="line">        &amp;:hover &#123;</div><div class="line">            font-weight: bold;</div><div class="line">            color: #a3d2a3;</div><div class="line">            text-decoration: underline;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    &amp;:hover p .copy-path::after &#123;</div><div class="line">        content: &quot;复制&quot;;</div><div class="line">    &#125;</div><div class="line">    .post-url:hover &#123;</div><div class="line">        font-weight: normal;</div><div class="line">    &#125;</div><div class="line">    .copy-path &#123;</div><div class="line">        margin-left: 1em;</div><div class="line">        &amp;:hover &#123;</div><div class="line">            color: gray;</div><div class="line">            cursor: pointer;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第一段的toc-article指定了目录整个<div>的背景色、边框色、倒角半径、各种间距以及最大的宽度。注意这里最好指定目录的最大宽度，我将其设为了28%，也就是文章正文那个框的宽度的28%，也可以设为一个固定的长度，比如在笔记本电脑上16em就是个不错的宽度，但为了能适配各种不同尺寸的屏幕，最好还是设置为百分比。如果不指定最大宽度，遇到比较长的标题时，生成的目录会非常难看。这个最大宽度的设置是我在网上其他添加目录的方法中没有见到的。</div></p>
<p>第二段的toc-title指的就是“文章目录”那四个字，这四个字要比其他字大一些，将其字号设为其他字的120%。</p>
<p>第三段的#toc.toc指定了目录列表的一些细节，将font-size设为0.9em会让目录的字比文章的字稍小一些。最后的.toc-child指定了二级目录的缩进量。</p>
<p>再次生成页面，应该已经可以显示比较美观的目录了。</p>
<blockquote>
<p>收尾工作</p>
</blockquote>
<p>通常情况下我们不需要为每一篇文章都添加目录，因为大部分文章的长度还是相对较短，或者结构简单而没有添加小标题。在我的博客上，需要添加目录的长文还是相对较少的。因为我选择了默认不生成目录，而手动为需要目录的文章添加显式地标记。</p>
<p>下面我就需要编辑每一篇需要添加目录的文章，在文章开头的front-matter中加入toc: true。</p>
<h2 id="插入自定义页面"><a href="#插入自定义页面" class="headerlink" title="插入自定义页面"></a>插入自定义页面</h2><p>仿照Hexo官网，了解到单页面的添加方式。</p>
<blockquote>
<p>添加代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">D:\Hexo\Hexos\themes\spfk\layout\plugins.swig</div><div class="line"></div><div class="line">&lt;div id=&quot;content-wrap&quot;&gt;</div><div class="line">  &lt;div class=&quot;wrapper&quot;&gt;</div><div class="line">    &lt;div class=&quot;inner&quot;&gt;</div><div class="line">      &lt;header id=&quot;plugin-list-header&quot;&gt;</div><div class="line">        &lt;h1 id=&quot;plugin-list-title&quot;&gt;&#123;&#123; page.title &#125;&#125;&lt;/h1&gt;</div><div class="line">        &lt;input type=&quot;search&quot; id=&quot;plugin-search-input&quot; placeholder=&quot;Search&quot;&gt;</div><div class="line">        &lt;div id=&quot;plugin-list-count&quot;&gt;&#123;&#123; site.data[page.data].length &#125;&#125; items&lt;/div&gt;</div><div class="line">      &lt;/header&gt;</div><div class="line">      &lt;ul id=&quot;plugin-list&quot;&gt;</div><div class="line">        &#123;% for plugin in _.sortBy(site.data[page.data], &apos;name&apos;) %&#125;</div><div class="line">          &#123;&#123; partial(&apos;_partial/&apos; + page.partial, &#123;plugin: plugin&#125;) &#125;&#125;</div><div class="line">        &#123;% endfor %&#125;</div><div class="line">      &lt;/ul&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;script&gt;window.SEARCH_INDEX = &#123;&#123; lunr_index(site.data[page.data]) &#125;&#125;&lt;/script&gt;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">D:\Hexo\Hexos\themes\spfk\layout\_partial\plugin.swig</div><div class="line"></div><div class="line">&lt;li class=&quot;plugin on&quot;&gt;</div><div class="line">  &lt;a href=&quot;&#123;&#123; plugin.link &#125;&#125;&quot; class=&quot;plugin-name&quot; target=&quot;_blank&quot;&gt;&#123;&#123; plugin.name &#125;&#125;&lt;/a&gt;</div><div class="line">  &lt;p class=&quot;plugin-desc&quot;&gt;&#123;&#123; plugin.description &#125;&#125;&lt;/p&gt;</div><div class="line">  &lt;div class=&quot;plugin-tag-list&quot;&gt;</div><div class="line">    &#123;% for tag in plugin.tags %&#125;</div><div class="line">      &lt;a href=&quot;#&#123;&#123; tag &#125;&#125;&quot; class=&quot;plugin-tag&quot;&gt;&#123;&#123; tag &#125;&#125;&lt;/a&gt;</div><div class="line">    &#123;% endfor %&#125;</div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/li&gt;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">D:\Hexo\Hexos\themes\spfk\layout\_partial\work.swig</div><div class="line"></div><div class="line"></div><div class="line">&lt;li class=&quot;plugin on&quot;&gt;</div><div class="line">  &lt;div class=&quot;plugin-screenshot&quot;&gt;</div><div class="line">    &lt;img src=&quot;&#123;&#123; plugin.imgs &#125;&#125;&quot; class=&quot;plugin-screenshot-img&quot;&gt;</div><div class="line">    &#123;% if plugin.preview %&#125;</div><div class="line">    &lt;a href=&quot;&#123;&#123; plugin.preview &#125;&#125;&quot; class=&quot;plugin-preview-link&quot; target=&quot;_blank&quot;&gt;&lt;i class=&quot;fa fa-eye&quot;&gt;&lt;/i&gt;&lt;/a&gt;</div><div class="line">    &#123;% endif %&#125;</div><div class="line">  &lt;/div&gt;</div><div class="line">  &lt;a href=&quot;&#123;&#123; plugin.link &#125;&#125;&quot; class=&quot;plugin-name&quot; target=&quot;_blank&quot;&gt;&#123;&#123; plugin.name &#125;&#125;&lt;/a&gt;</div><div class="line">  &lt;p class=&quot;plugin-desc&quot;&gt;&#123;&#123; plugin.description &#125;&#125;&lt;/p&gt;</div><div class="line">  &lt;div class=&quot;plugin-tag-list&quot;&gt;</div><div class="line">    &#123;% for tag in plugin.tags %&#125;</div><div class="line">      &lt;a href=&quot;#&#123;&#123; tag &#125;&#125;&quot; class=&quot;plugin-tag&quot;&gt;&#123;&#123; tag &#125;&#125;&lt;/a&gt;</div><div class="line">    &#123;% endfor %&#125;</div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/li&gt;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">引入样式文件</div><div class="line">D:\Hexo\Hexos\themes\spfk\source\css\style.styl</div><div class="line"></div><div class="line">@import &quot;_partial/plugins&quot;</div></pre></td></tr></table></figure>
<blockquote>
<p>修改样式</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line">D:\Hexo\Hexos\themes\spfk\layout\_partial\plugin.swig</div><div class="line"></div><div class="line">#plugin-list-header</div><div class="line">  clearfix()</div><div class="line">  margin: 40px 0</div><div class="line"></div><div class="line">#plugin-list-title</div><div class="line">  font-family: font-title</div><div class="line">  font-size: 36px</div><div class="line">  font-weight: 300</div><div class="line">  line-height: 1</div><div class="line">  float: left</div><div class="line"></div><div class="line">#plugin-list-count</div><div class="line">  color: color-gray</div><div class="line">  padding-top: 1em</div><div class="line">  text-align: right</div><div class="line">  @media mq-normal</div><div class="line">    float: right</div><div class="line">    line-height: 40px</div><div class="line">    padding-top: 0</div><div class="line">    padding-right: 15px</div><div class="line"></div><div class="line">#plugin-search-input</div><div class="line">  font-size: 16px</div><div class="line">  font-family: inherit</div><div class="line">  -webkit-appearance: none</div><div class="line">  border: 1px solid color-border</div><div class="line">  padding: 10px 10px</div><div class="line">  width: 100%</div><div class="line">  margin-top: 25px</div><div class="line">  @media mq-normal</div><div class="line">    float: right</div><div class="line">    width: 50%</div><div class="line">    margin-top: 0</div><div class="line"></div><div class="line">#plugin-list</div><div class="line">  margin: 40px -20px</div><div class="line">  display: flex</div><div class="line">  flex-flow: column</div><div class="line">  @media mq-tablet</div><div class="line">    flex-flow: row wrap</div><div class="line"></div><div class="line">.plugin</div><div class="line">  display: none</div><div class="line">  padding: 20px</div><div class="line">  @media mq-tablet</div><div class="line">    flex: 0 0 50%</div><div class="line">  @media mq-normal</div><div class="line">    flex: 0 0 (100 / 3)%</div><div class="line">  &amp;.on</div><div class="line">    display: block</div><div class="line"></div><div class="line">.plugin-name</div><div class="line">  font-family: font-title</div><div class="line">  font-weight: bold</div><div class="line">  color: color-link</div><div class="line">  font-size: 20px</div><div class="line">  text-decoration: none</div><div class="line">  line-height: 1</div><div class="line">  &amp;:hover</div><div class="line">    color: color-link-hover</div><div class="line"></div><div class="line">.plugin-desc</div><div class="line">  line-height: line-height</div><div class="line">  margin: 1em 0</div><div class="line"></div><div class="line">.plugin-tag-list</div><div class="line">  clearfix()</div><div class="line">  line-height: 1.3</div><div class="line"></div><div class="line">.plugin-tag</div><div class="line">  color: color-gray</div><div class="line">  font-size: 0.9em</div><div class="line">  text-decoration: none</div><div class="line">  float: left</div><div class="line">  margin-right: 10px</div><div class="line">  &amp;:hover</div><div class="line">    color: color-link-hover</div><div class="line">  &amp;:before</div><div class="line">    content: &quot;#&quot;</div><div class="line"></div><div class="line">.plugin-screenshot</div><div class="line">  margin-bottom: 15px</div><div class="line">  position: relative</div><div class="line">  padding-top: (10 / 16 * 100)% // 16:10 ratio</div><div class="line">  height: 0</div><div class="line">  overflow: hidden</div><div class="line"></div><div class="line">.plugin-screenshot-img</div><div class="line">  position: absolute</div><div class="line">  top: 0</div><div class="line">  left: 0</div><div class="line">  width: 100%</div><div class="line">  height: auto</div><div class="line"></div><div class="line">.plugin-preview-link</div><div class="line">  position: absolute</div><div class="line">  top: 0</div><div class="line">  left: 0</div><div class="line">  width: 100%</div><div class="line">  height: 100%</div><div class="line">  background: rgba(0, 0, 0, 0.7)</div><div class="line">  color: #fff</div><div class="line">  text-align: center</div><div class="line">  opacity: 0</div><div class="line">  transition: 0.15s</div><div class="line">  &amp;:hover</div><div class="line">    opacity: 1</div><div class="line">    .fa</div><div class="line">      opacity: 1</div><div class="line">      transform: scale(1)</div><div class="line">  .fa</div><div class="line">    position: absolute</div><div class="line">    top: 0</div><div class="line">    left: 0</div><div class="line">    bottom: 0</div><div class="line">    right: 0</div><div class="line">    margin: auto</div><div class="line">    font-size: 50px</div><div class="line">    width: @font-size</div><div class="line">    height: @font-size</div><div class="line">    opacity: 0</div><div class="line">    transform: scale(6)</div><div class="line">    transition: 0.2s</div><div class="line">    transition-delay: 0.15s</div></pre></td></tr></table></figure>
<h2 id="自定义挂件"><a href="#自定义挂件" class="headerlink" title="自定义挂件"></a>自定义挂件</h2><p>除了默认已提供的挂件外，你还可以自定义自己的小挂件，在hexo\themes\modernist\layout_widget\下，新建自己的ejs文件，如myWidget.ejs，然后在配置文件hexo\themes\modernist_config.yml中配置。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">widgets:</div><div class="line">  - myWidget</div><div class="line">用上述方法可以添加新浪微博小挂件。</div><div class="line"></div><div class="line">生成自己的微博组件。</div><div class="line">添加hexo\themes\modernist\layout\_widget\weibo.ejs文件。</div><div class="line">配置hexo\themes\modernist\_config.yml。</div></pre></td></tr></table></figure></p>
<h2 id="Hexo语法高亮"><a href="#Hexo语法高亮" class="headerlink" title="Hexo语法高亮"></a>Hexo语法高亮</h2><p>查阅格式高亮代码，了解到本主题，通过特定的规律进行语法高亮！好像无法识别不同代码的语法高亮！</p>
<p>测试：</p>
<p>通过测试代码，查看后台代码逻辑，了解到可以识别Apache、C++、bash等，还有部分不可识别。那么这个主题用的是什么的语法高亮？</p>
<p>代码code，table-gutter-pre是代码前面的序号。class=”highlight apache”<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">J:\Hexo\Hexo\themes\spfk\source\css\_partial\highlight.styl</div><div class="line"></div><div class="line">// https://github.com/luuman/hexo-theme-spfk</div><div class="line"></div><div class="line">code-bgc = #002B36</div><div class="line">code-tag = #F92672</div><div class="line">code-attr = #A6E22E</div><div class="line">code-word = #FFFFFF</div><div class="line">code-value = #E6DB74</div><div class="line">code-number = #9E90FF</div><div class="line">code-keyword = #66D9EF</div><div class="line">code-comment = #75715E</div><div class="line">code-argument = #FD971F</div><div class="line"></div><div class="line">$code-block</div><div class="line">  background: code-bgc</div><div class="line">  margin: 10px 0</div><div class="line">  padding: 10px 10px</div><div class="line">  overflow: auto</div><div class="line">  color: #4C4C4C</div><div class="line">  line-height: font-size * line-height</div></pre></td></tr></table></figure></p>
<p>参考：<br>highlight.js：<br>Demo <a href="https://highlightjs.org/static/demo/" target="_blank" rel="external">https://highlightjs.org/static/demo/</a><br>Solarized Dark<br>Atelier Sulphurpool Dark<br>文档：<a href="http://highlightjs.readthedocs.org/en/latest/css-classes-reference.html" target="_blank" rel="external">http://highlightjs.readthedocs.org/en/latest/css-classes-reference.html</a><br>下载：<a href="https://highlightjs.org/download/" target="_blank" rel="external">https://highlightjs.org/download/</a></p>
<h2 id="首页添加loading效果"><a href="#首页添加loading效果" class="headerlink" title="首页添加loading效果"></a>首页添加loading效果</h2><p>themes\spfk\layout\index.ejs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;css/loading-style.css&quot;&gt;</div><div class="line">&lt;div id=&quot;loader-wrapper&quot;&gt;</div><div class="line">    &lt;div id=&quot;loader&quot;&gt;&lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line"></div><div class="line">&lt;%- partial(&apos;_partial/archive&apos;, &#123;pagination: 2, index: true&#125;) %&gt;</div><div class="line">&lt;!-- loading --&gt;</div><div class="line">&lt;script&gt;window.jQuery || document.write(&apos;&lt;script src=&quot;js/jquery-1.9.1.min.js&quot;&gt;&lt;\/script&gt;&apos;)&lt;/script&gt;</div><div class="line">&lt;script type=&quot;text/javascript&quot;&gt;</div><div class="line">    $(window).load(function() &#123;                              // makes sure the whole site is loaded</div><div class="line">        $(&apos;#loader&apos;).fadeOut();                              // will first fade out the loading animation</div><div class="line">            $(&apos;#loader-wrapper&apos;).delay(350).fadeOut(&apos;slow&apos;); // will fade out the white DIV that covers the website.</div><div class="line">        $(&apos;body&apos;).delay(350).css(&#123;&apos;overflow-y&apos;:&apos;visible&apos;&#125;);</div><div class="line">    &#125;)</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure>
<h2 id="LoadingBar页面顶部加载进度条"><a href="#LoadingBar页面顶部加载进度条" class="headerlink" title="LoadingBar页面顶部加载进度条"></a>LoadingBar页面顶部加载进度条</h2><p>J:\Hexo\Hexo\themes\spfk\layout_partial\head.ejs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;!-- 加载特效 --&gt;</div><div class="line">&lt;% if(theme.animate) &#123; %&gt;</div><div class="line"> &lt;script src=&quot;/js/pace.js&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;link href=&quot;/css/pace/pace-theme-flash.css&quot; rel=&quot;stylesheet&quot; /&gt;</div><div class="line">&lt;% &#125; %&gt;</div></pre></td></tr></table></figure>
<h2 id="highlight-js"><a href="#highlight-js" class="headerlink" title="highlight.js"></a>highlight.js</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">J:\Hexo\Hexo\node_modules\hexo-renderer-marked\node_modules\hexo-util\lib\highlight.js:</div><div class="line">   37    &#125;</div><div class="line">   38  </div><div class="line">   39:   result += &apos;&lt;figure class=&quot;highlight&apos; + (data.language ? &apos; &apos; + data.language : &apos;&apos;) + &apos;&quot;&apos; + &apos;data-lang=&quot;&apos; + (data.language ? &apos; &apos; + data.language : &apos;&apos;) + &apos;&quot;&gt;&apos;;</div><div class="line">   40  </div><div class="line">   41    if (caption) &#123;</div><div class="line"></div><div class="line">J:\Hexo\Hexo\node_modules\hexo-util\lib\highlight.js:</div><div class="line">   33    &#125;</div><div class="line">   34  </div><div class="line">   35:   result += &apos;&lt;figure class=&quot;highlight&apos; + (data.language ? &apos; &apos; + data.language : &apos;&apos;) + &apos;&quot;&gt;&apos;;</div><div class="line">   36  </div><div class="line">   37    if (caption)&#123;</div><div class="line"></div><div class="line">6 matches across 2 files</div><div class="line"></div><div class="line">  result += &apos;&lt;figure class=&quot;highlight&apos; + (data.language ? &apos; &apos; + data.language : &apos;&apos;) + &apos;&quot;&apos; + &apos;data-lang=&quot;&apos; + (data.language ? &apos; &apos; + data.language : &apos;&apos;) + &apos;&quot;&gt;&apos;;</div></pre></td></tr></table></figure>
<h2 id="Hexo插件"><a href="#Hexo插件" class="headerlink" title="Hexo插件"></a>Hexo插件</h2><p><a href="&quot;https://swiftype.com/&quot;">Swiftype</a></p>
<p><a href="&quot;https://dashboard.tinysou.com/&quot;">微搜索</a></p>
<p><a href="&quot;http://busuanzi.ibruce.info/&quot;">不蒜子</a></p>
<p><a href="&quot;http://sitecenter.baidu.com/sc-web/&quot;">百度统计</a></p>
<p><a href="&quot;http://www.cnzz.com/&quot;">CNZZ数据</a></p>
<p><a href="&quot;http://fontawesome.io/&quot;">Font Awesome</a></p>
<p><a href="&quot;http://naotu.baidu.com/edit.html&quot;">百度脑图</a></p>
<p><a href="&quot;http://www.easyicon.net/&quot;">ICON图标</a></p>
<p><a href="&quot;http://fontawesome.dashgame.com/&quot;">Font Awesome</a></p>
<p><a href="&quot;https://freeiconmaker.com/&quot;">FREE Icon Maker</a></p>
<p><a href="&quot;https://icomoon.io/&quot;">Icon Font</a></p>
<p><a href="&quot;http://www.ico.la/&quot;">在线ico</a></p>
<p><a href="&quot;https://icomoon.io/&quot;">IcoMoon</a></p>
<p><a href="&quot;https://disqus.com/&quot;">Disqus</a></p>
<p><a href="&quot;http://luuman.duoshuo.com/admin/&quot;">多说评论</a></p>
<p><a href="&quot;http://open.mail.qq.com/cgi-bin/dy_template?sid=8EZP69fLJrYnKjRi&amp;t=index&amp;sub=0&amp;r=2a79875e99ef37e39c7438e990f66d32&quot;">QQ邮箱开放平台</a></p>
<p><a href="&quot;https://portal.qiniu.com/&quot;">七牛云存储</a></p>
<p><a href="&quot;http://share.baidu.com/&quot;">百度分享</a></p>
<p><a href="&quot;http://www.addthis.com/&quot;">AddThis</a></p>
<p><a href="&quot;http://ask.imiker.com/question/6970&quot;">分享一个方法解决Facebook,Linkedin,Twitter,Google+等SNS平台太多更新不过来的问题。 - 米课问答</a></p>
<p><a href="&quot;https://gitcafe.com/&quot;">GitCafe</a></p>
<p><a href="&quot;https://coding.net/user&quot;">Coding.Net</a></p>
<p><a href="&quot;https://github.com/&quot;">GitHub</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;　　&lt;strong&gt;自用笔记：&lt;/strong&gt;本文属于自用笔记，不做详解，仅供参考。在此记录自己已理解并开始遵循的前端代码规范。What How Why&lt;br&gt;　　最近，使用Hexo遇到了很多问题，在设立进行整理。&lt;/p&gt;
    
    </summary>
    
      <category term="Hexo" scheme="https://smuwjs.github.io/categories/Hexo/"/>
    
    
      <category term="Hexo" scheme="https://smuwjs.github.io/tags/Hexo/"/>
    
  </entry>
  
  <entry>
    <title>Hexo的使用介绍</title>
    <link href="https://smuwjs.github.io/2016/09/07/Hexo/"/>
    <id>https://smuwjs.github.io/2016/09/07/Hexo/</id>
    <published>2016-09-07T21:33:01.000Z</published>
    <updated>2017-05-05T09:48:30.740Z</updated>
    
    <content type="html"><![CDATA[<p>　　<strong>自用笔记：</strong>本文属于自用笔记，不做详解，仅供参考。在此记录自己已理解并开始遵循的前端代码规范。What How Why<br>　　最近，使用Hexo遇到了很多问题，在设立进行整理。</p>
<a id="more"></a>
<h3 id="写文章"><a href="#写文章" class="headerlink" title="写文章"></a>写文章</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">$ hexo n #写文章 </div><div class="line"></div><div class="line">    其中my new post为文章标题，执行命令后。</div><div class="line">    会在项目\source_posts中生成my new post.md文件，用编辑器打开编写即可。</div><div class="line"></div><div class="line">    当然，也可以直接在\source_posts中新建一个md文件，我就是这么做的。</div><div class="line"></div><div class="line">    文章开头语法：</div><div class="line"></div><div class="line">title: name #文章标题</div><div class="line">date: 2015-12-25 18:29:00  #写作时间</div><div class="line">description: #文章描述</div><div class="line">categories: #文章分类</div><div class="line">- 建站</div><div class="line">tags: #文章标签</div><div class="line">- 博客</div><div class="line">- 建站</div><div class="line">- Hexo</div><div class="line">toc: true # 生成目录</div><div class="line">author:</div><div class="line">comments:</div><div class="line">original:</div><div class="line">permalink: #指定链接</div><div class="line">---</div><div class="line"></div><div class="line">    以上是摘要</div><div class="line">&lt;!--more--&gt;</div><div class="line"></div><div class="line">    以下是余下全文</div></pre></td></tr></table></figure>
<h3 id="写多种文章"><a href="#写多种文章" class="headerlink" title="写多种文章"></a>写多种文章</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">$ hexo new [layout] &quot;postName&quot; #新建文章</div><div class="line"></div><div class="line">    [layout]：其中layout是可选参数，默认值为post。</div><div class="line">    有哪些layout呢，请到 scaffolds 目录下查看，这些文件名称就是layout名称。</div><div class="line">    当然你可以添加自己的layout，方法就是添加一个文件即可。</div><div class="line">    同时你也可以编辑现有的layout，比如post的layout默认是 hexo\scaffolds\post.md</div><div class="line"></div><div class="line">    关于hexo\scaffolds\photo.md配置文件的介绍：</div><div class="line"></div><div class="line">layout: &#123; &#123; layout &#125; &#125; #layout名称</div><div class="line">title: &#123; &#123; title &#125; &#125; #文章标题</div><div class="line">date: &#123; &#123; date &#125; &#125; #文章生成时间</div><div class="line">ategories: #文章分类目录</div><div class="line">tags:  #文章标签</div><div class="line">-  #</div><div class="line">photos:  #</div><div class="line">-  #</div><div class="line">---</div><div class="line"></div><div class="line">layout: photo</div><div class="line">title: 我的阅历</div><div class="line">date: 2085-01-16 07:33:44</div><div class="line">tags: [hexo]</div><div class="line">photos:</div><div class="line">- http://bruce.u.qiniudn.com/2013/11/27/reading/photos-0.jpg</div><div class="line">- http://bruce.u.qiniudn.com/2013/11/27/reading/photos-1.jpg</div></pre></td></tr></table></figure>
<h3 id="自定义页面"><a href="#自定义页面" class="headerlink" title="自定义页面"></a>自定义页面</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">    执行new page命令</div><div class="line"></div><div class="line">$ hexo new page &quot;about&quot;</div><div class="line"></div><div class="line">    在 *hexo\source\* 下会生成 *about* 目录，</div><div class="line">    里面有个index.md，直接编辑就可以了，</div><div class="line">    然后在主题的 *_config.yml* 中将其配置显示出来。 </div><div class="line"></div><div class="line">    上述步骤，也可以手工生成，在 *hexo\source\* 下手工新建</div><div class="line">     *about* 和 *index.md* 也是完全等价的。</div><div class="line"></div><div class="line">    因为markdown对table的支持不好，我是在about中直接</div><div class="line">    建立index.html，里面书写页面内容，hexo会帮你加上头和尾。</div></pre></td></tr></table></figure>
<h3 id="写页面（404）"><a href="#写页面（404）" class="headerlink" title="写页面（404）"></a>写页面（404）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ hexo new page &quot;404&quot;</div><div class="line"></div><div class="line">UUhike@UUhike-pc MINGW64 /d/Hexo/Hexo (master)</div><div class="line">$ hexo new page &quot;404&quot;</div><div class="line">INFO  Created: D:\Hexo\Hexo\source\404\index-1.md</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">title: 404 Not Found：该页无法显示</div><div class="line">comments: false</div><div class="line">permalink: /404</div><div class="line">fancybox: false</div><div class="line">---</div><div class="line">&lt;style type=&quot;text/css&quot;&gt;</div><div class="line">    .article-title &#123;</div><div class="line">        font-size: 2.1em;</div><div class="line">    &#125;</div><div class="line">    strong a &#123;</div><div class="line">        color: #747474;</div><div class="line">    &#125;</div><div class="line">    .share &#123;</div><div class="line">        display: none;</div><div class="line">    &#125;</div><div class="line">    .player &#123;</div><div class="line">        margin-left: -10px;</div><div class="line">    &#125;</div><div class="line">    .sign &#123;</div><div class="line">        text-align: right;</div><div class="line">        font-style: italic;</div><div class="line">    &#125;</div><div class="line">    #page-visit &#123;</div><div class="line">        display: none;</div><div class="line">    &#125;</div><div class="line">    .center &#123;</div><div class="line">        text-align: center;</div><div class="line">        height: 2.5em;</div><div class="line">        font-weight: bold;</div><div class="line">    &#125;</div><div class="line">    .search2 &#123;</div><div class="line">        height: 2.2em;</div><div class="line">        font-size: 1em;</div><div class="line">        width: 50%;</div><div class="line">        margin: auto 24%;</div><div class="line">        color: #727272;</div><div class="line">        opacity: .6;</div><div class="line">        border: 2px solid lightgray;</div><div class="line">    &#125;</div><div class="line">    .search2:hover &#123;</div><div class="line">        opacity: 1;</div><div class="line">        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3)</div><div class="line">        &#125;;</div><div class="line">    .article-entry hr &#123;</div><div class="line">        margin: 0;</div><div class="line">    &#125;</div><div class="line">    .pic &#123;</div><div class="line">        text-align: center;</div><div class="line">        margin: 0;</div><div class="line">    &#125;</div><div class="line">    .pic br &#123;</div><div class="line">        display: none;</div><div class="line">    &#125;</div><div class="line">&lt;/style&gt;</div><div class="line"></div><div class="line">***</div><div class="line"></div><div class="line">&lt;div class=&quot;pic&quot;&gt;</div><div class="line">&lt;img src=&quot;/resources/Mihawk-Wind.gif&quot; title=&quot;Mihawk-Wind&quot;&gt;</div><div class="line">&lt;/div&gt;</div><div class="line"></div><div class="line">&lt;p class=&quot;center&quot;&gt;很抱歉，您所访问的地址并不存在: &lt;/p&gt;</div><div class="line"></div><div class="line">&lt;p class=&quot;center&quot;&gt;&lt;a href=&quot;/&quot;&gt;回主页&lt;/a&gt; · &lt;a href=&quot;/archives&quot;&gt;所有文章&lt;/a&gt; · &lt;a href=&quot;/about&quot;&gt;留言板&lt;/a&gt;&lt;/p&gt;</div><div class="line"></div><div class="line">&lt;p class=&quot;center&quot;&gt;可在边栏搜索框中对本站进行检索，以获取相关信息。&lt;/p&gt;</div><div class="line"></div><div class="line">&lt;div style=&quot;text-align: center&quot;&gt;</div><div class="line">以下是博主喜欢的一些歌曲，可以听听，稍作休息~</div><div class="line">&lt;iframe frameborder=&quot;no&quot; border=&quot;0&quot; marginwidth=&quot;0&quot; marginheight=&quot;0&quot; width=320 height=330 src=&quot;http://music.163.com/outchain/player?type=0&amp;id=112513213&amp;auto=0&amp;height=430&quot;&gt;&lt;/iframe&gt;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure>
<h3 id="发布博客内容"><a href="#发布博客内容" class="headerlink" title="发布博客内容"></a>发布博客内容</h3><p>实现发布，前提是配置好，部署到Github前需要配置_config.yml文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># Deployment</div><div class="line">## Docs: http://hexo.io/docs/deployment.html</div><div class="line">deploy:</div><div class="line">  type: github</div><div class="line">  repository: git@github.com:zhchnchn/zhchnchn.github.io.git</div><div class="line">  branch: master</div></pre></td></tr></table></figure>
<p>更新的最新版本，可能会有Bug，自行百度，好像要修改type：git。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ hexo server #开启预览访问端口（默认端口4000，&apos;ctrl + c&apos;关闭server）Hexo 会监视文件变动并自动更新，您无须重启服务器。</div><div class="line"></div><div class="line">$ hexo g #生成</div><div class="line">$ hexo generate #生成静态页面至public目录（最终上传这个文件到GitHub）</div><div class="line"></div><div class="line">$ hexo d == hexo deploy#部署</div><div class="line">$ hexo d #部署 # 可与hexo g合并为 hexo d -g</div><div class="line"></div><div class="line">$ hexo deploy -g</div><div class="line">$ hexo server -g # 生成默认文件群再执行,开启本地静态html服务器</div></pre></td></tr></table></figure></p>
<h3 id="主题的更改"><a href="#主题的更改" class="headerlink" title="主题的更改"></a>主题的更改</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">1. 将Git Shell 切到/D/Hexo目录下，然后执行下面的命令，将pacman下载到 themes/pacman 目录下。</div><div class="line"></div><div class="line">$ git clone https://github.com/A-limon/pacman.git themes/pacman</div><div class="line">2. 修改你的博客根目录/D/Hexo下的config.yml配置文件中的theme属性，将其设置为pacman。</div><div class="line"></div><div class="line">3. 更新pacman主题</div><div class="line"></div><div class="line">$ cd themes/pacman</div><div class="line">$ git pull</div><div class="line"></div><div class="line">NOTE：先备份_config.yml 文件后再升级</div><div class="line"></div><div class="line">主题：</div><div class="line">    yilia</div><div class="line">$ git clone https://github.com/litten/hexo-theme-yilia.git themes/yilia</div><div class="line">    modernist</div><div class="line">$ git clone https://github.com/heroicyang/hexo-theme-modernist.git themes/modernist</div><div class="line">    jacman</div><div class="line">$ git clone https://github.com/cnfeat/cnfeat.git themes/jacman</div></pre></td></tr></table></figure>
<h3 id="文章图片路径"><a href="#文章图片路径" class="headerlink" title="文章图片路径"></a>文章图片路径</h3><p>Hexo如何方式图片，图片应该放置到哪里，不会应为上传而覆盖掉。然后把文章里的index.md删除，将文件存放在resource文件夹中间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">    发布页面</div><div class="line">$ hexo new page &quot;name&quot; # 新建一个页面，页面名称name</div><div class="line"></div><div class="line">    UUhike@UUhike-pc MINGW64 /d/Hexo/Hexo (master)</div><div class="line">$ hexo new page &quot;resoures&quot;</div><div class="line">    INFO  Created: D:\Hexo\Hexo\source\resoures\index.md</div></pre></td></tr></table></figure>
<h3 id="Hexo文件备份"><a href="#Hexo文件备份" class="headerlink" title="Hexo文件备份"></a>Hexo文件备份</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">    git-backup.</div><div class="line"></div><div class="line">    Install</div><div class="line"></div><div class="line">    if your hexo version is 2.x.x, you should install as follow:</div><div class="line"></div><div class="line">$ npm install hexo-git-backup@0.0.91 --save</div><div class="line">    if version is 3.x.x, you should install as follow:</div><div class="line"></div><div class="line">$ npm install hexo-git-backup --save</div><div class="line">    Update</div><div class="line"></div><div class="line">    if you install with --save, you must remove firstly when you update it.</div><div class="line"></div><div class="line">$ npm remove hexo-git-backup</div><div class="line">$ npm install hexo-git-backup --save</div><div class="line">    Configure</div><div class="line"></div><div class="line">    You should configure this plugin in _config.yml.</div><div class="line"></div><div class="line">backup:</div><div class="line">    type: git</div><div class="line">    repository:</div><div class="line">       github: git@github.com:xxx/xxx.git,branchName</div><div class="line">       gitcafe: git@github.com:xxx/xxx.git,branchName</div><div class="line">Using</div><div class="line"></div><div class="line">hexo backup </div><div class="line">or</div><div class="line"></div><div class="line">hexo b</div><div class="line">Options</div><div class="line"></div><div class="line">if you want to back up with your theme,just add theme: your theme name,your theme name in _config.yml.</div><div class="line"></div><div class="line">backup:</div><div class="line">    type: git</div><div class="line">    theme: coney,landscape,xxx</div><div class="line">    repository:</div><div class="line">       github: git@github.com:xxx/xxx.git,branchName</div><div class="line">       gitcafe: git@github.com:xxx/xxx.git,branchName</div><div class="line">Attention: if you do as above, the dir themes/coney/.gitwill be removed</div><div class="line"></div><div class="line">if you want DIY commit message, just add &apos;message: update xxx&apos;.</div><div class="line"></div><div class="line">backup:</div><div class="line">    type: git</div><div class="line">    message: update xxx</div><div class="line">    repository:</div><div class="line">       github: git@github.com:xxx/xxx.git,branchName</div><div class="line">       gitcafe: git@github.com:xxx/xxx.git,branchName</div><div class="line">Now you can backup all the blog!</div><div class="line"></div><div class="line">Problems</div><div class="line"></div><div class="line">You may get some troubles by your computer&apos; permission。</div><div class="line"></div><div class="line">Error: EISDIR, open</div><div class="line"></div><div class="line">it is caused by permission. just do &apos;sudo hexo b&apos;</div><div class="line"></div><div class="line">sudo hexo b</div></pre></td></tr></table></figure>
<h1 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h1><p><a href="http://luuman.github.io/2015/12/25/GitHub+Hexo/" target="_blank" rel="external">使用GitHub搭建Hexo博客</a><br><a href="http://luuman.github.io/2015/12/27/Hexo-plug/" target="_blank" rel="external">Hexo插件安装</a><br><a href="http://ibruce.info/2013/11/22/hexo-your-blog/" target="_blank" rel="external">hexo你的博客</a><br><a href="http://www.jianshu.com/p/05289a4bc8b2#" target="_blank" rel="external">如何搭建一个独立博客——简明Github Pages与Hexo教程</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;　　&lt;strong&gt;自用笔记：&lt;/strong&gt;本文属于自用笔记，不做详解，仅供参考。在此记录自己已理解并开始遵循的前端代码规范。What How Why&lt;br&gt;　　最近，使用Hexo遇到了很多问题，在设立进行整理。&lt;/p&gt;
    
    </summary>
    
      <category term="Hexo" scheme="https://smuwjs.github.io/categories/Hexo/"/>
    
    
      <category term="Hexo" scheme="https://smuwjs.github.io/tags/Hexo/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="https://smuwjs.github.io/2016/09/06/hello-world/"/>
    <id>https://smuwjs.github.io/2016/09/06/hello-world/</id>
    <published>2016-09-06T18:29:00.000Z</published>
    <updated>2017-05-05T09:48:30.740Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
    
    </summary>
    
    
  </entry>
  
</feed>
