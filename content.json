[{"title":"3-1 分布式版本管理Git","date":"2017-04-02T00:00:00.000Z","path":"2017/04/02/分布式版本管理/","text":"Git是一款免费、开源的分布式版本控制系统，用于敏捷高效地处理任何或小或大的项目。Git是一个开源的分布式版本控制系统，可以有效、高速的处理从很小到非常大的项目版本管理。Git 是 Linus Torvalds 为了帮助管理 Linux 内核开发而开发的一个开放源码的版本控制软件。 本节不是Git的教程，而是介绍一下项目中Git的分支策略以及流程管理，同时也涉及一种广泛应用的商用Git工具BitBucket，顺便也会涉及一些代码托管Github以及这两年开始流行的Gitlab的使用方法，当然Github与Gitlab已不单单是版本控制，也包括后文将会提到的知识管理和持续集成。Git使用教程上一张比较经典的分支策略的图，涵盖版本发布，新Sprint开发，bug fix。 分布式而非集中式对于这种分支模型，我们设置了一个版本库称为原始库（origin）。每个开发者都对原始库（origin）库拉取（pull）代码和推送（push）代码。但是除了集中式的存取代码关系，每个开发者也可以从子团队的其他队友那里获得代码版本变更。例如，对于2个或多个开发者一起完成的大版本变更，为了防止过早地向origin库提交工作内容，这种机制就变得非常有用。在上述途中，有如下子团队：Alice和Bob，Alice和David，Clair和David。从技术上将，这意味着，Alice创建了一个Git的远程节点，而对于Bob，该节点指向了Bob的版本库，反之亦然。 主分支中心库有2个分支（branch）： master分支 develop分支 每个Git用户都要熟悉原始的master分支。与master分支并行的另一个分支，我们称之为develop分支。我们把origin/master库认作为主分支，HEAD默认指向master。我们把origin/develop库认为是主分支，该分支HEAD默认指向develop。当develop分支的源码到达了一个稳定状态待发布，所有的代码变更需要以某种方式合并到master分支，然后标记一个版本号。如何操作将在稍后详细介绍。所以，每次变更都合并到了master，这就是新产品的定义，并为之打上标签（tag）。 ###辅助性分支我们的开发模型使用了各种辅助性分支，这些分支与关键分支（master和develop）一起，用来支持团队成员们并行开发，使得易于追踪功能，协助生产发布环境准备，以及快速修复实时在线问题。与关键分支不同，这些分支总是有一个有限的生命期，因为他们最终会被移除。我们用到的分支类型包括： 功能分支 发布分支 热修复分支 每一种分支有一个特定目的，并且受限于严格到规则，比如：可以用哪些分支作为源分支，哪些分支能作为合并目标。我们马上将进行演练。从技术角度来看，这些分支绝不是特殊分支。分支的类型基于我们使用的方法来进行分类。它们理所当然是普通的Git分支。 ###功能分支（feature）可能是develop分支的分支版本，最终必须合并到develop分支中。分支命名规则：除了master、develop、release-或者hotfix-之外，其他命名均可。feature分支通常为即将发布或者未来发布版开发新的功能。当新功能开始研发，包含该功能的发布版本在这时还是无法确定发布时间的。feature版本的实质是只要这个功能处于开发状态它就会存在，但是最终会合并到develop分支或取消。功能分支通常存在于开发者的软件库，而不是在源代码库中。 创建一个功能分支开始一项功能的开发工作时，基于develop创建分支。12$ git checkout -b myfeature developSwitched to a new branch &quot;myfeature&quot; 合并一个功能到develop分支完成的功能可以合并进develop分支，以明确加入到未来的发布：12345678$ git checkout developSwitched to branch &apos;develop&apos;$ git merge --no-ff myfeatureUpdating ea1b82a..05e9557(Summary of changes)$ git branch -d myfeatureDeleted branch myfeature (was 05e9557).$ git push origin develop –no-ff标志导致合并操作创建一个新commit对象，即使该合并操作可以fast-forward。这避免了丢失这个功能分支存在的历史信息，将该功能的所有提交组合在一起。 比较:后一种情况，不可能从Git历史中看到哪些提交一起实现了一个功能，你必须手工阅读全部的日志信息。如果对整个功能进行回退 (比如一组提交)，后一种方式会是一种真正头痛的问题，而使用–no-ff的情况则很容易。 Release 分支Release分支可能从develop分支分离而来，但是一定要合并到develop和master分支上，它的习惯命名方式为：release-*。Release分支是为新产品的发布做准备的。它允许我们在最后时刻做一些细小的修改。他们允许小bugs的修改和准备发布元数据（版本号，开发时间等等）。从develop分支创建新的Release分支的关键时刻是develop分支达到了发布的理想状态。至少所有这次要发布的features必须在这个点及时合并到develop分支。对于所有未来准备发布的features必须等到Release分支创建以后再合并。在Release分支创建的时候要为即将发行版本分配一个版本号。直到那时，develop分支反映的变化都是为了下一个发行版，但是在Release分支创建之前，下一个发行版到底叫0.3还是1.0是不明确的。这个决定是在Release分支创建时根据项目在版本号上的规则制定的。 创建一个release分支Release分支是从develop分支创建的。例如，当前产品的发行版本号为1.1.5，同时我们有一个大的版本即将发行。develop 分支已经为下次发行做好了准备，我们得决定下一个版本是1.2（而不是1.1.6或者2.0）。所以我们将Release分支分离出来，给一个能够反映新版本号的分支名。1234567$ git checkout -b release-1.2 developSwitched to a new branch &quot;release-1.2&quot;$ ./bump-version.sh 1.2Files modified successfully, version bumped to 1.2.$ git commit -a -m &quot;Bumped version number to 1.2&quot;[release-1.2 74d9424] Bumped version number to 1.21 files changed, 1 insertions(+), 1 deletions(-) 创建新分支以后，切换到该分支，添加版本号。这里，bump-version.sh 是一个虚构的shell脚本，它可以复制一些文件来反映新的版本（这当然可以手动改变–目的就是修改一些文件）。然后版本号被提交。这个新分支可能会存在一段时间，直到该发行版到达它的预定目标。在此期间，bug的修复可能被提交到该分支上（而不是提交到develop分支上）。在这里严格禁止增加大的新features。他们必须合并到develop分支上，然后等待下一次大的发行版。 完成一个release分支当一个release分支准备好成为一个真正的发行版的时候，有一些工作必须完成。首先，release分支要合并到master上（因为每一次提交到master上的都是一个新定义的发行版，记住）。然后，提交到master上必须打一个标签，以便以后更加方便的引用这个历史版本。最后，在release分支上的修改必须合并到develop分支上，以便未来发行版也包含这些bugs的修复。123456$ git checkout masterSwitched to branch &apos;master&apos;$ git merge --no-ff release-1.2Merge made by recursive.(Summary of changes)$ git tag -a 1.2 为了是修改保持在release分支上，我们需要合并这些到develop分支上去。12345$ git checkout developSwitched to branch &apos;develop&apos;$ git merge --no-ff release-1.2Merge made by recursive.(Summary of changes) 这个步骤可能会导致合并冲突（可能由于改变版本号更是如此）。如果是这样，修复它然后提交。现在我们真正的完成了，这个release分支将被删除，因为我们不再需要它了。12$ git branch -d release-1.2Deleted branch release-1.2 (was ff452fe). 热修复分支可以基于master分支，必须合并回develop和master分支。分支名约定：hotfix-*热修复分支与发布分支很相似，他们都为新的生成环境发布做准备，尽管这是未经计划的。他们来自生产环境的处于异常状态压力。当生成环境验证缺陷必须马上修复是，热修复分支可以基于master分支上对应与线上版本的tag创建。其本质是团队成员（在develop分支上）的工作可以继续，而另一个人准备生产环境的快速修复。 创建修补bug分支hotfix branch（修补bug分支）是从Master分支上面分出来的。例如，1.2版本是当前生产环境的版本并且有bug。但是开发分支（develop）变化还不稳定。我们需要分出来一个修补bug分支（hotfix branch）来解决这种情况。1234567$ git checkout -b hotfix-1.2.1 masterSwitched to a new branch &quot;hotfix-1.2.1&quot;$ ./bump-version.sh 1.2.1Files modified successfully, version bumped to 1.2.1.$ git commit -a -m &quot;Bumped version number to 1.2.1&quot;[hotfix-1.2.1 41e61bb] Bumped version number to 1.2.11 files changed, 1 insertions(+), 1 deletions(-) 分支关闭的时侯不要忘了更新版本号(bump the version)然后，修复bug，一次提交或者多次分开提交。123$ git commit -m &quot;Fixed severe production problem&quot;[hotfix-1.2.1 abbe5d6] Fixed severe production problem5 files changed, 32 insertions(+), 17 deletions(-) 完成一个hotfix分支完成一个bugfix之后，需要把bugfix合并到master和develop分支去，这样就可以保证修复的这个bug也包含到下一个发行版中。这一点和完成release分支很相似。首先，更新master并对release打上tag：123456$ git checkout masterSwitched to branch &apos;master&apos;$ git merge --no-ff hotfix-1.2.1Merge made by recursive.(Summary of changes)$ git tag -a 1.2.1 下一步，把bugfix添加到develop分支中：12345$ git checkout developSwitched to branch &apos;develop&apos;$ git merge --no-ff hotfix-1.2.1Merge made by recursive.(Summary of changes) 规则的一个例外是： 如果一个release分支已经存在，那么应该把hotfix合并到这个release分支，而不是合并到develop分支。当release分支完成后， 将bugfix分支合并回release分支也会使得bugfix被合并到develop分支。（如果在develop分支的工作急需这个bugfix，等不到release分支的完成，那你也可以把bugfix合并到develop分支）最后，删除临时分支：12$ git branch -d hotfix-1.2.1Deleted branch hotfix-1.2.1 (was abbe5d6).","tags":[{"name":"基础流程","slug":"基础流程","permalink":"https://smuwjs.github.io/tags/基础流程/"}]},{"title":"mina学习笔记七：串口编程","date":"2016-09-08T20:12:19.000Z","path":"2016/09/08/mina学习笔记七：串口编程/","text":"原文：http://blog.csdn.net/yoara/article/details/37726817 1.基于java.comm的串口编程以前做过一个针对串口扫描枪解析的项目，当时是用的java.comm包。回忆一下当时是怎么做的。 第一步：下载comm包，它包含有三个文件win32com.dll、comm.jar、javax.comm.properties 第二步：分别将他们拷到对应的文件夹 123xcopy \"system\\win32com.dll\" \"%JAVA_HOME%\\jre6\\bin\\\" /E xcopy \"system\\comm.jar\" \"%JAVA_HOME%\\jre6\\lib\\\" /E xcopy \"system\\javax.comm.properties\" \"%JAVA_HOME%\\jre6\\lib\\\" /E 第三步：编码，代码大致如下 12345678910111213141516171819private CommPortIdentifier portId; private SerialPort serialPort; private InputStream is; private ReaderThread t; private static final String PortName = \"COM1\"; //串口号 private static final int DATABITS = 8; //数据位 private static final int STOPBITS = 1; //停止位 private static final int RATE = 9600; //波特率 try&#123; this.portId = CommPortIdentifier.getPortIdentifier(getPortName()); this.serialPort = ((SerialPort)this.portId.open(\"Bar_Scan\", 20000)); this.is = this.serialPort.getInputStream(); this.serialPort.addEventListener(this.t); this.serialPort.notifyOnDataAvailable(true); this.serialPort.setSerialPortParams(getRATE(), getDATABITS(), getSTOPBITS(), 0); this.t.init(this.serialPort, this.is); &#125;catch()&#123;&#125; 12345678910111213141516171819202122public class ReaderThread extends Thread implements SerialPortEventListener&#123; private SerialPort serialPort; private InputStream is; public void init(SerialPort serialPort, InputStream is) &#123; this.serialPort = serialPort; this.is = is; &#125; public void serialEvent(SerialPortEvent event) &#123; switch (event.getEventType()) &#123; case SerialPortEvent.DATA_AVAILABLE: while (true) try &#123; ...; int b = this.is.read(); ... &#125; catch (IOException e)&#123; log4J.error(e); &#125; &#125; &#125; &#125; 2.为什么用mina封装串口通讯可以看出，用sun自带的comm方式针对串口编程也很简单，同时comm包自带了非常丰富的参考例子。但是用mina封装的好处是能复用mina的连接模型，包括filter、listener、handler等等，把对底层的通讯和业务解耦，是系统结构清晰，权责分明。 不过估计mina也觉得用串口编程或通过mina框架串口编程的人士不会很多，所以在官方的标准发布包中并未包含serial部分，需要重新下载。 同时该serial包依赖于rxtx的串口并口包。由于sun的comm包很久都没有维护了，RXTX事实上是对comm再支持，他是开源的，基本思想和开发的模式跟comm几乎一样。编程时最明显的不同是要包含的包名由javax.comm.改成了gnu.io.。 2.1 RXTX的配置方式RXTX官网的下载链接失效了，可以使用这里的。和comm一样，RXTX在使用前需要进行配置（Window下，linux请看包内install） 123Copy RXTXcomm.jar ---&gt; &lt;JAVA_HOME&gt;\\jre\\lib\\ext Copy rxtxSerial.dll ---&gt; &lt;JAVA_HOME&gt;\\jre\\bin Copy rxtxParallel.dll ---&gt; &lt;JAVA_HOME&gt;\\jre\\bin 2.2 mina中的集成使用方式串行通信只提供了一个IoConnector接口，因为串行通信是基于点对点的。要连接到一个串行通信端口上，需要创建一个SerialConnector。 123456//创建串口连接 SerialConnector connector = new SerialConnector(); //绑定处理handler connector.setHandler(new MyHandler()); //设置过滤器 connector.getFilterChain().addLast(\"logger\",new LoggingFilter()); 现在创建一个地址连接到一个串行端口： 123//配置串口连接 SerialAddress address = new SerialAddress (\"COM1\", 9600, DataBits.DATABITS_8,StopBits.BITS_1 , Parity.NONE, FlowControl.NONE); 第一个参数是串行端口标识符，对于Windows系统来说，串行端口被称作“COM1”、“COM2”等，对于Linux和Unix系统来说，则是”/dev/ttyS0”、”/dev/ttyS1”和”/dev/ttyUsb0”等。 剩余的参数取决于所使用的设备，在SerialAddress类中定义了相关的枚举量可参考： 波特率：这是一个衡量符号传输速率的参数。指的是信号被调制以后在单位时间内的变化，即单位时间内载波参数变化的次数，如每秒钟传送240个字符，而每个字符格式包含10位（1个起始位，1个停止位，8个数据位），这时的波特率为240Bd，比特率为10位*240个/秒=2400bps。一般调制速率大于波特率，比如曼彻斯特编码）。通常电话线的波特率为14400，28800和36600。波特率可以远远大于这些值，但是波特率和距离成反比。高波特率常常用于放置的很近的仪器间的通信，典型的例子就是GPIB设备的通信。 数据位：这是衡量通信中实际数据位的参数。当计算机发送一个信息包，实际的数据不会是8位的，标准的值是6、7和8位。如何设置取决于你想传送的信息。比如，标准的ASCII码是0～127（7位）。扩展的ASCII码是0～255（8位）。如果数据使用简单的文本（标准 ASCII码），那么每个数据包使用7位数据。每个包是指一个字节，包括开始/停止位，数据位和奇偶校验位。由于实际数据位取决于通信协议的选取，术语“包”指任何通信的情况。 停止位：用于表示单个包的最后一位。典型的值为1，1.5和2位。由于数据是在传输线上定时的，并且每一个设备有其自己的时钟，很可能在通信中两台设备间出现了小小的不同步。因此停止位不仅仅是表示传输的结束，并且提供计算机校正时钟同步的机会。适用于停止位的位数越多，不同时钟同步的容忍程度越大，但是数据传输率同时也越慢。 奇偶校验位：在串口通信中一种简单的检错方式。有四种检错方式：偶、奇、高和低。当然没有校验位也是可以的。对于偶和奇校验的情况，串口会设置校验位（数据位后面的一位），用一个值确保传输的数据有偶个或者奇个逻辑高位。例如，如果数据是011，那么对于偶校验，校验位为0，保证逻辑高的位数是偶数个。如果是奇校验，校验位为1，这样就有3个逻辑高位。高位和低位不真正的检查数据，简单置位逻辑高或者逻辑低校验。这样使得接收设备能够知道一个位的状态，有机会判断是否有噪声干扰了通信或者是否传输和接收数据是否不同步。 最后建立链接 1234ConnectFuture future = connector.connect(address); future.await(); IoSession session = future.getSession(); session.write(\"good mina\"); 2.3 测试效果手头上没有串口工具，所以用VSPD虚拟了串口出来。测试可用正常。 3.mina serial处理方式分析连接代码被调用时SerialConnector.connect0方法被执行 1234567SerialPort serialPort = initializePort(\"Apache MINA\", portId, portAddress); ConnectFuture future = new DefaultConnectFuture(); SerialSessionImpl session = new SerialSessionImpl(this, getListeners(), portAddress, serialPort); initSession(session, future, sessionInitializer); session.start(); return future; 串口的session，不仅继承了AbstractIoSession ，同时他还实现了SerialSession, SerialPortEventListener。 1class SerialSessionImpl extends AbstractIoSession implements SerialSession, SerialPortEventListener 我们注意他的start方法 123456789101112131415void start() throws IOException, TooManyListenersException &#123; inputStream = port.getInputStream(); outputStream = port.getOutputStream(); ReadWorker w = new ReadWorker(); w.start(); port.addEventListener(this); ((SerialConnector) getService()).getIdleStatusChecker0().addSession(this); try &#123; getService().getFilterChainBuilder().buildFilterChain(getFilterChain()); serviceListeners.fireSessionCreated(this); &#125; catch (Throwable e) &#123; getFilterChain().fireExceptionCaught(e); processor.remove(this); &#125; &#125; 其中有个ReadWorker线程，他首先等待Object readReadyMonitor的资源，如果readReadyMonitor被notify，那线程就开始读数据 1234567891011121314151617181920212223try &#123; readReadyMonitor.wait(); &#125; catch (InterruptedException e) &#123; log.error(\"InterruptedException\", e); &#125; if (isClosing() || !isConnected()) &#123; break; &#125; int dataSize; try &#123; dataSize = inputStream.available(); byte[] data = new byte[dataSize]; int readBytes = inputStream.read(data); if (readBytes &gt; 0) &#123; IoBuffer buf = IoBuffer.wrap(data, 0, readBytes); buf.put(data, 0, readBytes); buf.flip(); getFilterChain().fireMessageReceived(buf); &#125; &#125; catch (IOException e) &#123; getFilterChain().fireExceptionCaught(e); &#125; 而readReadyMonitor被notify的事件就发生在串口有数据读入，因SerialSessionImpl实现了SerialPortEventListener，所以他就可以监听事件 1234567public void serialEvent(SerialPortEvent evt) &#123; if (evt.getEventType() == SerialPortEvent.DATA_AVAILABLE) &#123; synchronized (readReadyMonitor) &#123; readReadyMonitor.notifyAll(); &#125; &#125; &#125; 结语补充了一下mina对串口的支持，框架确实是个剥离业务与底层的好东西。 版权声明：本文为博主原创文章，未经博主允许不得转载。","tags":[{"name":"java mina","slug":"java-mina","permalink":"https://smuwjs.github.io/tags/java-mina/"}]},{"title":"mina学习笔记六：补刀","date":"2016-09-08T20:12:18.000Z","path":"2016/09/08/mina学习笔记六：补刀/","text":"原文：http://blog.csdn.net/yoara/article/details/37612703 补充一些可能没讲到的细节。 1.WriteRequest每一个session.write()操作都会被封装成writeRequest并被添加到WriteRequestQueue队列中。过滤器的每一次责任链流转都是以writeRequest为传参的。我们的老祖父AbstractIoService在实例化时，自带了一个非常重要的属性字段。是不得不注意的参数哟，虽然他对我们基本上是透明的。 1private IoSessionDataStructureFactory sessionDataStructureFactory = new DefaultIoSessionDataStructureFactory(); 这个参数就包括了两个鸟不得的结构体，一个就是attribute的map，另一个就是我们可爱的WriteRequestQueue了。 2.IoBufferIoBuffer是mina框架对Nio中Buffer的再封装，Buffer应已经是很好用了，mina为什么还要继续封装呢？他给出的原因有2： Buffer没有提供实用的工具型getter和setter方法，比如fill, get/putString, and get/putAsciiInt() 。 原生的Buffer是固定长度的，非常不利于用于操作可变长度的数据。 说实话，这两个原因看上去都不怎么靠谱，要我说，真正的原因就是，框架没有点自己的封装就不是高大上了嘛~哈哈。 mina自身也有点后悔这样的选择，据说在mina3中将采取不同的策略。下面是官方的原话： This will change in MINA 3\\. The main reason why MINA has its own wrapper on top of nio ByteBuffer is to have extensible buffers.This was a very bad decision.Buffers are just buffers : a temporary place to store temporary data, before it is used. Many other solutions exist, like defining a wrapper which relies on a list of NIO ByteBuffers, instead of copying the existing buffer to a bigger one just because we want to extend the buffer capacity. It might also be more comfortable to use an InputStream instead of a byte buffer all along the filters, as it does not imply anything about the nature of the stored data : it can be a byte array, strings, messages... Last, not least, the current implementation defeat one of the target : zero-copy strategy (ie, once we have read the data from the socket, we want to avoid a copy being done later). As we use extensible byte buffers, we will most certainly copy those data if we have to manage big messages. Assuming that the MINA ByteBuffer is just a wrapper on top of NIO ByteBuffer, this can be a real problem when using direct buffers. 3.用到的设计模式3.1抽象工厂ProtocolCodecFactory机智的过滤器ProtocolCodecFilter需要机智的解编码器。以TextLineCodecFactory为例： 3.2 建造者模式这里的导演类就是我们添加filter的设置代码，而产生出的产品则是顺序不同的filter链。 3.3 适配器模式![](http://opesdt6ii.bkt.clouddn.com/17-5-5/66833683-file_1493967343756_e360.jpg) 3.4 装饰者模式writeRequest这一家子就是很好的例子。 3.5 外观模式我们劳苦功高的IoServiceListenerSupport，为filter和listener提供了一致性的操作接口 3.6 桥接模式这就太多了，但凡存在属性字段是接口的，几乎都是桥接模式。只画个类图示意： 3.7 组合模式过滤器链里面的用到的模式之一。 3.8 享元模式每个在数组pool里的IoProcessor都是一个享元。 3.9 模板方法大量的实现都用到了模板方法，这个模式是子类延迟实现的典范。 3.10 观察者模式在背后默默支持我们的IoServiceListenerSupport，就担负着通知观察者的重任。 3.11 策略模式每一种filter的具体实现都是一种策略 3.12 责任链模式在过滤器链中，每个节点都持有对下一个节点的引用。其中节点并非filter实例，而是封装了filter、上一个filter、下一个filter、下一个filter操作对象的Entry对象。 3.13 命令模式比如session.wirte，发送的消息将被封装到WriteRequest中，最终经过一系列的过滤器被提交到WriteRequestQueue中等待发送。IoProcessor通过轮询将消息队列flush出去。在这里，消息的请求者是session、消息发送实现者是Processor，而消息及消息处理的future被封装到WriteRequest这个对象中。 一般命令模式的主体会持有执行者的引用，命令模式通过调用执行者的方法执行命令，这里是放到一个队列里被轮询执行，所以不能算是完整的命令模式。但命令模式关注的是“行为请求者”和“行为执行者”的解耦，并封装调用请求的变化，这里是符合这个思想的。 4.为什么NioDatagramAcceptor不使用SimpleIoProcessorPool我们知道在前面讲到NioSocketAcceptor在初始化时会生成SimpleIoProcessorPool的IoProcessor的池，池中每个processor都会处理一组session。而NioDatagramAcceptor没有使用池化的IoProcessor，而是选择实现了IoProcessor，即他本身就是一个IoProcessor，在他自身的executer中只有一个Acceptor勤劳的为他做着接受新数据的 但是为什么呢？ 我们知道，UDP是无连接的协议，select()应答器响应有通道的数据到来时，通过receive()方法获取buffer内容。NioDatagramAcceptor只开启了单个DatagramChannel用于数据传输，因为他不需要像NioSocketAcceptor那样维持一个通讯会话session。 对于远程地址相同的请求，NioDatagramAcceptor使用可重用的ExpiringSessionRecycler对象sessionRecycler来复用session。而NioSocketAcceptor会为把每个session分配到指定的IoProcessor池中的一个去处理。 12345678910111213141516171819202122232425262728293031323334353637383940AbstractPollingConnectionlessIoAcceptor.newSessionWithoutLock( SocketAddress remoteAddress, SocketAddress localAddress ) throws Exception &#123; H handle = boundHandles.get( localAddress ); if ( handle == null ) &#123; throw new IllegalArgumentException( \"Unknown local address: \" + localAddress ); &#125; IoSession session; synchronized ( sessionRecycler ) &#123; session = sessionRecycler.recycle( remoteAddress ); if ( session != null ) &#123; return session; &#125; // If a new session needs to be created. S newSession = newSession( this, handle, remoteAddress ); getSessionRecycler().put( newSession ); session = newSession; &#125; initSession( session, null, null ); try &#123; this.getFilterChainBuilder().buildFilterChain( session.getFilterChain() ); getListeners().fireSessionCreated( session ); &#125; catch ( Throwable t ) &#123; ExceptionMonitor.getInstance().exceptionCaught( t ); &#125; return session; &#125; 究其原因，应该是NioDatagramAcceptor对于会话的维护不需要付出NioSocketAcceptor那么大的代价。NioDatagramAcceptor只用了一个Selector去监听会话请求，而NioSocketAcceptor用了1个监听连接、CPU+1个去监听不同的session，可见一斑。 结语客户端的IoConnector部分就不分析了。相信通过这几节的了解，框架结构都非常清楚了。应该没有别的落下= =不过其中有很多对网络的实现方面的细节还不是很清楚，看来要了解网络传输底层的东西才行。 版权声明：本文为博主原创文章，未经博主允许不得转载。","tags":[{"name":"java mina","slug":"java-mina","permalink":"https://smuwjs.github.io/tags/java-mina/"}]},{"title":"mina学习笔记五：做嫁衣的IoFilter和IoListener","date":"2016-09-08T20:12:17.000Z","path":"2016/09/08/mina学习笔记五：做嫁衣的IoFilter和IoListener/","text":"原文：http://blog.csdn.net/yoara/article/details/37597141 总有那么一群人，他们默默无闻的工作在自己的岗位上，你永远都接触不到他们，可是离了他们完整的做好一件事。譬如只注意在荧光屏上的明星，却不知道谁给他们打得灯光、谁给他们踩得位、谁给他们化妆端茶送水等等。IoFilter也是这群人中的一员，每个session的请求和事件离不了他们，IoFilter在IoService和IoHandler之间提供了各个层面的切面支持，让其他两个组件安心做自己的事而不用关注其他细节。软件工程的魅力也在于此——解耦。 1.IoFilter的一家子IoFilter家族的类图结构非常简单明快，mina非常贴心的为广大使用者提供了丰富的Filter实现子类，很多标准服务我们都不需要自己实现。 图5.1 IoFilter类图 我们先简单介绍一下这个家族成员和他们各自的作用吧：| Filter | class | Description || —————————- | —————————————- | —————————————- || Blacklist | BlacklistFilter | 黑名单过滤器 || BufferedWrite | BufferedWriteFilter | 发送缓存过滤器，缓存发送的消息，避免短小消息频繁发送 || Compression | CompressionFilter | 数据压缩过滤器 || ConnectionThrottle | ConnectionThrottleFilter | 连接控制过滤器，对同一IP地址频繁的创建连接的时间间隔进行控制 || ErrorGenerating | ErrorGeneratingFilter | 花数据过滤器，增加、修改、移除接受的数据包内容，可作为加密的方式 || Executor | ExecutorFilter | 处理线程池过滤器，让每个请求或者事件都通过线程池去执行 || FileRegionWrite | FileRegionWriteFilter | 文件转换过滤器，通常应该由IoProcess做这件事，但若需要压缩或者修改时，可通过过滤器链之间的配合来实现 || KeepAlive | KeepAliveFilter | 心跳包过滤器，在idle状态时发送心跳包，并能对超时进行处理 || Logging | LoggingFilter | 日志记录过滤器，最常用之一 || MDC Injection | MdcInjectionFilter | 日志信息注入过滤器，MDC(Mapped Diagnostic Context有译作线程映射表)是日志框架维护的一组信息键值对，可向日志输出信息中插入一些想要显示的内容。 || Noop | NoopFilter | 用作内部测试的filter，什么也没做 || Profiler | ProfilerTimerFilter | 时间分析过滤器，记录各种事件消耗的时间 || ProtocolCodec | ProtocolCodecFilter | 编解码过滤器，最常用之二 || Proxy | ProxyFilter | 是IoConnector在连接握手时自动加入的过滤器，握手成功后就透明了 || Reference counting | ReferenceCountingFilter | 引用数过滤器，能记录该过滤器被加入或移除过滤器链的次数，真实使用是继承他。 || RequestResponse | RequestResponseFilter | 继承WriteRequest || SessionAttributeInitializing | SessionAttributeInitializingFilter | 初始化过滤器 || StreamWrite | StreamWriteFilter | InputStream直接转换成IoBuffer的过滤器 || SslFilter | SslFilter | TCP/IP层面的SSl加解密过滤器 || WriteRequest | WriteRequestFilter | 简化IoFilter IoEventType.WRITE事件的实现的抽象过滤器 | 还有两个FIlter是mina自带并且不为用户管理的，当生成过滤器链自动注入： HeadFilter（当发生write操作时，将写buffer加入到session.scheduledWriteMessages队列，并执行发送调用IoProcessor执行write()操作），位于过滤器链头。 TailFilter（当所有过滤器都处理完后，他将调用IoHandler的对应方法）。位于过滤器链尾。 2.IoFilter执行顺序搞清楚了 在事件端，我们以messageSent事件被执行的代码来详解下过程；在操作端我们的例子是session.write。 2.1 messageSent顺序调用过滤器链当IoProcessor的remove(session)方法被调用时，该session将被添加进Processor内部的removingSessions的ConcurrentLinkedQueue等待被移除。 12345678public final void remove(S session) &#123; scheduleRemove(session); startupProcessor(); &#125; private void scheduleRemove(S session) &#123; removingSessions.add(session); &#125; 当IoProcessor工作线程执行一个循环，调用removeSessions()方法，状态为SessionState.OPENED的session将被移除，移除的代码中就包括刷新消息队列，其中代码如下，从而引发一次过滤器链的调用。 123456789101112if (message instanceof IoBuffer) &#123; IoBuffer buf = (IoBuffer) message; if (buf.hasRemaining()) &#123; buf.reset(); failedRequests.add(req); &#125; else &#123; IoFilterChain filterChain = session.getFilterChain(); filterChain.fireMessageSent(req); &#125; &#125; else &#123; failedRequests.add(req); &#125; 最终调用的是TailFilter，他的代码如下： 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465private static class TailFilter extends IoFilterAdapter &#123; public void sessionCreated(NextFilter nextFilter, IoSession session) throws Exception &#123; session.getHandler().sessionCreated(session); &#125;  public void sessionOpened(NextFilter nextFilter, IoSession session) throws Exception &#123; session.getHandler().sessionOpened(session); &#125;  public void sessionClosed(NextFilter nextFilter, IoSession session) throws Exception &#123; AbstractIoSession s = (AbstractIoSession) session; try &#123; s.getHandler().sessionClosed(session); &#125; finally &#123; try &#123; s.getWriteRequestQueue().dispose(session); &#125; finally &#123; try &#123; s.getAttributeMap().dispose(session); &#125; finally &#123; try &#123; // Remove all filters. session.getFilterChain().clear(); &#125; finally &#123; if (s.getConfig().isUseReadOperation()) &#123; s.offerClosedReadFuture(); &#125; &#125; &#125; &#125; &#125; &#125;  public void sessionIdle(NextFilter nextFilter, IoSession session, IdleStatus status) throws Exception &#123; session.getHandler().sessionIdle(session, status); &#125;  public void exceptionCaught(NextFilter nextFilter, IoSession session, Throwable cause) throws Exception &#123; AbstractIoSession s = (AbstractIoSession) session; try &#123; s.getHandler().exceptionCaught(s, cause); &#125; finally &#123; if (s.getConfig().isUseReadOperation()) &#123; s.offerFailedReadFuture(cause); &#125; &#125; &#125;  public void messageReceived(NextFilter nextFilter, IoSession session, Object message) throws Exception &#123; session.getHandler().messageReceived(s, message); &#125; public void messageSent(NextFilter nextFilter, IoSession session, WriteRequest writeRequest) throws Exception &#123; session.getHandler().messageSent(session, writeRequest.getMessage()); &#125; public void filterWrite(NextFilter nextFilter, IoSession session, WriteRequest writeRequest) throws Exception &#123; nextFilter.filterWrite(session, writeRequest); &#125;  public void filterClose(NextFilter nextFilter, IoSession session) throws Exception &#123; nextFilter.filterClose(session); &#125; &#125; 2.2 session.write逆序调用过滤器链在Handler中持有session的对象，调用session.write(date.toString());，session会调用具体方法： 123456AbstractIoSession.write(Object message) &#123; ... IoFilterChain filterChain = getFilterChain(); filterChain.fireFilterWrite(writeRequest); ... &#125; 1234DefaultIoFilterChain.fireFilterWrite(WriteRequest writeRequest) &#123; Entry tail = this.tail; callPreviousFilterWrite(tail, session, writeRequest); &#125; 触发逆序的过滤器链，最终到HeadFilter中： 123456789101112131415161718...其他Filter HeadFilter.filterWrite(NextFilter nextFilter, IoSession session, WriteRequest writeRequest) throws Exception &#123; AbstractIoSession s = (AbstractIoSession) session; ... WriteRequestQueue writeRequestQueue = s.getWriteRequestQueue(); if (!s.isWriteSuspended()) &#123; if (writeRequestQueue.size() == 0) &#123; // We can write directly the message s.getProcessor().write(s, writeRequest); &#125; else &#123; s.getWriteRequestQueue().offer(s, writeRequest); s.getProcessor().flush(s); &#125; &#125; else &#123; s.getWriteRequestQueue().offer(s, writeRequest); &#125; &#125; 3.IoHandler APIHandler虽然是直面用户的对象，但由上述可知，他其实只是整个操作链上最后的一环，也是最简单的一环，给出IoHander的API清单 sessionCreated(IoSession)：session创建时调用 sessionOpened(IoSession)：session打开时调用，实际上是在sessionCreated后立即执行 sessionClosed(IoSession)：session关闭时调用 sessionIdle(IoSession, IdleStatus)：session空闲时调用 exceptionCaught(IoSession, Throwable)：异常时调用 messageReceived(IoSession, Object)：接收到新的request时调用 messageSent(IoSession, Object)：发送在消息队列中未完成的消息时调用 4. IoFilter API和Handler有一部分一致： init() filter初始化方法，在下面4个on方法调用之前必须先被调用。 destroy() 该方法被ReferenceCountingFilter引用到，如果不继承ReferenceCountingFilter，不需实现该方法。 onPreAdd(IoFilterChain, String, NextFilter) 过滤器被添加之前调用。 onPostAdd(IoFilterChain, String, NextFilter) 过滤器被添加之后调用。 onPreRemove(IoFilterChain, String, NextFilter) 过滤器被移除之前调用。 onPostRemove(IoFilterChain, String, NextFilter) 过滤器被移除之后调用。 sessionCreated(NextFilter, IoSession) sessionOpened(NextFilter, IoSession) sessionClosed(NextFilter, IoSession) sessionIdle(NextFilter, IoSession, IdleStatus) exceptionCaught(NextFilter, IoSession, Throwable) messageReceived(NextFilter, IoSession, Object) messageSent(NextFilter, IoSession, WriteRequest) filterClose(NextFilter, IoSession) session.close(）方法中调用。 filterWrite(NextFilter, IoSession, WriteRequest) session.write(）方法中调用。 5. IoListener上面用了比较多的篇幅介绍了IoFilter，现在我们也该讲讲二号后台人物——IoListerner。在mina中主要有两类，一个是IoServiceListener，另一个就是IoFutureListener。 5.1 IoServiceListenerIoServiceListener负责Service的各个生命周期节点事件通知。我们曾在学习笔记三中提到过IoServiceListenerSupport，此类对象是该service所有IoServiceListener对象的持有类并管理着监听器的回调入口，同时还管理着当前Service的所有session。当时没有详细的介绍，现在我们重点说说这个类在做嫁衣方面的独到之处。 IoServiceListenerSupport是在AbstractIoService的构造函数中被生成的，也就是说，恭喜，无论你是Acceptor还是Connector，你都拥有这个强大的助手了。为了支持监听器的功能，可爱的祖父AbstractIoService还贴心的为我们实现好了addListener(IoServiceListener listener)和removeListener(IoServiceListener listener)方法。 我们先看看的API吧： serviceActivated(IoService) 当service生效时被调用。当新的service被bind时或第一个session生成时，IoServiceListenerSupport.fireServiceActivated被调用同时调用此方法。 serviceIdle(IoService, IdleStatus) 当service空闲时被调用，不过此方法没有在mina中真正使用。 serviceDeactivated(IoService) 当service失效时被调用。当service被unbind或最后个session注销时，IoServiceListenerSupport.fireServiceDeactivated被调用同时调用此方法。 sessionCreated(IoSession) 当新的session生成时被调用。IoServiceListenerSupport.fireSessionCreated sessionDestroyed(IoSession) 当session被注销时调用。IoServiceListenerSupport.fireSessionDestroyed 如此一看，还是很简单清晰的，监听器可以在任意时刻被添加或移除。我们的使用方法也很简单： 123456789101112131415IoServiceListener listener = new IoServiceListener() &#123; public void sessionDestroyed(IoSession session) throws Exception &#123; &#125; public void sessionCreated(IoSession session) throws Exception &#123; &#125; public void serviceIdle(IoService service, IdleStatus idleStatus) throws Exception &#123; &#125; public void serviceDeactivated(IoService service) throws Exception &#123; &#125; public void serviceActivated(IoService service) throws Exception &#123; &#125; &#125;; acceptor.addListener(listener); acceptor.removeListener(listener); 5.1 IoFutureListener还有一种Listener就是IoFutureListener，他在学习笔记四种也出现过，确实也比较简单，能在IoFuture任务完成后被调用，唯一的API： 123public interface IoFutureListener&lt;F extends IoFuture&gt; extends EventListener &#123; void operationComplete(F future); &#125; 因为大部分的future都被mina集成在框架里，所以future的listener支持一项特性：若任务已经执行完后添加的listener将被立刻执行。我们先看看future是怎么实现该功能的。 1234567891011121314151617181920212223242526public IoFuture addListener(IoFutureListener&lt;?&gt; listener) &#123; if (listener == null) &#123; throw new IllegalArgumentException(\"listener\"); &#125; boolean notifyNow = false; synchronized (lock) &#123; if (ready) &#123; notifyNow = true; &#125; else &#123; if (firstListener == null) &#123; firstListener = listener; &#125; else &#123; if (otherListeners == null) &#123; otherListeners = new ArrayList&lt;IoFutureListener&lt;?&gt;&gt;(1); &#125; otherListeners.add(listener); &#125; &#125; &#125; 是这里了！如果ready完成了，则马上执行 if (notifyNow) &#123; notifyListener(listener); &#125; return this; &#125; 那不用说就知道啦，在notiffyListener中将会回调监听器的方法。 6. 结语mina框架核心部件基本上都讲的差不多了，看看如果有需要补余的，留在下一章节。 版权声明：本文为博主原创文章，未经博主允许不得转载。","tags":[{"name":"java mina","slug":"java-mina","permalink":"https://smuwjs.github.io/tags/java-mina/"}]},{"title":"mina学习笔记四：交互的核心IoSession","date":"2016-09-08T20:12:16.000Z","path":"2016/09/08/mina学习笔记四：交互的核心IoSession/","text":"原文：http://blog.csdn.net/yoara/article/details/37568027 这一章讲的就是IoSession，session这个词做web应用的人应该都是耳熟能详，在mina中IoSession也是起着相同的作用。mina为每个客户端提供了会话session，session是服务器端和客户端的连接持有者，直到连接中断session才会被销毁。 IoSession不仅是connection的相关信息，同时，服务器端还能通过他存储其他可能需要的数据信息。好，让我们一步一步剖析IoSession那不平凡的一生吧。 1. IoSession在服务器端的创建第一步：accept(processor,handle)接着上节说，我们已经知道，NioSocketAcceptor.bind()后，最终会生成一个在自身维护的executor线程池内提交的任务Acceptor（单一线程），该任务不断的轮询判断服务是否关闭、同时等待新的连接接入。当有新的连接接入时： 123456Acceptor.run()&#123; ... //selectedHandles()获取一个selector中注册的服务监听的serversocketchannel的迭代器 processHandles(selectedHandles()); ...&#125; 创建session、并为其分配指定IoProcessor的秘密都在AbstractPollingIoAcceptor.processHandles()这个方法中。我们接着看： 12345678910111213141516171819private void processHandles(Iterator&lt;ServerSocketChannel&gt; handles) throws Exception &#123; while (handles.hasNext()) &#123; H handle = handles.next(); handles.remove(); // 创建session并将本地的processor处理池当参数传递给session // 注意这里还未分配具体的processor S session = accept(processor, handle); if (session == null) &#123; continue; &#125; // 初始化Session initSession(session, null, null); // 将session分配给具体的processor session.getProcessor().add(session); &#125; &#125; 第一步accept(processor,handle)方法，调用子类实现的NioSession accept(...)方法，判断了SelectionKey的有效性后，获得连接的通道SocketChannel ch = handle.accept();最后以此为传参创建IoSession对象return new NioSocketSession(this, processor, ch);我们看下构造函数做了什么（为了方便起见，相关的父类构造函数都写在一块了）： 1234567891011121314151617181920212223242526272829303132333435 public NioSocketSession(IoService service, IoProcessor&lt;NioSession&gt; processor, SocketChannel channel) &#123;//AbstractIoSession(IoService service) this.service = service; this.handler = service.getHandler(); //保存当前的处理时间信息 long currentTime = System.currentTimeMillis(); creationTime = currentTime; lastThroughputCalculationTime = currentTime; lastReadTime = currentTime; lastWriteTime = currentTime; lastIdleTimeForBoth = currentTime; lastIdleTimeForRead = currentTime; lastIdleTimeForWrite = currentTime; //在关闭时的动作，下面以此展开对IoFuture的探讨。 closeFuture.addListener(SCHEDULED_COUNTER_RESETTER); //为session创建唯一的ID sessionId = idGenerator.incrementAndGet();//END AbstractIoSession(IoService service)//NioSession(IoProcessor&lt;NioSession&gt; processor, IoService service, Channel channel)//即当前session的SocketChannelthis.channel = channel;//这是ioservice中的processor池哦 this.processor = processor;//这步过滤器链厉害了，后面细说 filterChain = new DefaultIoFilterChain(this);//END NioSession(IoProcessor&lt;NioSession&gt; processor, IoService service, Channel channel)//设置各种初始参数 config = new SessionConfigImpl(); this.config.setAll(service.getSessionConfig()); &#125; 右边这张图是IoSession的类图结构，比较清晰。 我们细细的分析一下NioSocketSession在初始化时做了哪些工作，首先持有了sevice及其处理类引用，并设置了一些初始时间信息，然后他在关闭时注册了监听操作closeFuture.addListener(SCHEDULED_COUNTER_RESETTER)。 1.1 IoFuture我们已经很多次看到IoFuture，有必要来详细了解一下IoFuture的作用。那用过Executor的同学都知道，submit()提交Callback的任务后将返回一个Future表示这个任务的操作结果，这里的IoFuture的作用是类似的，他代表一次相关于IoSession的操作的操作结果，同时，还可以在他完成时获取定义相关的操作。我们看下他的子类结构图 图4.1 IoFuture子类结构图 由图中可见，对session相关的操作例如关闭、连接、写、读等操作，IoFuture全都有子类去支持。session的操作可以很方便的通过IoFuture查看处理的结果。我们看下IoFuture接口的API清单： 12345678910addListener(IoFutureListener&lt;?&gt;)await()await(long)await(long, TimeUnit)awaitUninterruptibly()awaitUninterruptibly(long)awaitUninterruptibly(long, TimeUnit)getSession()isDone()removeListener(IoFutureListener&lt;?&gt;) 从清单我们了解到：1.IoFuture支持添加操作完成的监听器，2.IoFuture支持可中断、可设置超时时间的阻塞式操作。3.isDone()则返回操作的完成状态。 123public interface IoFutureListener&lt;F extends IoFuture&gt; extends EventListener &#123; void operationComplete(F future);&#125; 在他的直接实现子类DefaultIoFuture里面，我们看一下该类很主要一个实现方法setValue(Object newValue)，所有其他子类都会调用该方法以完成具体的操作： 123456789101112131415161718 public void setValue(Object newValue) &#123; synchronized (lock) &#123; // 已经完成则直接返回 if (ready) &#123; return; &#125; //设置结果 result = newValue; //设置完成状态 ready = true; //唤醒所有等待线程 if (waiters &gt; 0) &#123; lock.notifyAll(); &#125; &#125;//通知监听器执行完成操作 notifyListeners(); &#125; DefaultIoFuture中个还有一个检查死锁的方法，大家有兴趣可以看下是怎么判断死锁的： 12345678910111213141516171819202122232425262728293031323334353637383940private void checkDeadLock() &#123; // Only read / write / connect / write future can cause dead lock. if (!(this instanceof CloseFuture || this instanceof WriteFuture || this instanceof ReadFuture || this instanceof ConnectFuture)) &#123; return; &#125; // Get the current thread stackTrace. // Using Thread.currentThread().getStackTrace() is the best solution, // even if slightly less efficient than doing a new Exception().getStackTrace(), // as internally, it does exactly the same thing. The advantage of using // this solution is that we may benefit some improvement with some // future versions of Java. StackTraceElement[] stackTrace = Thread.currentThread().getStackTrace(); // Simple and quick check. for (StackTraceElement s : stackTrace) &#123; if (AbstractPollingIoProcessor.class.getName().equals(s.getClassName())) &#123; IllegalStateException e = new IllegalStateException(\"t\"); e.getStackTrace(); throw new IllegalStateException(\"DEAD LOCK: \" + IoFuture.class.getSimpleName() + \".await() was invoked from an I/O processor thread. \" + \"Please use \" + IoFutureListener.class.getSimpleName() + \" or configure a proper thread model alternatively.\"); &#125; &#125; // And then more precisely. for (StackTraceElement s : stackTrace) &#123; try &#123; Class&lt;?&gt; cls = DefaultIoFuture.class.getClassLoader().loadClass(s.getClassName()); if (IoProcessor.class.isAssignableFrom(cls)) &#123; throw new IllegalStateException(\"DEAD LOCK: \" + IoFuture.class.getSimpleName() + \".await() was invoked from an I/O processor thread. \" + \"Please use \" + IoFutureListener.class.getSimpleName() + \" or configure a proper thread model alternatively.\"); &#125; &#125; catch (Exception cnfe) &#123; // Ignore &#125; &#125;&#125; 1.2 IoSession的过滤器链IoSession是有状态的，它包括： Connected ：IoSession已被创建且生效。 Idle ：会话在一定时间内没有处理任何请求，它包括下面三个子状态： Idle for read ： 一段时间内没有接受数据。 Idle for write ： 一段时间内没有发送数据。 Idle for both ： 一段时间内没有产生接受或发送数据的操作。 Closing : IoSession正在关闭中。 Closed : session已经被关闭。 每个状态都会引起一系列的过滤器的对应的操作，从这句代码中我们了解到，每个IoSession都有他自己的过滤器链，即我们可以为每个session定制过滤器链。 1filterChain = new DefaultIoFilterChain(this); IoSession会先继承IoService的过滤器链，过滤器链将放在下一节统一分析。 2. IoSession在服务器端的创建第二步：initSession(session, null, null)这一步initSession(session, null, null);主要的有两段可配置的属性，一个就是存储attribute属性键值对的Map，默认是ConcurrentHashMap；另一个就是发送队列，默认是ConcurrentLinkedQueue。若要实现自己的数据结构，需要重写接口IoSessionDataStructureFactory或继承DefaultIoSessionDataStructureFactory。 1234567891011121314151617try &#123; ((AbstractIoSession) session).setAttributeMap(session.getService().getSessionDataStructureFactory() .getAttributeMap(session)); &#125; catch (IoSessionInitializationException e) &#123; throw e; &#125; catch (Exception e) &#123; throw new IoSessionInitializationException(\"Failed to initialize an attributeMap.\", e); &#125; try &#123; ((AbstractIoSession) session).setWriteRequestQueue(session.getService().getSessionDataStructureFactory() .getWriteRequestQueue(session)); &#125; catch (IoSessionInitializationException e) &#123; throw e; &#125; catch (Exception e) &#123; throw new IoSessionInitializationException(\"Failed to initialize a writeRequestQueue.\", e); &#125; 3. IoSession在服务器端的创建第三步：session.getProcessor().add(session);这一步就是为我们新生成的IoSession在IoService的Processor池中指定一个Processor处理。分配的方式就是取模分配，完成后在分配Processor中增加该IoSession的引用。SimpleIoProcessorPool中的代码如下： 12345 public final void add(S session) &#123; //请注意这里是两步，第一步getProcessor(session)在下面段代码，创建（若没有）并返回Processor //第二步在该Processor中add(session),这里就是调用AbstractPollingIoProcessor.add()，后面有更多描述 getProcessor(session).add(session); &#125; 12345678910111213141516171819private IoProcessor&lt;S&gt; getProcessor(S session) &#123; IoProcessor&lt;S&gt; processor = (IoProcessor&lt;S&gt;) session.getAttribute(PROCESSOR); if (processor == null) &#123; if (disposed || disposing) &#123; throw new IllegalStateException(\"A disposed processor cannot be accessed.\"); &#125; processor = pool[Math.abs((int) session.getId()) % pool.length]; if (processor == null) &#123; throw new IllegalStateException(\"A disposed processor cannot be accessed.\"); &#125; session.setAttributeIfAbsent(PROCESSOR, processor); &#125; return processor; &#125; 4. SimpleIoProcessorPool、IoProcess和NioSocketAcceptor之间的关系上节我们留了个悬念，SimpleIoProcessorPool、IoProcess和IoServices之间的到底是关系呢？我们从SimpleIoProcessorPool初始化池说起： 12345for (int i = 1; i &lt; pool.length; i++) &#123; ... pool[i] = processorConstructor.newInstance(this.executor); ... &#125; 这段代码将生成的线程池当做构造传参传递给所有的NioProcess，即数组池中所有NioProcess都是共享一个Executro线程池的（newCashedThreadPool）。AbstractPollingIoProcessor.add()方法做了这些工作： 12345678910 public final void add(S session) &#123; if (disposed || disposing) &#123; throw new IllegalStateException(\"Already disposed.\"); &#125; // 将session添加到ConcurrentLinkedQueue的队列中，并启动Processor 的worker线程 newSessions.add(session); //启动Processor线程 tartupProcessor(); &#125; 我们很有必要具体看一下Processor线程做了什么： 1234567891011121314151617181920212223242526272829303132333435363738394041private class Processor implements Runnable &#123; public void run() &#123; ... for (;;) &#123; try &#123; // 监控空闲时间 long t0 = System.currentTimeMillis(); int selected = select(1000); long t1 = System.currentTimeMillis(); long delta = (t1 - t0); ... // 注册新的session连接，并初始化session信息，如过滤器链， // 通知service的监听器 nSessions += handleNewSessions(); ... // 处理新的请求 if (selected &gt; 0) &#123; process(); &#125; ... // 移除 nSessions -= removeSessions(); // 通知空闲监听器 notifyIdleSessions(currentTime); ... //关闭 if (isDisposing()) &#123; for (Iterator&lt;S&gt; i = allSessions(); i.hasNext();) &#123; scheduleRemove(i.next()); &#125; wakeup(); &#125; &#125; catch ... &#125; ... &#125; &#125; 其中，handlesNewSessions()做了如下工作： 1234567891011 //在selector上注册感兴趣的相应集合读操作 SelectableChannel ch = (SelectableChannel) session.getChannel(); ch.configureBlocking(false); session.setSelectionKey(ch.register(selector, SelectionKey.OP_READ, session));  //将service的过滤器链设置在session上 IoFilterChainBuilder chainBuilder = session.getService().getFilterChainBuilder(); chainBuilder.buildFilterChain(session.getFilterChain()); //回调监听器 IoServiceListenerSupport listeners = ((AbstractIoService) session.getService()).getListeners(); listeners.fireSessionCreated(session); 至此SimpleIoProcessorPool、IoProcess和IoServices的关系就清晰了。 SimpleIoProcessorPool维护一组IoProcess[] ，每个IoProcess都在线程池中绑定了工作线程，该工作线程开启一个selector并监听session交互OP_READ。 123456789public NioProcessor(Executor executor) &#123; super(executor); try &#123; selector = Selector.open(); &#125; catch (IOException e) &#123; throw new RuntimeIoException(\"Failed to open a selector.\", e); &#125; &#125; NioSocketAcceptor持有一个pool的引用 NioSocketAcceptor自身也有个单线程的executor，用于监听新的session的链接OP_ACCEPT。 123NioSocketAcceptor.init() throws Exception &#123; selector = Selector.open(); &#125; 结语今天分析了IoSession后，mina的框架体系就比较清晰了，不过还有重要的filter、handler等，我们接下来几章继续探讨。 版权声明：本文为博主原创文章，未经博主允许不得转载。","tags":[{"name":"java mina","slug":"java-mina","permalink":"https://smuwjs.github.io/tags/java-mina/"}]},{"title":"mina学习笔记三：一切的源头IoService","date":"2016-09-08T20:12:15.000Z","path":"2016/09/08/mina学习笔记三：一切的源头IoService/","text":"原文:http://blog.csdn.net/yoara/article/details/37382137 1.IoService介绍从上节的例子已经了解到，创建服务端服务第一步是： 1IoAcceptor acceptor = new NioSocketAcceptor(); 而创建客户端连接的第一步是： 1IoConnector connector = new NioSocketConnector(); 这两个接口的父接口正是IoService。IoService是mina的核心组件，他提供标准的I/O 服务并且管理I/O 会话Session。IoService为大部分mina服务提供了底层的API支持。AbstractIoService是IoService的子类，他提供了基本的服务实现。先由下图简单的了解下IoService及其子类AbstractIoService的在mina体系结构中所担负的责任。 职责分解图 如图所见，IoService的权责主要包括： 会话Session管理：创建和销毁会话，检测session等待等。 过滤器链管理：管理过滤器链，提供多个切面的服务，并允许用户在运行时动态变更过滤器链。 处理调用：当有新消息或其他session生命周期触发事件响应时，回调用户的业务代码。 统计管理：更新消息发送量、字节发送量等等信息。 监听器管理：提供服务各个生命周期触发时间的监听器管理，如服务有效时、服务空闲时、会话创建时等。 传输管理：可在服务端客户端有效的控制数据流的传输，平衡负载。 2.IoService API分析那了解了IoService所承担的责任，以及知道他是服务端和客户端的共同祖先接口，我们有必要看一下他的API 清单： void addListener(IoServiceListener)：为service添加监听器 void removeListener(IoServiceListener)：移除一个监听器 Set broadcast(Object)：向持有的所有session广播消息 void dispose()：关闭service并释放相关联的资源，如果有session还未关闭，此方法会一直堵塞。 void dispose(boolean)：如果参数为true，service会一直阻塞直到ExecutorService线程池关闭后，才会关闭。 boolean isDisposed()：是否已经注销service boolean isDisposing()：是否正在注销service boolean isActive()：是否service还在服务 long getActivationTime()：获取最新活动的时间，如果sevice已经停止，则返回最后一次活动时间 DefaultIoFilterChainBuilder getFilterChain()：获得默认的过滤器链，如果用户没有使用自定义的，将会抛IllegalStateException异常。 void setFilterChainBuilder(IoFilterChainBuilder)：设置过滤器链对象 IoFilterChainBuilder getFilterChainBuilder()：获得过滤器链对象 void setHandler(IoHandler)：设置处理类 IoHandler getHandler()：获得处理类 int getManagedSessionCount()：获得有效的连接session数量 Map getManagedSessions() ：获得当前只读的有效session int getScheduledWriteBytes()：获取尚未发送的字节数 int getScheduledWriteMessages()：获取尚未发送的消息数量 IoSessionConfig getSessionConfig()：获得连接配置信息 void setSessionDataStructureFactory(IoSessionDataStructureFactory)：设置初始化session用的数据信息，注意，服务启动后不可设置。 IoSessionDataStructureFactory getSessionDataStructureFactory()：获得初始化session时用到的一些数据信息 IoServiceStatistics getStatistics()：获得统计数据信息 TransportMetadata getTransportMetadata()：session相关的元数据信息 3.从IoAcceptor开始吧显然，该接口的名称来源于耳熟能详的accept()方法。mina框架已经为我们封装了大部分网络通讯的实现类。因此我们大可不必自己重新去实现（除非有特殊的应用场景）。我们可根据自己的情况从下选择： NioSocketAcceptor ：非阻塞的套接字TCP（Socket） IoAcceptor NioDatagramAcceptor : 非阻塞的数据包UDP IoAcceptor AprSocketAcceptor : 基于 APR 的阻塞式套接字 IoAcceptor VmPipeSocketAcceptor : 基于虚拟机管道的 IoAcceptor 下图是IoAccceptor一支的类图结构： 3.1 创建IoAcceptor上节我们已经了解到，IoService开启服务的第一步是创建IoAcceptor： 12//首先，我们为服务端创建IoAcceptor，NioSocketAcceptor是基于NIO的服务端监听器IoAcceptor acceptor = new NioSocketAcceptor(); NioSocketAcceptor 继承自 AbstractPollingIoAcceptor并实现了SocketAcceptor接口。NioSocketAcceptor共有四个构造函数签名： NioSocketAcceptor() NioSocketAcceptor(int) NioSocketAcceptor(IoProcessor) NioSocketAcceptor(Executor, IoProcessor) 分别调用父类的四个对应构造函数如下。从这里我们知道，IoAcceptor在实例化是必须依赖3个接口，他们分别是IoSessionConfig、IoProcessor、Executor。 AbstractPollingIoAcceptor(IoSessionConfig, Class&lt;? extends IoProcessor&gt;) AbstractPollingIoAcceptor(IoSessionConfig, Class&lt;? extends IoProcessor&gt;, int) AbstractPollingIoAcceptor(IoSessionConfig, IoProcessor) AbstractPollingIoAcceptor(IoSessionConfig, Executor, IoProcessor) 3.1.1先从IoSessionConfig说起无论是NioSocketAcceptor或者NioDatagramAcceptor，具体实现类都是new一个DefaultDatagramSessionConfig实例做为传参： 1234public NioSocketAcceptor() &#123; super(new DefaultSocketSessionConfig(), NioProcessor.class); ((DefaultSocketSessionConfig) getSessionConfig()).init(this); &#125; boolean tcpNoDelay：表示立即发送数据。默认false boolean reuseAddress：表示是否允许重用Socket所绑定的本地地址。默认false int soLinger：表示当执行Socket的close()方法时，是否立即关闭底层的Socket。默认-1 int sendBufferSize：表示发送数据的缓冲区的大小。默认-1 int receiveBufferSize：表示接收数据的缓冲区的大小。默认-1 boolean keepAlive：表示对于长时间处于空闲状态的Socket，是否要自动把它关闭。默认false boolean oobInline：表示是否支持发送一个字节的TCP紧急数据。默认false。 int trafficClass：IP服务类型，底成本：0x02/高可靠：0x04/最高吞吐量：0x08/最小延迟：0x10 同时祖父类AbstractIoSessionConfig还包括如下参数： private int minReadBufferSize = 64; private int readBufferSize = 2048; private int maxReadBufferSize = 65536; private int idleTimeForRead; private int idleTimeForWrite; private int idleTimeForBoth; private int writeTimeout = 60; private boolean useReadOperation;//当IoSession.read()方法可用时，为true。接受到的所有消息将被存储在内部的BlockingQueue中，使用客户端程序可使用更加方便的读取方式。但使该操作生效并不会在服务端应用中产生什么好处反倒会导致不可预料的内存泄露，默认是关闭的。 private int throughputCalculationInterval = 3;//每次throughputCalculation（吞吐量计算？）的间隔时间，默认是3秒。 这些设置主要是传输相关的参数设置，默认就可以了，我们经常用到的估计就是BufferSize和idleTime了。 3.1.2 IoProcessor如果自己不实现IoProcess的话，默认的传递参数是NioProcessor.class（NioDatagramAcceptor构造函数是不需要该参数的）。在父类AbstractPollingIoAcceptor将调用 1new SimpleIoProcessorPool&lt;S&gt;(processorClass) 方法新建一个SimpleIoProcessorPool的实例。IoProcessor提供一个IoProcessor[处理器数+1] 数组类型的池，未处理每一种IoSessions分类。大多数的Services的实现子类都在内部使用该IoProcessor已达到在多核环境下更好的性能。我们不需要直接使用它。但是，如果在本地JVM中需要存在多个IoServices，那有必要让这些services共享一个SimpleIoProcessorPool。如使用一下方法： 1234SimpleIoProcessorPool&lt;NioSession&gt; pool = new SimpleIoProcessorPool&lt;NioSession&gt;(NioProcessor.class, 16);SocketAcceptor acceptor = new NioSocketAcceptor(pool);SocketConnector connector = new NioSocketConnector(pool); 来看一看SimpleIoProcessorPool的构造方法吧：其中，传递的参数processorType为NioProcessor.class 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091public SimpleIoProcessorPool(Class&lt;? extends IoProcessor&lt;S&gt;&gt; processorType, Executor executor, int size) &#123; if (processorType == null) &#123; throw new IllegalArgumentException(\"processorType\"); &#125; if (size &lt;= 0) &#123; throw new IllegalArgumentException(\"size: \" + size + \" (expected: positive integer)\"); &#125; // 事实上，&lt;span style=\"font-family: Arial, Helvetica, sans-serif;\"&gt;executor在框架内必然是null，除非我们实现自己的子类。&lt;/span&gt; createdExecutor = (executor == null); if (createdExecutor) &#123; &lt;span style=\"color:#ff0000;\"&gt;this.executor = Executors.newCachedThreadPool();&lt;/span&gt; //饱和策略选择了由调度者执行的机制。不过newCachedThreadPool不是无限线程池么，怎么又回饱和呢？ //难道是并发过载导致线程生成不过来？这样的话，负荷过载就会蔓延到IoServices的主线程，这样的饱和策略真的好么？ //我觉得不如抛弃任务，并抛出异常让上层捕获比较好。 ((ThreadPoolExecutor) this.executor).setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy()); &#125; else &#123; this.executor = executor; &#125; pool = new IoProcessor[size]; boolean success = false; Constructor&lt;? extends IoProcessor&lt;S&gt;&gt; processorConstructor = null; boolean usesExecutorArg = true; try &#123; // 首先保证至少能生成一个processor：默认的话就是newCachedThreadPool()返回的ThreadPoolExecutor，可自行实现 // 这里的初始化策略是：1.首先调用参数类型为ExecutorService 子类的构造函数， // 如果失败则2.调用参数类型为Executor子类的构造函数， // 否则3.调用无参的构造函数 try &#123; try &#123; processorConstructor = processorType.getConstructor(ExecutorService.class); pool[0] = processorConstructor.newInstance(this.executor); &#125; catch (NoSuchMethodException e1) &#123; // To the next step... try &#123; processorConstructor = processorType.getConstructor(Executor.class); pool[0] = processorConstructor.newInstance(this.executor); &#125; catch (NoSuchMethodException e2) &#123; // To the next step... try &#123; processorConstructor = processorType.getConstructor(); usesExecutorArg = false; pool[0] = processorConstructor.newInstance(); &#125; catch (NoSuchMethodException e3) &#123; // To the next step... &#125; &#125; &#125; &#125; catch (RuntimeException re) &#123; LOGGER.error(\"Cannot create an IoProcessor :&#123;&#125;\", re.getMessage()); throw re; &#125; catch (Exception e) &#123; String msg = \"Failed to create a new instance of \" + processorType.getName() + \":\" + e.getMessage(); LOGGER.error(msg, e); throw new RuntimeIoException(msg, e); &#125; if (processorConstructor == null) &#123; // Raise an exception if no proper constructor is found. String msg = String.valueOf(processorType) + \" must have a public constructor with one \" + ExecutorService.class.getSimpleName() + \" parameter, a public constructor with one \" + Executor.class.getSimpleName() + \" parameter or a public default constructor.\"; LOGGER.error(msg); throw new IllegalArgumentException(msg); &#125; // 生成其他的Processor，重复上述步骤 for (int i = 1; i &lt; pool.length; i++) &#123; try &#123; if (usesExecutorArg) &#123; pool[i] = processorConstructor.newInstance(this.executor); &#125; else &#123; pool[i] = processorConstructor.newInstance(); &#125; &#125; catch (Exception e) &#123; // Won't happen because it has been done previously &#125; &#125; success = true; &#125; finally &#123; if (!success) &#123; dispose(); &#125; &#125; &#125; 如果创建失败，则调用dispose方法，遍历IoProcess[]数组并释放所有的资源。 有人会问了，那SimpleIoProcessorPool、IoProcess和IoServices的服务之间有什么关联，为什么NioDatagramAcceptor不需要IoProcess呢？我们将在后面详细阐述。 3.1.3 Executor如果不传入Executor的而实现，mina会默认生成一个newCashedThreadPool，具体代码在非常底层的AbstractIoService类中，即无论是哪种连接方式、服务端、客户端，Executor的默认初始化方式都是一致的。 1234567if (executor == null) &#123; this.executor = Executors.newCachedThreadPool(); createdExecutor = true;&#125; else &#123; this.executor = executor; createdExecutor = false;&#125; 又有问题了，这里的Executor和SimpleIoProcessorPool中为每个IoProcess所共享的Executor有什么关系呢？再卖个关子。 3.2 IoAcceptor的构造函数做了什么？搞清楚了传入参数，我们来看下构造器做了哪些初始化的动作。以NioSocketAcceptor为例。上面我们已经知道底层的AbstractIoService类做了executor的初始化，不仅如此，在这之前他还做了元数据判断和初始化监听器链的工作： 12345678910 if (!getTransportMetadata().getSessionConfigType().isAssignableFrom(sessionConfig.getClass())) &#123; throw new IllegalArgumentException(\"sessionConfig type: \" + sessionConfig.getClass() + \" (expected: \" + getTransportMetadata().getSessionConfigType() + \")\"); &#125; // 创建监听器链，并增加第一个监听器// 该监听器的作用就是在service被激活时，设置IoServiceStatistics的// setLastReadTime、setLastWriteTime、setLastThroughputCalculationTime为激活时间 listeners = new IoServiceListenerSupport(this); listeners.add(serviceActivationListener); 同时，AbstructIoService类还实例化了IoFilterChainBuilder 对象，用于维护过滤器链。 1private IoFilterChainBuilder filterChainBuilder = new DefaultIoFilterChainBuilder(); 有必要提一下IoServiceListenerSupport，此类是所有监听器对象的持有类并管理着监听器的回调入口，同时还管理着当前Service的所有session。 1234567891011/** 当前service的引用 **/private final IoService service;/** 基于COW线程保护的listeners集合 */private final List&lt;IoServiceListener&gt; listeners = new CopyOnWriteArrayList&lt;IoServiceListener&gt;();/** 线程安全的session集合 */private final ConcurrentMap&lt;Long, IoSession&gt; managedSessions = new ConcurrentHashMap&lt;Long, IoSession&gt;();/** session集合的只读视图 **/private final Map&lt;Long, IoSession&gt; readOnlyManagedSessions = Collections.unmodifiableMap(managedSessions); 以其中的方法fireServiceActivated()为例，此方法是Service被激活时调用 1234567891011121314151617 public void fireServiceActivated() &#123; if (!activated.compareAndSet(false, true)) &#123; // 如果已经激活，则返回 return; &#125;//设置激活时间 activationTime = System.currentTimeMillis(); // 观察者模式，回调观察者listener的serviceActivated()方法 for (IoServiceListener listener : listeners) &#123; try &#123; listener.serviceActivated(service); &#125; catch (Throwable e) &#123; ExceptionMonitor.getInstance().exceptionCaught(e); &#125; &#125; &#125; 监听器的每个方法都是在IoServiceListenerSupport里被回调的： 1234fireServiceActivated()fireServiceDeactivated()fireSessionCreated(IoSession)fireSessionDestroyed(IoSession) 同时，service的getActivationTime()、isActive()方法等跟生命周期相关的信息获取方法，都是通过IoServiceListenerSupport的同名方法获得，可以说，IoServiceListenerSupport贯穿了整个IoService的生命周期。 至此，AbstructIoService完成了他的工作，接着AbstructIoAcceptor把defaultLocalAddresses设置为null，不知道这个defaultLocalAddresses的什么用？ 12super(sessionConfig, executor);defaultLocalAddresses.add(null); AbstructIoAcceptor老爹唱罢，儿子AbstractPollingIoAcceptor登场。这儿子就干了一件正经事儿，回调了孙子NioSocketAccept的init()方法。 123protected void init() throws Exception &#123; selector = Selector.open();&#125; 于是，选择器开启。在NIO的时代，Selector.open后紧接着就是注册了channel了，然后select()阻塞起等待连接了。而我们的mina接着是怎么做的呢？我们先跳过fliter链的设置和连接参数的设置，进入 12//绑定端口acceptor.bind(new InetSocketAddress(PORT)); 在一步老精彩了，儿子AbstractPollingIoAcceptor再也不是打酱油的角色了。老爹霹雳啪啦一大串模板方法，引出儿子关键的一步： 123456789...try &#123; &lt;span style=\"color:#ff0000;\"&gt;Set&lt;SocketAddress&gt; addresses = bindInternal(localAddressesCopy);&lt;/span&gt; synchronized (boundAddresses) &#123; boundAddresses.addAll(addresses); &#125;&#125;... 我们看看bindInternal在AbstractPollingIoAcceptor中做了什么 1234567891011121314151617181920212223242526272829303132333435363738394041424344 protected final Set&lt;SocketAddress&gt; bindInternal(List&lt;? extends SocketAddress&gt; localAddresses) throws Exception &#123;// 创建了与selector注册相关的任务，并添加至registerQueue中 AcceptorOperationFuture request = new AcceptorOperationFuture(localAddresses); registerQueue.add(request); // 在私有变量executor线程池中启动具体的Acceptor执行线程 &lt;span style=\"color:#ff0000;\"&gt;startupAcceptor();&lt;/span&gt; // As we just started the acceptor, we have to unblock the select() // in order to process the bind request we just have added to the // registerQueue. try &#123; lock.acquire(); // 让线程池任务运行Acceptor任务 // 实际上不需要这一步，我们知道wakeup()方法，如果当前没有select()执行，则会解除下一次select()阻塞状态 Thread.sleep(10); // 这个wakeup()方法很巧妙，因为Acceptor监听线程已经开启 // 但是没有连接接入，因此select()方法是阻塞的， // 为了让必要的request完成操作，调用一次wakeup(); wakeup(); &#125; finally &#123; lock.release(); &#125; // 等待request任务完成注册 request.awaitUninterruptibly(); if (request.getException() != null) &#123; throw request.getException(); &#125; // Update the local addresses. // setLocalAddresses() shouldn't be called from the worker thread // because of deadlock. Set&lt;SocketAddress&gt; newLocalAddresses = new HashSet&lt;SocketAddress&gt;(); for (H handle : boundHandles.values()) &#123; newLocalAddresses.add(localAddress(handle)); &#125; return newLocalAddresses; &#125; 这里我们看到，bindInternal()方法主要完成了selector的注册和启动。其中主要的方法是startupAcceptor(); 12345678910111213141516171819private void startupAcceptor() throws InterruptedException &#123; if (!selectable) &#123; registerQueue.clear(); cancelQueue.clear(); &#125; // 如果acceptor已经启动，则什么也不做，否则启动之。 Acceptor acceptor = acceptorRef.get(); if (acceptor == null) &#123; lock.acquire(); &lt;span style=\"color:#ff0000;\"&gt;acceptor = new Acceptor();&lt;/span&gt; if (acceptorRef.compareAndSet(null, acceptor)) &#123; executeWorker(acceptor); &#125; else &#123; lock.release(); &#125; &#125;&#125; Acceptor继承自Runnable，用于提交到线程池中执行，而这个线程池就是作为参数（或者默认newCashedThreadPool返回）的Executor。Acceptor线程任务以循环的方式调用select()，第一次运行时将注册选择器。后续主要完成3个工作： 12345678// 将 selector 设置监听 OP_ACCEPT，只在选择器第一次运行执行该代码，该方法依赖registerQueue队列nHandles += registerHandles(); // 如有连接接入，处理sessionprocessHandles(selectedHandles()); // 关闭selector监听，若关闭，则循环break跳出，线程任务结束，&lt;span style=\"font-family: Arial, Helvetica, sans-serif;\"&gt;该方法依赖cancelQueue队列&lt;/span&gt;nHandles -= unregisterHandles(); 启动和关闭selector的操作比较NIO，就不解释了，直接截取registerHandles()和unregisterHandles()部分方法源码 123456789101112131415161718192021222324252627282930313233343536373839protected ServerSocketChannel open(SocketAddress localAddress) throws Exception &#123; // Creates the listening ServerSocket ServerSocketChannel channel = ServerSocketChannel.open(); boolean success = false; try &#123; // This is a non blocking socket channel channel.configureBlocking(false); // Configure the server socket, ServerSocket socket = channel.socket(); // Set the reuseAddress flag accordingly with the setting socket.setReuseAddress(isReuseAddress()); // and bind. socket.bind(localAddress, getBacklog()); // Register the channel within the selector for ACCEPT event channel.register(selector, SelectionKey.OP_ACCEPT); success = true; &#125; finally &#123; if (!success) &#123; close(channel); &#125; &#125; return channel;&#125;protected void close(ServerSocketChannel handle) throws Exception &#123; SelectionKey key = handle.keyFor(selector); if (key != null) &#123; key.cancel(); &#125; handle.close();&#125; processHandles(selectedHandles()); 而最最关键也最最精彩的则是处理客户端连接的部分，我们下节继续。 版权声明：本文为博主原创文章，未经博主允许不得转载。","tags":[{"name":"java mina","slug":"java-mina","permalink":"https://smuwjs.github.io/tags/java-mina/"}]},{"title":"mina学习笔记二：从官方例子开始","date":"2016-09-08T20:12:14.000Z","path":"2016/09/08/mina学习笔记二：从官方例子开始/","text":"原文：http://blog.csdn.net/yoara/article/details/37324821 本节内容只介绍mina总体架构，同时给出官方的几个实用TCP、UDP的经典服务端客户端例子。 mina体系结构mina位于用户程序和网络处理之间，将用户从复杂的网络处理中解耦，那我们就可以更加关注业务领域。 让我们再深入进去，mina框架内部的各个组件是怎么协调工作的呢？ 显然，mina框架被分成了主要的3个组件部分： I/O Service，具体提供服务的组件。 I/O Filter Chain，过滤器链，用于支持各种切面服务。 I/O Handler，用于处理用户的业务逻辑。 相对应的，为了创建一个基于mina的应用程序，我们需要： 创建I/O Service ：可选择mina提供的Services如（*Acceptor）或实现自己的Service。 创建I/O Filter ：同样可以选择mina提供的各类filter，也可以实现自己的编解码过滤器等。 实现I/O Handler，实现Handler接口，处理各种消息。 服务端结构服务端的作用就是开启监听端口，等待请求的到来、处理他们、以及将发送对请求的响应。同时，服务端会为每个连接创建session，在session周期内提供各种精度的服务，比如连接创建时(sessionCreated(IoSession session))、连接等待时(sessionIdle(IoSession session, IdleStatus status))、连接销毁时(sessionClosed(IoSession session))等。mina的api为TCP/UDP提供的一致性Server端操作。 IOAcceptor 监听来自网络的请求。 当新的连接建立时，一个新的session会被创建，该session用作对同一IP/端口组合的客户端提供服务。 数据包需经过一系列的过滤器，这些过滤器可用来修改数据包的内容（如转换对象、添加或修改信息等），其中将原始字节流转换成POJO对象是非常有用的。当然这需要解编码器提供支持。 最后这些数据包或转化后的对象将交由IOHandler处理，我们将实现IOHandler用于处理具体的业务逻辑。 客户端结构客户端需要连接服务端，发送请求并处理响应。实际上客户端的结构和服务端极其相似。 客户端首先需要创建IOConnector对象，绑定服务端的IP和端口。 一旦连接成功，一个于本次连接绑定的session对象将被创建。 客户端发送给服务端的请求都需要经过一系列的fliter。 同样，响应消息的接受也会经过一系列的filter再到IOHandler被处理。 所以整体上，mina提供良好的一致性调用和封装结构。在使用mina创建基于网络的程序应用时，投入的学习成本比较低。 TCP连接的例子依赖的Jar包： MINA 2.x Core JDK 1.5 或以上 SLF4J 1.3.0 或以上 Log4J 1.2： slf4j-api.jar, slf4j-log4j12.jar, Log4j 1.2.x Log4J 1.3： slf4j-api.jar, slf4j-log4j13.jar, Log4j 1.3.x（注意，请确认log4j的版本） TCP Server端代码： 12345678910111213141516171819202122232425262728293031323334353637383940414243444546public class MinaTimeTest &#123; private static final int PORT = 9123; public static void main(String[] args) throws IOException &#123; //首先，我们为服务端创建IoAcceptor，NioSocketAcceptor是基于NIO的服务端监听器 IoAcceptor acceptor = new NioSocketAcceptor(); //接着，如结构图示，在Acceptor和IoHandler之间将设置一系列的Fliter //包括记录过滤器和编解码过滤器。其中TextLineCodecFactory是mina自带的文本解编码器 acceptor.getFilterChain().addLast(\"logger\", new LoggingFilter()); acceptor.getFilterChain().addLast(\"codec\", new ProtocolCodecFilter(new TextLineCodecFactory(Charset.forName(\"UTF-8\")))); //配置事务处理Handler，将请求转由TimeServerHandler处理。 acceptor.setHandler(new TimeServerHandler()); //配置Buffer的缓冲区大小 acceptor.getSessionConfig().setReadBufferSize(2048); //设置等待时间，每隔IdleTime将调用一次handler.sessionIdle()方法 acceptor.getSessionConfig().setIdleTime(IdleStatus.BOTH_IDLE, 10); //绑定端口 acceptor.bind(new InetSocketAddress(PORT)); &#125; static class TimeServerHandler extends IoHandlerAdapter &#123; public void exceptionCaught(IoSession session, Throwable cause) throws Exception &#123; cause.printStackTrace(); &#125; public void messageReceived(IoSession session, Object message) throws Exception &#123; String str = message.toString(); if (str.trim().equalsIgnoreCase(\"quit\")) &#123; session.close(false); return; &#125; Date date = new Date(); session.write(date.toString()); System.out.println(\"Message written...\"); &#125; public void sessionIdle(IoSession session, IdleStatus status) throws Exception &#123; System.out.println(\"IDLE \" + session.getIdleCount(status)); &#125; &#125;&#125; TCP Client端代码： 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061public class TimeClient &#123; private static final String HOSTNAME = \"127.0.0.1\"; private static final int PORT = 9123; private static final long CONNECT_TIMEOUT = 30 * 1000L; // 30 seconds public static void main(String[] args) throws Throwable &#123; //创建Connector连接器 NioSocketConnector connector = new NioSocketConnector(); //设置连接超时时间 connector.setConnectTimeoutMillis(CONNECT_TIMEOUT); connector.getFilterChain().addLast(\"codec\", new ProtocolCodecFilter(new TextLineCodecFactory())); connector.getFilterChain().addLast(\"logger\", new LoggingFilter()); //非常简单的处理Handler，向服务器发送一个数字 connector.setHandler(new ClientSessionHandler(1)); IoSession session = null; try &#123; //连接远程主机，设置IP和端口 ConnectFuture future = connector.connect(new InetSocketAddress( HOSTNAME, PORT)); //等待连接建立 future.awaitUninterruptibly(); //连接建立后返回会话session session = future.getSession(); &#125; catch (RuntimeIoException e) &#123; System.err.println(\"Failed to connect.\"); e.printStackTrace(); Thread.sleep(5000); &#125; finally&#123; if(session!=null)&#123; //等待本次连接通话结束，不可中断式的阻塞等待 session.getCloseFuture().awaitUninterruptibly(); &#125; &#125; //关闭连接 connector.dispose(); &#125; static class ClientSessionHandler extends IoHandlerAdapter &#123; private final int value; public ClientSessionHandler(int value) &#123; this.value = value; &#125; @Override public void sessionOpened(IoSession session) &#123; session.write(value); &#125; @Override public void messageReceived(IoSession session, Object message) &#123; System.out.println(message); session.close(true); &#125; @Override public void exceptionCaught(IoSession session, Throwable cause) &#123; session.close(true); &#125; &#125;&#125; UDP连接的例子UDP服务端： 123456789101112131415161718192021222324252627public class UdpServer &#123; private final static int PORT = 9234; public static void main(String[] args) throws IOException &#123; //创建UDPAcceptor NioDatagramAcceptor acceptor = new NioDatagramAcceptor(null); //这次不设置字符解编码器filter，消息直接用Buffer字节流传递 acceptor.getFilterChain().addLast(\"logger\", new LoggingFilter()); acceptor.setHandler(new UDPHandler()); acceptor.getSessionConfig().setIdleTime(IdleStatus.BOTH_IDLE, 10); acceptor.getSessionConfig().setReuseAddress(true);//&lt;span style=\"font-family: Arial, Helvetica, sans-serif;\"&gt;NioDatagramAcceptor 设置为null，才能重复使用端口&lt;/span&gt; acceptor.bind(new InetSocketAddress(PORT)); &#125; static class UDPHandler extends IoHandlerAdapter&#123; @Override public void messageReceived(IoSession session, Object message) throws Exception &#123; IoBuffer buffer = (IoBuffer)message; System.out.println(buffer.getLong()); session.close(false); &#125; @Override public void sessionIdle(IoSession session, IdleStatus status) throws Exception &#123; System.out.println(\"IDLE \" + session.getIdleCount(status)); &#125; &#125;&#125; UDP客户端： 123456789101112131415161718192021222324252627282930313233343536373839404142434445public class UdpClient &#123; private static IoSession session = null; public static void main(String[] args) &#123; NioDatagramConnector connect = new NioDatagramConnector(); connect.setHandler(new UDPClientHandler()); try&#123; ConnectFuture future = connect.connect(new InetSocketAddress(\"127.0.0.1\",9234)); future.awaitUninterruptibly(); session = future.getSession(); //增加连接建立完成后的监听器。 //若在建立完成后才添加监听器，监听器将马上执行 future.addListener(new IoFutureListener&lt;ConnectFuture&gt;()&#123; public void operationComplete(ConnectFuture future) &#123; if( future.isConnected() )&#123; try &#123; sendData(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; else &#123; System.out.println((\"Not connected...exiting\")); &#125; &#125; &#125;); &#125;catch(Exception e)&#123; &#125;finally&#123; if(session!=null)&#123; session.getCloseFuture().awaitUninterruptibly(); &#125; &#125; connect.dispose(); &#125; private static void sendData() throws InterruptedException &#123; long free = Runtime.getRuntime().freeMemory(); IoBuffer buffer = IoBuffer.allocate(8); buffer.putLong(free); buffer.flip(); session.write(buffer); //因为是UDP，客户端需主动关闭连接 session.close(false); &#125; static class UDPClientHandler extends IoHandlerAdapter&#123;&#125;&#125; 结语这一节介绍了mina的组件结构和框架体系，用几个案例简单介绍了下mina的使用方法。在日常的开发中，其实已经足够了。 版权声明：本文为博主原创文章，未经博主允许不得转载。","tags":[{"name":"java mina","slug":"java-mina","permalink":"https://smuwjs.github.io/tags/java-mina/"}]},{"title":"mina学习笔记一：mina上路","date":"2016-09-08T20:12:13.000Z","path":"2016/09/08/mina学习笔记一：mina上路/","text":"原文：http://blog.csdn.net/yoara/article/details/37117477 很久以前用mina做过项目，当时的感觉就是很轻松简单，几行代码就能写好复杂的网络连接雏形，不用考虑请求阻塞，不用考虑客户端的负荷压力。做了好些年业务代码，有时候回头看看自己的技术底蕴真的有些欠缺。最近重拾起NIO和并发编程的内容，java api了解了大概，通过对mina的学习，也算是巩固和升华吧。 起篇的意义在于对mina的背景了解和mina框架的鸟瞰，NIO是什么？为什么还需要在NIO的基础上重新开发出一套mina框架？带着问题我们进入主题。 NIO VS IONIO即所谓的new IO(也称为Non-Blocking IO)，是Java在1.4版本引入的用以解决java.io在系统伸缩性上瓶颈的新的架构设计。java.io类主要分为字符流（Reader/Writer）和字节流(Input/OutputStream)，无一例外的是阻塞式的。阻塞式代码带来的问题就是系统的性能瓶颈就受制于串行的挂起等待，线程因为磁盘IO操作或套接字的连接传输等而被挂起，在这其间不仅CPU资源被闲置浪费，也不能通过横向的增加硬件设备以得到很好的缓解负荷提升性能的目的。 于是NIO引入了一套非阻塞的机制。 java.nio框架主要包含以下几个构成部分： Buffer：缓冲区，数据的载体。 Channel：数据通道，他要么从Buffer中获取数据并向flie或socket写，要么从file或socket中获取数据往Buffer中写。 Selector：提供多路复用的非阻塞IO选择器。 Charset：用于字节到Unicode字符集的转码工具。 Regexp：正则表达式工具类 NIO提供多路复用的机制，他把读写IO的操作委托给操作系统（select()/poll()）。当操作系统从数据源读入数据，并将它存放到nio指定的Buffer缓冲区后，就会提醒Selector选择器，某一Channel通道的数据已经准备就绪。这时Selector告诉用户线程数据已到位可以来做对应的业务处理了。如图1.1 相较于IO，NIO的优势在于，用户线程不需要在串行的等待数据的IO操作，操作系统代替了用户去准备，这时用户线程可以从当前阻塞中脱离并去做其他的事情。同时在服务器端也不必为连接客户端而持有大量的处理线程，只需单线程的selector负责监听即可实现高伸缩性的网络应用。（事实上NIO主要分为文件(File)IO和套接字(Socket)IO，File 类操作依旧是阻塞式的。FileChannel没有实现SelectedChannel，而选择器只接受实现自此接口的通道注册。本质的原因是基于文件的IO操作系统已经有了足够的优化和预读取机制，并且更重要的一点是可以实现异步IO。而多路复用其实是一种同步的IO，具体可参详LInux的5种IO方式。） 为什么需要mina相较于业务功能的开发，网络通讯更偏向于底层。可能大多数程序员在学校里学完以后，在以后的工作中就很难用到。毕竟，Java的好处就是取之不尽的框架，不同的人把焦点集中在不同层面，既避免了重复造轮子也提高了生产效率。 对于阻塞式的IO，线程需要等待；而对于非阻塞式的IO，仍然需要单线程去轮询selector的状态。mina将封装了这些网络层的处理，对用户是透明的。它简化了TCP、UDP、串行通信程序等网络连接的使用；简化了服务端和客户端的使用。在高扩展性、性能和内存使用（据说netty做的更好，不过这两个框架基本思想差不多）方面给用户提供有力的支持。 mina是简单但功能齐全的网络应用程序框架，它的主要特性包括： 为各种网络通讯提供统一的API。 基于Java NIO 的TCP/IP UDP/IP。 基于RXTX的串行通信程序。 基于VM内部的管道通讯。 支持自定义实现。 可扩展的过滤器链，类似Serlvet的过滤器模型。 底层和抽象层的数据API。 底层：可基于ByteBuffer使用。 抽象层：用户自定义的消息对象和解编码方式。 高度可定制的线程模型。 单线程 单线程池 多个线程池 基于Java 5 SSLEngine进行了封装，支持开箱即用的SSL、TLS、StartTLS等。（？） 过载保护和流量控制。 可使用mock对象进行方便的单元测试。 集成JMX的管理架构 支持流IO（Stream-Base I/O）的操作，通过实现StreamIoHandle。 可被常用的容器框架集成管理，如Spring。 能从Netty平滑的迁移过度到Mina。 结语 总体介绍就是这样了，下一节从官方的例子开始，一步一步的剖析mina吧。 版权声明：本文为博主原创文章，未经博主允许不得转载。","tags":[{"name":"java mina","slug":"java-mina","permalink":"https://smuwjs.github.io/tags/java-mina/"}]},{"title":"使用GitHub搭建Hexo博客","date":"2016-09-08T20:12:12.000Z","path":"2016/09/08/GitHub+Hexo/","text":"来到GitHub这么长时间，才开始真真的了解GitHub，这个国外的代码托管平台，充满着大牛的身影。国内也有不多少的代码托管平台，本文将就用GitHub的GitHub Pages 功能来搭建，我的个性博客，最近在学习JS后端Node.js, 现在火的不行, 异步IO的机制, 所以在学习过程中发现了hexo是由Node.js驱动的一款快速、简单且功能强大的博客框架。比起WordPress，hexo的搭建更加简洁，配合上markdown的使用，更加便捷的管理自己的学习文档。 概况 为什么选择GitHub Pages1、GitHub Pages有免费的代码托管空间，资料自己管理，保存可靠；2、学着用 GitHub，享受 GitHub 的便利，上面有很多大牛，眼界会开阔很多；3、顺便理解 GitHub 工作原理，最好的团队协作流程；4、GitHub建立私有仓库才会收费，所以会有很多开源代码。 GitHub Pages是什么应用GitHub Pages创建属于自己的个人博客，GitHub将提供免费的空间。GitHub提供的域名（用户名+github+io）,在Repository name对应处填写资源名，其需要使用自己的用户名，每个用户名下面只能建立一个，并且资源命名必须符合这样的规则username/username.github.io，之后勾选下面的”Initialize this repository with a README” 。 hexo出自何人hexo出自台湾大学生 tommy351 之手，是一个基于Node.js的静态博客程序，其编译上百篇文字只需要几秒。hexo生成的静态网页可以直接放到GitHub Pages，BAE，SAE等平台上。 安装准备 环境搭建： Node.js：下载地址 Git：下载地址 Sublime：下载地址安装Node到 Node.js 官网下载相应平台的 最新版本 ，一路安装即可。我用的是 node-v0.10.22-x86.msi安装GitGit的客户端很多，我用的是 msysgit ，喜欢用绿色版本 Portable application for official Git for Windows 1.8.4 ，下载下来设置一下环境变量即可，Git_HOME，%Git_HOME%\\bin之类的，不多说。安装SublimeSublime Text 2 在这里仅仅作为一个文本编辑器使用，支持各种编程语言和文件格式，当然也支持Markdown语法，实在是个不可多得的练码奇才。喜欢追鲜的也可以尝试处于beta版本的 Sublime Text 3 。 GitHub注册与配置 注册：访问：GitHub，注册你的username和邮箱，邮箱十分重要，GitHub上很多通知都是通过邮箱的。注册过程比较简单，详细也可以看：使用Github Page搭建博客, 需要遵循一定的规则, 需要在github建立仓库,仓库名为Github用户.github.io, 更多详情请参考官方文档 配置和使用Github以下教程主要参考beiyuu的《使用Github Pages建独立博客》写成。 配置SSH keys我们如何让本地git项目与远程的github建立联系呢？用SSH keys。打开Git Bash工具，执行以下操作 检查SSH keys的设置 123456789101112 首先我们需要检查你电脑上现有的ssh key：$ cd ~/. ssh 检查本机的ssh密钥 如果提示：No such file or directory 说明你是第一次使用git。 生成新的SSH Key：$ ssh-keygen -t rsa -C &quot;邮件地址@youremail.com&quot;Generating public/private rsa key pair.Enter file in which to save the key (/Users/your_user_directory/.ssh/id_rsa):&lt;回车就好&gt; 注意1: 此处的邮箱地址，你可以输入自己的邮箱地址；注意2: 此处的「-C」的是大写的「C」 然后系统会要你输入密码： Enter passphrase (empty for no passphrase):&lt;输入加密串&gt;Enter same passphrase again:&lt;再次输入加密串&gt; 在回车中会提示你输入一个密码，这个密码会在你提交项目时使用，如果为空的话提交项目时则不用输入。这个设置是防止别人往你的项目里提交内容。 注意：输入密码的时候没有*字样的，你直接输入就可以了。 最后看到这样的界面，就成功设置ssh key了：12 添加SSH Key到GitHub在本机设置SSH Key之后，需要添加到GitHub上，以完成SSH链接的设置。 打开本地C:\\Documents and Settings\\Administrator.ssh\\id_rsa.pub文件。此文件里面内容为刚才生成人密钥。如果看不到这个文件，你需要设置显示隐藏文件。准确的复制这个文件的内容，才能保证设置的成功。 登陆github系统。点击右上角的 Account Settings—&gt;SSH Public keys —&gt; add another public keys 把你本地生成的密钥复制到里面（key文本框中）， 点击 add key 就ok了 测试 1234567891011121314151617181920212223242526 可以输入下面的命令，看看设置是否成功，git@github.com的部分不要修改：$ ssh -T git@github.com 如果是下面的反馈：The authenticity of host &apos;github.com (207.97.227.239)&apos; can&apos;t be established.RSA key fingerprint is 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48.Are you sure you want to continue connecting (yes/no)? 不要紧张，输入yes就好，然后会看到：Hi cnfeat! You&apos;ve successfully authenticated, but GitHub does not provide shell access. 设置用户信息： 现在你已经可以通过SSH链接到GitHub了，还有一些个人信息需要完善的。 Git会根据用户的名字和邮箱来记录提交。 GitHub也是用这些信息来做权限的处理，输入下面的代码进行个人信息的设置，把名称和邮箱替换成你自己的，名字必须是你的真名，而不是GitHub的昵称。$ git config --global user.name &quot;cnfeat&quot;//用户名$ git config --global user.email &quot;cnfeat@gmail.com&quot;//填写自己的邮箱 SSH Key配置成功，本机已成功连接到github。 Hexo博客 HexoHexo的作者是tommy351，根据官方介绍，Hexo是一个简单、快速、强大的博客发布工具，支持Markdown格式。hexo的主题列表 Hexo Themes。 我比较喜欢 pacman ， modernist 、 ishgo ， raytaylorism 。 安装Hexo打开Git Bash工具（前提确保Node.js已经安装，环境配置OK） $ npm install -g hexo 注释： 执行命令：npm install -g hexo，报错如下： 12345678910111213141516171819202122232425262728293031npm ERR! Error: shasum check failed for C:\\Users\\ADMINI~1\\AppData\\Local\\Temp\\npm-30024-KDJHJzgP\\registry.npmjs.org\\hexo-cli\\-\\hexo-cli-0.1.6.tgznpm ERR! Expected: 7dc3ab939d0889c4bed6a961605ff3e2d67f67a2npm ERR! Actual: 41de7d67a9b764352eb07c49c32fc38dd7f479b9npm ERR! From: https://registry.npmjs.org/hexo-cli/-/hexo-cli-0.1.6.tgznpm ERR! at d:\\Program Files\\nodejs\\node_modules\\npm\\node_modules\\sha\\index.js:38:8npm ERR! at ReadStream.&lt;anonymous&gt; (d:\\Program Files\\nodejs\\node_modules\\npm\\node_modules\\sha\\index.js:85:7)npm ERR! at ReadStream.emit (events.js:117:20)npm ERR! at _stream_readable.js:943:16npm ERR! at process._tickCallback (node.js:419:13)npm ERR! If you need help, you may report this *entire* log,npm ERR! including the npm and node versions, at:npm ERR! &lt;http://github.com/npm/npm/issues&gt;npm ERR! System Windows_NT 6.2.9200npm ERR! command &quot;d:\\\\Program Files\\\\nodejs\\\\node.exe&quot; &quot;d:\\\\Program Files\\\\nodejs\\\\node_modules\\\\npm\\\\bin\\\\npm-cli.js&quot; &quot;install&quot; &quot;-g&quot; &quot;hexo&quot;npm ERR! cwd C:\\Users\\Administrator\\Desktopnpm ERR! node -v v0.10.31npm ERR! npm -v 1.4.23npm ERR! registry error parsing jsonnpm ERR!npm ERR! Additional logging details can be found in:npm ERR! C:\\Users\\Administrator\\Desktop\\npm-debug.lognpm ERR! not ok code 0 莫非是因为被墙了？换国内镜像源试试。npm config set registry=&quot;http://registry.cnpmjs.org&quot;， 然后再次执行npm install -g hexo，成功！ 部署Hexo123456789101112131415161718192021 在我的电脑中建立一个名字叫「Hexo」的文件夹，然后在此文件夹中右键打开Git Bash。$ hexo init 如果无法使用右击“Git Bash”，则可以切换到指定目录 UUhike@UUhike-pc MINGW64 ~$ cd j:/github/hexo UUhike@UUhike-pc MINGW64 /j/github/hexo 安装依赖包$ npm install Hexo随后会自动在目标文件夹建立网站所需要的所有文件。 现在我们已经搭建起本地的hexo博客了，执行以下命令(在H:\\hexo)，然后到浏览器输入localhost:4000看看。 本地查看$ hexo generate #生成静态页面至public目录（最终上传这个文件到GitHub）$ hexo server #开启预览访问端口（默认端口4000，&apos;ctrl + c&apos;关闭server） 部署到GitHub123456789编辑E:\\hexo下的_config.yml，修改Deployment部分：# Deployment## Docs: http://hexo.io/docs/deployment.htmldeploy: type: git repository: https://github.com/luuman/luuman.github.io.git branch: master 注释： hexo d，执行该命令，报错： 1234567891011121314151617181920212223242526272829303132333435ERROR Deployer not found: git执行命令：npm install hexo-deployer-git --save再次执行hexo d,报错：INFO Deploying: gitINFO Clearing .deploy folder...INFO Copying files from public folder...warning: LF will be replaced by CRLF in 2015/05/30/hello-world/index.html.The file will have its original line endings in your working directory.......*** Please tell me who you are.Run git config --global user.email &quot;you@example.com&quot; git config --global user.name &quot;Your Name&quot;to set your account&apos;s default identity.Omit --global to set the identity only in this repository.fatal: unable to auto-detect email address (got &apos;Administrator@PC-201505290750.(none)&apos;)Username for &apos;https://github.com&apos;: voidkingPassword for &apos;https://voidking@github.com&apos;:error: src refspec master does not match any.error: failed to push some refs to &apos;https://github.com/voidking/voidking.github.io.git&apos;FATAL Something&apos;s wrong. Maybe you can find the solution here: http://hexo.io/docs/troubleshooting.htmlError: error: src refspec master does not match any.error: failed to push some refs to &apos;https://github.com/voidking/voidking.github.io.git&apos; at ChildProcess.&lt;anonymous&gt; (E:\\hexo\\node_modules\\hexo-deployer-git\\node_modules\\hexo-util\\lib\\spawn.js:42:17) at ChildProcess.emit (events.js:98:17) at maybeClose (child_process.js:756:16) at Process.ChildProcess._handle.onexit (child_process.js:823:5) hexo d，执行该命令，报错： 复制cnfeat的主题以下进入复制主题环节，如果那一步出现问题，或者修改后没有显示修改的结果，建议来来一个，再看看，可以解决很多问题。 12345678910111213$ hexo clean$ hexo generate #生成静态页面至public目录（最终上传这个文件到GitHub）$ hexo server #开启预览访问端口（默认端口4000，&apos;ctrl + c&apos;关闭server）建立了Hexo文件，复制我的主题了到themes文件夹中yilia$ git clone https://github.com/litten/hexo-theme-yilia.git themes/yiliamodernist$ git clone https://github.com/heroicyang/hexo-theme-modernist.git themes/modernistjacman$ git clone https://github.com/cnfeat/cnfeat.git themes/jacman 启用cnfeat的主题修改Hexo目录下的config.yml配置文件中的theme属性，将其设置为jacman。同时请设置stylus属性中的compress值为true。theme: jacman 注意：Hexo有两个config.yml文件，一个在根目录，一个在theme下，此时修改的是在根目录下的。 更新主题 $ cd themes/jacman $ git pull 注意：为避免出错，请先备份你的_config.yml 文件后再升级本地查看调试 1234567891011121314$ hexo g #生成$ hexo s #启动本地服务，进行文章预览调试或者直接作用组合命令$ hexo deploy -g$ hexo server -g简写：hexo n == hexo newhexo g == hexo generatehexo s == hexo serverhexo d == hexo deploy 4、浏览器中查看效果 浏览器输入http://localhost:4000 ，查看搭建效果。此后的每次变更_config.yml文件或者上传文件都可以先用此命令调试，非常好用，尤其是当你想调试出自己想要的主题时。 #进阶篇：Hexo设置 网站搭建完成后，就可以根据自己爱好来对Hexo生成的网站进行设置了，对整站的设置，只要修改项目目录的hexo/_config.yml就可以了，这是我的设置，可供参考。 默认目录结构： 1234567891011.├── .deploy├── public├── scaffolds├── scripts├── source| ├── _drafts| └── _posts├── themes├── _config.yml└── package.json hexo/_config.yml 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485# Hexo Configuration## Docs: http://hexo.io/docs/configuration.html## Source: https://github.com/hexojs/hexo/# Site #整站的基本信息title: 1000 words a Day #网站标题subtitle: Writing 1000 Words a Day Changes My Life #网站副标题description: 学习总结 思考感悟 知识管理 #网站描述author: cnFeat #网站作者，在下方显示email: cnFeat@gmail.com #联系邮箱language: zh-CN #主题实际的文件名称timezone:# URL #这项暂不配置，绑定域名后，欲创建sitemap.xml需要配置该项## If your site is put in a subdirectory, set url as &apos;http://yoursite.com/child&apos; and root as &apos;/child/&apos;url: http://yoursite.comroot: /permalink: :year/:month/:day/:title/permalink_defaults:# Directorysource_dir: sourcepublic_dir: publictag_dir: tagsarchive_dir: archivescategory_dir: categoriescode_dir: downloads/codei18n_dir: :langskip_render:# Writing 文章布局、写作格式的定义，不修改new_post_name: :title.md # File name of new postsdefault_layout: posttitlecase: false # Transform title into titlecaseexternal_link: true # Open external links in new tabfilename_case: 0render_drafts: falsepost_asset_folder: falserelative_link: falsefuture: truehighlight: enable: true line_number: true auto_detect: true tab_replace:# Category &amp; Tagdefault_category: uncategorizedcategory_map:tag_map:# Date / Time format 日期格式，不修改## Hexo uses Moment.js to parse and display date## You can customize the date format as defined in## http://momentjs.com/docs/#/displaying/format/date_format: YYYY-MM-DDtime_format: HH:mm:ss# Pagination 每页显示文章数，可以自定义，我将10改成了5## Set per_page to 0 to disable paginationper_page: 5pagination_dir: page# Disqus Disqus插件，我们会替换成“多说”，不修改disqus_shortname:# Extensions## Plugins: http://hexo.io/plugins/## Themes: http://hexo.io/themes/theme: spfk# 自动生成sitemapsitemap:path: sitemap.xmlbaidusitemap:path: baidusitemap.xml# Deployment 站点部署到github要配置，上一节中已经讲过## Docs: http://zespia.tw/hexo/docs/deploy.htmldeploy: type: git repository: git@github.com:luuman/luuman.github.io.git branch: master 修改局部页面 页面展现的全部逻辑都在每个主题中控制，源代码在hexo\\themes\\主题名称\\中： hexo\\themes\\ 1234567891011121314151617├── languages #多语言| ├── default.yml#默认语言| └── zh-CN.yml #中文语言├── layout #布局，根目录下的*.ejs文件是对主页，分页，存档等的控制| ├── _partial #局部的布局，此目录下的*.ejs是对头尾等局部的控制| └── _widget#小挂件的布局，页面下方小挂件的控制├── source #源码| ├── css#css源码 | | ├── _base #*.styl基础css| | ├── _partial #*.styl局部css| | ├── fonts #字体| | ├── images #图片| | └── style.styl #*.styl引入需要的css源码| ├── fancybox #fancybox效果源码| └── js #javascript源代码├── _config.yml#主题配置文件└── README.md #用GitHub的都知道 主题文档的配置 hexo\\themes/_config.yml 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657# Headermenu: 主页: / 所有文章: /archives # 随笔: /tags/随笔# SubNavsubnav: github: &quot;#&quot; weibo: &quot;#&quot; rss: &quot;#&quot; zhihu: &quot;#&quot; #douban: &quot;#&quot; #mail: &quot;#&quot; #facebook: &quot;#&quot; #google: &quot;#&quot; #twitter: &quot;#&quot; #linkedin: &quot;#&quot;rss: /atom.xml# Contentexcerpt_link: morefancybox: truemathjax: true# Miscellaneousgoogle_analytics: &apos;&apos;favicon: /favicon.png#你的头像urlavatar: &quot;&quot;#是否开启分享share: true#是否开启多说评论，填写你在多说申请的项目名称 duoshuo: duoshuo-key（http://duoshuo-key.duoshuo.com/）#若使用disqus，请在博客config文件中填写disqus_shortname，并关闭多说评论duoshuo: true#是否开启云标签tagcloud: true#是否开启友情链接#不开启——#friends: false#开启——friends: 奥巴马的博客: http://localhost:4000/ 卡卡的美丽传说: http://localhost:4000/ 本泽马的博客: http://localhost:4000/ 吉格斯的博客: http://localhost:4000/ 习大大大不同: http://localhost:4000/ 托蒂的博客: http://localhost:4000/#是否开启“关于我”。#不开启——#aboutme: false#开启——aboutme: 我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货… 参考资料：hexo你的博客如何搭建一个独立博客——简明Github Pages与Hexo教程Hexo的使用介绍Hexo插件安装","tags":[{"name":"Hexo","slug":"Hexo","permalink":"https://smuwjs.github.io/tags/Hexo/"}]},{"title":"Hexo插件安装","date":"2016-09-07T22:33:55.000Z","path":"2016/09/07/Hexo-plug/","text":"自用笔记：本文属于自用笔记，不做详解，仅供参考。在此记录自己已理解并开始遵循的前端代码规范。What How Why 最近，使用Hexo遇到了很多问题，在设立进行整理。 同步instagram图片 新建页面 12执行命令：hexo new page &quot;instagram&quot; 修改文件 12345678910111213在目录yourBlog\\source\\instagram下，修改index.md内容为：---layout: postslug: &quot;instagram&quot;title: &quot;相册&quot;noDate: &quot;true&quot;---&lt;div class=&quot;instagram&quot; data-client-id=&quot;a0d4bd ab154b4c689aff70602cb34a2c&quot; data-user-id=&quot;438522285&quot;&gt; &lt;a href=&quot;http://instagram.com/litten225&quot; target=&quot;_blank&quot; class=&quot;open-ins&quot;&gt;图片来自instagram，正在加载中…&lt;/a&gt;&lt;/div&gt;&lt;script src=&quot;/js/jquery.lazyload.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;/js/instagram.js&quot;&gt;&lt;/script&gt; 获取ID 123456789101112131415data-client-id：[注册新客户端](http://instagram.com/developer/clients/manage/)获取CLIENT ID：a0d4bdab154b4c689aff70602cb34a2c用client_id去换取token：在浏览器中请求： https://instagram.com/oauth/authorize/?client_id=&#123;CLIENT_ID&#125;&amp;redirect_uri=&#123;REDIRECT_URI&#125;&amp;response_type=token https://instagram.com/oauth/authorize/?client_id=a0d4bdab154b4c689aff70602cb34a2c&amp;redirect_uri=http://luuman.github.io/&amp;response_type=token 花括号里面的值，对应上一步最终得到的client_id和自己设定的redirect_uri。 请求到的是一个授权页面，授权完毕后，则重定向到你的redirect_uri。 注意看授权成功后的url，hash部分会附带给你的token。至此，token成功获取，将至放在data-client-id。data-user-id：需要到[lookup-user-id](http://jelled.com/instagram/lookup-user-id#)填写用户名并查找。 分享按钮 添加代码 123456789101112131415161718192021222324252627282930以下代码是百度分享的页面24页面分享的代码，可以自行选择以下标签。配置vim themes/light/layout/_partial/article.ejs删除&lt;%-partial(&apos;post/share&apos;)%&gt;替换为刚刚获取的分享代码&lt;div class=&quot;bdsharebuttonbox&quot;&gt; &lt;a href=&quot;#&quot; class=&quot;fx fa-weibo bds_tsina&quot; data-cmd=&quot;tsina&quot; title=&quot;分享到新浪微博&quot;&gt;&lt;/a&gt; &lt;a href=&quot;#&quot; class=&quot;fx fa-weixin bds_weixin&quot; data-cmd=&quot;weixin&quot; title=&quot;分享到微信&quot;&gt;&lt;/a&gt; &lt;a href=&quot;#&quot; class=&quot;fx fa-qq bds_sqq&quot; data-cmd=&quot;sqq&quot; title=&quot;分享到QQ好友&quot;&gt;&lt;/a&gt; &lt;a href=&quot;#&quot; class=&quot;fx fa-facebook-official bds_fbook&quot; data-cmd=&quot;fbook&quot; title=&quot;分享到Facebook&quot;&gt;&lt;/a&gt; &lt;a href=&quot;#&quot; class=&quot;fx fa-twitter bds_twi&quot; data-cmd=&quot;twi&quot; title=&quot;分享到Twitter&quot;&gt;&lt;/a&gt; &lt;a href=&quot;#&quot; class=&quot;fx fa-linkedin bds_linkedin&quot; data-cmd=&quot;linkedin&quot; title=&quot;分享到linkedin&quot;&gt;&lt;/a&gt; &lt;a href=&quot;#&quot; class=&quot;fx fa-files-o bds_copy&quot; data-cmd=&quot;copy&quot; title=&quot;分享到复制网址&quot;&gt;&lt;/a&gt; &lt;a href=&quot;#&quot; class=&quot;fx fa-plus-square bds_more&quot; data-cmd=&quot;more&quot;&gt;&lt;/a&gt; &lt;a href=&quot;#&quot; class=&quot;fx fa-tencent-weibo bds_tqq&quot; data-cmd=&quot;tqq&quot; title=&quot;分享到腾讯微博&quot;&gt;&lt;/a&gt; &lt;a href=&quot;#&quot; class=&quot;fx fa-renren bds_renren&quot; data-cmd=&quot;renren&quot; title=&quot;分享到人人网&quot;&gt;&lt;/a&gt; &lt;a href=&quot;#&quot; class=&quot;fx fa-paw bds_tieba&quot; data-cmd=&quot;tieba&quot; title=&quot;分享到百度贴吧&quot;&gt;&lt;/a&gt; &lt;a href=&quot;#&quot; class=&quot;fx fa-envelope-o bds_mail&quot; data-cmd=&quot;mail&quot; title=&quot;分享到邮件分享&quot;&gt;&lt;/a&gt;&lt;/div&gt; &lt;a href=&quot;#&quot; class=&quot;fx fa-print bds_print&quot; data-cmd=&quot;print&quot; title=&quot;分享到打印&quot;&gt;&lt;/a&gt; &lt;a href=&quot;#&quot; class=&quot;fx fa-share-alt bds_mshare&quot; data-cmd=&quot;mshare&quot; title=&quot;分享到一键分享&quot;&gt;&lt;/a&gt; &lt;a href=&quot;#&quot; class=&quot;fx bds_douban&quot; data-cmd=&quot;douban&quot; title=&quot;分享到豆瓣网&quot;&gt;&lt;/a&gt; &lt;a href=&quot;#&quot; class=&quot;fx fa- bds_qzone&quot; data-cmd=&quot;qzone&quot; title=&quot;分享到QQ空间&quot;&gt;&lt;/a&gt; &lt;a href=&quot;#&quot; class=&quot;fx fa- bds_evernotecn&quot; data-cmd=&quot;evernotecn&quot; title=&quot;分享到印象笔记&quot;&gt;&lt;/a&gt;&lt;/div&gt;&lt;script&gt;window._bd_share_config=&#123;&quot;common&quot;:&#123;&quot;bdSnsKey&quot;:&#123;&#125;,&quot;bdText&quot;:&quot;&quot;,&quot;bdMini&quot;:&quot;1&quot;,&quot;bdMiniList&quot;:false,&quot;bdPic&quot;:&quot;&quot;,&quot;bdStyle&quot;:&quot;2&quot;,&quot;bdSize&quot;:&quot;24&quot;&#125;,&quot;share&quot;:&#123;&#125;&#125;;with(document)0[(getElementsByTagName(&apos;head&apos;)[0]||body).appendChild(createElement(&apos;script&apos;)).src=&apos;http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=&apos;+~(-new Date()/36e5)];&lt;/script&gt; 修改样式 1234567891011121314151617181920212223242526272829303132\\themes\\spfk\\source\\css\\_partial\\article.styl/* bd share button box */.bdshare-button-style2-24&#123; width: 330px; margin: auto; .fx &#123; color: #999; padding: 0; margin: 6px; height: 54px; display: inline-block; font: normal normal normal 36px/1 FontAwesome; background: none; text-rendering: auto; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; &#125; .fx:hover&#123; color: #FFF; opacity: 1; &#125;&#125;themes\\spfk\\source\\css\\_partial\\mobile.styl/* bd share button box */.bdshare-button-style2-24&#123; width: 289px; .fx &#123; font: normal normal normal 30px/1 FontAwesome; &#125;&#125; 百度统计 添加代码 1234567891011121314151617181920212223242526去百度统计获取统计代码vim themes/light/layout/_partial/baidu_analytics.ejs&lt;% if (theme.baidu_analytics)&#123; %&gt;&lt;script&gt;var _hmt = _hmt || [];(function() &#123; var hm = document.createElement(&quot;script&quot;); hm.src = &quot;//hm.baidu.com/hm.js?819b1c6493df653afb8c784db6&quot;; var s = document.getElementsByTagName(&quot;script&quot;)[0]; s.parentNode.insertBefore(hm, s);&#125;)();&lt;/script&gt;&lt;% &#125; %&gt;vim hexo/themes/light/_config.ymlbaidu_analytics: truevim hexo/themes/light/layout/_partial/head.ejs在/head前添加&lt;%- partial(&apos;baidu_analytics&apos;) %&gt;&lt;/head&gt; 不蒜子 添加代码 123456789101112131415161718192021222324252627themes/你的主题/layout/_partial/footer.ejs&lt;footer id=&quot;footer&quot;&gt; &lt;div class=&quot;outer&quot;&gt; &lt;div id=&quot;footer-info&quot;&gt; &lt;div class=&quot;footer-left&quot;&gt; &amp;copy; &lt;%= date(new Date(), &apos;YYYY&apos;) %&gt; &lt;%= config.author || config.title %&gt; &lt;/div&gt; &lt;div class=&quot;footer-right&quot;&gt; &lt;a href=&quot;http://hexo.io/&quot; target=&quot;_blank&quot;&gt;Hexo&lt;/a&gt; Theme &lt;a href=&quot;https://github.com/luuman/hexo-theme-spfk&quot; target=&quot;_blank&quot;&gt;spfk&lt;/a&gt; by luuman &lt;/div&gt; &lt;/div&gt; &lt;div class=&quot;visit&quot;&gt; &lt;span id=&quot;busuanzi_container_site_pv&quot; style=&apos;display:none&apos;&gt; &lt;span id=&quot;site-visit&quot; &gt;本站到访数: &lt;span id=&quot;busuanzi_value_site_uv&quot;&gt;&lt;/span&gt; &lt;/span&gt; &lt;/span&gt; &lt;span id=&quot;busuanzi_container_page_pv&quot; style=&apos;display:none&apos;&gt; &lt;span id=&quot;page-visit&quot;&gt;, 本页阅读量: &lt;span id=&quot;busuanzi_value_page_pv&quot;&gt;&lt;/span&gt; &lt;/span&gt; &lt;/span&gt; &lt;/div&gt; &lt;/div&gt;&lt;script async src=&quot;https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js&quot;&gt;&lt;/script&gt;&lt;/footer&gt; 修改样式 移动端出现上移themes\\spfk\\source\\css_partial\\mobile.styl1234567891011121314#footer &#123; bottom: 10px; .footer-left&#123; float: initial; margin-bottom: 10px; &#125; .footer-right&#123; float: initial; margin-bottom: 10px; &#125;&#125;#container .visit &#123; margin-top: 1em;&#125; 版权声明 添加代码 123456789101112131415161718192021222324252627282930313233343536373839404142\\layout\\_partial\\post\\nav.ejs&lt;% if (post.original != false &amp;&amp; !is_page())&#123; %&gt; &lt;div class=&quot;copyright&quot;&gt; &lt;p&gt;&lt;span&gt;本文标题:&lt;/span&gt;&lt;a href=&quot;&lt;%- url_for(post.path) %&gt;&quot;&gt;&lt;%= post.title %&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;&lt;span&gt;文章作者:&lt;/span&gt;&lt;a href=&quot;/&quot; title=&quot;请访问 &lt;%=theme.author%&gt; 博客&quot;&gt;&lt;%=theme.author%&gt;&lt;/a&gt;&lt;/p&gt; &lt;!-- &lt;p&gt;&lt;span&gt;发布时间:&lt;/span&gt;&lt;%= post.date.format(&quot;YYYY年MM月DD日 - HH时mm分&quot;) %&gt;&lt;/p&gt; --&gt; &lt;!-- &lt;p&gt;&lt;span&gt;最后更新:&lt;/span&gt;&lt;%= post.updated.format(&quot;YYYY年MM月DD日 - HH时mm分&quot;) %&gt;&lt;/p&gt; --&gt; &lt;p&gt; &lt;span&gt;原始链接:&lt;/span&gt;&lt;a class=&quot;post-url&quot; href=&quot;&lt;%- url_for(post.path) %&gt;&quot; title=&quot;&lt;%= post.title %&gt;&quot;&gt;&lt;%= post.permalink %&gt;&lt;/a&gt; &lt;span class=&quot;copy-path&quot; data-clipboard-text=&quot;原文: &lt;%= post.permalink %&gt; 作者: &lt;%=theme.author%&gt;&quot; title=&quot;点击复制文章链接&quot;&gt;&lt;i class=&quot;fa fa-clipboard&quot;&gt;&lt;/i&gt;&lt;/span&gt; &lt;script src=&quot;/js/clipboard.min.js&quot;&gt;&lt;/script&gt; &lt;script&gt; var clipboard = new Clipboard(&apos;.copy-path&apos;); &lt;/script&gt; &lt;/p&gt; &lt;p&gt; &lt;span&gt;许可协议:&lt;/span&gt;&lt;i class=&quot;fa fa-creative-commons&quot;&gt;&lt;/i&gt; &lt;a rel=&quot;license&quot; href=&quot;http://creativecommons.org/licenses/by-nc-sa/3.0/cn/&quot; title=&quot;中国大陆 (CC BY-NC-SA 3.0 CN)&quot;&gt;&quot;署名-非商用-相同方式共享 3.0&quot;&lt;/a&gt; 转载请保留原文链接及作者。 &lt;/p&gt; &lt;/div&gt;&lt;% &#125; %&gt;&lt;% if (post.prev || post.next)&#123; %&gt;&lt;nav id=&quot;article-nav&quot;&gt; &lt;% if (post.prev)&#123; %&gt; &lt;a href=&quot;&lt;%- url_for(post.prev.path) %&gt;&quot; id=&quot;article-nav-newer&quot; class=&quot;article-nav-link-wrap&quot;&gt; &lt;strong class=&quot;article-nav-caption&quot;&gt;&lt;&lt;/strong&gt; &lt;div class=&quot;article-nav-title&quot;&gt; &lt;% if (post.prev.title)&#123; %&gt; &lt;%= post.prev.title %&gt; &lt;% &#125; else &#123; %&gt; (no title) &lt;% &#125; %&gt; &lt;/div&gt; &lt;/a&gt; &lt;% &#125; %&gt; &lt;% if (post.next)&#123; %&gt; &lt;a href=&quot;&lt;%- url_for(post.next.path) %&gt;&quot; id=&quot;article-nav-older&quot; class=&quot;article-nav-link-wrap&quot;&gt; &lt;div class=&quot;article-nav-title&quot;&gt;&lt;%= post.next.title %&gt;&lt;/div&gt; &lt;strong class=&quot;article-nav-caption&quot;&gt;&gt;&lt;/strong&gt; &lt;/a&gt; &lt;% &#125; %&gt;&lt;/nav&gt;&lt;% &#125; %&gt; 修改样式12345678910111213141516171819202122232425262728293031323334353637383940\\themes\\spfk\\source\\css\\_partial\\article.styl/* copyright */.copyright &#123; width: 85%; max-width: 45em; margin: 0 auto; padding: .5em 1.8em; border: 1px solid lightgray; font-size: .93em; line-height: 1.6em; word-break: break-word; background: rgba(255, 255, 255, .4); span &#123; margin-right: 1em; color: #B5B5B5; font-weight: bold; &#125; a &#123; color: gray; &amp;:hover &#123; font-weight: bold; color: #a3d2a3; text-decoration: underline; &#125; &#125; &amp;:hover p .copy-path::after &#123; content: &quot;复制&quot;; &#125; .post-url:hover &#123; font-weight: normal; &#125; .copy-path &#123; margin-left: 1em; &amp;:hover &#123; color: gray; cursor: pointer; &#125; &#125;&#125; 社交账号图标修改 添加代码 123456789\\themes\\spfk\\layout\\_partial\\left-col.ejs&lt;nav class=&quot;header-nav&quot;&gt; &lt;div class=&quot;social&quot;&gt; &lt;% for (var i in theme.subnav)&#123; %&gt; &lt;a class=&quot;fl &lt;%= i %&gt;&quot; target=&quot;_blank&quot; href=&quot;&lt;%- url_for(theme.subnav[i]) %&gt;&quot; title=&quot;&lt;%= i %&gt;&quot;&gt;&lt;%= i %&gt;&lt;/a&gt; &lt;%&#125;%&gt; &lt;/div&gt;&lt;/nav&gt; 修改样式 站内搜索框 添加代码用ajax+json搜索 完美解决Hexo静态博客搜索问题 站点Swiftype搜索框 添加代码 12345678910111213141516171819202122232425\\themes\\spfk\\layout\\_partial\\left-col.ejs&lt;form&gt; &lt;input type=&quot;text&quot; class=&quot;st-default-search-input search&quot; id=&quot;search&quot; placeholder=&quot; Search...&quot; autocomplete=&quot;off&quot; autocorrect=&quot;off&quot; autocapitalize=&quot;off&quot;&gt;&lt;/form&gt;D:\\Hexo\\Hexo\\themes\\spfk\\layout\\_partial\\after-footer.ejs&lt;script type=&quot;text/javascript&quot;&gt; window.onload = function()&#123; document.getElementById(&quot;search&quot;).onclick = function()&#123; console.log(&quot;search&quot;) search(); &#125; &#125; function search()&#123; (function(w,d,t,u,n,s,e)&#123;w[&apos;SwiftypeObject&apos;]=n;w[n]=w[n]||function()&#123; (w[n].q=w[n].q||[]).push(arguments);&#125;;s=d.createElement(t); e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e); &#125;)(window,document,&apos;script&apos;,&apos;//s.swiftypecdn.com/install/v2/st.js&apos;,&apos;_st&apos;); _st(&apos;install&apos;,&apos;A1Pz-LKMXbrzcFg2FWi6&apos;,&apos;2.0.0&apos;); &#125;&lt;/script&gt; 修改样式1234567891011121314151617181920212223242526272829303132333435363738394041.search &#123; width: 68%; height: 18px; margin-top: 1px; padding: 0; font-family: inherit; border: 2px solid transparent; border-bottom: 2px solid lightgray; border-radius: 2px; opacity: .7; background: none; &amp;:hover &#123; border: 0px solid lightgray; opacity: 1; box-shadow: 0 0 10px rgba(0, 0, 0, 0.3); &#125;;&#125;display: inline-block; width: 190px; height: 16px; padding: 7px 11px 7px 28px; border: 1px solid #bbb; border: 1px solid rgba(0,0,0,0.25); font-weight: 400; color: #444; font-size: 14px; line-height: 16px; box-sizing: content-box; background: #fff 8px 8px no-repeat url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6%2BR8AAAACXB…Hx4Taq1nrnKaW8K6XUUsrHWuvNevdRRLzFGwzvDbXAB9cDAHvhedDruuxSAAAAAElFTkSuQmCC); background-clip: padding-box; -webkit-border-radius: 5px; -moz-border-radius: 5px; -ms-border-radius: 5px; -o-border-radius: 5px; border-radius: 5px; -webkit-box-shadow: none; -moz-box-shadow: none; box-shadow: none; font-family: &quot;Helvetica Neue&quot;,Helvetica,Arial,&quot;Lucida Grande&quot;,sans-serif; RSS不显示123456789 安装RSS插件$ npm install hexo-generator-feed --save 开启RSS功能 编辑hexo/themes_config.yml，添加如下代码： rss: /atom.xml #rss地址 默认即可 sitemap网站地图12345678910111213141516171819202122232425262728293031323334353637381、安装插件：$ npm install hexo-generator-sitemap --save$ npm install hexo-generator-baidu-sitemap --save2、在博客目录的hexo/_config.yml中添加如下代码：# 自动生成sitemap编辑sitemap:path: sitemap.xmlbaidusitemap:path: baidusitemap.xml3、hexo编译的时候会自动在根目录生成站点地图 UUhike@UUhike-pc MINGW64 /d/Hexo/Hexo (master) $ npm install hexo-generator-sitemap --save npm WARN install Couldn&apos;t install optional dependency: Unsupported npm WARN install Couldn&apos;t install optional dependency: Unsupported hexo-site@0.0.0 D:\\Hexo\\Hexo └── hexo-generator-sitemap@1.0.1 UUhike@UUhike-pc MINGW64 /d/Hexo/Hexo (master) $ npm install hexo-generator-baidu-sitemap --save npm WARN install Couldn&apos;t install optional dependency: Unsupported npm WARN install Couldn&apos;t install optional dependency: Unsupported hexo-site@0.0.0 D:\\Hexo\\Hexo └── hexo-generator-baidu-sitemap@0.1.2 UUhike@UUhike-pc MINGW64 /d/Hexo/Hexo (master) $ hexo g INFO Files loaded in 2.42 s INFO Generated: baidusitemap.xml INFO Generated: sitemap.xml INFO 2 files generated in 477 ms 多说评论插件 添加代码 123456789101112131415161718192021222324252627282930313233343536373839 ├── spfk ├── _config.yml #主题配置文件 #是否开启多说评论，填写你在多说申请的项目名称 duoshuo: duoshuo-key（http://duoshuo-key.duoshuo.com/） #若使用disqus，请在博客config文件中填写disqus_shortname，并关闭多说评论 duoshuo: true复制到 themes\\landscape\\layout\\_partial\\article.ejs把&lt;% if (!index &amp;&amp; post.comments &amp;&amp; config.disqus_shortname)&#123; %&gt;&lt;section id=&quot;comments&quot;&gt;&lt;div id=&quot;disqus_thread&quot;&gt;&lt;noscript&gt;Please enable JavaScript to view the &lt;a href=&quot;//disqus.com/?ref_noscript&quot;&gt;comments powered by Disqus.&lt;/a&gt;&lt;/noscript&gt;&lt;/div&gt;&lt;/section&gt;&lt;% &#125; %&gt;改为&lt;% if (!index &amp;&amp; post.comments &amp;&amp; config.disqus_shortname)&#123; %&gt;&lt;section id=&quot;comments&quot;&gt;&lt;!-- 多说评论框 start --&gt;&lt;div class=&quot;ds-thread&quot; data-thread-key=&quot;&lt;%= post.layout %&gt;-&lt;%= post.slug %&gt;&quot; data-title=&quot;&lt;%= post.title %&gt;&quot; data-url=&quot;&lt;%= page.permalink %&gt;&quot;&gt;&lt;/div&gt;&lt;!-- 多说评论框 end --&gt;&lt;!-- 多说公共JS代码 start (一个网页只需插入一次) --&gt;&lt;script type=&quot;text/javascript&quot;&gt;var duoshuoQuery = &#123;short_name:&apos;&lt;%= config.disqus_shortname %&gt;&apos;&#125;; (function() &#123; var ds = document.createElement(&apos;script&apos;); ds.type = &apos;text/javascript&apos;;ds.async = true; ds.src = (document.location.protocol == &apos;https:&apos; ? &apos;https:&apos; : &apos;http:&apos;) + &apos;//static.duoshuo.com/embed.js&apos;; ds.charset = &apos;UTF-8&apos;; (document.getElementsByTagName(&apos;head&apos;)[0] || document.getElementsByTagName(&apos;body&apos;)[0]).appendChild(ds); &#125;)(); &lt;/script&gt;&lt;!-- 多说公共JS代码 end --&gt;&lt;/section&gt;&lt;% &#125; %&gt; 修改样式：V说：设计达人：设计达人： 添加方法：添加方法：打开「后台」 &gt; 「多说评论」 &gt; 「设置」 &gt; 「基本设置」 &gt; 然后把样式粘贴到「自定义CSS」文本框 &gt; 「保存」 个性样式： 1#ds-thread #ds-reset ul.ds-comments-tabs li.ds-tab a.ds-current&#123;border:0;color:#848568;text-shadow:none;background:#dddfc2&#125;#ds-thread #ds-reset .ds-highlight&#123;font-family:Arial,Helvetica,sans-serif;font-size:14px;font-weight:700;color:#848568!important&#125;#ds-thread #ds-reset ul.ds-comments-tabs li.ds-tab a.ds-current:hover&#123;color:#696a52;background:#d4d6ba&#125;#ds-thread #ds-reset a.ds-highlight:hover&#123;color:#696a52!important&#125;#ds-thread&#123;padding-left:30px&#125;#ds-thread #ds-reset #ds-hot-posts,#ds-thread #ds-reset li.ds-post&#123;overflow:visible&#125;#ds-thread #ds-reset .ds-post-self&#123;padding:10px 0 10px 10px&#125;#ds-thread #ds-reset .ds-post-self,#ds-thread #ds-reset li.ds-post&#123;border:0!important&#125;#ds-reset .ds-avatar,#ds-thread #ds-reset ul.ds-children .ds-avatar&#123;position:absolute;top:26px;left:-14px;padding:5px;width:36px;height:36px;box-shadow:-1px 0 1px rgba(0,0,0,.15) inset;border-radius:46px;background:#E5E6D0&#125;#ds-thread #ds-reset ul.ds-children .ds-avatar&#123;left:-23px&#125;#ds-thread .ds-avatar a&#123;display:inline-block;padding:1px;width:32px;height:32px;border:1px solid #b9baa6;border-radius:50%;background-color:#fff!important&#125;#ds-thread .ds-avatar a:hover&#123;border-color:#de5a4e&#125;#ds-thread .ds-avatar&gt;img&#123;margin:2px 0 0 2px&#125;#ds-thread #ds-reset .ds-replybox&#123;box-shadow:none&#125;#ds-reset .ds-replybox.ds-inline-replybox a.ds-avatar,#ds-thread #ds-reset ul.ds-children .ds-replybox.ds-inline-replybox a.ds-avatar&#123;left:0;top:0;padding:0;width:32px!important;height:32px!important;background:0 0;box-shadow:none&#125;#ds-reset .ds-replybox.ds-inline-replybox a.ds-avatar img&#123;width:32px!important;height:32px!important;border-radius:50%&#125;#ds-reset .ds-replybox .ds-avatar img,#ds-reset .ds-replybox a.ds-avatar&#123;padding:0;width:50px!important;height:50px!important;border-radius:5px&#125;#ds-reset .ds-avatar img&#123;width:32px!important;height:32px!important;border-radius:32px;box-shadow:0 1px 3px rgba(0,0,0,.22);-webkit-transition:.4s all ease-in-out;-moz-transition:.4s all ease-in-out;-o-transition:.4s all ease-in-out;-ms-transition:.4s all ease-in-out;transition:.4s all ease-in-out&#125;.ds-post-self:hover .ds-avatar img&#123;-webkit-transform:rotate(360deg);-moz-transform:rotate(360deg);-o-transform:rotate(360deg);-ms-transform:rotate(360deg);transform:rotate(360deg)&#125;#ds-thread #ds-reset .ds-comment-body&#123;background:#F0F0E3;padding:15px 15px 12px 32px;border-radius:5px;box-shadow:0 1px 2px rgba(0,0,0,.15),0 1px 0 rgba(255,255,255,.75) inset&#125;#ds-thread #ds-reset .ds-comment-body p&#123;color:#787968&#125;#ds-thread #ds-reset .ds-comments a.ds-user-name&#123;font-weight:700;color:#696A52!important&#125;#ds-thread #ds-reset .ds-comments a.ds-user-name:hover&#123;color:#D32!important&#125;#ds-thread #ds-reset #ds-hot-posts&#123;border:0&#125;#ds-reset #ds-hot-posts .ds-gradient-bg&#123;background:0 0&#125;#ds-reset #ds-bubble #ds-ctx .ds-ctx-entry&#123;padding:0&#125;#ds-reset #ds-bubble #ds-ctx-bubble .ds-avatar a,#ds-reset #ds-bubble .ds-avatar&#123;position:static;padding:0;border:0;background:0 0;box-shadow:none&#125;#ds-reset #ds-bubble #ds-ctx-bubble .ds-avatar a,#ds-reset #ds-bubble .ds-avatar img&#123;width:45px!important;height:45px!important&#125;#ds-reset #ds-bubble .ds-user-name&#123;padding-left:13px&#125;#ds-reset .ds-comment-body #ds-ctx&#123;border-left:1px solid #b9baa6;background-color:#e8e8dc!important&#125;#ds-reset #ds-ctx&#123;margin-right:-15px&#125;#ds-reset #ds-ctx .ds-ctx-entry&#123;position:relative;padding:10px 30px 10px 10px&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-avatar&#123;top:6px;left:5px;background:0 0;box-shadow:none&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-body&#123;margin-left:46px&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-content&#123;color:#787968&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a&#123;color:#696A52;font-weight:700&#125; 个性样式： 1#ds-reset .ds-avatar img,#ds-reset .ds-avatar img:hover&#123;-webkit-animation-fill-mode:both;-moz-animation-fill-mode:both;-ms-animation-fill-mode:both;-o-animation-fill-mode:both;animation-fill-mode:both;-webkit-animation-duration:0s;-moz-animation-duration:0s;-ms-animation-duration:0s;-o-animation-duration:0s;animation-duration:0s;-webkit-animation-duration:.7s;-moz-animation-duration:.7s;-ms-animation-duration:.7s;-o-animation-duration:.7s;animation-duration:.7s&#125;@-webkit-keyframes wobble&#123;0%&#123;-webkit-transform:translateX(0)&#125;15%&#123;-webkit-transform:translateX(-25%) rotate(-5deg)&#125;30%&#123;-webkit-transform:translateX(20%) rotate(3deg)&#125;45%&#123;-webkit-transform:translateX(-15%) rotate(-3deg)&#125;60%&#123;-webkit-transform:translateX(10%) rotate(2deg)&#125;75%&#123;-webkit-transform:translateX(-5%) rotate(-1deg)&#125;100%&#123;-webkit-transform:translateX(0)&#125;&#125;@-moz-keyframes wobble&#123;0%&#123;-moz-transform:translateX(0)&#125;15%&#123;-moz-transform:translateX(-25%) rotate(-5deg)&#125;30%&#123;-moz-transform:translateX(20%) rotate(3deg)&#125;45%&#123;-moz-transform:translateX(-15%) rotate(-3deg)&#125;60%&#123;-moz-transform:translateX(10%) rotate(2deg)&#125;75%&#123;-moz-transform:translateX(-5%) rotate(-1deg)&#125;100%&#123;-moz-transform:translateX(0)&#125;&#125;@-o-keyframes wobble&#123;0%&#123;-o-transform:translateX(0)&#125;15%&#123;-o-transform:translateX(-25%) rotate(-5deg)&#125;30%&#123;-o-transform:translateX(20%) rotate(3deg)&#125;45%&#123;-o-transform:translateX(-15%) rotate(-3deg)&#125;60%&#123;-o-transform:translateX(10%) rotate(2deg)&#125;75%&#123;-o-transform:translateX(-5%) rotate(-1deg)&#125;100%&#123;-o-transform:translateX(0)&#125;&#125;@keyframes wobble&#123;0%&#123;transform:translateX(0)&#125;15%&#123;transform:translateX(-25%) rotate(-5deg)&#125;30%&#123;transform:translateX(20%) rotate(3deg)&#125;45%&#123;transform:translateX(-15%) rotate(-3deg)&#125;60%&#123;transform:translateX(10%) rotate(2deg)&#125;75%&#123;transform:translateX(-5%) rotate(-1deg)&#125;100%&#123;transform:translateX(0)&#125;&#125;#ds-reset .ds-avatar img:hover&#123;-webkit-animation-name:wobble;-moz-animation-name:wobble;-o-animation-name:wobble;animation-name:wobble&#125; 个性样式： 1#ds-ssr&#123;display:none !important&#125;#ds-reset&#123;font-weight:normal;font-size:13px;font-size-adjust:none;color:#333;line-height:1;text-align:left&#125;#ds-reset *&#123;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box&#125;#ds-reset input[type=button],#ds-reset input[type=submit],#ds-reset input[type=reset],#ds-reset button&#123;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box&#125;#ds-reset div,#ds-reset ul,#ds-reset ol,#ds-reset li,#ds-reset ul li,#ds-reset ol li,#ds-reset iframe,#ds-reset h1,#ds-reset h2,#ds-reset h3,#ds-reset h4,#ds-reset h5,#ds-reset h6,#ds-reset p,#ds-reset img,#ds-reset blockquote,#ds-reset a,#ds-reset span,#ds-reset pre,#ds-reset code,#ds-reset strong,#ds-reset sub,#ds-reset sup,#ds-reset fieldset,#ds-reset form,#ds-reset label,#ds-reset input,#ds-reset textarea,#ds-reset select&#123;border:0;padding:0;margin:0;vertical-align:baseline;font:inherit;line-height:inherit;background:none;width:auto;float:none;overflow:visible;transition:none&#125;#ds-reset strong&#123;font-weight:bold&#125;#ds-reset p&#123;text-indent:0;clear:none&#125;#ds-reset span,#ds-reset strong,#ds-reset label,#ds-reset input&#123;display:inline;margin:0&#125;#ds-reset textarea:focus,#ds-reset input:focus&#123;outline:none&#125;#ds-reset ul,#ds-reset ol,#ds-reset ul li,#ds-reset ol li&#123;list-style:none;display:block&#125;#ds-reset input,#ds-reset button&#123;-webkit-border-radius:3px;border-radius:3px&#125;#ds-indicator&#123;display:none;position:fixed;z-index:99999;top:150px;left:0;padding:8px;border-bottom-right-radius:3px;border-top-right-radius:3px;width:16px;height:16px;background:#666 url(&quot;data:image/gif;base64,R0lGODlhEAAQAPQAAGZmZv///2lpadzc3K+vr/r6+ufn5319fZmZmfDw8Le3t8DAwHV1daOjo4eHh9LS0srKygAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAAFUCAgjmRpnqUwFGwhKoRgqq2YFMaRGjWA8AbZiIBbjQQ8AmmFUJEQhQGJhaKOrCksgEla+KIkYvC6SJKQOISoNSYdeIk1ayA8ExTyeR3F749CACH5BAkKAAAALAAAAAAQABAAAAVoICCKR9KMaCoaxeCoqEAkRX3AwMHWxQIIjJSAZWgUEgzBwCBAEQpMwIDwY1FHgwJCtOW2UDWYIDyqNVVkUbYr6CK+o2eUMKgWrqKhj0FrEM8jQQALPFA3MAc8CQSAMA5ZBjgqDQmHIyEAIfkECQoAAAAsAAAAABAAEAAABWAgII4j85Ao2hRIKgrEUBQJLaSHMe8zgQo6Q8sxS7RIhILhBkgumCTZsXkACBC+0cwF2GoLLoFXREDcDlkAojBICRaFLDCOQtQKjmsQSubtDFU/NXcDBHwkaw1cKQ8MiyEAIfkECQoAAAAsAAAAABAAEAAABVIgII5kaZ6AIJQCMRTFQKiDQx4GrBfGa4uCnAEhQuRgPwCBtwK+kCNFgjh6QlFYgGO7baJ2CxIioSDpwqNggWCGDVVGphly3BkOpXDrKfNm/4AhACH5BAkKAAAALAAAAAAQABAAAAVgICCOZGmeqEAMRTEQwskYbV0Yx7kYSIzQhtgoBxCKBDQCIOcoLBimRiFhSABYU5gIgW01pLUBYkRItAYAqrlhYiwKjiWAcDMWY8QjsCf4DewiBzQ2N1AmKlgvgCiMjSQhACH5BAkKAAAALAAAAAAQABAAAAVfICCOZGmeqEgUxUAIpkA0AMKyxkEiSZEIsJqhYAg+boUFSTAkiBiNHks3sg1ILAfBiS10gyqCg0UaFBCkwy3RYKiIYMAC+RAxiQgYsJdAjw5DN2gILzEEZgVcKYuMJiEAOwAAAAAAAAAAAA==&quot;) 8px 8px no-repeat;*background-image:url(&quot;//static.duoshuo.com/images/loading.gif&quot;);*position:absolute;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box&#125;#ds-waiting&#123;cursor:wait;display:block;width:16px;height:11px;padding:0 0 3px 5px;margin:0;background:url(&quot;data:image/gif;base64,R0lGODlhEAALAPQAAP///z2LqeLt8dvp7u7090GNqz2LqV+fuJ/F1IW2ycrf51aatHWswaXJ14i4ys3h6FmctUCMqniuw+vz9eHs8fb5+meku+Tu8vT4+cfd5bbT3tbm7PH2+AAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCwAAACwAAAAAEAALAAAFLSAgjmRpnqSgCuLKAq5AEIM4zDVw03ve27ifDgfkEYe04kDIDC5zrtYKRa2WQgAh+QQJCwAAACwAAAAAEAALAAAFJGBhGAVgnqhpHIeRvsDawqns0qeN5+y967tYLyicBYE7EYkYAgAh+QQJCwAAACwAAAAAEAALAAAFNiAgjothLOOIJAkiGgxjpGKiKMkbz7SN6zIawJcDwIK9W/HISxGBzdHTuBNOmcJVCyoUlk7CEAAh+QQJCwAAACwAAAAAEAALAAAFNSAgjqQIRRFUAo3jNGIkSdHqPI8Tz3V55zuaDacDyIQ+YrBH+hWPzJFzOQQaeavWi7oqnVIhACH5BAkLAAAALAAAAAAQAAsAAAUyICCOZGme1rJY5kRRk7hI0mJSVUXJtF3iOl7tltsBZsNfUegjAY3I5sgFY55KqdX1GgIAIfkECQsAAAAsAAAAABAACwAABTcgII5kaZ4kcV2EqLJipmnZhWGXaOOitm2aXQ4g7P2Ct2ER4AMul00kj5g0Al8tADY2y6C+4FIIACH5BAkLAAAALAAAAAAQAAsAAAUvICCOZGme5ERRk6iy7qpyHCVStA3gNa/7txxwlwv2isSacYUc+l4tADQGQ1mvpBAAIfkECQsAAAAsAAAAABAACwAABS8gII5kaZ7kRFGTqLLuqnIcJVK0DeA1r/u3HHCXC/aKxJpxhRz6Xi0ANAZDWa+kEAA7AAAAAAAAAAAA&quot;) 0 0 no-repeat;*background-image:url(&quot;//static.duoshuo.com/images/waiting.gif&quot;)&#125;#ds-reset .ds-highlight&#123;color:#d32 !important&#125;#ds-reset .ds-rounded&#123;-webkit-border-radius:3px;border-radius:3px&#125;#ds-reset .ds-rounded-top&#123;-webkit-border-top-right-radius:3px;-webkit-border-top-left-radius:3px;border-top-right-radius:3px;border-top-left-radius:3px&#125;#ds-reset .ds-rounded-bottom&#123;border-bottom-left-radius:3px;border-bottom-right-radius:3px;-webkit-border-bottom-left-radius:3px;-webkit-border-bottom-right-radius:3px&#125;#ds-reset .ds-gradient-bg&#123;background:url(&quot;//static.duoshuo.com/images/bg_sprites.png&quot;) 0 -60px repeat-x&#125;#ds-reset .ds-avatar&#123;box-shadow:0 1px 1px rgba(255,255,255,0.75);position:relative;-webkit-border-radius:3px;border-radius:3px;background-color:#fff;float:left&#125;#ds-reset .ds-avatar img&#123;display:block;width:50px;height:50px;max-width:none;box-shadow:0 1px 3px rgba(0,0,0,0.22);-webkit-border-radius:3px;border-radius:3px&#125;#ds-reset .ds-avatar .ds-service-icon&#123;display:block;position:absolute;bottom:-4px;right:-4px&#125;#ds-reset img.ds-smiley&#123;margin:0;padding:0;display:inline;border:none&#125;#ds-reset .ds-icon&#123;vertical-align:middle;display:inline-block;overflow:hidden;background:transparent url(&quot;//static.duoshuo.com/images/sprites.png&quot;) no-repeat;_background-image:url(&quot;//static.duoshuo.com/images/sprites.gif&quot;)&#125;#ds-reset a .ds-icon&#123;opacity:.6;-webkit-transition:opacity .15s linear;-moz-transition:opacity .15s linear;transition:opacity .15s linear&#125;#ds-reset a:hover .ds-icon&#123;opacity:1&#125;#ds-reset .ds-service-list a&#123;vertical-align:middle;padding-right:3px&#125;#ds-reset .ds-service-list li:hover a&#123;color:#333&#125;#ds-reset .ds-service-icon,#ds-reset .ds-service-icon-grey&#123;width:16px !important;height:16px !important;line-height:100px;display:inline-block;background:url(&quot;//static.duoshuo.com/images/service-icons-color.png?v=2&quot;) no-repeat;_background-image:url(&quot;//static.duoshuo.com/images/service-icons-color.gif?v=2&quot;);overflow:hidden&#125;#ds-reset .ds-service-icon-grey&#123;background-image:url(&quot;//static.duoshuo.com/images/service-icons-grey.png&quot;);_background-image:url(&quot;//static.duoshuo.com/images/service-icons-grey.gif&quot;)&#125;#ds-reset .ds-service-link&#123;height:16px !important;line-height:16px;padding-left:20px;display:block;background:url(&quot;//static.duoshuo.com/images/service-icons-color.png?v=2&quot;) no-repeat;_background-image:url(&quot;//static.duoshuo.com/images/service-icons-color.gif?v=2&quot;);overflow:hidden&#125;#ds-reset .ds-weibo&#123;background-position:0 0&#125;#ds-reset .ds-renren&#123;background-position:0 -32px&#125;#ds-reset .ds-qqt&#123;background-position:0 -64px&#125;#ds-reset .ds-kaixin&#123;background-position:0 -80px&#125;#ds-reset .ds-douban&#123;background-position:0 -96px&#125;#ds-reset .ds-qzone&#123;background-position:0 -128px&#125;#ds-reset .ds-duoshuo&#123;background-position:0 -144px&#125;#ds-reset .ds-qq&#123;background-position:0 -192px&#125;#ds-reset .ds-baidu&#123;background-position:0 -208px&#125;#ds-reset .ds-google&#123;background-position:0 -240px&#125;#ds-reset .ds-weixin&#123;background-position:0 -272px&#125;#ds-reset .ds-wechat&#123;background-position:0 -272px&#125;.ds-icons-32 a&#123;display:block;cursor:pointer;width:32px !important;height:32px !important;background:url(&quot;//static.duoshuo.com/images/icons_large.png&quot;) no-repeat !important;overflow:hidden;text-indent:-9999px&#125;.ds-icons-32 a.ds-weibo&#123;background-position:-37px 0 !important&#125;.ds-icons-32 a.ds-qzone&#123;background-position:0 0 !important&#125;.ds-icons-32 a.ds-qqt&#123;background-position:-74px 0 !important&#125;.ds-icons-32 a.ds-renren&#123;background-position:-148px 0 !important&#125;.ds-icons-32 a.ds-kaixin&#123;background-position:-111px 0 !important&#125;.ds-icons-32 a.ds-weixin&#123;background-position:-224px 0 !important&#125;.ds-icons-32 a.ds-wechat&#123;background-position:-224px 0 !important&#125;.ds-icons-32 a.ds-qq&#123;background-position:-488px 0 !important&#125;.ds-icons-32 a.ds-douban&#123;background-position:-186px 0 !important&#125;.ds-icons-32 a.ds-baidu&#123;background-position:-262px 0 !important&#125;#ds-reset #ds-ctx&#123;padding:0;margin:8px 0;max-width:640px&#125;#ds-reset #ds-ctx .ds-ctx-entry&#123;padding:6px;margin:0;border-bottom:1px solid #e6e6e6&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a&#123;color:#e77064&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a:hover&#123;color:#d32&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-avatar&#123;margin:0;width:30px;height:30px&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-avatar img&#123;width:30px;height:30px;box-shadow:none&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-body&#123;margin-left:38px&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head&#123;position:relative;_zoom:1;line-height:1em;padding:1px 0 0;margin:0 0 .25em&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-nth&#123;color:#999;font-size:12px;position:absolute;top:2px;right:0&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-time&#123;font-size:12px;*font-size:12px;margin-left:8px;color:#999;_zoom:1&#125;#ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-content&#123;position:relative;_zoom:1;padding:0;margin:0;overflow:hidden;line-height:1.5em&#125;#ds-reset #ds-ctx .ds-ctx-entry:hover .ds-comment-actions&#123;display:block&#125;#ds-reset #ds-ctx .ds-comment-actions&#123;bottom:0;right:0;line-height:18px;position:absolute;display:none;*display:block&#125;#ds-reset #ds-ctx .ds-comment-actions a&#123;margin:0 0 0 6px&#125;#ds-reset.ds-touch #ds-ctx .ds-ctx-entry .ds-comment-actions&#123;display:block&#125;#ds-reset .ds-comment-body #ds-ctx&#123;border-left:3px solid #ccc;background-color:rgba(0,0,0,0.03)&#125;#ds-reset.ds-no-opacity .ds-comment-body #ds-ctx&#123;background:#f8f8f8&#125;#ds-reset .ds-dialog-body #ds-ctx .ds-ctx-entry:hover .ds-comment-actions&#123;display:none&#125;#ds-thread&#123;clear:both;position:relative;overflow:visible;_zoom:1&#125;#ds-thread #ds-reset a&#123;cursor:pointer;text-decoration:none;color:#777;background-color:transparent;-webkit-transition:color .15s linear;-moz-transition:color .15s linear;transition:color .15s linear&#125;#ds-thread #ds-reset a:hover&#123;color:#333&#125;#ds-thread #ds-reset ul,#ds-thread #ds-reset ul li&#123;background:none;margin:0;padding:0&#125;#ds-thread #ds-reset .ds-arrow&#123;position:absolute;width:0;height:0;font-size:0 !important;line-height:0 !important;_border-right-color:#ffc0cb !important;_border-left-color:#ffc0cb !important;_filter:chroma(color=#ffc0cb) !important&#125;#ds-thread #ds-reset .ds-arrow-down&#123;border-left:5px solid transparent;border-right:5px solid transparent;border-top:5px solid #fff&#125;#ds-thread #ds-reset button&#123;cursor:pointer;margin:0;padding:0;border-radius:0&#125;#ds-thread #ds-reset .ds-meta&#123;position:relative;padding:8px 0;line-height:24px;border-bottom:1px solid rgba(0,0,0,0.13)&#125;#ds-thread #ds-reset .ds-like-tooltip&#123;position:absolute;z-index:9999;background-color:#fcfcfc;background-repeat:repeat-x;background-image:-khtml-gradient(linear, left top, left bottom, from(#fcfcfc), to(#f9f9f9));background:-moz-linear-gradient(top, #fcfcfc 0, #f9f9f9 100%);background:-webkit-gradient(linear, left top, left bottom, color-stop(0, #fcfcfc), color-stop(100%, #f9f9f9));background:-webkit-linear-gradient(top, #fcfcfc 0, #f9f9f9 100%);background:-ms-linear-gradient(top, #fcfcfc 0, #f9f9f9 100%);background:linear-gradient(top, #fcfcfc 0, #f9f9f9 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=&apos;#fcfcfc&apos;,endColorstr=&apos;#f9f9f9&apos;,GradientType=0);border:1px solid #aaa;box-shadow:0 0 2px rgba(0,0,0,0.2);text-shadow:0 1px 0 #fff;font-size:12px;padding:8px 14px&#125;#ds-thread #ds-reset .ds-like-tooltip ul&#123;width:84px;float:left&#125;#ds-thread #ds-reset .ds-like-tooltip li&#123;line-height:16px;margin:6px 0&#125;#ds-thread #ds-reset .ds-like-tooltip p&#123;clear:both;margin:6px 0&#125;#ds-thread #ds-reset .ds-like-tooltip .ds-like-tooltip-footer&#123;text-align:right&#125;#ds-thread #ds-reset a.ds-like-thread-button&#123;color:#555;padding:4px 8px;border:1px solid #ccc;border-bottom-color:#aaa;box-shadow:inset 0 0 1px #fff;margin-right:15px;text-shadow:0 1px 0 #fff;background-color:#e0e0e0;background-repeat:no-repeat;background-image:-webkit-gradient(linear, 0 0, 0 100%, from(#fff), color-stop(25%, #fff), to(#e0e0e0));background-image:-webkit-linear-gradient(#fff, #fff 25%, #e0e0e0);background-image:-moz-linear-gradient(top, #fff, #fff 25%, #e0e0e0);background-image:-ms-linear-gradient(#fff, #fff 25%, #e0e0e0);background-image:linear-gradient(#fff, #fff 25%, #e0e0e0)&#125;#ds-thread #ds-reset a.ds-like-thread-button .ds-icon-heart&#123;position:relative;top:-2px;opacity:1&#125;#ds-thread #ds-reset a.ds-like-thread-button span&#123;color:#555&#125;#ds-thread #ds-reset .ds-thread-cancel-like&#123;display:none&#125;#ds-thread #ds-reset a.ds-thread-liked&#123;background:#e9e9e9&#125;#ds-thread #ds-reset a.ds-thread-liked:hover .ds-thread-cancel-like&#123;display:inline&#125;#ds-thread #ds-reset a.ds-thread-liked:hover .ds-thread-like-text&#123;display:none&#125;#ds-thread #ds-reset #ds-hot-posts&#123;border:1px solid #ccc;overflow:hidden;margin:8px 0;padding:0;_height:100%&#125;#ds-thread #ds-reset .ds-header&#123;font-weight:bold;font-size:14px;color:#555;line-height:30px;padding:0 12px&#125;#ds-thread #ds-reset .ds-toolbar&#123;position:relative;z-index:5;font-size:12px;padding:8px 0;width:100%;clear:both&#125;#ds-thread #ds-reset .ds-toolbar:after&#123;content:&quot;.&quot;;display:block;height:0;clear:both;visibility:hidden&#125;#ds-thread #ds-reset .ds-visitor&#123;float:right;line-height:1.5em;margin-right:6px&#125;#ds-thread #ds-reset .ds-account-control&#123;float:right;position:relative;font-size:12px;cursor:pointer;text-align:right;line-height:18px;padding-bottom:3px;width:75px&#125;#ds-thread #ds-reset .ds-account-control span&#123;display:block;float:left;color:#999&#125;#ds-thread #ds-reset .ds-account-control ul&#123;display:none;position:absolute;top:19px;left:0;border:1px solid #aaa;background:#f8f8f8;box-shadow:inset 0 1px 1px #fff,0 1px 1px rgba(0,0,0,0.3);border-radius:3px;text-align:center&#125;#ds-thread #ds-reset .ds-account-control ul li a&#123;border-top:1px solid #fff;border-bottom:1px solid #ddd;display:block;padding:3px 10px;text-shadow:0 1px 0 #fff&#125;#ds-thread #ds-reset .ds-account-control ul li a:hover&#123;color:#555&#125;#ds-thread #ds-reset .ds-account-control.ds-active span&#123;color:#555&#125;#ds-thread #ds-reset .ds-account-control.ds-active ul&#123;display:block&#125;#ds-thread #ds-reset .ds-alert&#123;margin:.5em 0;border:1px solid #fbeed5;border-radius:3px;padding:6px 6px;color:#c09853;background-color:#fcf8e3;line-height:1.5em&#125;#ds-thread #ds-reset .ds-login-buttons&#123;width:100%;position:relative;padding:10px 0 6px&#125;#ds-thread #ds-reset .ds-login-buttons p&#123;float:left;line-height:24px;margin:0&#125;#ds-thread #ds-reset .ds-login-buttons .ds-service-list li&#123;float:left;height:16px;width:54px;padding:4px 0;margin:0 0 0 6px&#125;#ds-thread #ds-reset .ds-login-buttons .ds-more-services&#123;color:#d32 !important;line-height:16px;display:block&#125;#ds-thread #ds-reset .ds-login-buttons .ds-more-services:hover&#123;color:#e77064 !important&#125;#ds-thread #ds-reset .ds-login-buttons .ds-additional-services&#123;display:none&#125;#ds-thread #ds-reset .ds-login-buttons .ds-social-links&#123;float:left;width:306px&#125;#ds-thread #ds-reset .ds-login-buttons:after&#123;content:&quot;.&quot;;display:block;height:0;clear:both;visibility:hidden&#125;#ds-thread #ds-reset a.ds-unread-comments-count&#123;display:none;background-color:#d32;color:#fff !important;margin-right:6px;padding:1px 5px;font-weight:bold;-webkit-border-radius:5px;border-radius:5px;box-shadow:inset 0 1px 1px rgba(255,255,255,0.4),0 1px 1px rgba(0,0,0,0.3);text-shadow:0 1px 1px rgba(0,0,0,0.3)&#125;#ds-thread #ds-reset a.ds-unread-comments-count:hover&#123;background:#f00&#125;#ds-thread #ds-reset .ds-replybox&#123;width:auto;font-size:12px;z-index:3;margin:8px 0;padding:0 0 0 60px;position:relative;_zoom:1&#125;#ds-thread #ds-reset .ds-replybox:after&#123;content:&quot;.&quot;;display:block;height:0;clear:both;visibility:hidden&#125;#ds-thread #ds-reset .ds-replybox .ds-avatar&#123;position:absolute;top:0;left:0&#125;#ds-thread #ds-reset .ds-replybox .ds-avatar img&#123;width:50px;height:50px;visibility:visible;margin:0&#125;#ds-thread #ds-reset .ds-inline-replybox&#123;margin:8px 0 2px 0;padding-left:38px&#125;#ds-thread #ds-reset .ds-inline-replybox .ds-avatar img&#123;width:30px;height:30px;box-shadow:0 1px 2px rgba(0,0,0,0.22)&#125;#ds-thread #ds-reset .ds-textarea-wrapper&#123;position:relative;border:1px solid #ccc;border-bottom:none;padding-right:20px;background:#fff url(&quot;//static.duoshuo.com/images/bg_sprites.png&quot;) 0 -90px repeat-x;overflow:hidden&#125;#ds-thread #ds-reset .ds-textarea-wrapper textarea&#123;box-shadow:none;-webkit-appearance:none;overflow:auto;padding:10px;height:54px;margin:0;resize:none;color:#999;width:100%&#125;#ds-thread #ds-reset .ds-textarea-wrapper textarea:focus&#123;color:#333&#125;#ds-thread #ds-reset .ds-textarea-wrapper .ds-hidden-text&#123;word-wrap:break-word;visibility:hidden;position:absolute;top:0;left:10px;right:10px&#125;#ds-thread #ds-reset .ds-textarea-wrapper textarea,#ds-thread #ds-reset .ds-textarea-wrapper .ds-hidden-text&#123;display:block;font-family:&quot;Helvetica Neue&quot;,Helvetica,Arial,sans-serif;font-size:13px;line-height:20px;border:none&#125;#ds-thread #ds-reset .ds-post-toolbar&#123;position:relative;width:100%;box-shadow:0 1px 0 rgba(255,255,255,0.6)&#125;#ds-thread #ds-reset .ds-post-toolbar span,#ds-thread #ds-reset .ds-post-toolbar input,#ds-thread #ds-reset .ds-post-toolbar label,#ds-thread #ds-reset .ds-post-toolbar a&#123;vertical-align:middle;width:auto&#125;#ds-thread #ds-reset .ds-post-options&#123;position:relative;margin-right:100px;height:30px;border:1px solid #ccc;border-right:none;border-bottom-color:#aaa;border-bottom-left-radius:3px;-webkit-border-bottom-left-radius:3px&#125;#ds-thread #ds-reset .ds-toolbar-buttons&#123;position:absolute;top:5px;left:6px&#125;#ds-thread #ds-reset .ds-toolbar-button&#123;display:block;width:19px !important;height:19px;float:left;margin-right:4px;background:transparent url(&quot;//static.duoshuo.com/images/sprites.png&quot;) no-repeat;_background-image:url(&quot;//static.duoshuo.com/images/sprites.gif&quot;);vertical-align:middle;opacity:.6;-webkit-transition:opacity .15s linear;-moz-transition:opacity .15s linear;transition:opacity .15s linear&#125;#ds-thread #ds-reset .ds-toolbar-button:hover&#123;opacity:1&#125;#ds-thread #ds-reset .ds-add-image&#123;background-position:0 -48px&#125;#ds-thread #ds-reset .ds-add-image:hover&#123;background-position:0 -66px&#125;#ds-thread #ds-reset .ds-add-emote&#123;background-position:0 -12px&#125;#ds-thread #ds-reset .ds-add-emote:hover&#123;background-position:0 -30px&#125;#ds-thread #ds-reset .ds-sync&#123;font-size:12px;color:#999;line-height:30px;position:absolute;right:5px&#125;#ds-thread #ds-reset .ds-sync label&#123;color:#777;cursor:pointer;-webkit-transition:color .15s linear;-moz-transition:color .15s linear;transition:color .15s linear&#125;#ds-thread #ds-reset .ds-sync label:hover&#123;color:#555&#125;#ds-thread #ds-reset .ds-sync a.ds-service-icon,#ds-thread #ds-reset .ds-sync a.ds-service-icon-grey&#123;margin:7px 2px 7px 3px&#125;#ds-thread #ds-reset .ds-post-button&#123;font-family:&quot;Helvetica Neue&quot;,Helvetica,Arial,sans-serif;position:absolute;right:0;top:0;height:32px;width:100px;text-align:center;text-shadow:0 1px 0 #fff;color:#555;font-size:14px;font-weight:bold;border:1px solid #ccc;border-bottom-color:#aaa;border-bottom-right-radius:3px;-webkit-border-bottom-right-radius:3px;background-color:#e6e6e6;background-repeat:no-repeat;background-image:-webkit-gradient(linear, 0 0, 0 100%, from(#fcfcfc), color-stop(25%, #fcfcfc), to(#e6e6e6));background-image:-webkit-linear-gradient(#fcfcfc, #fcfcfc 25%, #e6e6e6);background-image:-moz-linear-gradient(top, #fcfcfc, #fcfcfc 25%, #e6e6e6);background-image:-ms-linear-gradient(#fcfcfc, #fcfcfc 25%, #e6e6e6);background-image:linear-gradient(#fcfcfc, #fcfcfc 25%, #e6e6e6);-webkit-transition:all .15s linear;-moz-transition:all .15s linear;transition:all .15s linear;box-shadow:inset 0 0 1px #fff&#125;#ds-thread #ds-reset .ds-post-button:hover&#123;background-position:0 -15px;color:#333&#125;#ds-thread #ds-reset .ds-post-button:active&#123;-webkit-box-shadow:inset 0 2px 4px rgba(0,0,0,0.15),0 1px 2px rgba(0,0,0,0.05);box-shadow:inset 0 2px 4px rgba(0,0,0,0.15),0 1px 2px rgba(0,0,0,0.05)&#125;#ds-thread #ds-reset .ds-comments-info&#123;width:100%;font-size:13px;margin-top:10px;padding:8px 0;line-height:25px;position:relative&#125;#ds-thread #ds-reset .ds-sort&#123;position:absolute;right:0;top:8px&#125;#ds-thread #ds-reset .ds-sort a&#123;color:#999;padding:0 4px;margin:0 2px&#125;#ds-thread #ds-reset .ds-sort a:hover&#123;color:#333&#125;#ds-thread #ds-reset .ds-sort a.ds-current,#ds-thread #ds-reset .ds-sort a:active&#123;color:#d32&#125;#ds-thread #ds-reset ul.ds-comments-tabs .ds-highlight&#123;margin:0 2px 0 0&#125;#ds-thread #ds-reset ul.ds-comments-tabs .ds-service-icon&#123;vertical-align:middle;margin:0 2px 1px 0&#125;#ds-thread #ds-reset li.ds-tab&#123;display:inline;font-size:13px;margin:0 5px 0 0;padding:0&#125;#ds-thread #ds-reset li.ds-tab a&#123;text-shadow:0 1px 0 #fff;padding:3px 5px;display:inline;-webkit-border-radius:5px;border-radius:5px&#125;#ds-thread #ds-reset li.ds-tab a.ds-current&#123;border:1px solid #ccc;background-color:rgba(0,0,0,0.04)&#125;#ds-thread #ds-reset li.ds-tab a:hover&#123;background-color:rgba(0,0,0,0.04)&#125;#ds-thread #ds-reset .ds-comments&#123;width:100%;border-bottom:1px solid rgba(0,0,0,0.13)&#125;#ds-thread #ds-reset .ds-comments:after&#123;content:&quot;.&quot;;display:block;height:0;clear:both;visibility:hidden&#125;#ds-thread #ds-reset li.ds-post&#123;width:100%;overflow:hidden;clear:both;border-top:1px solid rgba(0,0,0,0.13);margin:0;padding:0;list-style:none&#125;#ds-thread #ds-reset li.ds-post-placeholder&#123;text-align:center;color:#999;padding:1em 0&#125;#ds-thread #ds-reset .ds-post-self&#123;position:relative;padding:10px;border-top:1px solid rgba(255,255,255,0.7)&#125;#ds-thread #ds-reset .ds-post-self:after&#123;content:&quot;.&quot;;display:block;height:0;clear:both;visibility:hidden&#125;#ds-thread #ds-reset .ds-post-self:hover .ds-post-delete,#ds-thread #ds-reset .ds-post-self:hover .ds-post-report&#123;display:inline-block&#125;#ds-thread #ds-reset.ds-touch .ds-post-self .ds-post-delete,#ds-thread #ds-reset.ds-touch .ds-post-self .ds-post-report&#123;display:inline-block&#125;#ds-thread #ds-reset .ds-comment-body&#123;padding-left:60px&#125;#ds-thread #ds-reset .ds-comment-body p&#123;font-size:13px;line-height:1.5em;margin:.5em 0;word-wrap:break-word&#125;#ds-thread #ds-reset .ds-comment-body img&#123;max-width:100%;vertical-align:text-bottom;box-shadow:none&#125;#ds-thread #ds-reset .ds-comment-body embed&#123;max-width:100%&#125;#ds-thread #ds-reset .ds-comment-body code&#123;display:block;font-size:12px;font-family:Monaco,Menlo,Consolas,&quot;Courier New&quot;,monospace;padding:8px 12px;background-color:#f0f0f0;margin:8px 0;border-radius:3px;border:1px solid #ddd;color:#666&#125;#ds-thread #ds-reset .ds-comment-body a&#123;color:#777&#125;#ds-thread #ds-reset .ds-comment-body a:hover&#123;color:#555&#125;#ds-thread #ds-reset a.ds-comment-context&#123;position:relative;margin:.5em 0;color:#e77064&#125;#ds-thread #ds-reset a.ds-comment-context:hover&#123;color:#d32&#125;#ds-thread #ds-reset #ds-bubble&#123;position:absolute;background-color:#fff;-webkit-border-radius:5px;border-radius:5px;padding:10px;color:#333;border:1px solid #aaa;box-shadow:0 0 2px rgba(0,0,0,0.2);z-index:9999;font-size:13px&#125;#ds-thread #ds-reset #ds-bubble a&#123;color:#e77064&#125;#ds-thread #ds-reset #ds-bubble a:hover&#123;color:#d32&#125;#ds-thread #ds-reset #ds-bubble p&#123;line-height:18px&#125;#ds-thread #ds-reset #ds-bubble .ds-arrow-border&#123;border-top-color:#aaa;bottom:-6px&#125;#ds-thread #ds-reset #ds-bubble .ds-arrow&#123;left:32px;bottom:-5px&#125;#ds-thread #ds-reset #ds-ctx-bubble&#123;width:300px&#125;#ds-thread #ds-reset #ds-ctx-bubble .ds-bubble-footer&#123;padding:6px 0 0 0;line-height:18px&#125;#ds-thread #ds-reset #ds-user-card&#123;width:276px;min-height:50px&#125;#ds-thread #ds-reset #ds-user-card .ds-avatar&#123;margin-right:10px&#125;#ds-thread #ds-reset #ds-user-card .ds-avatar img&#123;width:50px;height:50px&#125;#ds-thread #ds-reset #ds-user-card .ds-user-name&#123;vertical-align:top;display:inline-block;max-width:8em;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;font-size:14px&#125;#ds-thread #ds-reset #ds-user-card .ds-user-card-meta&#123;margin:14px 0 0 62px&#125;#ds-thread #ds-reset #ds-user-card .ds-user-description&#123;border-top:1px dotted #ddd;margin-top:.5em;color:#aaa&#125;#ds-thread #ds-reset #ds-user-card .ds-service-icon&#123;margin-right:3px&#125;#ds-thread #ds-reset .ds-comment-header&#123;padding-top:1px&#125;#ds-thread #ds-reset .ds-comment-footer&#123;line-height:1.5em&#125;#ds-thread #ds-reset .ds-comment-footer a&#123;margin:0 6px 0 0;padding:0 6px 0 0&#125;#ds-thread #ds-reset .ds-comment-actions a&#123;font-size:12px;color:#999&#125;#ds-thread #ds-reset .ds-comment-actions a .ds-icon&#123;position:relative;top:-1px&#125;#ds-thread #ds-reset .ds-user-name&#123;color:#777;font-size:13px;margin-right:8px&#125;#ds-thread #ds-reset .ds-post-liked .ds-icon-like&#123;background-position:0 -130px&#125;#ds-thread #ds-reset .ds-post-liked a.ds-post-likes&#123;color:#d32&#125;#ds-thread #ds-reset .ds-reply-active&#123;display:block&#125;#ds-thread #ds-reset .ds-reply-active .ds-post-reply&#123;color:#333&#125;#ds-thread #ds-reset .ds-reply-active .ds-post-reply .ds-icon&#123;opacity:1&#125;#ds-thread #ds-reset .ds-post-delete,#ds-thread #ds-reset .ds-post-report&#123;display:none&#125;#ds-thread #ds-reset .ds-icon-heart&#123;width:14px;height:13px;background-position:0 -130px&#125;#ds-thread #ds-reset .ds-icon-settings&#123;width:12px;height:12px;margin:3px 4px 0;opacity:1&#125;#ds-thread #ds-reset .ds-icon-like&#123;width:14px;height:13px;background-position:0 -117px&#125;#ds-thread #ds-reset .ds-icon-share&#123;width:18px;height:13px;background-position:0 -234px&#125;#ds-thread #ds-reset .ds-icon-reply&#123;width:18px;height:13px;background-position:0 -105px&#125;#ds-thread #ds-reset .ds-icon-delete&#123;width:13px;height:13px;background-position:0 -176px&#125;#ds-thread #ds-reset .ds-icon-report&#123;width:12px;height:12px;background-position:0 -189px&#125;#ds-thread #ds-reset .ds-time&#123;font-size:12px;*font-size:12px;margin-right:8px;color:#999;_zoom:1&#125;#ds-thread #ds-reset ul.ds-children&#123;margin-left:38px&#125;#ds-thread #ds-reset ul.ds-children .ds-avatar&#123;width:30px;height:30px&#125;#ds-thread #ds-reset ul.ds-children .ds-avatar img&#123;width:30px;height:30px&#125;#ds-thread #ds-reset ul.ds-children .ds-post-self&#123;padding-left:0&#125;#ds-thread #ds-reset ul.ds-children .ds-comment-body&#123;padding-left:38px&#125;#ds-thread #ds-reset .ds-paginator&#123;border-bottom:1px solid rgba(0,0,0,0.13);text-align:right;padding-bottom:15px;clear:both;line-height:1em&#125;#ds-thread #ds-reset .ds-paginator div.ds-border&#123;border-top:1px solid rgba(255,255,255,0.7);margin-bottom:15px&#125;#ds-thread #ds-reset .ds-paginator a&#123;font-size:12px;margin:0 3px;padding:2px 5px;border:1px solid transparent&#125;#ds-thread #ds-reset .ds-paginator a:hover,#ds-thread #ds-reset .ds-paginator a.ds-current&#123;-webkit-border-radius:3px;border-radius:3px;background-color:rgba(0,0,0,0.03)&#125;#ds-thread #ds-reset .ds-paginator a.ds-current&#123;color:#d32;border:1px solid #ccc&#125;#ds-thread #ds-reset .ds-powered-by&#123;font-size:12px;text-align:right;padding:10px 0&#125;#ds-thread #ds-reset .ds-powered-by a&#123;color:#999;text-decoration:none&#125;#ds-thread #ds-reset .ds-powered-by a:hover&#123;color:#555&#125;#ds-thread #ds-reset.ds-no-transition .ds-post-button,#ds-thread #ds-reset.ds-no-transition .ds-more a&#123;background:url(&quot;//static.duoshuo.com/images/bg_sprites.png&quot;) repeat-x !important&#125;#ds-thread #ds-reset.ds-no-transition .ds-post-button:hover,#ds-thread #ds-reset.ds-no-transition .ds-more a:hover&#123;background-position:0 -30px !important&#125;#ds-thread #ds-reset.ds-no-transition .ds-like-thread-button&#123;background:url(&quot;//static.duoshuo.com/images/bg_sprites.png&quot;) repeat-x&#125;#ds-thread #ds-reset.ds-no-opacity li.ds-post&#123;border-top:1px solid #ddd&#125;#ds-thread #ds-reset.ds-no-opacity .ds-comments,#ds-thread #ds-reset.ds-no-opacity .ds-paginator&#123;border-bottom:1px solid #ddd&#125;#ds-thread #ds-reset.ds-no-opacity .ds-post-self&#123;border-top:none&#125;#ds-thread #ds-reset.ds-no-opacity .ds-tab a.ds-current&#123;background:#f8f8f8&#125;#ds-thread #ds-reset.ds-ie6 .ds-post-report,#ds-thread #ds-reset.ds-ie6 .ds-post-delete&#123;display:inline !important&#125;#ds-thread #ds-reset.ds-ie6 .ds-textarea-wrapper&#123;padding:10px 10px&#125;#ds-thread #ds-reset.ds-ie6 .ds-textarea-wrapper textarea&#123;width:95%;color:#333;padding:0&#125;#ds-thread #ds-reset.ds-ie6 .ds-post&#123;width:100%;float:left&#125;#ds-thread #ds-reset.ds-ie6 .ds-tab a.ds-current&#123;padding-bottom:5px&#125;#ds-thread #ds-reset.ds-ie6 #ds-ctx-bubble .ds-arrow&#123;bottom:-8px&#125;#ds-thread #ds-reset.ds-ie6 #ds-ctx-bubble .ds-arrow-border&#123;bottom:-9px&#125;#ds-thread.ds-narrow #ds-reset .ds-post-self&#123;padding:8px&#125;#ds-thread.ds-narrow #ds-reset .ds-comment-body,#ds-thread.ds-narrow #ds-reset .ds-replybox&#123;padding-left:38px&#125;#ds-thread.ds-narrow #ds-reset .ds-avatar img&#123;width:30px;height:30px&#125;#ds-thread.ds-narrow #ds-reset .ds-post-button&#123;width:70px&#125;#ds-thread.ds-narrow #ds-reset .ds-post-options&#123;margin-right:70px&#125;#ds-smilies-tooltip&#123;border:1px solid #aaa;position:absolute;width:400px;background-color:#fff;z-index:9999;box-shadow:0 0 2px rgba(0,0,0,0.2);text-shadow:0 1px 0 #fff;-webkit-border-radius:3px;border-radius:3px&#125;#ds-smilies-tooltip a&#123;cursor:pointer&#125;#ds-smilies-tooltip ul&#123;list-style-type:none;padding:0;margin:0&#125;#ds-smilies-tooltip ul.ds-smilies-tabs&#123;width:119px;position:absolute;top:0;left:0;height:159px;overflow-y:auto;background:#f8f8f8;border-right:1px solid #ccc;border-top-left-radius:3px;border-bottom-left-radius:3px&#125;#ds-smilies-tooltip ul.ds-smilies-tabs li a&#123;color:#999;padding:6px 10px;display:block;border-bottom:1px solid #ccc;background-color:#fff;background-repeat:repeat-x;background-image:-khtml-gradient(linear, left top, left bottom, from(#fff), to(#e9e9e9));background:-moz-linear-gradient(top, #fff 0, #e9e9e9 100%);background:-webkit-gradient(linear, left top, left bottom, color-stop(0, #fff), color-stop(100%, #e9e9e9));background:-webkit-linear-gradient(top, #fff 0, #e9e9e9 100%);background:-ms-linear-gradient(top, #fff 0, #e9e9e9 100%);background:linear-gradient(top, #fff 0, #e9e9e9 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=&apos;#ffffff&apos;,endColorstr=&apos;#e9e9e9&apos;,GradientType=0);font-size:12px;line-height:1.3em&#125;#ds-smilies-tooltip ul.ds-smilies-tabs li:first-child a&#123;border-top-left-radius:3px&#125;#ds-smilies-tooltip ul.ds-smilies-tabs li a.ds-current&#123;color:#666;background:#e3e3e3;filter:none;box-shadow:inset 0 0 4px rgba(0,0,0,0.1)&#125;#ds-smilies-tooltip .ds-smilies-container&#123;padding:10px 5px;height:140px;margin-left:125px;overflow-y:auto&#125;#ds-smilies-tooltip .ds-smilies-container li&#123;list-style:none;float:left;width:26px;height:26px;text-align:center;cursor:pointer&#125;#ds-smilies-tooltip .ds-smilies-container li img&#123;visibility:visible&#125;#ds-smilies-tooltip .ds-smilies-container li:hover&#123;position:relative;top:-1px&#125;#ds-wrapper&#123;left:0;right:0;top:20%;bottom:0;width:100%;margin:auto;z-index:9999;position:fixed;_position:absolute;text-align:center;color:#777&#125;#ds-wrapper .ds-dialog,#ds-wrapper #ds-reset.ds-dialog&#123;margin:0 auto;text-align:left;_zoom:1;width:480px;max-width:100%&#125;#ds-wrapper #ds-reset.ds-dialog-bind-more .ds-service-list&#123;width:50%&#125;#ds-wrapper #ds-reset a&#123;cursor:pointer;text-decoration:none;color:#777&#125;#ds-wrapper #ds-reset .ds-dialog-inner&#123;width:100%;position:relative;border:1px solid #aaa;background:#fff url(&quot;//static.duoshuo.com/images/bg_sprites.png&quot;) 0 -90px repeat-x;text-shadow:0 1px 0 #fff;box-shadow:inset 0 1px 1px #fff,0 2px 6px rgba(0,0,0,0.4)&#125;#ds-wrapper #ds-reset .ds-dialog-inner .ds-unread-list&#123;max-height:300px;overflow-y:auto&#125;#ds-wrapper #ds-reset .ds-control-group&#123;margin:18px 0;position:relative;padding-right:80px;max-width:166px&#125;#ds-wrapper #ds-reset .ds-control-group input&#123;color:#777;width:100%;font-size:13px;border:1px solid #ccc;padding:4px 80px 6px 6px;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1)&#125;#ds-wrapper #ds-reset .ds-control-group input:focus&#123;border-color:#08b5fb&#125;#ds-wrapper #ds-reset .ds-control-group label&#123;font-size:13px;color:#ccc;letter-spacing:1px;position:absolute;right:0;top:8px&#125;#ds-wrapper #ds-reset tr&#123;height:45px&#125;#ds-wrapper #ds-reset button&#123;cursor:pointer;color:#555;background-color:#e6e6e6;background-repeat:no-repeat;background-image:-webkit-gradient(linear, 0 0, 0 100%, from(#fff), color-stop(25%, #fff), to(#e6e6e6));background-image:-webkit-linear-gradient(#fff, #fff 25%, #e6e6e6);background-image:-moz-linear-gradient(top, #fff, #fff 25%, #e6e6e6);background-image:-ms-linear-gradient(#fff, #fff 25%, #e6e6e6);background-image:linear-gradient(#fff, #fff 25%, #e6e6e6);-webkit-transition:all .15s linear;-moz-transition:all .15s linear;transition:all .15s linear;border:1px solid #aaa;display:inline-block;font-size:15px;height:30px;width:100px;padding:0&#125;#ds-wrapper #ds-reset button:hover&#123;background-position:0 -15px;color:#333&#125;#ds-wrapper #ds-reset button:active&#123;top:0;-webkit-box-shadow:inset 0 2px 4px rgba(0,0,0,0.15),0 1px 2px rgba(0,0,0,0.05);box-shadow:inset 0 2px 4px rgba(0,0,0,0.15),0 1px 2px rgba(0,0,0,0.05)&#125;#ds-wrapper #ds-reset h2&#123;display:block;font-weight:normal;font-size:16px;margin:0 0 15px 0;color:#555&#125;#ds-wrapper #ds-reset .ds-dialog-body&#123;padding:30px 30px 25px;position:relative;overflow:hidden&#125;#ds-wrapper #ds-reset .ds-icons-32&#123;height:32px;margin-bottom:20px;overflow:hidden&#125;#ds-wrapper #ds-reset .ds-icons-32 a&#123;float:left;margin:0 5px 0 0&#125;#ds-wrapper #ds-reset ul li&#123;margin:10px 0&#125;#ds-wrapper #ds-reset .ds-service-list&#123;width:45%;float:left&#125;#ds-wrapper #ds-reset .ds-service-list .ds-more-services&#123;display:none&#125;#ds-wrapper #ds-reset .ds-icon-ok&#123;background-position:0 -203px;width:12px;height:12px&#125;#ds-wrapper #ds-reset .ds-quote&#123;margin:10px 0;padding:6px 10px;background:#f8f8f8;line-height:1.5em;font-size:12px;overflow-y:auto;max-height:180px&#125;#ds-wrapper #ds-reset .ds-textarea-wrapper&#123;border:1px solid #ccc;padding:0 20px 0 0;position:relative;margin:12px 0&#125;#ds-wrapper #ds-reset .ds-textarea-wrapper textarea&#123;width:100%;height:54px;margin:0;resize:none;padding:6px 10px;overflow:auto&#125;#ds-wrapper #ds-reset .ds-textarea-wrapper .ds-hidden-text&#123;top:0;left:10px;right:10px;position:absolute;visibility:hidden;word-wrap:break-word&#125;#ds-wrapper #ds-reset .ds-textarea-wrapper textarea,#ds-wrapper #ds-reset .ds-textarea-wrapper .ds-hidden-text&#123;font-size:13px;line-height:1.5em&#125;#ds-wrapper #ds-reset .ds-actions&#123;position:relative;height:30px&#125;#ds-wrapper #ds-reset .ds-actions button&#123;display:block;position:absolute;top:0;right:0&#125;#ds-wrapper #ds-reset .ds-dialog-close&#123;position:absolute;bottom:13px;right:11px;display:block;width:13px;height:13px;overflow:hidden;background:transparent url(&quot;//static.duoshuo.com/images/sprites.png&quot;) 0 -163px no-repeat;_background-image:url(&quot;//static.duoshuo.com/images/sprites.gif&quot;)&#125;#ds-wrapper #ds-reset .ds-dialog-close:hover&#123;background-position:0 -176px&#125;#ds-wrapper #ds-reset .ds-logo&#123;display:inline-block;width:64px;height:21px;margin-right:10px;background:url(&quot;//static.duoshuo.com/images/logo.png&quot;) 0 0 no-repeat&#125;#ds-wrapper #ds-reset .ds-dialog-footer&#123;clear:both;border-top:1px dotted #ccc;padding:10px 15px 6px&#125;#ds-wrapper #ds-reset .ds-dialog-footer span&#123;color:#999;position:relative;top:-6px&#125;#ds-wrapper #ds-reset .ds-connect&#123;display:none&#125;#ds-wrapper #ds-reset .ds-unread-list li&#123;position:relative;margin:0;padding:8px 0;border-top:1px solid #eee;line-height:1.5em;color:#777&#125;#ds-wrapper #ds-reset .ds-unread-list li a&#123;color:#d32&#125;#ds-wrapper #ds-reset .ds-unread-list li a:hover&#123;color:#e45c4e&#125;#ds-wrapper #ds-reset .ds-unread-list li a[rel~=&quot;author&quot;]&#123;color:#777&#125;#ds-wrapper #ds-reset .ds-unread-list li .ds-delete&#123;display:none;position:absolute;right:0;bottom:10px;text-indent:-9999px;width:14px;height:14px;overflow:hidden;background:transparent url(&quot;//static.duoshuo.com/images/delete.gif&quot;) no-repeat scroll 0 -14px&#125;#ds-wrapper #ds-reset .ds-unread-list li:hover .ds-delete&#123;display:block&#125;#ds-wrapper #ds-reset.ds-touch .ds-unread-list li .ds-delete&#123;display:block&#125;#ds-wrapper.ds-no-transition #ds-reset button&#123;background:url(&quot;//static.duoshuo.com/images/bg_sprites.png&quot;) repeat-x !important&#125;#ds-wrapper.ds-no-transition #ds-reset button:hover&#123;background-position:0 -30px !important&#125;#ds-wrapper.ds-no-transition #ds-reset.ds-dialog&#123;background-image:url(&quot;//static.duoshuo.com/images/black.png&quot;)&#125;#ds-wrapper.ds-ie6 #ds-reset&#123;margin-top:0&#125;#ds-wrapper.ds-ie6 #ds-reset .ds-dialog-footer span&#123;top:-3px&#125;#ds-notify&#123;position:fixed;*position:absolute;z-index:9999;max-width:144px;_width:130px;display:block;float:none;padding:8px 12px;background-color:#fff;-webkit-border-radius:5px;border-radius:5px;box-shadow:0 1px 1px rgba(0,0,0,0.25);border:1px solid #aaa&#125;#ds-notify #ds-reset&#123;line-height:14px&#125;#ds-notify #ds-reset a.ds-logo&#123;width:18px;height:14px;background:transparent url(&quot;//static.duoshuo.com/images/sprites.png&quot;) 0 -220px no-repeat;_background-image:url(&quot;//static.duoshuo.com/images/sprites.gif&quot;);position:absolute;display:block;top:8px;left:12px&#125;#ds-notify #ds-reset span.ds-unread-count&#123;font-weight:bold;color:#e32&#125;#ds-notify #ds-reset ul.ds-notify-unread&#123;line-height:150%;display:inline-block;margin:0 0 0 22px;padding:0&#125;#ds-notify #ds-reset ul.ds-notify-unread li a&#123;color:#d32;text-decoration:none&#125;#ds-recent-comments li.ds-comment&#123;list-style-type:none;position:relative !important;margin:0 !important;padding:6px 0 !important;_zoom:1;border-top:1px solid #dcdcdc;word-wrap:break-word;font-size:13px&#125;#ds-recent-comments li.ds-comment a&#123;display:inline&#125;#ds-recent-comments li.ds-comment div&#123;padding:0;margin:0&#125;#ds-recent-comments li.ds-comment .ds-avatar&#123;position:absolute !important;top:6px !important;left:0 !important&#125;#ds-recent-comments li.ds-comment .ds-avatar a&#123;display:block&#125;#ds-recent-comments li.ds-comment .ds-meta&#123;*margin-left:-15px;_margin-left:0&#125;#ds-recent-comments li.ds-comment .ds-time&#123;font-size:10px;color:#999;margin-left:5px&#125;#ds-recent-comments li.ds-comment .ds-thread-title&#123;margin:0 0 4px 0;line-height:13px;font-size:12px;color:#777&#125;#ds-recent-comments li.ds-comment .ds-thread-title a&#123;font-size:12px&#125;#ds-recent-comments li.ds-comment .ds-excerpt&#123;line-height:18px&#125;#ds-recent-comments li.ds-comment.ds-show-avatars&#123;padding-left:38px !important&#125;#ds-recent-visitors .ds-avatar&#123;display:inline;padding:0 !important;margin:4px !important&#125;#ds-login .ds-icons-32 a&#123;float:left;margin:0 5px 0 0&#125;#ds-share #ds-reset.ds-share-aside-left ul,#ds-share #ds-reset.ds-share-aside-right ul,#ds-share #ds-reset.ds-share-inline ul&#123;list-style:none;margin:0;padding:0;*zoom:1&#125;#ds-share #ds-reset.ds-share-aside-left ul:after,#ds-share #ds-reset.ds-share-aside-right ul:after,#ds-share #ds-reset.ds-share-inline ul:after&#123;content:&quot;.&quot;;display:block;height:0;clear:both;visibility:hidden&#125;#ds-share #ds-reset.ds-share-aside-left ul li,#ds-share #ds-reset.ds-share-aside-right ul li,#ds-share #ds-reset.ds-share-inline ul li&#123;list-style:none;float:left;font-size:14px;padding:7px 0&#125;#ds-share #ds-reset.ds-share-inline&#123;position:relative&#125;#ds-share #ds-reset.ds-share-inline ul li&#123;margin-left:8px&#125;#ds-share #ds-reset.ds-share-inline ul li:first-child&#123;margin-left:0&#125;#ds-share #ds-reset.ds-share-aside-left,#ds-share #ds-reset.ds-share-aside-right&#123;position:fixed;top:50%;z-index:1000;-webkit-transition:all .2s linear;-moz-transition:all .2s linear;transition:all .2s linear&#125;#ds-share #ds-reset.ds-share-aside-left&#123;left:0;-webkit-transform:translate(-100%, -50%);-ms-transform:translate(-100%, -50%);-o-transform:translate(-100%, -50%);transform:translate(-100%, -50%)&#125;#ds-share #ds-reset.ds-share-aside-right&#123;right:0;-webkit-transform:translate(100%, -50%);-ms-transform:translate(100%, -50%);-o-transform:translate(100%, -50%);transform:translate(100%, -50%)&#125;#ds-share #ds-reset .ds-share-aside-toggle&#123;width:28px;padding:23px 2px;background:#e94c4c;color:#fff;position:absolute;top:0;text-align:center;font-size:16px;font-weight:bolder;cursor:pointer&#125;#ds-share #ds-reset.ds-share-aside-left .ds-share-aside-toggle&#123;right:-32px;border-top-right-radius:3px;border-bottom-right-radius:3px&#125;#ds-share #ds-reset.ds-share-aside-left .ds-share-icons&#123;border-top-right-radius:0;border-top-left-radius:0;border-bottom-left-radius:0;border-left:none&#125;#ds-share #ds-reset.ds-share-aside-right .ds-share-aside-toggle&#123;left:-32px;border-top-left-radius:3px;border-bottom-left-radius:3px&#125;#ds-share #ds-reset.ds-share-aside-right .ds-share-icons&#123;border-top-left-radius:0;border-top-right-radius:0;border-bottom-right-radius:0;border-right:none&#125;#ds-share #ds-reset.slide-to-left&#123;-webkit-transform:translate(0, -50%);-ms-transform:translate(0, -50%);-o-transform:translate(0, -50%);transform:translate(0, -50%)&#125;#ds-share #ds-reset.slide-to-right&#123;-webkit-transform:translate(0, -50%);-ms-transform:translate(0, -50%);-o-transform:translate(0, -50%);transform:translate(0, -50%)&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-weibo,#ds-share #ds-reset .ds-share-icons-32 .ds-sohu,#ds-share #ds-reset .ds-share-icons-32 .ds-renren,#ds-share #ds-reset .ds-share-icons-32 .ds-netease,#ds-share #ds-reset .ds-share-icons-32 .ds-qqt,#ds-share #ds-reset .ds-share-icons-32 .ds-kaixin,#ds-share #ds-reset .ds-share-icons-32 .ds-douban,#ds-share #ds-reset .ds-share-icons-32 .ds-msn,#ds-share #ds-reset .ds-share-icons-32 .ds-qzone,#ds-share #ds-reset .ds-share-icons-32 .ds-duoshuo,#ds-share #ds-reset .ds-share-icons-32 .ds-360,#ds-share #ds-reset .ds-share-icons-32 .ds-alipay,#ds-share #ds-reset .ds-share-icons-32 .ds-qq,#ds-share #ds-reset .ds-share-icons-32 .ds-baidu,#ds-share #ds-reset .ds-share-icons-32 .ds-taobao,#ds-share #ds-reset .ds-share-icons-32 .ds-google,#ds-share #ds-reset .ds-share-icons-32 .ds-more,#ds-share #ds-reset .ds-share-icons-32 .ds-wechat,#ds-share #ds-reset .ds-share-icons-32 .ds-diandian,#ds-share #ds-reset .ds-share-icons-32 .ds-huaban,#ds-share #ds-reset .ds-share-icons-32 .ds-duitang,#ds-share #ds-reset .ds-share-icons-32 .ds-youdao,#ds-share #ds-reset .ds-share-icons-32 .ds-pengyou,#ds-share #ds-reset .ds-share-icons-32 .ds-facebook,#ds-share #ds-reset .ds-share-icons-32 .ds-twitter,#ds-share #ds-reset .ds-share-icons-32 .ds-linkedin,#ds-share #ds-reset .ds-share-icons-32 .ds-meilishuo,#ds-share #ds-reset .ds-share-icons-32 .ds-mogujie&#123;height:32px;width:32px;text-decoration:none;color:#999;display:block;overflow:hidden;background-image:url(&quot;//static.duoshuo.com/images/service-icons-color-32.png&quot;);background-repeat:no-repeat;_background-image:url(&quot;//static.duoshuo.com/images/service-icons-color-32.gif&quot;)&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-weibo&#123;background-position:0 0&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-sohu&#123;background-position:0 -32px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-renren&#123;background-position:0 -64px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-netease&#123;background-position:0 -96px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-qqt&#123;background-position:0 -128px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-kaixin&#123;background-position:0 -160px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-douban&#123;background-position:0 -192px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-msn&#123;background-position:0 -224px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-qzone&#123;background-position:0 -256px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-duoshuo&#123;background-position:0 -288px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-360&#123;background-position:0 -320px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-alipay&#123;background-position:0 -352px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-qq&#123;background-position:0 -384px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-baidu&#123;background-position:0 -416px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-taobao&#123;background-position:0 -448px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-google&#123;background-position:0 -480px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-more&#123;background-position:0 -512px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-wechat&#123;background-position:0 -544px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-diandian&#123;background-position:0 -576px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-huaban&#123;background-position:0 -608px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-duitang&#123;background-position:0 -640px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-youdao&#123;background-position:0 -672px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-pengyou&#123;background-position:0 -704px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-facebook&#123;background-position:0 -736px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-twitter&#123;background-position:0 -768px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-linkedin&#123;background-position:0 -800px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-meilishuo&#123;background-position:0 -832px&#125;#ds-share #ds-reset .ds-share-icons-32 .ds-mogujie&#123;background-position:0 -864px&#125;#ds-share #ds-reset .ds-share-icons-32 .flat&#123;background-image:url(&quot;//static.duoshuo.com/images/service-icons-color-flat-32.png&quot;);_background-image:url(&quot;//static.duoshuo.com/images/service-icons-color-flat-32.gif&quot;)&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-weibo,#ds-share #ds-reset .ds-share-icons-16 .ds-sohu,#ds-share #ds-reset .ds-share-icons-16 .ds-renren,#ds-share #ds-reset .ds-share-icons-16 .ds-netease,#ds-share #ds-reset .ds-share-icons-16 .ds-qqt,#ds-share #ds-reset .ds-share-icons-16 .ds-kaixin,#ds-share #ds-reset .ds-share-icons-16 .ds-douban,#ds-share #ds-reset .ds-share-icons-16 .ds-msn,#ds-share #ds-reset .ds-share-icons-16 .ds-qzone,#ds-share #ds-reset .ds-share-icons-16 .ds-duoshuo,#ds-share #ds-reset .ds-share-icons-16 .ds-360,#ds-share #ds-reset .ds-share-icons-16 .ds-alipay,#ds-share #ds-reset .ds-share-icons-16 .ds-qq,#ds-share #ds-reset .ds-share-icons-16 .ds-baidu,#ds-share #ds-reset .ds-share-icons-16 .ds-taobao,#ds-share #ds-reset .ds-share-icons-16 .ds-google,#ds-share #ds-reset .ds-share-icons-16 .ds-more,#ds-share #ds-reset .ds-share-icons-16 .ds-wechat,#ds-share #ds-reset .ds-share-icons-16 .ds-diandian,#ds-share #ds-reset .ds-share-icons-16 .ds-huaban,#ds-share #ds-reset .ds-share-icons-16 .ds-duitang,#ds-share #ds-reset .ds-share-icons-16 .ds-youdao,#ds-share #ds-reset .ds-share-icons-16 .ds-pengyou,#ds-share #ds-reset .ds-share-icons-16 .ds-facebook,#ds-share #ds-reset .ds-share-icons-16 .ds-twitter,#ds-share #ds-reset .ds-share-icons-16 .ds-linkedin,#ds-share #ds-reset .ds-share-icons-16 .ds-meilishuo,#ds-share #ds-reset .ds-share-icons-16 .ds-mogujie&#123;line-height:16px;padding-left:20px;text-decoration:none;color:#999;display:block;overflow:hidden;background-image:url(&quot;//static.duoshuo.com/images/service-icons-color.png?v=2&quot;);background-repeat:no-repeat;_background-image:url(&quot;//static.duoshuo.com/images/service-icons-color.gif?v=2&quot;)&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-weibo&#123;background-position:0 0&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-sohu&#123;background-position:0 -16px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-renren&#123;background-position:0 -32px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-netease&#123;background-position:0 -48px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-qqt&#123;background-position:0 -64px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-kaixin&#123;background-position:0 -80px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-douban&#123;background-position:0 -96px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-msn&#123;background-position:0 -112px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-qzone&#123;background-position:0 -128px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-duoshuo&#123;background-position:0 -144px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-360&#123;background-position:0 -160px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-alipay&#123;background-position:0 -176px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-qq&#123;background-position:0 -192px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-baidu&#123;background-position:0 -208px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-taobao&#123;background-position:0 -224px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-google&#123;background-position:0 -240px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-more&#123;background-position:0 -256px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-wechat&#123;background-position:0 -272px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-diandian&#123;background-position:0 -288px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-huaban&#123;background-position:0 -304px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-duitang&#123;background-position:0 -320px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-youdao&#123;background-position:0 -336px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-pengyou&#123;background-position:0 -352px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-facebook&#123;background-position:0 -368px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-twitter&#123;background-position:0 -384px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-linkedin&#123;background-position:0 -400px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-meilishuo&#123;background-position:0 -416px&#125;#ds-share #ds-reset .ds-share-icons-16 .ds-mogujie&#123;background-position:0 -432px&#125;#ds-share #ds-reset .ds-share-icons-16 .flat&#123;background-image:url(&quot;//static.duoshuo.com/images/service-icons-color-flat.png&quot;);_background-image:url(&quot;//static.duoshuo.com/images/service-icons-color-flat.gif&quot;)&#125;#ds-share #ds-reset .ds-share-icons&#123;border:1px solid #ccc;background:#fff;border-radius:3px&#125;#ds-share #ds-reset .ds-share-icons .ds-share-icons-inner&#123;width:208px;padding:10px&#125;#ds-share #ds-reset .ds-share-icons .ds-share-icons-inner ul&#123;margin:0;padding:0&#125;#ds-share #ds-reset .ds-share-icons .ds-share-icons-inner ul li&#123;padding-left:8px;margin-left:0;width:92px;font-size:12px&#125;#ds-share #ds-reset .ds-share-icons .ds-share-icons-inner ul li:hover&#123;border-radius:3px;background:#eee&#125;#ds-share #ds-reset .ds-share-icons .ds-share-icons-inner ul li:nth-child(even)&#123;margin-left:8px&#125;#ds-share #ds-reset .ds-share-icons .ds-share-icons-footer&#123;text-align:right;line-height:30px;font-size:12px;color:#ccc;background-color:#eee;padding-right:10px&#125;#ds-share #ds-reset .ds-share-icons-more&#123;top:30px;left:0;position:absolute;z-index:1000&#125;#ds-share.ds-no-transition #ds-reset.ds-share-aside-left&#123;left:-229px;transform:none&#125;#ds-share.ds-no-transition #ds-reset.ds-share-aside-right&#123;right:-229px;transform:none&#125;#ds-share .ds-share-aside-left,#ds-share .ds-share-aside-right&#123;width:230px;_position:absolute;_bottom:auto;_top:expression(eval(document.documentElement.scrollTop+200))&#125;#ds-share .ds-share-aside-left&#123;_left:expression(eval(document.documentElement.scrollLeft-230))&#125;#ds-share .ds-share-aside-right&#123;_right:auto;_left:expression(eval(document.documentElement.scrollLeft+document.documentElement.clientWidth-this.offsetWidth)-(parseInt(this.currentStyle.marginLeft,10)||0)-(parseInt(this.currentStyle.marginRight,10)||0 - 230))&#125; 具体样式请参照：多说.css 为Hexo博客添加目录Hexo博客系统的核心支持生成目录（Table of Contents），但其默认的主题Landscape并不支持目录的显示。我们只需对Landscape的主题文件稍作修改并添加一点目录的CSS就可以在文章前面显示友好的目录了。 修改Landscape主题的ejs文件 我们首先要编辑文章显示页面的模板，也就是themes/landscape/layout/_partial/article.ejs文件。为了将目录生成在正文之前，我们首先在这个文件中找到&lt;%- post.content %&gt;，并在这一行之前加入如下代码： 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869 引入文件_partial\\article.ejs &lt;% if (!index &amp;&amp; post.toc != false &amp;&amp; !is_page())&#123; %&gt; &lt;%- partial(&apos;_partial/toc&apos;) %&gt; &lt;% &#125; %&gt; &lt;% if (!index &amp;&amp; post.toc)&#123; %&gt; &lt;%- partial(&apos;post/toc&apos;) %&gt; &lt;% &#125; %&gt;&lt;div id=&quot;toc&quot; class=&quot;toc-article&quot;&gt; &lt;strong class=&quot;toc-title&quot;&gt;文章目录&lt;/strong&gt; &lt;%- toc(post.content) %&gt;&lt;/div&gt;&lt;style&gt; .left-col .switch-btn &#123; display: none; &#125; .left-col .switch-area &#123; display: none; &#125;&lt;/style&gt;&lt;input type=&quot;button&quot; id=&quot;tocButton&quot; value=&quot;隐藏目录&quot; title=&quot;点击按钮隐藏或者显示文章目录&quot;&gt;&lt;%- js(&apos;http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min&apos;) %&gt;&lt;script&gt; var toc_button = document.getElementById(&quot;tocButton&quot;); var toc_div = document.getElementById(&quot;toc&quot;); toc_button.onclick=function() &#123; if (toc_div.style.display == &quot;none&quot;) &#123; toc_div.style.display = &quot;block&quot;; toc_button.value = &quot;隐藏目录&quot;; document.getElementById(&quot;switch-btn&quot;).style.display = &quot;none&quot;; document.getElementById(&quot;switch-area&quot;).style.display = &quot;none&quot;; &#125; else &#123; toc_div.style.display = &quot;none&quot;; toc_button.value = &quot;显示目录&quot;; document.getElementById(&quot;switch-btn&quot;).style.display = &quot;block&quot;; document.getElementById(&quot;switch-area&quot;).style.display = &quot;block&quot;; &#125; &#125; if ($(&quot;.toc&quot;).length &lt; 1) &#123; $(&quot;#toc&quot;).css(&quot;display&quot;,&quot;none&quot;); $(&quot;#tocButton&quot;).css(&quot;display&quot;,&quot;none&quot;); $(&quot;.switch-btn&quot;).css(&quot;display&quot;,&quot;block&quot;); $(&quot;.switch-area&quot;).css(&quot;display&quot;,&quot;block&quot;); &#125;&lt;/script&gt;&lt;% if (theme.toc_nowrap) &#123; %&gt; &lt;style&gt; .toc &#123; white-space: nowrap; overflow-x: hidden; &#125; &lt;/style&gt; &lt;script&gt; $(document).ready(function() &#123; $(&quot;.toc li a&quot;).mouseover(function() &#123; var title = $(this).attr(&apos;href&apos;); $(this).attr(&quot;title&quot;, title); &#125;); &#125;) &lt;/script&gt;&lt;% &#125; %&gt; 这段代码的含义清晰明了，if语句中有两个条件，!index是为了不在首页的文章摘要中生成目录，post.toc确保了只在显式地标记了toc: true的文章中生成目录。若这两个条件满足，则创建一个目录的。 修改完这个文件之后，找一篇包含了多个子标题的文章，并在文章开头的front-matter中添加一句toc: true，在浏览器中访问这篇文章，应该可以看到文章的开头处已经有了带链接的目录。但是这样的目录实在太难看，我们还需要添加相应的CSS来将其指定为我们想要的样式。 为目录编写CSS文件 要指定目录的样式，我们要修改的文件是themes/landscape/source/css/_partial/article.styl。在文件的最后，添加如下代码： 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110/*toc*/#tocButton &#123; position: fixed; border: none; left: 220px; top: 382px; background: none; font-size: .9em; font-weight: bold; color: lightgray; cursor: pointer font-family: inherit; outline: none; /*Remove button border when clicked.*/ -webkit-appearance: none; /*Remove iOS button style*/ &amp;:hover &#123; color: #88acdb; &#125;&#125;.toc-article &#123; position: fixed; width: 230px; top: 378px; bottom: 1em; left: 0; margin-left: 0em; padding: 6px 10px 10px 50px; border-radius: 2.8%; overflow: auto;&#125;#toc &#123; float: right; font-size: .9em; line-height: 1.65em; z-index: 12; a &#123; color: gray; &amp;:visited &#123; color: rgba(244, 131, 133, 1); &#125; &amp;:hover &#123; color: #88acdb; text-decoration: none; &#125; &#125; li:hover &#123; background: none; li:hover &#123; background: rgba(158, 188, 226, .21); &#125; &#125; .toc-title &#123; font-weight: bold; color: gray; &#125; .toc &#123; padding: .7em; padding-right: 0; li &#123; list-style-type: none; &#125; &#125; ol &#123; margin-left: 0; &#125; .toc-child &#123; padding-left: 1.25em; margin: 4px 0; &#125; .toc-link:hover &#123; background: rgba(158, 188, 226, .21); &#125;&#125;.copyright &#123; width: 85%; max-width: 45em; margin: 0 auto; padding: .5em 1.8em; border: 1px solid lightgray; font-size: .93em; line-height: 1.6em; word-break: break-word; background: rgba(255, 255, 255, .4); span &#123; margin-right: 1em; color: #B5B5B5; font-weight: bold; &#125; a &#123; color: gray; &amp;:hover &#123; font-weight: bold; color: #a3d2a3; text-decoration: underline; &#125; &#125; &amp;:hover p .copy-path::after &#123; content: &quot;复制&quot;; &#125; .post-url:hover &#123; font-weight: normal; &#125; .copy-path &#123; margin-left: 1em; &amp;:hover &#123; color: gray; cursor: pointer; &#125; &#125;&#125; 第一段的toc-article指定了目录整个的背景色、边框色、倒角半径、各种间距以及最大的宽度。注意这里最好指定目录的最大宽度，我将其设为了28%，也就是文章正文那个框的宽度的28%，也可以设为一个固定的长度，比如在笔记本电脑上16em就是个不错的宽度，但为了能适配各种不同尺寸的屏幕，最好还是设置为百分比。如果不指定最大宽度，遇到比较长的标题时，生成的目录会非常难看。这个最大宽度的设置是我在网上其他添加目录的方法中没有见到的。 第二段的toc-title指的就是“文章目录”那四个字，这四个字要比其他字大一些，将其字号设为其他字的120%。 第三段的#toc.toc指定了目录列表的一些细节，将font-size设为0.9em会让目录的字比文章的字稍小一些。最后的.toc-child指定了二级目录的缩进量。 再次生成页面，应该已经可以显示比较美观的目录了。 收尾工作 通常情况下我们不需要为每一篇文章都添加目录，因为大部分文章的长度还是相对较短，或者结构简单而没有添加小标题。在我的博客上，需要添加目录的长文还是相对较少的。因为我选择了默认不生成目录，而手动为需要目录的文章添加显式地标记。 下面我就需要编辑每一篇需要添加目录的文章，在文章开头的front-matter中加入toc: true。 插入自定义页面仿照Hexo官网，了解到单页面的添加方式。 添加代码 1234567891011121314151617181920D:\\Hexo\\Hexos\\themes\\spfk\\layout\\plugins.swig&lt;div id=&quot;content-wrap&quot;&gt; &lt;div class=&quot;wrapper&quot;&gt; &lt;div class=&quot;inner&quot;&gt; &lt;header id=&quot;plugin-list-header&quot;&gt; &lt;h1 id=&quot;plugin-list-title&quot;&gt;&#123;&#123; page.title &#125;&#125;&lt;/h1&gt; &lt;input type=&quot;search&quot; id=&quot;plugin-search-input&quot; placeholder=&quot;Search&quot;&gt; &lt;div id=&quot;plugin-list-count&quot;&gt;&#123;&#123; site.data[page.data].length &#125;&#125; items&lt;/div&gt; &lt;/header&gt; &lt;ul id=&quot;plugin-list&quot;&gt; &#123;% for plugin in _.sortBy(site.data[page.data], &apos;name&apos;) %&#125; &#123;&#123; partial(&apos;_partial/&apos; + page.partial, &#123;plugin: plugin&#125;) &#125;&#125; &#123;% endfor %&#125; &lt;/ul&gt; &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;&lt;script&gt;window.SEARCH_INDEX = &#123;&#123; lunr_index(site.data[page.data]) &#125;&#125;&lt;/script&gt; 1234567891011D:\\Hexo\\Hexos\\themes\\spfk\\layout\\_partial\\plugin.swig&lt;li class=&quot;plugin on&quot;&gt; &lt;a href=&quot;&#123;&#123; plugin.link &#125;&#125;&quot; class=&quot;plugin-name&quot; target=&quot;_blank&quot;&gt;&#123;&#123; plugin.name &#125;&#125;&lt;/a&gt; &lt;p class=&quot;plugin-desc&quot;&gt;&#123;&#123; plugin.description &#125;&#125;&lt;/p&gt; &lt;div class=&quot;plugin-tag-list&quot;&gt; &#123;% for tag in plugin.tags %&#125; &lt;a href=&quot;#&#123;&#123; tag &#125;&#125;&quot; class=&quot;plugin-tag&quot;&gt;&#123;&#123; tag &#125;&#125;&lt;/a&gt; &#123;% endfor %&#125; &lt;/div&gt;&lt;/li&gt; 123456789101112131415161718D:\\Hexo\\Hexos\\themes\\spfk\\layout\\_partial\\work.swig&lt;li class=&quot;plugin on&quot;&gt; &lt;div class=&quot;plugin-screenshot&quot;&gt; &lt;img src=&quot;&#123;&#123; plugin.imgs &#125;&#125;&quot; class=&quot;plugin-screenshot-img&quot;&gt; &#123;% if plugin.preview %&#125; &lt;a href=&quot;&#123;&#123; plugin.preview &#125;&#125;&quot; class=&quot;plugin-preview-link&quot; target=&quot;_blank&quot;&gt;&lt;i class=&quot;fa fa-eye&quot;&gt;&lt;/i&gt;&lt;/a&gt; &#123;% endif %&#125; &lt;/div&gt; &lt;a href=&quot;&#123;&#123; plugin.link &#125;&#125;&quot; class=&quot;plugin-name&quot; target=&quot;_blank&quot;&gt;&#123;&#123; plugin.name &#125;&#125;&lt;/a&gt; &lt;p class=&quot;plugin-desc&quot;&gt;&#123;&#123; plugin.description &#125;&#125;&lt;/p&gt; &lt;div class=&quot;plugin-tag-list&quot;&gt; &#123;% for tag in plugin.tags %&#125; &lt;a href=&quot;#&#123;&#123; tag &#125;&#125;&quot; class=&quot;plugin-tag&quot;&gt;&#123;&#123; tag &#125;&#125;&lt;/a&gt; &#123;% endfor %&#125; &lt;/div&gt;&lt;/li&gt; 1234引入样式文件D:\\Hexo\\Hexos\\themes\\spfk\\source\\css\\style.styl@import &quot;_partial/plugins&quot; 修改样式 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126D:\\Hexo\\Hexos\\themes\\spfk\\layout\\_partial\\plugin.swig#plugin-list-header clearfix() margin: 40px 0#plugin-list-title font-family: font-title font-size: 36px font-weight: 300 line-height: 1 float: left#plugin-list-count color: color-gray padding-top: 1em text-align: right @media mq-normal float: right line-height: 40px padding-top: 0 padding-right: 15px#plugin-search-input font-size: 16px font-family: inherit -webkit-appearance: none border: 1px solid color-border padding: 10px 10px width: 100% margin-top: 25px @media mq-normal float: right width: 50% margin-top: 0#plugin-list margin: 40px -20px display: flex flex-flow: column @media mq-tablet flex-flow: row wrap.plugin display: none padding: 20px @media mq-tablet flex: 0 0 50% @media mq-normal flex: 0 0 (100 / 3)% &amp;.on display: block.plugin-name font-family: font-title font-weight: bold color: color-link font-size: 20px text-decoration: none line-height: 1 &amp;:hover color: color-link-hover.plugin-desc line-height: line-height margin: 1em 0.plugin-tag-list clearfix() line-height: 1.3.plugin-tag color: color-gray font-size: 0.9em text-decoration: none float: left margin-right: 10px &amp;:hover color: color-link-hover &amp;:before content: &quot;#&quot;.plugin-screenshot margin-bottom: 15px position: relative padding-top: (10 / 16 * 100)% // 16:10 ratio height: 0 overflow: hidden.plugin-screenshot-img position: absolute top: 0 left: 0 width: 100% height: auto.plugin-preview-link position: absolute top: 0 left: 0 width: 100% height: 100% background: rgba(0, 0, 0, 0.7) color: #fff text-align: center opacity: 0 transition: 0.15s &amp;:hover opacity: 1 .fa opacity: 1 transform: scale(1) .fa position: absolute top: 0 left: 0 bottom: 0 right: 0 margin: auto font-size: 50px width: @font-size height: @font-size opacity: 0 transform: scale(6) transition: 0.2s transition-delay: 0.15s 自定义挂件除了默认已提供的挂件外，你还可以自定义自己的小挂件，在hexo\\themes\\modernist\\layout_widget\\下，新建自己的ejs文件，如myWidget.ejs，然后在配置文件hexo\\themes\\modernist_config.yml中配置。1234567widgets: - myWidget用上述方法可以添加新浪微博小挂件。生成自己的微博组件。添加hexo\\themes\\modernist\\layout\\_widget\\weibo.ejs文件。配置hexo\\themes\\modernist\\_config.yml。 Hexo语法高亮查阅格式高亮代码，了解到本主题，通过特定的规律进行语法高亮！好像无法识别不同代码的语法高亮！ 测试： 通过测试代码，查看后台代码逻辑，了解到可以识别Apache、C++、bash等，还有部分不可识别。那么这个主题用的是什么的语法高亮？ 代码code，table-gutter-pre是代码前面的序号。class=”highlight apache”123456789101112131415161718192021J:\\Hexo\\Hexo\\themes\\spfk\\source\\css\\_partial\\highlight.styl// https://github.com/luuman/hexo-theme-spfkcode-bgc = #002B36code-tag = #F92672code-attr = #A6E22Ecode-word = #FFFFFFcode-value = #E6DB74code-number = #9E90FFcode-keyword = #66D9EFcode-comment = #75715Ecode-argument = #FD971F$code-block background: code-bgc margin: 10px 0 padding: 10px 10px overflow: auto color: #4C4C4C line-height: font-size * line-height 参考：highlight.js：Demo https://highlightjs.org/static/demo/Solarized DarkAtelier Sulphurpool Dark文档：http://highlightjs.readthedocs.org/en/latest/css-classes-reference.html下载：https://highlightjs.org/download/ 首页添加loading效果themes\\spfk\\layout\\index.ejs 123456789101112131415&lt;link rel=&quot;stylesheet&quot; href=&quot;css/loading-style.css&quot;&gt;&lt;div id=&quot;loader-wrapper&quot;&gt; &lt;div id=&quot;loader&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;%- partial(&apos;_partial/archive&apos;, &#123;pagination: 2, index: true&#125;) %&gt;&lt;!-- loading --&gt;&lt;script&gt;window.jQuery || document.write(&apos;&lt;script src=&quot;js/jquery-1.9.1.min.js&quot;&gt;&lt;\\/script&gt;&apos;)&lt;/script&gt;&lt;script type=&quot;text/javascript&quot;&gt; $(window).load(function() &#123; // makes sure the whole site is loaded $(&apos;#loader&apos;).fadeOut(); // will first fade out the loading animation $(&apos;#loader-wrapper&apos;).delay(350).fadeOut(&apos;slow&apos;); // will fade out the white DIV that covers the website. $(&apos;body&apos;).delay(350).css(&#123;&apos;overflow-y&apos;:&apos;visible&apos;&#125;); &#125;)&lt;/script&gt; LoadingBar页面顶部加载进度条J:\\Hexo\\Hexo\\themes\\spfk\\layout_partial\\head.ejs 12345&lt;!-- 加载特效 --&gt;&lt;% if(theme.animate) &#123; %&gt; &lt;script src=&quot;/js/pace.js&quot;&gt;&lt;/script&gt;&lt;link href=&quot;/css/pace/pace-theme-flash.css&quot; rel=&quot;stylesheet&quot; /&gt;&lt;% &#125; %&gt; highlight.js1234567891011121314151617J:\\Hexo\\Hexo\\node_modules\\hexo-renderer-marked\\node_modules\\hexo-util\\lib\\highlight.js: 37 &#125; 38 39: result += &apos;&lt;figure class=&quot;highlight&apos; + (data.language ? &apos; &apos; + data.language : &apos;&apos;) + &apos;&quot;&apos; + &apos;data-lang=&quot;&apos; + (data.language ? &apos; &apos; + data.language : &apos;&apos;) + &apos;&quot;&gt;&apos;; 40 41 if (caption) &#123;J:\\Hexo\\Hexo\\node_modules\\hexo-util\\lib\\highlight.js: 33 &#125; 34 35: result += &apos;&lt;figure class=&quot;highlight&apos; + (data.language ? &apos; &apos; + data.language : &apos;&apos;) + &apos;&quot;&gt;&apos;; 36 37 if (caption)&#123;6 matches across 2 files result += &apos;&lt;figure class=&quot;highlight&apos; + (data.language ? &apos; &apos; + data.language : &apos;&apos;) + &apos;&quot;&apos; + &apos;data-lang=&quot;&apos; + (data.language ? &apos; &apos; + data.language : &apos;&apos;) + &apos;&quot;&gt;&apos;; Hexo插件Swiftype 微搜索 不蒜子 百度统计 CNZZ数据 Font Awesome 百度脑图 ICON图标 Font Awesome FREE Icon Maker Icon Font 在线ico IcoMoon Disqus 多说评论 QQ邮箱开放平台 七牛云存储 百度分享 AddThis 分享一个方法解决Facebook,Linkedin,Twitter,Google+等SNS平台太多更新不过来的问题。 - 米课问答 GitCafe Coding.Net GitHub","tags":[{"name":"Hexo","slug":"Hexo","permalink":"https://smuwjs.github.io/tags/Hexo/"}]},{"title":"Hexo的使用介绍","date":"2016-09-07T21:33:01.000Z","path":"2016/09/07/Hexo/","text":"自用笔记：本文属于自用笔记，不做详解，仅供参考。在此记录自己已理解并开始遵循的前端代码规范。What How Why 最近，使用Hexo遇到了很多问题，在设立进行整理。 写文章1234567891011121314151617181920212223242526272829$ hexo n #写文章 其中my new post为文章标题，执行命令后。 会在项目\\source_posts中生成my new post.md文件，用编辑器打开编写即可。 当然，也可以直接在\\source_posts中新建一个md文件，我就是这么做的。 文章开头语法：title: name #文章标题date: 2015-12-25 18:29:00 #写作时间description: #文章描述categories: #文章分类- 建站tags: #文章标签- 博客- 建站- Hexotoc: true # 生成目录author:comments:original:permalink: #指定链接--- 以上是摘要&lt;!--more--&gt; 以下是余下全文 写多种文章1234567891011121314151617181920212223242526$ hexo new [layout] &quot;postName&quot; #新建文章 [layout]：其中layout是可选参数，默认值为post。 有哪些layout呢，请到 scaffolds 目录下查看，这些文件名称就是layout名称。 当然你可以添加自己的layout，方法就是添加一个文件即可。 同时你也可以编辑现有的layout，比如post的layout默认是 hexo\\scaffolds\\post.md 关于hexo\\scaffolds\\photo.md配置文件的介绍：layout: &#123; &#123; layout &#125; &#125; #layout名称title: &#123; &#123; title &#125; &#125; #文章标题date: &#123; &#123; date &#125; &#125; #文章生成时间ategories: #文章分类目录tags: #文章标签- #photos: #- #---layout: phototitle: 我的阅历date: 2085-01-16 07:33:44tags: [hexo]photos:- http://bruce.u.qiniudn.com/2013/11/27/reading/photos-0.jpg- http://bruce.u.qiniudn.com/2013/11/27/reading/photos-1.jpg 自定义页面12345678910111213 执行new page命令$ hexo new page &quot;about&quot; 在 *hexo\\source\\* 下会生成 *about* 目录， 里面有个index.md，直接编辑就可以了， 然后在主题的 *_config.yml* 中将其配置显示出来。 上述步骤，也可以手工生成，在 *hexo\\source\\* 下手工新建 *about* 和 *index.md* 也是完全等价的。 因为markdown对table的支持不好，我是在about中直接 建立index.html，里面书写页面内容，hexo会帮你加上头和尾。 写页面（404）12345$ hexo new page &quot;404&quot;UUhike@UUhike-pc MINGW64 /d/Hexo/Hexo (master)$ hexo new page &quot;404&quot;INFO Created: D:\\Hexo\\Hexo\\source\\404\\index-1.md 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071title: 404 Not Found：该页无法显示comments: falsepermalink: /404fancybox: false---&lt;style type=&quot;text/css&quot;&gt; .article-title &#123; font-size: 2.1em; &#125; strong a &#123; color: #747474; &#125; .share &#123; display: none; &#125; .player &#123; margin-left: -10px; &#125; .sign &#123; text-align: right; font-style: italic; &#125; #page-visit &#123; display: none; &#125; .center &#123; text-align: center; height: 2.5em; font-weight: bold; &#125; .search2 &#123; height: 2.2em; font-size: 1em; width: 50%; margin: auto 24%; color: #727272; opacity: .6; border: 2px solid lightgray; &#125; .search2:hover &#123; opacity: 1; box-shadow: 0 0 10px rgba(0, 0, 0, 0.3) &#125;; .article-entry hr &#123; margin: 0; &#125; .pic &#123; text-align: center; margin: 0; &#125; .pic br &#123; display: none; &#125;&lt;/style&gt;***&lt;div class=&quot;pic&quot;&gt;&lt;img src=&quot;/resources/Mihawk-Wind.gif&quot; title=&quot;Mihawk-Wind&quot;&gt;&lt;/div&gt;&lt;p class=&quot;center&quot;&gt;很抱歉，您所访问的地址并不存在: &lt;/p&gt;&lt;p class=&quot;center&quot;&gt;&lt;a href=&quot;/&quot;&gt;回主页&lt;/a&gt; · &lt;a href=&quot;/archives&quot;&gt;所有文章&lt;/a&gt; · &lt;a href=&quot;/about&quot;&gt;留言板&lt;/a&gt;&lt;/p&gt;&lt;p class=&quot;center&quot;&gt;可在边栏搜索框中对本站进行检索，以获取相关信息。&lt;/p&gt;&lt;div style=&quot;text-align: center&quot;&gt;以下是博主喜欢的一些歌曲，可以听听，稍作休息~&lt;iframe frameborder=&quot;no&quot; border=&quot;0&quot; marginwidth=&quot;0&quot; marginheight=&quot;0&quot; width=320 height=330 src=&quot;http://music.163.com/outchain/player?type=0&amp;id=112513213&amp;auto=0&amp;height=430&quot;&gt;&lt;/iframe&gt;&lt;/div&gt; 发布博客内容实现发布，前提是配置好，部署到Github前需要配置_config.yml文件。 123456# Deployment## Docs: http://hexo.io/docs/deployment.htmldeploy: type: github repository: git@github.com:zhchnchn/zhchnchn.github.io.git branch: master 更新的最新版本，可能会有Bug，自行百度，好像要修改type：git。12345678910$ hexo server #开启预览访问端口（默认端口4000，&apos;ctrl + c&apos;关闭server）Hexo 会监视文件变动并自动更新，您无须重启服务器。$ hexo g #生成$ hexo generate #生成静态页面至public目录（最终上传这个文件到GitHub）$ hexo d == hexo deploy#部署$ hexo d #部署 # 可与hexo g合并为 hexo d -g$ hexo deploy -g$ hexo server -g # 生成默认文件群再执行,开启本地静态html服务器 主题的更改123456789101112131415161718191. 将Git Shell 切到/D/Hexo目录下，然后执行下面的命令，将pacman下载到 themes/pacman 目录下。$ git clone https://github.com/A-limon/pacman.git themes/pacman2. 修改你的博客根目录/D/Hexo下的config.yml配置文件中的theme属性，将其设置为pacman。3. 更新pacman主题$ cd themes/pacman$ git pullNOTE：先备份_config.yml 文件后再升级主题： yilia$ git clone https://github.com/litten/hexo-theme-yilia.git themes/yilia modernist$ git clone https://github.com/heroicyang/hexo-theme-modernist.git themes/modernist jacman$ git clone https://github.com/cnfeat/cnfeat.git themes/jacman 文章图片路径Hexo如何方式图片，图片应该放置到哪里，不会应为上传而覆盖掉。然后把文章里的index.md删除，将文件存放在resource文件夹中间。 123456 发布页面$ hexo new page &quot;name&quot; # 新建一个页面，页面名称name UUhike@UUhike-pc MINGW64 /d/Hexo/Hexo (master)$ hexo new page &quot;resoures&quot; INFO Created: D:\\Hexo\\Hexo\\source\\resoures\\index.md Hexo文件备份1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162 git-backup. Install if your hexo version is 2.x.x, you should install as follow:$ npm install hexo-git-backup@0.0.91 --save if version is 3.x.x, you should install as follow:$ npm install hexo-git-backup --save Update if you install with --save, you must remove firstly when you update it.$ npm remove hexo-git-backup$ npm install hexo-git-backup --save Configure You should configure this plugin in _config.yml.backup: type: git repository: github: git@github.com:xxx/xxx.git,branchName gitcafe: git@github.com:xxx/xxx.git,branchNameUsinghexo backup orhexo bOptionsif you want to back up with your theme,just add theme: your theme name,your theme name in _config.yml.backup: type: git theme: coney,landscape,xxx repository: github: git@github.com:xxx/xxx.git,branchName gitcafe: git@github.com:xxx/xxx.git,branchNameAttention: if you do as above, the dir themes/coney/.gitwill be removedif you want DIY commit message, just add &apos;message: update xxx&apos;.backup: type: git message: update xxx repository: github: git@github.com:xxx/xxx.git,branchName gitcafe: git@github.com:xxx/xxx.git,branchNameNow you can backup all the blog!ProblemsYou may get some troubles by your computer&apos; permission。Error: EISDIR, openit is caused by permission. just do &apos;sudo hexo b&apos;sudo hexo b 参考资料：使用GitHub搭建Hexo博客Hexo插件安装hexo你的博客如何搭建一个独立博客——简明Github Pages与Hexo教程","tags":[{"name":"Hexo","slug":"Hexo","permalink":"https://smuwjs.github.io/tags/Hexo/"}]},{"title":"Hello World","date":"2016-09-06T18:29:00.000Z","path":"2016/09/06/hello-world/","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post12$ hexo new \"My New Post\" More info: Writing Run server12$ hexo server More info: Server Generate static files12$ hexo generate More info: Generating Deploy to remote sites12$ hexo deploy More info: Deployment","tags":[]},{"title":"使用SoureceTree管理你的git项目","date":"2016-04-20T21:31:49.000Z","path":"2016/04/20/git01-sourcetree/","text":"Update update: Windows用户在初始化Souretree工具时，需要用到Atlassian ID，新建用户时需要加载google 验证码，这一步需要VPN的支持，请注意。 找到一个版本的SourceTree工具可以不需要以上验证也能使用，下载链接：SourceTreeSetup_1.6.14.exe 补充1 ：Git学习网站 猴子都能学会的git教程 常用 Git 命令清单 廖雪峰的git教程 Why Git is Better than X 补充2 ：利用Git协同开发 团队中的Git实践 Git 使用规范流程 Git分支管理模型 图解Git 1. 关于 SourceTreeSourceTree 是一款免费且同时支持Windows 和Mac 的git项目管理软件，本文旨在给大家介绍这款应用的基础使用，并用它来管理你的项目。 官网： https://www.sourcetreeapp.com/ 2. git帐号建立1. 新员工入职之后，你的公司邮箱内会收到一封来自Gitlab的邮件，如下图： 2. 点击邮件中的 “Click here to set your password”，设置gitlab登陆密码。 3. 登陆gitlab帐号，将会出现这个界面： 4. 设定个人信息： 5. sshKey5.1 在Linux和Mac上生成sshkey：123456789101112131415161718192021222324➜ ~ ssh-keygen -t rsaGenerating public/private rsa key pair.Enter file in which to save the key (/Users/Alex/.ssh/id_rsa):Enter passphrase (empty for no passphrase):Enter same passphrase again:Your identification has been saved in /Users/Alex/.ssh/id_rsa.Your public key has been saved in /Users/Alex/.ssh/id_rsa.pub.The key fingerprint is:SHA256:98jE3jhBhFT5nQlZRj34a3WOk1t6XF+Dbf/hliXl4WQ Alex@Alex-MacThe key&apos;s randomart image is:+---[RSA 2048]----+| ..oo. +=. || ... oo ..|| .. o.o.|| o . +E+|| S = **=|| = * .=BB|| * o oOO|| . +o*|| .oo|+----[SHA256]-----+➜ ~ cat ~/.ssh/id_rsa.pubssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCvuQAq65b+nLZPqqc3b3Mj9e7Pt8oWKasJFa2QH1VIEkDvxKLFGcHsT7Ur4zXwEi9YiW2tVRrBSjcMALxuBjVm2IxYV6Lk8SLuGadyYy5telWGJmHsQ3VIPRuKwpzTkLN643kjqc6JFSlnZG/XoP9SPtCOsp2ql4u0s7Auc2bZay4RaTDXbcpJVU9OA0xM8Zy4oTTNYdZ4tvGittVmn+wLrhN255J7clORF5126dmDYxV3E8ZboaDdQpdLGIWmDNcBJQvl0CLwpKUCi7EUDqDVtm4bNgwIX9fEIkTxGdaWjBW1iXBk8TGXWkgB+Qp8B1IwaJ4GHUwUhQrefWvw9XeJ Alex@Alex-Mac➜ ~ 5.2 在Windows上生成sshkey：因为windows没有自带openssl模块，所以在Windows环境中使用第三方工具puttygen.exe生成sshkey 下载地址步骤如下： 当sourcetree首次启动时，会弹出加载sshkey的提示，按提示操作，找到之前保存的private.ppk文件 5.3 上传sshkey： 6. 回到 dashboard ，点击项目名称进入详情： 7. 使用souretree将项目从git服务器clone到本地7.1 安装souretree 软件 ［略］7.2 clone项目到本地 8. 进入项目工作台： 9. 关于sourcetree工具的使用，下面是一些git操作的释疑。 检出仓库: 将在本地创建一个git仓库的克隆版本 工作流: 本地仓库由 git 维护的三棵“树”组成。第一个是 工作目录，它持有实际文件；第二个是 缓存区（Index），它像个缓存区域，临时保存改动；最后是 HEAD，指向最近一次提交后的结果。 提交：可以计划改动（把它们添加到缓存区),将改动提交到了 HEAD，但是还没到提交到远端仓库。 拉取：从远端仓库拉取最新版本状态，特别是在其他人员有所改动之后。 推送：改动现在已经在本地仓库的 HEAD 中了。这时可以使用它将这些改动提交到远端仓库。 分支：分支是用来将特性开发分离出来的。在创建仓库的时候，master 是“默认的”。创建分支将可以从主线开发上分离开来，然后在不影响主线的同时继续工作，完成后再将它们合并到主分支上。 合并： 将分支功能并入主分支。","tags":[{"name":"Git","slug":"Git","permalink":"https://smuwjs.github.io/tags/Git/"}]}]